const TAG_PHASE={GLOBAL:"global",DISCOVERY:"discovery",CONTENT:"content",EFFECT:"effect"},TAG_VALUE={REQUIRED:"required",OPTIONAL:"optional",NONE:"none"},TAGS={THEME:{names:["THEME"],phase:TAG_PHASE.GLOBAL,value:TAG_VALUE.REQUIRED,description:"Set default theme (light/dark)"},AUTHOR:{names:["AUTHOR"],phase:TAG_PHASE.GLOBAL,value:TAG_VALUE.REQUIRED,description:"Story author name"},TITLE:{names:["TITLE"],phase:TAG_PHASE.GLOBAL,value:TAG_VALUE.REQUIRED,description:"Story title"},TONE:{names:["TONE"],phase:TAG_PHASE.GLOBAL,value:TAG_VALUE.REQUIRED,description:"Define tone indicator (e.g., TONE: flirty ðŸ”¥)"},TONE_INDICATORS:{names:["TONE_INDICATORS","SHOW_TONES"],phase:TAG_PHASE.GLOBAL,value:TAG_VALUE.REQUIRED,description:"Enable tone indicators (on/off)"},TONE_TRAILING:{names:["TONE_TRAILING","TRAILING_TONES"],phase:TAG_PHASE.GLOBAL,value:TAG_VALUE.NONE,description:"Show all tone icons after choice text"},CHOICE_NUMBERS:{names:["CHOICE_NUMBERS","CHOICE_NUMBERING","KEYBOARD_HINTS"],phase:TAG_PHASE.GLOBAL,value:TAG_VALUE.REQUIRED,description:"Choice numbering mode (auto/on/off)"},SPECIAL_PAGE:{names:["SPECIAL_PAGE","PAGE"],phase:TAG_PHASE.DISCOVERY,value:TAG_VALUE.OPTIONAL,description:"Mark knot as special page, optionally with display name"},PAGE_MENU:{names:["PAGE_MENU","MENU","MENU_ORDER","PAGE_ORDER","SPECIAL_PAGE_ORDER"],phase:TAG_PHASE.GLOBAL,value:TAG_VALUE.REQUIRED,description:"Define page menu order"},IMAGE:{names:["IMAGE","IMG","PICTURE","PIC"],phase:TAG_PHASE.CONTENT,value:TAG_VALUE.REQUIRED,description:"Display image (src, alignment, width, alt)"},STATBAR:{names:["STATBAR","STAT_BAR","PROGRESSBAR","PROGRESS_BAR"],phase:TAG_PHASE.CONTENT,value:TAG_VALUE.REQUIRED,description:"Display stat bar (variable, min, max, labels)"},USER_INPUT:{names:["USER_INPUT","INPUT","PROMPT","TEXT_INPUT"],phase:TAG_PHASE.CONTENT,value:TAG_VALUE.REQUIRED,description:"Text input field (variable, placeholder)"},AUDIO:{names:["AUDIO","SOUND","SFX","SOUND_EFFECT"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.REQUIRED,description:"Play one-shot audio file"},AUDIOLOOP:{names:["AUDIOLOOP","AUDIO_LOOP","MUSIC","BACKGROUND_MUSIC","BGM"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.REQUIRED,description:"Play looping audio (or 'none' to stop)"},BACKGROUND:{names:["BACKGROUND","BG","BACKGROUND_IMAGE"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.REQUIRED,description:"Set background image (or 'none' to remove)"},NOTIFICATION:{names:["NOTIFICATION","NOTIFY","MESSAGE","INFO"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.REQUIRED,description:"Show info notification"},ACHIEVEMENT:{names:["ACHIEVEMENT","SUCCESS","UNLOCK"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.REQUIRED,description:"Show success notification (6s duration)"},WARNING:{names:["WARNING","WARN"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.REQUIRED,description:"Show warning notification"},ERROR:{names:["ERROR","ERR"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.REQUIRED,description:"Show error notification"},CLASS:{names:["CLASS","CSS_CLASS","STYLE"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.REQUIRED,description:"Add CSS class to element"},CLEAR:{names:["CLEAR"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.NONE,description:"Clear story content"},RESTART:{names:["RESTART","RESET","NEW_GAME"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.NONE,description:"Restart story from beginning"},UNCLICKABLE:{names:["UNCLICKABLE","DISABLED","DISABLE","LOCKED","LOCK"],phase:TAG_PHASE.EFFECT,value:TAG_VALUE.NONE,description:"Make choice visible but not clickable"}};for(const e in TAGS)TAGS[e].names||(TAGS[e].names=[e]);const TAG_LOOKUP={};for(const e in TAGS)for(const n of TAGS[e].names){const t=n.toUpperCase();TAG_LOOKUP[t]&&console.warn(`Duplicate tag alias "${t}" used by both "${TAG_LOOKUP[t]}" and "${e}"`),TAG_LOOKUP[t]=e}function getTagsByPhase(e){return Object.keys(TAGS).filter(t=>TAGS[t].phase===e)}function isKnownTag(e){return TAG_LOOKUP[e.toUpperCase()]!==0[0]}function getTagDef(e){const t=TAG_LOOKUP[e.toUpperCase()];return t?TAGS[t]:null}function validateTagValue(e,t){if(!e)return{valid:!0,error:null};const s=t&&t.trim()!=="",n=e.names[0];return e.value===TAG_VALUE.REQUIRED&&!s?{valid:!1,error:`Tag "${n}" requires a value (use # ${n}: value)`}:e.value===TAG_VALUE.NONE&&s?{valid:!1,error:`Tag "${n}" should not have a value (use # ${n} alone)`}:{valid:!0,error:null}}window.TagRegistry={TAG_PHASE,TAG_VALUE,TAGS,TAG_LOOKUP,getTagsByPhase,isKnownTag,getTagDef,validateTagValue,parseTag(e){if(!e||typeof e!="string")return{tagDef:null,tagValue:""};const n=this.splitPropertyTag(e),o=n?n.property:e.trim(),s=n?.val||"",t=this.getTagDef(o);if(t){const e=this.validateTagValue(t,s);if(!e.valid)return{tagDef:t,tagValue:s,invalid:!0,error:e.error}}return{tagDef:t,tagValue:s,invalid:!1,error:null}},splitPropertyTag(e){if(!e||typeof e!="string")return null;const t=e.indexOf(":");return t===-1?null:{property:e.slice(0,t).trim(),val:e.slice(t+1).trim()}},hasSpecialPageTag(e){return!!Array.isArray(e)&&e.some(e=>{if(typeof e!="string")return!1;const{tagDef:t}=this.parseTag(e);return t===TAGS.SPECIAL_PAGE})},isRegisteredToneTag(e){const t=window.storyManager?.settings?.toneMap||{};return Object.keys(t).some(t=>t.toLowerCase()===e.toLowerCase())}},window.StoryFeatures={hasAudio:!1,scan(e){const t=JSON.stringify(e),n=(...e)=>{const n=e.flatMap(e=>e?.names||[]);return!!n.length&&new RegExp(`"\\^(${n.join("|")})\\s*:`,"i").test(t)};return this.hasAudio=n(TAGS.AUDIO,TAGS.AUDIOLOOP),this}},window.Utils={isMobile(){return window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(pointer: fine)").matches},isMac(){return navigator.userAgentData?.platform==="macOS"||navigator.platform.toUpperCase().includes("MAC")},levenshteinDistance(e,t){if(e.length===0)return t.length;if(t.length===0)return e.length;const n=[];for(let e=0;e<=t.length;e++)n[e]=[e];for(let t=0;t<=e.length;t++)n[0][t]=t;for(let s=1;s<=t.length;s++)for(let o=1;o<=e.length;o++){const i=e[o-1]===t[s-1]?0:1;n[s][o]=Math.min(n[s-1][o]+1,n[s][o-1]+1,n[s-1][o-1]+i)}return n[t.length][e.length]}},!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).inkjs={})}(this,function(e){"use strict";class r{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){let e=arguments[0];this.componentsString=e}else if(arguments[0]instanceof r.Component&&arguments[1]instanceof r){let e=arguments[0],t=arguments[1];this._components.push(e),this._components=this._components.concat(t._components)}else if(arguments[0]instanceof Array){let e=arguments[0],t=!!arguments[1];this._components=this._components.concat(e),this._isRelative=t}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return this._components.length>0?this._components[0]:null}get tail(){if(this._components.length>=2){let e=this._components.slice(1,this._components.length);return new r(e)}return r.self}get length(){return this._components.length}get lastComponent(){let e=this._components.length-1;return e>=0?this._components[e]:null}get containsNamedComponent(){for(let e=0,t=this._components.length;e<t;e++)if(!this._components[e].isIndex)return!0;return!1}static get self(){let e=new r;return e._isRelative=!0,e}GetComponent(e){return this._components[e]}PathByAppendingPath(e){let t=new r,n=0;for(let t=0;t<e._components.length&&e._components[t].isParent;++t)n++;for(let e=0;e<this._components.length-n;++e)t._components.push(this._components[e]);for(let s=n;s<e._components.length;++s)t._components.push(e._components[s]);return t}get componentsString(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString}set componentsString(e){if(this._components.length=0,this._componentsString=e,null==this._componentsString||""==this._componentsString)return;"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));let t=this._componentsString.split(".");for(let e of t)/^(-|\+)?([0-9]+|Infinity)$/.test(e)?this._components.push(new r.Component(parseInt(e))):this._components.push(new r.Component(e))}toString(){return this.componentsString}Equals(e){if(e==null)return!1;if(e._components.length!=this._components.length)return!1;if(e.isRelative!=this.isRelative)return!1;for(let t=0,n=e._components.length;t<n;t++)if(!e._components[t].Equals(this._components[t]))return!1;return!0}PathByAppendingComponent(e){let t=new r;return t._components.push(...this._components),t._components.push(e),t}}var o,l,E,L;function s(e,t){return e instanceof t?K(e):null}function u(e,t){if(e instanceof t)return K(e);throw new Error("".concat(e," is not of type ").concat(t))}function R(e){return e.hasValidName&&e.name?e:null}function B(e){return 0[0]===e?null:e}function W(e){return"object"==typeof e&&"function"==typeof e.Equals}function K(e){return e}r.parentId="^",function(e){class t{constructor(e){this.index=-1,this.name=null,"string"==typeof e?this.name=e:this.index=e}get isIndex(){return this.index>=0}get isParent(){return this.name==e.parentId}static ToParent(){return new t(e.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(e){return e!=null&&e.isIndex==this.isIndex&&(this.isIndex?this.index==e.index:this.name==e.name)}}e.Component=t}(r||(r={})),function(e){function t(e,t){if(!e)throw 0[0]!==t&&console.warn(t),console.trace&&console.trace(),new Error("")}e.AssertType=function(e,n,s){t(e instanceof n,s)},e.Assert=t}(E||(E={}));class Q extends Error{}function n(e){throw new Q("".concat(e," is null or undefined"))}class b{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(e){this._debugMetadata=e}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(e){if(null===e)return null;let t=this.rootContentContainer;if(t){let n=t.ContentAtPath(e).obj;if(n){let e=n.debugMetadata;if(null!==e)return e.startLineNumber}}return null}get path(){if(null==this._path)if(null==this.parent)this._path=new r;else{let o=[],t=this,e=s(t.parent,a);for(;null!==e;){let i=R(t);if(i!=null&&i.hasValidName){if(null===i.name)return n("namedChild.name");o.unshift(new r.Component(i.name))}else o.unshift(new r.Component(e.content.indexOf(t)));t=e,e=s(e.parent,a)}this._path=new r(o)}return this._path}ResolvePath(e){if(null===e)return n("path");if(e.isRelative){let t=s(this,a);return null===t&&(E.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),t=s(this.parent,a),E.Assert(null!==t,"Expected parent to be a container"),E.Assert(e.GetComponent(0).isParent),e=e.tail),null===t?n("nearestContainer"):t.ContentAtPath(e)}{let t=this.rootContentContainer;return null===t?n("contentContainer"):t.ContentAtPath(e)}}ConvertPathToRelative(e){let n=this.path,o=Math.min(e.length,n.length),t=-1;for(let s=0;s<o;++s){let i=n.GetComponent(s),a=e.GetComponent(s);if(!i.Equals(a))break;t=s}if(-1==t)return e;let i=n.componentCount-1-t,s=[];for(let e=0;e<i;++e)s.push(r.Component.ToParent());for(let n=t+1;n<e.componentCount;++n)s.push(e.GetComponent(n));return new r(s,!0)}CompactPathString(e){let t=null,n=null;return e.isRelative?(n=e.componentsString,t=this.path.PathByAppendingPath(e).componentsString):(n=this.ConvertPathToRelative(e).componentsString,t=e.componentsString),n.length<t.length?n:t}get rootContentContainer(){let e=this;for(;e.parent;)e=e.parent;return s(e,a)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(e,t,n){e[t]&&(e[t]=null),e[t]=n,e[t]&&(e[t].parent=this)}Equals(e){return e===this}}class y{constructor(e){e=0[0]!==e?e.toString():"",this.string=e}get Length(){return this.string.length}Append(e){null!==e&&(this.string+=e)}AppendLine(e){0[0]!==e&&this.Append(e),this.string+=`
`}AppendFormat(e){for(var n=arguments.length,s=new Array(n>1?n-1:0),t=1;t<n;t++)s[t-1]=arguments[t];this.string+=e.replace(/{(\d+)}/g,(e,t)=>0[0]!==s[t]?s[t]:e)}toString(){return this.string}Clear(){this.string=""}}class d{constructor(){if(this.originName=null,this.itemName=null,0[0]!==arguments[1]){let e=arguments[0],t=arguments[1];this.originName=e,this.itemName=t}else if(arguments[0]){let e=arguments[0].toString().split(".");this.originName=e[0],this.itemName=e[1]}}static get Null(){return new d(null,null)}get isNull(){return null==this.originName&&null==this.itemName}get fullName(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(e){if(e instanceof d){let t=e;return t.itemName==this.itemName&&t.originName==this.originName}return!1}copy(){return new d(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(e){let t=JSON.parse(e);if(!d.isLikeInkListItem(t))return d.Null;let n=t;return new d(n.originName,n.itemName)}static isLikeInkListItem(e){return"object"==typeof e&&!!e.hasOwnProperty("originName")&&!!e.hasOwnProperty("itemName")&&("string"==typeof e.originName||null===typeof e.originName)&&("string"==typeof e.itemName||null===typeof e.itemName)}}class f extends Map{constructor(){if(super(arguments[0]instanceof f?arguments[0]:[]),this.origins=null,this._originNames=[],arguments[0]instanceof f){let e=arguments[0],t=e.originNames;null!==t&&(this._originNames=t.slice()),null!==e.origins&&(this.origins=e.origins.slice())}else if("string"==typeof arguments[0]){let e=arguments[0],s=arguments[1];if(this.SetInitialOriginName(e),null===s.listDefinitions)return n("originStory.listDefinitions");let t=s.listDefinitions.TryListGetDefinition(e,null);if(!t.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+e);if(null===t.result)return n("def.result");this.origins=[t.result]}else if("object"==typeof arguments[0]&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let e=arguments[0];this.Add(e.Key,e.Value)}}static FromString(e,t){var s;let o=null===(s=t.listDefinitions)||0[0]===s?0[0]:s.FindSingleItemListWithName(e);if(o)return null===o.value?n("listValue.value"):new f(o.value);throw new Error("Could not find the InkListItem from the string '"+e+"' to create an InkList because it doesn't exist in the original list definition in ink.")}AddItem(e){if(e instanceof d){let t=e;if(null==t.originName)return void this.AddItem(t.itemName);if(null===this.origins)return n("this.origins");for(let e of this.origins)if(e.name==t.originName){let n=e.TryGetValueForItem(t,0);if(n.exists)return void this.Add(t,n.result);throw new Error("Could not add the item "+t+" to this list because it doesn't exist in the original list definition in ink.")}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}{let s=e,t=null;if(null===this.origins)return n("this.origins");for(let e of this.origins){if(null===s)return n("itemName");if(e.ContainsItemWithName(s)){if(t!=null)throw new Error("Could not add the item "+s+" to this list because it could come from either "+e.name+" or "+t.name);t=e}}if(t==null)throw new Error("Could not add the item "+s+" to this list because it isn't known to any list definitions previously associated with this list.");let o=new d(t.name,s),i=t.ValueForItem(o);this.Add(o,i)}}ContainsItemNamed(e){for(let[t]of this)if(d.fromSerializedKey(t).itemName==e)return!0;return!1}ContainsKey(e){return this.has(e.serialized())}Add(e,t){let n=e.serialized();if(this.has(n))throw new Error("The Map already contains an entry for ".concat(e));this.set(n,t)}Remove(e){return this.delete(e.serialized())}get Count(){return this.size}get originOfMaxItem(){if(null==this.origins)return null;let t=this.maxItem.Key.originName,e=null;return this.origins.every(n=>n.name!=t||(e=n,!1)),e}get originNames(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(let[t]of this){let e=d.fromSerializedKey(t);if(null===e.originName)return n("item.originName");this._originNames.push(e.originName)}}return this._originNames}SetInitialOriginName(e){this._originNames=[e]}SetInitialOriginNames(e){this._originNames=e==null?null:e.slice()}get maxItem(){let e={Key:d.Null,Value:0};for(let[n,t]of this){let s=d.fromSerializedKey(n);(e.Key.isNull||t>e.Value)&&(e={Key:s,Value:t})}return e}get minItem(){let e={Key:d.Null,Value:0};for(let[n,t]of this){let s=d.fromSerializedKey(n);(e.Key.isNull||t<e.Value)&&(e={Key:s,Value:t})}return e}get inverse(){let e=new f;if(null!=this.origins)for(let t of this.origins)for(let[s,o]of t.items){let n=d.fromSerializedKey(s);this.ContainsKey(n)||e.Add(n,o)}return e}get all(){let e=new f;if(null!=this.origins)for(let t of this.origins)for(let[n,s]of t.items){let o=d.fromSerializedKey(n);e.set(o.serialized(),s)}return e}Union(e){let t=new f(this);for(let[n,s]of e)t.set(n,s);return t}Intersect(e){let t=new f;for(let[n,s]of this)e.has(n)&&t.set(n,s);return t}HasIntersection(e){for(let[t]of this)if(e.has(t))return!0;return!1}Without(e){let t=new f(this);for(let[n]of e)t.delete(n);return t}Contains(e){if("string"==typeof e)return this.ContainsItemNamed(e);const t=e;if(0==t.size||0==this.size)return!1;for(let[e]of t)if(!this.has(e))return!1;return!0}GreaterThan(e){return 0!=this.Count&&(0==e.Count||this.minItem.Value>e.maxItem.Value)}GreaterThanOrEquals(e){return 0!=this.Count&&(0==e.Count||this.minItem.Value>=e.minItem.Value&&this.maxItem.Value>=e.maxItem.Value)}LessThan(e){return 0!=e.Count&&(0==this.Count||this.maxItem.Value<e.minItem.Value)}LessThanOrEquals(e){return 0!=e.Count&&(0==this.Count||this.maxItem.Value<=e.maxItem.Value&&this.minItem.Value<=e.minItem.Value)}MaxAsList(){return this.Count>0?new f(this.maxItem):new f}MinAsList(){return this.Count>0?new f(this.minItem):new f}ListWithSubRange(e,t){if(0==this.Count)return new f;let i=this.orderedItems,n=0,s=Number.MAX_SAFE_INTEGER;Number.isInteger(e)?n=e:e instanceof f&&e.Count>0&&(n=e.minItem.Value),Number.isInteger(t)?s=t:t instanceof f&&t.Count>0&&(s=t.maxItem.Value);let o=new f;o.SetInitialOriginNames(this.originNames);for(let e of i)e.Value>=n&&e.Value<=s&&o.Add(e.Key,e.Value);return o}Equals(e){if(e instanceof f==!1)return!1;if(e.Count!=this.Count)return!1;for(let[t]of this)if(!e.has(t))return!1;return!0}get orderedItems(){let e=new Array;for(let[t,n]of this){let s=d.fromSerializedKey(t);e.push({Key:s,Value:n})}return e.sort((e,t)=>null===e.Key.originName?n("x.Key.originName"):null===t.Key.originName?n("y.Key.originName"):e.Value==t.Value?e.Key.originName.localeCompare(t.Key.originName):e.Value<t.Value?-1:e.Value>t.Value?1:0),e}toString(){let t=this.orderedItems,e=new y;for(let s=0;s<t.length;s++){s>0&&e.Append(", ");let o=t[s].Key;if(null===o.itemName)return n("item.itemName");e.Append(o.itemName)}return e.toString()}valueOf(){return NaN}}class _ extends Error{constructor(e){super(e),this.useEndLineNumber=!1,this.message=e,this.name="StoryException"}}function w(e,t,n){if(null===e)return{result:n,exists:!1};let s=e.get(t);return 0[0]===s?{result:n,exists:!1}:{result:s,exists:!0}}class G extends b{static Create(e,t){if(t){if(t===o.Int&&Number.isInteger(Number(e)))return new c(Number(e));if(t===o.Float&&!(e!=e))return new x(Number(e))}return"boolean"==typeof e?new M(Boolean(e)):"string"==typeof e?new h(String(e)):Number.isInteger(Number(e))?new c(Number(e)):e!=e?e instanceof r?new k(u(e,r)):e instanceof f?new g(u(e,f)):null:new x(Number(e))}Copy(){return u(G.Create(this.valueObject),b)}BadCastException(e){return new _("Can't cast "+this.valueObject+" from "+this.valueType+" to "+e)}}class m extends G{constructor(e){super(),this.value=e}get valueObject(){return this.value}toString(){return null===this.value?n("Value.value"):this.value.toString()}}class M extends m{constructor(e){super(e||!1)}get isTruthy(){return Boolean(this.value)}get valueType(){return o.Bool}Cast(e){if(null===this.value)return n("Value.value");if(e==this.valueType)return this;if(e==o.Int)return new c(this.value?1:0);if(e==o.Float)return new x(this.value?1:0);if(e==o.String)return new h(this.value?"true":"false");throw this.BadCastException(e)}toString(){return this.value?"true":"false"}}class c extends m{constructor(e){super(e||0)}get isTruthy(){return 0!=this.value}get valueType(){return o.Int}Cast(e){if(null===this.value)return n("Value.value");if(e==this.valueType)return this;if(e==o.Bool)return new M(0!==this.value);if(e==o.Float)return new x(this.value);if(e==o.String)return new h(""+this.value);throw this.BadCastException(e)}}class x extends m{constructor(e){super(e||0)}get isTruthy(){return 0!=this.value}get valueType(){return o.Float}Cast(e){if(null===this.value)return n("Value.value");if(e==this.valueType)return this;if(e==o.Bool)return new M(0!==this.value);if(e==o.Int)return new c(this.value);if(e==o.String)return new h(""+this.value);throw this.BadCastException(e)}}class h extends m{constructor(e){if(super(e||""),this._isNewline=`
`==this.value,this._isInlineWhitespace=!0,null===this.value)return n("Value.value");this.value.length>0&&this.value.split("").every(e=>" "==e||"	"==e||(this._isInlineWhitespace=!1,!1))}get valueType(){return o.String}get isTruthy(){return null===this.value?n("Value.value"):this.value.length>0}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(e){if(e==this.valueType)return this;if(e==o.Int){let t=function(e){let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0,t=parseInt(e);return Number.isNaN(t)?{result:n,exists:!1}:{result:t,exists:!0}}(this.value);if(t.exists)return new c(t.result);throw this.BadCastException(e)}if(e==o.Float){let t=function(e){let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0,t=parseFloat(e);return Number.isNaN(t)?{result:n,exists:!1}:{result:t,exists:!0}}(this.value);if(t.exists)return new x(t.result);throw this.BadCastException(e)}throw this.BadCastException(e)}}class k extends m{constructor(){super(arguments.length>0&&0[0]!==arguments[0]?arguments[0]:null)}get valueType(){return o.DivertTarget}get targetPath(){return null===this.value?n("Value.value"):this.value}set targetPath(e){this.value=e}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a divert target")}Cast(e){if(e==this.valueType)return this;throw this.BadCastException(e)}toString(){return"DivertTargetValue("+this.targetPath+")"}}class O extends m{constructor(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:-1;super(e),this._contextIndex=t}get contextIndex(){return this._contextIndex}set contextIndex(e){this._contextIndex=e}get variableName(){return null===this.value?n("Value.value"):this.value}set variableName(e){this.value=e}get valueType(){return o.VariablePointer}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(e){if(e==this.valueType)return this;throw this.BadCastException(e)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new O(this.variableName,this.contextIndex)}}class g extends m{get isTruthy(){return null===this.value?n("this.value"):this.value.Count>0}get valueType(){return o.List}Cast(e){if(null===this.value)return n("Value.value");if(e==o.Int){let e=this.value.maxItem;return e.Key.isNull?new c(0):new c(e.Value)}if(e==o.Float){let e=this.value.maxItem;return e.Key.isNull?new x(0):new x(e.Value)}if(e==o.String){let e=this.value.maxItem;return e.Key.isNull?new h(""):new h(e.Key.toString())}if(e==this.valueType)return this;throw this.BadCastException(e)}constructor(e,t){super(null),e||t?e instanceof f?this.value=new f(e):e instanceof d&&"number"==typeof t&&(this.value=new f({Key:e,Value:t})):this.value=new f}static RetainListOriginsForAssignment(e,t){let i=s(e,g),o=s(t,g);return o&&null===o.value?n("newList.value"):i&&null===i.value?n("oldList.value"):0[0]}}!function(e){e[e.Bool=-1]="Bool",e[e.Int=0]="Int",e[e.Float=1]="Float",e[e.List=2]="List",e[e.String=3]="String",e[e.DivertTarget=4]="DivertTarget",e[e.VariablePointer=5]="VariablePointer"}(o||(o={}));class U{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof a?this.obj:null}copy(){let e=new U;return e.obj=this.obj,e.approximate=this.approximate,e}}class a extends b{constructor(){super(...arguments),this.name=null,this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return null!=this.name&&this.name.length>0}get content(){return this._content}set content(e){this.AddContent(e)}get namedOnlyContent(){let e=new Map;for(let[t,n]of this.namedContent){let s=u(n,b);e.set(t,s)}for(let n of this.content){let t=R(n);t!=null&&t.hasValidName&&e.delete(t.name)}return 0==e.size&&(e=null),e}set namedOnlyContent(e){let t=this.namedOnlyContent;if(t!=null)for(let[e]of t)this.namedContent.delete(e);if(e!=null)for(let[,n]of e){let t=R(n);t!=null&&this.AddToNamedContentOnly(t)}}get countFlags(){let e=0;return this.visitsShouldBeCounted&&(e|=a.CountFlags.Visits),this.turnIndexShouldBeCounted&&(e|=a.CountFlags.Turns),this.countingAtStartOnly&&(e|=a.CountFlags.CountStartOnly),e==a.CountFlags.CountStartOnly&&(e=0),e}set countFlags(e){let t=e;(t&a.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(t&a.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(t&a.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let t=[],e=this;for(;e instanceof a;)e.content.length>0&&(t.push(new r.Component(0)),e=e.content[0]);return new r(t)}AddContent(e){if(e instanceof Array){let t=e;for(let e of t)this.AddContent(e)}else{let t=e;if(this._content.push(t),t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}}TryAddNamedContent(e){let t=R(e);t!=null&&t.hasValidName&&this.AddToNamedContentOnly(t)}AddToNamedContentOnly(e){if(E.AssertType(e,b,"Can only add Runtime.Objects to a Runtime.Container"),u(e,b).parent=this,null===e.name)return n("namedContentObj.name");this.namedContent.set(e.name,e)}ContentAtPath(e){let r=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0,n=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:-1;-1==n&&(n=e.length);let t=new U;t.approximate=!1;let o=this,i=this;for(let c=r;c<n;++c){let d=e.GetComponent(c);if(o==null){t.approximate=!0;break}let l=o.ContentWithPathComponent(d);if(l==null){t.approximate=!0;break}i=l,o=s(l,a)}return t.obj=i,t}InsertContent(e,t){if(this.content.splice(t,0,e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}AddContentsOfContainer(e){this.content.push(...e.content);for(let t of e.content)t.parent=this,this.TryAddNamedContent(t)}ContentWithPathComponent(e){if(e.isIndex)return e.index>=0&&e.index<this.content.length?this.content[e.index]:null;if(e.isParent)return this.parent;{if(null===e.name)return n("component.name");let t=w(this.namedContent,e.name,null);return t.exists?u(t.result,b):null}}BuildStringOfHierarchy(){let e;if(0==arguments.length)return e=new y,this.BuildStringOfHierarchy(e,0,null),e.toString();e=arguments[0];let t=arguments[1],n=arguments[2];function s(){for(let n=0;n<4*t;++n)e.Append(" ")}s(),e.Append("["),this.hasValidName&&e.AppendFormat(" ({0})",this.name),this==n&&e.Append("  <---"),e.AppendLine(),t++;for(let i=0;i<this.content.length;++i){let o=this.content[i];o instanceof a?o.BuildStringOfHierarchy(e,t,n):(s(),o instanceof h?(e.Append('"'),e.Append(o.toString().replace(`
`,`\\n`)),e.Append('"')):e.Append(o.toString())),i!=this.content.length-1&&e.Append(","),o instanceof a||o!=n||e.Append("  <---"),e.AppendLine()}let o=new Map;for(let[t,e]of this.namedContent)this.content.indexOf(u(e,b))>=0||o.set(t,e);if(o.size>0){s(),e.AppendLine("-- named: --");for(let[,s]of o)E.AssertType(s,a,"Can only print out named Containers"),s.BuildStringOfHierarchy(e,t,n),e.AppendLine()}t--,s(),e.Append("]")}}!function(e){var t;(t=e.CountFlags||(e.CountFlags={}))[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"}(a||(a={}));class z extends b{toString(){return"Glue"}}class t extends b{get commandType(){return this._commandType}constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:t.CommandType.NotSet;super(),this._commandType=e}Copy(){return new t(this.commandType)}static EvalStart(){return new t(t.CommandType.EvalStart)}static EvalOutput(){return new t(t.CommandType.EvalOutput)}static EvalEnd(){return new t(t.CommandType.EvalEnd)}static Duplicate(){return new t(t.CommandType.Duplicate)}static PopEvaluatedValue(){return new t(t.CommandType.PopEvaluatedValue)}static PopFunction(){return new t(t.CommandType.PopFunction)}static PopTunnel(){return new t(t.CommandType.PopTunnel)}static BeginString(){return new t(t.CommandType.BeginString)}static EndString(){return new t(t.CommandType.EndString)}static NoOp(){return new t(t.CommandType.NoOp)}static ChoiceCount(){return new t(t.CommandType.ChoiceCount)}static Turns(){return new t(t.CommandType.Turns)}static TurnsSince(){return new t(t.CommandType.TurnsSince)}static ReadCount(){return new t(t.CommandType.ReadCount)}static Random(){return new t(t.CommandType.Random)}static SeedRandom(){return new t(t.CommandType.SeedRandom)}static VisitIndex(){return new t(t.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new t(t.CommandType.SequenceShuffleIndex)}static StartThread(){return new t(t.CommandType.StartThread)}static Done(){return new t(t.CommandType.Done)}static End(){return new t(t.CommandType.End)}static ListFromInt(){return new t(t.CommandType.ListFromInt)}static ListRange(){return new t(t.CommandType.ListRange)}static ListRandom(){return new t(t.CommandType.ListRandom)}static BeginTag(){return new t(t.CommandType.BeginTag)}static EndTag(){return new t(t.CommandType.EndTag)}toString(){return"ControlCommand "+this.commandType.toString()}}!function(e){var t;(t=e.CommandType||(e.CommandType={}))[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.ReadCount=13]="ReadCount",t[t.Random=14]="Random",t[t.SeedRandom=15]="SeedRandom",t[t.VisitIndex=16]="VisitIndex",t[t.SequenceShuffleIndex=17]="SequenceShuffleIndex",t[t.StartThread=18]="StartThread",t[t.Done=19]="Done",t[t.End=20]="End",t[t.ListFromInt=21]="ListFromInt",t[t.ListRange=22]="ListRange",t[t.ListRandom=23]="ListRandom",t[t.BeginTag=24]="BeginTag",t[t.EndTag=25]="EndTag",t[t.TOTAL_VALUES=26]="TOTAL_VALUES"}(t||(t={})),function(e){e[e.Tunnel=0]="Tunnel",e[e.Function=1]="Function",e[e.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(l||(l={}));class p{constructor(){this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}get isNull(){return null==this.container}get path(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new r.Component(this.index)):this.container.path}toString(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new p(this.container,this.index)}static StartOf(e){return new p(e,0)}static get Null(){return new p(null,-1)}}class T extends b{get targetPath(){if(null!=this._targetPath&&this._targetPath.isRelative){let e=this.targetPointer.Resolve();e&&(this._targetPath=e.path)}return this._targetPath}set targetPath(e){this._targetPath=e,this._targetPointer=p.Null}get targetPointer(){if(this._targetPointer.isNull){let e=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return n("this._targetPath");if(null===this._targetPath.lastComponent)return n("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===e)return n("targetObj");this._targetPointer.container=e.parent instanceof a?e.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=p.StartOf(e instanceof a?e:null)}return this._targetPointer.copy()}get targetPathString(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)}set targetPathString(e){this.targetPath=e==null?null:new r(e)}get hasVariableTarget(){return null!=this.variableDivertName}constructor(e){super(),this._targetPath=null,this._targetPointer=p.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,0[0]!==e&&(this.pushesToStack=!0,this.stackPushType=e)}Equals(e){let t=e;return t instanceof T&&this.hasVariableTarget==t.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==t.variableDivertName:null===this.targetPath?n("this.targetPath"):this.targetPath.Equals(t.targetPath))}toString(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";{let e=new y,t=this.targetPath.toString();return e.Append("Divert"),this.isConditional&&e.Append("?"),this.pushesToStack&&(this.stackPushType==l.Function?e.Append(" function"):e.Append(" tunnel")),e.Append(" -> "),e.Append(this.targetPathString),e.Append(" ("),e.Append(t),e.Append(")"),e.toString()}}}class V extends b{constructor(){let e=!(arguments.length>0&&0[0]!==arguments[0])||arguments[0];super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=e}get pathOnChoice(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){let e=this.choiceTarget;e&&(this._pathOnChoice=e.path)}return this._pathOnChoice}set pathOnChoice(e){this._pathOnChoice=e}get choiceTarget(){return null===this._pathOnChoice?n("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return null===this.pathOnChoice?n("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(e){this.pathOnChoice=new r(e)}get flags(){let e=0;return this.hasCondition&&(e|=1),this.hasStartContent&&(e|=2),this.hasChoiceOnlyContent&&(e|=4),this.isInvisibleDefault&&(e|=8),this.onceOnly&&(e|=16),e}set flags(e){this.hasCondition=(1&e)>0,this.hasStartContent=(2&e)>0,this.hasChoiceOnlyContent=(4&e)>0,this.isInvisibleDefault=(8&e)>0,this.onceOnly=(16&e)>0}toString(){return null===this.pathOnChoice?n("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}class N extends b{get containerForCount(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(e){this.pathForCount=null===e?null:new r(e)}constructor(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:null;super(),this.pathForCount=null,this.name=e}toString(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}class I extends b{constructor(e,t){super(),this.variableName=e||null,this.isNewDeclaration=!!t,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}}class A extends b{toString(){return"Void"}}class i extends b{static CallWithName(e){return new i(e)}static CallExistsWithName(e){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(e)}get name(){return null===this._name?n("NativeFunctionCall._name"):this._name}set name(e){this._name=e,this._isPrototype||(null===i._nativeFunctions?n("NativeFunctionCall._nativeFunctions"):this._prototype=i._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(e){this._numberOfParameters=e}Call(e){if(this._prototype)return this._prototype.Call(e);if(this.numberOfParameters!=e.length)throw new Error("Unexpected number of parameters");let n=!1;for(let t of e){if(t instanceof A)throw new _('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');t instanceof g&&(n=!0)}if(2==e.length&&n)return this.CallBinaryListOperation(e);let s=this.CoerceValuesToSingleType(e),t=s[0].valueType;return t==o.Int||t==o.Float||t==o.String||t==o.DivertTarget||t==o.List?this.CallType(s):null}CallType(e){let s=u(e[0],m),r=s.valueType,t=s,a=e.length;if(2==a||1==a){if(null===this._operationFuncs)return n("NativeFunctionCall._operationFuncs");let c=this._operationFuncs.get(r);if(!c){const e=o[r];throw new _("Cannot perform operation "+this.name+" on "+e)}if(2==a){let s=u(e[1],m),o=c;if(null===t.value||null===s.value)return n("NativeFunctionCall.Call BinaryOp values");let i=o(t.value,s.value);return m.Create(i)}{let a=c;if(null===t.value)return n("NativeFunctionCall.Call UnaryOp value");let e=a(t.value);return this.name===i.Int?m.Create(e,o.Int):this.name===i.Float?m.Create(e,o.Float):m.Create(e,s.valueType)}}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+e.length)}CallBinaryListOperation(e){if(("+"==this.name||"-"==this.name)&&e[0]instanceof g&&e[1]instanceof c)return this.CallListIncrementOperation(e);let t=u(e[0],m),s=u(e[1],m);if(!("&&"!=this.name&&"||"!=this.name||t.valueType==o.List&&s.valueType==o.List)){if(null===this._operationFuncs)return n("NativeFunctionCall._operationFuncs");let e=this._operationFuncs.get(o.Int);if(null===e)return n("NativeFunctionCall.CallBinaryListOperation op");let i=function(e){if("boolean"==typeof e)return e;throw new Error("".concat(e," is not a boolean"))}(e(t.isTruthy?1:0,s.isTruthy?1:0));return new M(i)}if(t.valueType==o.List&&s.valueType==o.List)return this.CallType([t,s]);throw new _("Can not call use "+this.name+" operation on "+o[t.valueType]+" and "+o[s.valueType])}CallListIncrementOperation(e){let t=u(e[0],g),s=u(e[1],c),i=new f;if(null===t.value)return n("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[r,c]of t.value){let l=d.fromSerializedKey(r);if(null===this._operationFuncs)return n("NativeFunctionCall._operationFuncs");let u=this._operationFuncs.get(o.Int);if(null===s.value)return n("NativeFunctionCall.CallListIncrementOperation intVal.value");let a=u(c,s.value),e=null;if(null===t.value.origins)return n("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let n of t.value.origins)if(n.name==l.originName){e=n;break}if(e!=null){let t=e.TryGetItemWithValue(a,d.Null);t.exists&&i.Add(t.result,a)}}return new g(i)}CoerceValuesToSingleType(e){let i=o.Int,t=null;for(let a of e){let n=u(a,m);n.valueType>i&&(i=n.valueType),n.valueType==o.List&&(t=s(n,g))}let a=[];if(o[i]==o[o.List])for(let i of e){let s=u(i,m);if(s.valueType==o.List)a.push(s);else{if(s.valueType!=o.Int){const e=o[s.valueType];throw new _("Cannot mix Lists and "+e+" values in this operation")}{let e=parseInt(s.valueObject);if(t=u(t,g),null===t.value)return n("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");let o=t.value.originOfMaxItem;if(null===o)return n("NativeFunctionCall.CoerceValuesToSingleType list");let i=o.TryGetItemWithValue(e,d.Null);if(!i.exists)throw new _("Could not find List item with the value "+e+" in "+o.name);{let t=new g(i.result,e);a.push(t)}}}}else for(let t of e){let n=u(t,m).Cast(i);a.push(n)}return a}constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,0===arguments.length)i.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){let e=arguments[0];i.GenerateNativeFunctionsIfNecessary(),this.name=e}else if(2===arguments.length){let e=arguments[0],t=arguments[1];this._isPrototype=!0,this.name=e,this.numberOfParameters=t}}static Identity(e){return e}static GenerateNativeFunctionsIfNecessary(){if(null==this._nativeFunctions){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(e,t)=>e+t),this.AddIntBinaryOp(this.Subtract,(e,t)=>e-t),this.AddIntBinaryOp(this.Multiply,(e,t)=>e*t),this.AddIntBinaryOp(this.Divide,(e,t)=>Math.floor(e/t)),this.AddIntBinaryOp(this.Mod,(e,t)=>e%t),this.AddIntUnaryOp(this.Negate,e=>-e),this.AddIntBinaryOp(this.Equal,(e,t)=>e==t),this.AddIntBinaryOp(this.Greater,(e,t)=>e>t),this.AddIntBinaryOp(this.Less,(e,t)=>e<t),this.AddIntBinaryOp(this.GreaterThanOrEquals,(e,t)=>e>=t),this.AddIntBinaryOp(this.LessThanOrEquals,(e,t)=>e<=t),this.AddIntBinaryOp(this.NotEquals,(e,t)=>e!=t),this.AddIntUnaryOp(this.Not,e=>0==e),this.AddIntBinaryOp(this.And,(e,t)=>0!=e&&0!=t),this.AddIntBinaryOp(this.Or,(e,t)=>0!=e||0!=t),this.AddIntBinaryOp(this.Max,(e,t)=>Math.max(e,t)),this.AddIntBinaryOp(this.Min,(e,t)=>Math.min(e,t)),this.AddIntBinaryOp(this.Pow,(e,t)=>e**t),this.AddIntUnaryOp(this.Floor,i.Identity),this.AddIntUnaryOp(this.Ceiling,i.Identity),this.AddIntUnaryOp(this.Int,i.Identity),this.AddIntUnaryOp(this.Float,e=>e),this.AddFloatBinaryOp(this.Add,(e,t)=>e+t),this.AddFloatBinaryOp(this.Subtract,(e,t)=>e-t),this.AddFloatBinaryOp(this.Multiply,(e,t)=>e*t),this.AddFloatBinaryOp(this.Divide,(e,t)=>e/t),this.AddFloatBinaryOp(this.Mod,(e,t)=>e%t),this.AddFloatUnaryOp(this.Negate,e=>-e),this.AddFloatBinaryOp(this.Equal,(e,t)=>e==t),this.AddFloatBinaryOp(this.Greater,(e,t)=>e>t),this.AddFloatBinaryOp(this.Less,(e,t)=>e<t),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(e,t)=>e>=t),this.AddFloatBinaryOp(this.LessThanOrEquals,(e,t)=>e<=t),this.AddFloatBinaryOp(this.NotEquals,(e,t)=>e!=t),this.AddFloatUnaryOp(this.Not,e=>0==e),this.AddFloatBinaryOp(this.And,(e,t)=>0!=e&&0!=t),this.AddFloatBinaryOp(this.Or,(e,t)=>0!=e||0!=t),this.AddFloatBinaryOp(this.Max,(e,t)=>Math.max(e,t)),this.AddFloatBinaryOp(this.Min,(e,t)=>Math.min(e,t)),this.AddFloatBinaryOp(this.Pow,(e,t)=>e**t),this.AddFloatUnaryOp(this.Floor,e=>Math.floor(e)),this.AddFloatUnaryOp(this.Ceiling,e=>Math.ceil(e)),this.AddFloatUnaryOp(this.Int,e=>Math.floor(e)),this.AddFloatUnaryOp(this.Float,i.Identity),this.AddStringBinaryOp(this.Add,(e,t)=>e+t),this.AddStringBinaryOp(this.Equal,(e,t)=>e===t),this.AddStringBinaryOp(this.NotEquals,(e,t)=>e!==t),this.AddStringBinaryOp(this.Has,(e,t)=>e.includes(t)),this.AddStringBinaryOp(this.Hasnt,(e,t)=>!e.includes(t)),this.AddListBinaryOp(this.Add,(e,t)=>e.Union(t)),this.AddListBinaryOp(this.Subtract,(e,t)=>e.Without(t)),this.AddListBinaryOp(this.Has,(e,t)=>e.Contains(t)),this.AddListBinaryOp(this.Hasnt,(e,t)=>!e.Contains(t)),this.AddListBinaryOp(this.Intersect,(e,t)=>e.Intersect(t)),this.AddListBinaryOp(this.Equal,(e,t)=>e.Equals(t)),this.AddListBinaryOp(this.Greater,(e,t)=>e.GreaterThan(t)),this.AddListBinaryOp(this.Less,(e,t)=>e.LessThan(t)),this.AddListBinaryOp(this.GreaterThanOrEquals,(e,t)=>e.GreaterThanOrEquals(t)),this.AddListBinaryOp(this.LessThanOrEquals,(e,t)=>e.LessThanOrEquals(t)),this.AddListBinaryOp(this.NotEquals,(e,t)=>!e.Equals(t)),this.AddListBinaryOp(this.And,(e,t)=>e.Count>0&&t.Count>0),this.AddListBinaryOp(this.Or,(e,t)=>e.Count>0||t.Count>0),this.AddListUnaryOp(this.Not,e=>0==e.Count?1:0),this.AddListUnaryOp(this.Invert,e=>e.inverse),this.AddListUnaryOp(this.All,e=>e.all),this.AddListUnaryOp(this.ListMin,e=>e.MinAsList()),this.AddListUnaryOp(this.ListMax,e=>e.MaxAsList()),this.AddListUnaryOp(this.Count,e=>e.Count),this.AddListUnaryOp(this.ValueOfList,e=>e.maxItem.Value);let e=(e,t)=>e.Equals(t),t=(e,t)=>!e.Equals(t);this.AddOpToNativeFunc(this.Equal,2,o.DivertTarget,e),this.AddOpToNativeFunc(this.NotEquals,2,o.DivertTarget,t)}}AddOpFuncForType(e,t){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(e,t)}static AddOpToNativeFunc(e,t,s,o){if(null===this._nativeFunctions)return n("NativeFunctionCall._nativeFunctions");let a=this._nativeFunctions.get(e);a||(a=new i(e,t),this._nativeFunctions.set(e,a)),a.AddOpFuncForType(s,o)}static AddIntBinaryOp(e,t){this.AddOpToNativeFunc(e,2,o.Int,t)}static AddIntUnaryOp(e,t){this.AddOpToNativeFunc(e,1,o.Int,t)}static AddFloatBinaryOp(e,t){this.AddOpToNativeFunc(e,2,o.Float,t)}static AddFloatUnaryOp(e,t){this.AddOpToNativeFunc(e,1,o.Float,t)}static AddStringBinaryOp(e,t){this.AddOpToNativeFunc(e,2,o.String,t)}static AddListBinaryOp(e,t){this.AddOpToNativeFunc(e,2,o.List,t)}static AddListUnaryOp(e,t){this.AddOpToNativeFunc(e,1,o.List,t)}toString(){return'Native "'+this.name+'"'}}i.Add="+",i.Subtract="-",i.Divide="/",i.Multiply="*",i.Mod="%",i.Negate="_",i.Equal="==",i.Greater=">",i.Less="<",i.GreaterThanOrEquals=">=",i.LessThanOrEquals="<=",i.NotEquals="!=",i.Not="!",i.And="&&",i.Or="||",i.Min="MIN",i.Max="MAX",i.Pow="POW",i.Floor="FLOOR",i.Ceiling="CEILING",i.Int="INT",i.Float="FLOAT",i.Has="?",i.Hasnt="!?",i.Intersect="^",i.ListMin="LIST_MIN",i.ListMax="LIST_MAX",i.All="LIST_ALL",i.Count="LIST_COUNT",i.ValueOfList="LIST_VALUE",i.Invert="LIST_INVERT",i._nativeFunctions=null;class F extends b{constructor(e){super(),this.text=e.toString()||""}toString(){return"# "+this.text}}class $ extends b{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.tags=null,this.originalThreadIndex=0}get pathStringOnChoice(){return null===this.targetPath?n("Choice.targetPath"):this.targetPath.toString()}set pathStringOnChoice(e){this.targetPath=new r(e)}}class Z{constructor(e,t){this._name=e||"",this._items=null,this._itemNameToValues=t||new Map}get name(){return this._name}get items(){if(null==this._items){this._items=new Map;for(let[e,t]of this._itemNameToValues){let n=new d(this.name,e);this._items.set(n.serialized(),t)}}return this._items}ValueForItem(e){if(!e.itemName)return 0;let t=this._itemNameToValues.get(e.itemName);return 0[0]!==t?t:0}ContainsItem(e){return!!e.itemName&&e.originName==this.name&&this._itemNameToValues.has(e.itemName)}ContainsItemWithName(e){return this._itemNameToValues.has(e)}TryGetItemWithValue(e){for(let[t,n]of this._itemNameToValues)if(n==e)return{result:new d(this.name,t),exists:!0};return{result:d.Null,exists:!1}}TryGetValueForItem(e){if(!e.itemName)return{result:0,exists:!1};let n=this._itemNameToValues.get(e.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}}class q{constructor(e){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(let t of e){this._lists.set(t.name,t);for(let[s,o]of t.items){let e=d.fromSerializedKey(s),n=new g(e,o);if(!e.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(e.itemName,n),this._allUnambiguousListValueCache.set(e.fullName,n)}}}get lists(){let e=[];for(let[,t]of this._lists)e.push(t);return e}TryListGetDefinition(e,t){if(null===e)return{result:t,exists:!1};let n=this._lists.get(e);return n?{result:n,exists:!0}:{result:t,exists:!1}}FindSingleItemListWithName(e){if(null===e)return n("name");let t=this._allUnambiguousListValueCache.get(e);return 0[0]!==t?t:null}}class v{static JArrayToRuntimeObjList(e){let o=arguments.length>1&&0[0]!==arguments[1]&&arguments[1],t=e.length;o&&t--;let s=[];for(let o=0;o<t;o++){let a=e[o],i=this.JTokenToRuntimeObject(a);if(null===i)return n("runtimeObj");s.push(i)}return s}static WriteDictionaryRuntimeObjs(e,t){e.WriteObjectStart();for(let[n,s]of t)e.WritePropertyStart(n),this.WriteRuntimeObject(e,s),e.WritePropertyEnd();e.WriteObjectEnd()}static WriteListRuntimeObjs(e,t){e.WriteArrayStart();for(let n of t)this.WriteRuntimeObject(e,n);e.WriteArrayEnd()}static WriteIntDictionary(e,t){e.WriteObjectStart();for(let[n,s]of t)e.WriteIntProperty(n,s);e.WriteObjectEnd()}static WriteRuntimeObject(e,o){let E=s(o,a);if(E)return void this.WriteRuntimeContainer(e,E);let r=s(o,T);if(r){let n,t="->";return r.isExternal?t="x()":r.pushesToStack&&(r.stackPushType==l.Function?t="f()":r.stackPushType==l.Tunnel&&(t="->t->")),n=r.hasVariableTarget?r.variableDivertName:r.targetPathString,e.WriteObjectStart(),e.WriteProperty(t,n),r.hasVariableTarget&&e.WriteProperty("var",!0),r.isConditional&&e.WriteProperty("c",!0),r.externalArgs>0&&e.WriteIntProperty("exArgs",r.externalArgs),void e.WriteObjectEnd()}let f=s(o,V);if(f)return e.WriteObjectStart(),e.WriteProperty("*",f.pathStringOnChoice),e.WriteIntProperty("flg",f.flags),void e.WriteObjectEnd();let _=s(o,M);if(_)return void e.WriteBool(_.value);let S=s(o,c);if(S)return void e.WriteInt(S.value);let y=s(o,x);if(y)return void e.WriteFloat(y.value);let b=s(o,h);if(b)return void(b.isNewline?e.Write(`
`,!1):(e.WriteStringStart(),e.WriteStringInner("^"),e.WriteStringInner(b.value),e.WriteStringEnd()));let j=s(o,g);if(j)return void this.WriteInkList(e,j);let p=s(o,k);if(p)return e.WriteObjectStart(),null===p.value?n("divTargetVal.value"):(e.WriteProperty("^->",p.value.componentsString),void e.WriteObjectEnd());let m=s(o,O);if(m)return e.WriteObjectStart(),e.WriteProperty("^var",m.value),e.WriteIntProperty("ci",m.contextIndex),void e.WriteObjectEnd();if(s(o,z))return void e.Write("<>");let w=s(o,t);if(w)return void e.Write(v._controlCommandNames[w.commandType]);let C=s(o,i);if(C){let t=C.name;return"^"==t&&(t="L^"),void e.Write(t)}let u=s(o,N);if(u){e.WriteObjectStart();let t=u.pathStringForCount;return t!=null?e.WriteProperty("CNT?",t):e.WriteProperty("VAR?",u.name),void e.WriteObjectEnd()}let d=s(o,I);if(d){e.WriteObjectStart();let t=d.isGlobal?"VAR=":"temp=";return e.WriteProperty(t,d.variableName),d.isNewDeclaration||e.WriteProperty("re",!0),void e.WriteObjectEnd()}if(s(o,A))return void e.Write("void");let D=s(o,F);if(D)return e.WriteObjectStart(),e.WriteProperty("#",D.text),void e.WriteObjectEnd();let L=s(o,$);if(!L)throw new Error("Failed to convert runtime object to Json token: "+o);this.WriteChoice(e,L)}static JObjectToDictionaryRuntimeObjs(e){let t=new Map;for(let s in e)if(e.hasOwnProperty(s)){let o=this.JTokenToRuntimeObject(e[s]);if(null===o)return n("inkObject");t.set(s,o)}return t}static JObjectToIntDictionary(e){let t=new Map;for(let n in e)e.hasOwnProperty(n)&&t.set(n,parseInt(e[n]));return t}static JTokenToRuntimeObject(e){if("number"==typeof e&&!(e!=e)||"boolean"==typeof e)return m.Create(e);if("string"==typeof e){let n=e.toString(),s=n[0];if("^"==s)return new h(n.substring(1));if(`
`==s&&1==n.length)return new h(`
`);if("<>"==n)return new z;for(let e=0;e<v._controlCommandNames.length;++e)if(n==v._controlCommandNames[e])return new t(e);if("L^"==n&&(n="^"),i.CallExistsWithName(n))return i.CallWithName(n);if("->->"==n)return t.PopTunnel();if("~ret"==n)return t.PopFunction();if("void"==n)return new A}if("object"==typeof e&&!Array.isArray(e)){let t,n=e;if(n["^->"])return t=n["^->"],new k(new r(t.toString()));if(n["^var"]){t=n["^var"];let e=new O(t.toString());return"ci"in n&&(t=n.ci,e.contextIndex=parseInt(t)),e}let s=!1,o=!1,i=l.Function,a=!1;if((t=n["->"])?s=!0:(t=n["f()"])?(s=!0,o=!0,i=l.Function):(t=n["->t->"])?(s=!0,o=!0,i=l.Tunnel):(t=n["x()"])&&(s=!0,a=!0,o=!1,i=l.Function),s){let e=new T;e.pushesToStack=o,e.stackPushType=i,e.isExternal=a;let s=t.toString();return(t=n.var)?e.variableDivertName=s:e.targetPathString=s,e.isConditional=!!n.c,a&&(t=n.exArgs)&&(e.externalArgs=parseInt(t)),e}if(t=n["*"]){let e=new V;return e.pathStringOnChoice=t.toString(),(t=n.flg)&&(e.flags=parseInt(t)),e}if(t=n["VAR?"])return new N(t.toString());if(t=n["CNT?"]){let e=new N;return e.pathStringForCount=t.toString(),e}let c=!1,u=!1;if((t=n["VAR="])?(c=!0,u=!0):(t=n["temp="])&&(c=!0,u=!1),c){let s=t.toString(),o=!n.re,e=new I(s,o);return e.isGlobal=u,e}if(0[0]!==n["#"])return t=n["#"],new F(t.toString());if(t=n.list){let e=t,s=new f;if(t=n.origins){let e=t;s.SetInitialOriginNames(e)}for(let t in e)if(e.hasOwnProperty(t)){let n=e[t],o=new d(t),i=parseInt(n);s.Add(o,i)}return new g(s)}if(null!=n.originalChoicePath)return this.JObjectToChoice(n)}if(Array.isArray(e))return this.JArrayToContainer(e);if(e==null)return null;throw new Error("Failed to convert token to runtime object: "+this.toJson(e,["parent"]))}static toJson(e,t,n){return JSON.stringify(e,(e,n)=>t?.some(t=>t===e)?0[0]:n,n)}static WriteRuntimeContainer(e,t){let l=arguments.length>2&&0[0]!==arguments[2]&&arguments[2];if(e.WriteArrayStart(),null===t)return n("container");for(let n of t.content)this.WriteRuntimeObject(e,n);let o=t.namedOnlyContent,i=t.countFlags,r=null!=t.name&&!l,c=o!=null||i>0||r;if(c&&e.WriteObjectStart(),o!=null)for(let[t,n]of o){let i=t,r=s(n,a);e.WritePropertyStart(i),this.WriteRuntimeContainer(e,r,!0),e.WritePropertyEnd()}i>0&&e.WriteIntProperty("#f",i),r&&e.WriteProperty("#n",t.name),c?e.WriteObjectEnd():e.WriteNull(),e.WriteArrayEnd()}static JArrayToContainer(e){let t=new a;t.content=this.JArrayToRuntimeObjList(e,!0);let n=e[e.length-1];if(n!=null){let e=new Map;for(let o in n)if("#f"==o)t.countFlags=parseInt(n[o]);else if("#n"==o)t.name=n[o].toString();else{let t=this.JTokenToRuntimeObject(n[o]),i=s(t,a);i&&(i.name=o),e.set(o,t)}t.namedOnlyContent=e}return t}static JObjectToChoice(e){let t=new $;return t.text=e.text.toString(),t.index=parseInt(e.index),t.sourcePath=e.originalChoicePath.toString(),t.originalThreadIndex=parseInt(e.originalThreadIndex),t.pathStringOnChoice=e.targetPath.toString(),e.tags&&(t.tags=e.tags),t}static WriteChoice(e,t){e.WriteObjectStart(),e.WriteProperty("text",t.text),e.WriteIntProperty("index",t.index),e.WriteProperty("originalChoicePath",t.sourcePath),e.WriteIntProperty("originalThreadIndex",t.originalThreadIndex),e.WriteProperty("targetPath",t.pathStringOnChoice),t.tags&&e.WriteProperty("tags",e=>{e.WriteArrayStart();for(const n of t.tags)e.WriteStringStart(),e.WriteStringInner(n),e.WriteStringEnd();e.WriteArrayEnd()}),e.WriteObjectEnd()}static WriteInkList(e,t){let s=t.value;if(null===s)return n("rawList");e.WriteObjectStart(),e.WritePropertyStart("list"),e.WriteObjectStart();for(let[o,i]of s){let t=d.fromSerializedKey(o),a=i;if(null===t.itemName)return n("item.itemName");e.WritePropertyNameStart(),e.WritePropertyNameInner(t.originName?t.originName:"?"),e.WritePropertyNameInner("."),e.WritePropertyNameInner(t.itemName),e.WritePropertyNameEnd(),e.Write(a),e.WritePropertyEnd()}if(e.WriteObjectEnd(),e.WritePropertyEnd(),0==s.Count&&null!=s.originNames&&s.originNames.length>0){e.WritePropertyStart("origins"),e.WriteArrayStart();for(let t of s.originNames)e.Write(t);e.WriteArrayEnd(),e.WritePropertyEnd()}e.WriteObjectEnd()}static ListDefinitionsToJToken(e){let t={};for(let s of e.lists){let o={};for(let[t,i]of s.items){let e=d.fromSerializedKey(t);if(null===e.itemName)return n("item.itemName");o[e.itemName]=i}t[s.name]=o}return t}static JTokenToListDefinitions(e){let t=e,n=[];for(let e in t)if(t.hasOwnProperty(e)){let i=e.toString(),s=t[e],o=new Map;for(let n in s)if(t.hasOwnProperty(e)){let e=s[n];o.set(n,parseInt(e))}let a=new Z(i,o);n.push(a)}return new q(n)}}v._controlCommandNames=(()=>{let e=[];e[t.CommandType.EvalStart]="ev",e[t.CommandType.EvalOutput]="out",e[t.CommandType.EvalEnd]="/ev",e[t.CommandType.Duplicate]="du",e[t.CommandType.PopEvaluatedValue]="pop",e[t.CommandType.PopFunction]="~ret",e[t.CommandType.PopTunnel]="->->",e[t.CommandType.BeginString]="str",e[t.CommandType.EndString]="/str",e[t.CommandType.NoOp]="nop",e[t.CommandType.ChoiceCount]="choiceCnt",e[t.CommandType.Turns]="turn",e[t.CommandType.TurnsSince]="turns",e[t.CommandType.ReadCount]="readc",e[t.CommandType.Random]="rnd",e[t.CommandType.SeedRandom]="srnd",e[t.CommandType.VisitIndex]="visit",e[t.CommandType.SequenceShuffleIndex]="seq",e[t.CommandType.StartThread]="thread",e[t.CommandType.Done]="done",e[t.CommandType.End]="end",e[t.CommandType.ListFromInt]="listInt",e[t.CommandType.ListRange]="range",e[t.CommandType.ListRandom]="lrnd",e[t.CommandType.BeginTag]="#",e[t.CommandType.EndTag]="/#";for(let n=0;n<t.CommandType.TOTAL_VALUES;++n)if(null==e[n])throw new Error("Control command not accounted for in serialisation");return e})();class C{get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){let e=this._threads[this._threads.length-1].callstack;return e[e.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(e){E.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(e)}get canPop(){return this.callStack.length>1}constructor(){if(this._threadCounter=0,this._startOfRoot=p.Null,arguments[0]instanceof j){let e=arguments[0];this._startOfRoot=p.StartOf(e.rootContentContainer),this.Reset()}else{let e=arguments[0];this._threads=[];for(let t of e._threads)this._threads.push(t.Copy());this._threadCounter=e._threadCounter,this._startOfRoot=e._startOfRoot.copy()}}Reset(){this._threads=[],this._threads.push(new C.Thread),this._threads[0].callstack.push(new C.Element(l.Tunnel,this._startOfRoot))}SetJsonToken(e,t){this._threads.length=0;let n=e.threads;for(let e of n){let s=e,o=new C.Thread(s,t);this._threads.push(o)}this._threadCounter=parseInt(e.threadCounter),this._startOfRoot=p.StartOf(t.rootContentContainer)}WriteJson(e){e.WriteObject(e=>{e.WritePropertyStart("threads"),e.WriteArrayStart();for(let t of this._threads)t.WriteJson(e);e.WriteArrayEnd(),e.WritePropertyEnd(),e.WritePropertyStart("threadCounter"),e.WriteInt(this._threadCounter),e.WritePropertyEnd()})}PushThread(){let e=this.currentThread.Copy();this._threadCounter++,e.threadIndex=this._threadCounter,this._threads.push(e)}ForkThread(){let e=this.currentThread.Copy();return this._threadCounter++,e.threadIndex=this._threadCounter,e}PopThread(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==l.FunctionEvaluationFromGame}Push(e){let n=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:0,s=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:0,t=new C.Element(e,this.currentElement.currentPointer,!1);t.evaluationStackHeightWhenPushed=n,t.functionStartInOutputStream=s,this.callStack.push(t)}CanPop(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:null;return!!this.canPop&&(e==null||this.currentElement.type==e)}Pop(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:null;if(!this.CanPop(e))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:-1;-1==t&&(t=this.currentElementIndex+1);let n=w(this.callStack[t-1].temporaryVariables,e,null);return n.exists?n.result:null}SetTemporaryVariable(e,t,n){let s=arguments.length>3&&0[0]!==arguments[3]?arguments[3]:-1;-1==s&&(s=this.currentElementIndex+1);let o=this.callStack[s-1];if(!n&&!o.temporaryVariables.get(e))throw new Error("Could not find temporary variable to set: "+e);let i=w(o.temporaryVariables,e,null);i.exists&&g.RetainListOriginsForAssignment(i.result,t),o.temporaryVariables.set(e,t)}ContextForVariableNamed(e){return this.currentElement.temporaryVariables.get(e)?this.currentElementIndex+1:0}ThreadWithIndex(e){let t=this._threads.filter(t=>{if(t.threadIndex==e)return t});return t.length>0?t[0]:null}get callStack(){return this.currentThread.callstack}get callStackTrace(){let e=new y;for(let t=0;t<this._threads.length;t++){let s=this._threads[t],o=t==this._threads.length-1;e.AppendFormat(`=== THREAD {0}/{1} {2}===
`,t+1,this._threads.length,o?"(current) ":"");for(let t=0;t<s.callstack.length;t++){s.callstack[t].type==l.Function?e.Append("  [FUNCTION] "):e.Append("  [TUNNEL] ");let o=s.callstack[t].currentPointer;if(!o.isNull){if(e.Append("<SOMEWHERE IN "),null===o.container)return n("pointer.container");e.Append(o.container.path.toString()),e.AppendLine(">")}}}return e.toString()}}!function(e){class t{constructor(e,t){let n=arguments.length>2&&0[0]!==arguments[2]&&arguments[2];this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=t.copy(),this.inExpressionEvaluation=n,this.temporaryVariables=new Map,this.type=e}Copy(){let e=new t(this.type,this.currentPointer,this.inExpressionEvaluation);return e.temporaryVariables=new Map(this.temporaryVariables),e.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,e.functionStartInOutputStream=this.functionStartInOutputStream,e}}e.Element=t;class s{constructor(){if(this.threadIndex=0,this.previousPointer=p.Null,this.callstack=[],arguments[0]&&arguments[1]){let e=arguments[0],s=arguments[1];this.threadIndex=parseInt(e.threadIndex);let i=e.callstack;for(let u of i){let a,e=u,h=parseInt(e.type),o=p.Null,l=e.cPath;if(0[0]!==l){a=l.toString();let t=s.ContentAtPath(new r(a));if(o.container=t.container,o.index=parseInt(e.idx),null==t.obj)throw new Error("When loading state, internal story location couldn't be found: "+a+". Has the story changed since this save data was created?");if(t.approximate){if(null===o.container)return n("pointer.container");s.Warning("When loading state, exact internal story location couldn't be found: '"+a+"', so it was approximated to '"+o.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}let m=!!e.exp,c=new t(h,o,m),d=e.temp;0[0]!==d?c.temporaryVariables=v.JObjectToDictionaryRuntimeObjs(d):c.temporaryVariables.clear(),this.callstack.push(c)}let o=e.previousContentObject;if(0[0]!==o){let e=new r(o.toString());this.previousPointer=s.PointerAtPath(e)}}}Copy(){let e=new s;e.threadIndex=this.threadIndex;for(let t of this.callstack)e.callstack.push(t.Copy());return e.previousPointer=this.previousPointer.copy(),e}WriteJson(e){e.WriteObjectStart(),e.WritePropertyStart("callstack"),e.WriteArrayStart();for(let t of this.callstack){if(e.WriteObjectStart(),!t.currentPointer.isNull){if(null===t.currentPointer.container)return n("el.currentPointer.container");e.WriteProperty("cPath",t.currentPointer.container.path.componentsString),e.WriteIntProperty("idx",t.currentPointer.index)}e.WriteProperty("exp",t.inExpressionEvaluation),e.WriteIntProperty("type",t.type),t.temporaryVariables.size>0&&(e.WritePropertyStart("temp"),v.WriteDictionaryRuntimeObjs(e,t.temporaryVariables),e.WritePropertyEnd()),e.WriteObjectEnd()}if(e.WriteArrayEnd(),e.WritePropertyEnd(),e.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){let t=this.previousPointer.Resolve();if(null===t)return n("this.previousPointer.Resolve()");e.WriteProperty("previousContentObject",t.path.toString())}e.WriteObjectEnd()}}e.Thread=s}(C||(C={}));class H extends class{}{variableChangedEvent(e,t){for(let n of this.variableChangedEventCallbacks)n(e,t)}get batchObservingVariableChanges(){return this._batchObservingVariableChanges}set batchObservingVariableChanges(e){if(this._batchObservingVariableChanges=e,e)this._changedVariablesForBatchObs=new Set;else if(null!=this._changedVariablesForBatchObs){for(let e of this._changedVariablesForBatchObs){let t=this._globalVariables.get(e);t?this.variableChangedEvent(e,t):n("currentValue")}this._changedVariablesForBatchObs=null}}get callStack(){return this._callStack}set callStack(e){this._callStack=e}$(e,t){if(0[0]===t){let t=null;return null!==this.patch&&(t=this.patch.TryGetGlobal(e,null),t.exists)?t.result.valueObject:(t=this._globalVariables.get(e),0[0]===t&&(t=this._defaultGlobalVariables.get(e)),0[0]!==t?t.valueObject:null)}{if(0[0]===this._defaultGlobalVariables.get(e))throw new _("Cannot assign to a variable ("+e+") that hasn't been declared in the story");let n=m.Create(t);if(n==null)throw t==null?new Error("Cannot pass null to VariableState"):new Error("Invalid value passed to VariableState: "+t.toString());this.SetGlobal(e,n)}}constructor(e,t){super(),this.variableChangedEventCallbacks=[],this.patch=null,this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._globalVariables=new Map,this._callStack=e,this._listDefsOrigin=t;try{return new Proxy(this,{get:(e,t)=>t in e?e[t]:e.$(t),set:(e,t,n)=>(t in e?e[t]=n:e.$(t,n),!0)})}catch{}}ApplyPatch(){if(null===this.patch)return n("this.patch");for(let[e,t]of this.patch.globals)this._globalVariables.set(e,t);if(null!==this._changedVariablesForBatchObs)for(let e of this.patch.changedVariables)this._changedVariablesForBatchObs.add(e);this.patch=null}SetJsonToken(e){this._globalVariables.clear();for(let[t,o]of this._defaultGlobalVariables){let s=e[t];if(0[0]!==s){let e=v.JTokenToRuntimeObject(s);if(null===e)return n("tokenInkObject");this._globalVariables.set(t,e)}else this._globalVariables.set(t,o)}}WriteJson(e){e.WriteObjectStart();for(let[s,o]of this._globalVariables){let t=s,n=o;if(H.dontSaveDefaultValues&&this._defaultGlobalVariables.has(t)){let e=this._defaultGlobalVariables.get(t);if(this.RuntimeObjectsEqual(n,e))continue}e.WritePropertyStart(t),v.WriteRuntimeObject(e,n),e.WritePropertyEnd()}e.WriteObjectEnd()}RuntimeObjectsEqual(e,t){if(null===e)return n("obj1");if(null===t)return n("obj2");if(e.constructor!==t.constructor)return!1;let a=s(e,M);if(null!==a)return a.value===u(t,M).value;let r=s(e,c);if(null!==r)return r.value===u(t,c).value;let l=s(e,x);if(null!==l)return l.value===u(t,x).value;let o=s(e,m),i=s(t,m);if(null!==o&&null!==i)return W(o.valueObject)&&W(i.valueObject)?o.valueObject.Equals(i.valueObject):o.valueObject===i.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+e.constructor.name)}GetVariableWithName(e){let o=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:-1,t=this.GetRawVariableWithName(e,o),n=s(t,O);return null!==n&&(t=this.ValueAtVariablePointer(n)),t}TryGetDefaultVariableValue(e){let t=w(this._defaultGlobalVariables,e,null);return t.exists?t.result:null}GlobalVariableExistsWithName(e){return this._globalVariables.has(e)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(e)}GetRawVariableWithName(e,t){let s=null;if(0==t||-1==t){let t=null;if(null!==this.patch&&(t=this.patch.TryGetGlobal(e,null),t.exists))return t.result;if(t=w(this._globalVariables,e,null),t.exists)return t.result;if(null!==this._defaultGlobalVariables&&(t=w(this._defaultGlobalVariables,e,null),t.exists))return t.result;if(null===this._listDefsOrigin)return n("VariablesState._listDefsOrigin");let s=this._listDefsOrigin.FindSingleItemListWithName(e);if(s)return s}return s=this._callStack.GetTemporaryVariableWithName(e,t),s}ValueAtVariablePointer(e){return this.GetVariableWithName(e.variableName,e.contextIndex)}Assign(e,t){let o=e.variableName;if(null===o)return n("name");let i=-1,a=!1;if(a=e.isNewDeclaration?e.isGlobal:this.GlobalVariableExistsWithName(o),e.isNewDeclaration){let e=s(t,O);null!==e&&(t=this.ResolveVariablePointer(e))}else{let e=null;do e=s(this.GetRawVariableWithName(o,i),O),e!=null&&(o=e.variableName,i=e.contextIndex,a=0==i);while(e!=null)}a?this.SetGlobal(o,t):this._callStack.SetTemporaryVariable(o,t,e.isNewDeclaration,i)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(e,t){let s=u(e,g),n=u(t,g);s.value&&n.value&&0==n.value.Count&&n.value.SetInitialOriginNames(s.value.originNames)}SetGlobal(e,t){let s=null;if(null===this.patch&&(s=w(this._globalVariables,e,null)),null!==this.patch&&(s=this.patch.TryGetGlobal(e,null),s.exists||(s=w(this._globalVariables,e,null))),g.RetainListOriginsForAssignment(s.result,t),null===e)return n("variableName");if(null!==this.patch?this.patch.SetGlobal(e,t):this._globalVariables.set(e,t),null!==this.variableChangedEvent&&null!==s&&t!==s.result)if(this.batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return n("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(e):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(e)}else this.variableChangedEvent(e,t)}ResolveVariablePointer(e){let t=e.contextIndex;-1==t&&(t=this.GetContextIndexOfVariableNamed(e.variableName));let n=s(this.GetRawVariableWithName(e.variableName,t),O);return n??new O(e.variableName,t)}GetContextIndexOfVariableNamed(e){return this.GlobalVariableExistsWithName(e)?0:this._callStack.currentElementIndex}ObserveVariableChange(e){this.variableChangedEventCallbacks.push(e)}}H.dontSaveDefaultValues=!0;class D{constructor(e){this.seed=e%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=48271*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}}class X{get globals(){return this._globals}get changedVariables(){return this._changedVariables}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}constructor(){if(this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]){let e=arguments[0];this._globals=new Map(e._globals),this._changedVariables=new Set(e._changedVariables),this._visitCounts=new Map(e._visitCounts),this._turnIndices=new Map(e._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}TryGetGlobal(e,t){return null!==e&&this._globals.has(e)?{result:this._globals.get(e),exists:!0}:{result:t,exists:!1}}SetGlobal(e,t){this._globals.set(e,t)}AddChangedVariable(e){return this._changedVariables.add(e)}TryGetVisitCount(e,t){return this._visitCounts.has(e)?{result:this._visitCounts.get(e),exists:!0}:{result:t,exists:!1}}SetVisitCount(e,t){this._visitCounts.set(e,t)}SetTurnIndex(e,t){this._turnIndices.set(e,t)}TryGetTurnIndex(e,t){return this._turnIndices.has(e)?{result:this._turnIndices.get(e),exists:!0}:{result:t,exists:!1}}}class S{static TextToDictionary(e){return new S.Reader(e).ToDictionary()}static TextToArray(e){return new S.Reader(e).ToArray()}}!function(e){e.Reader=class{constructor(e){this._rootObject=JSON.parse(e)}ToDictionary(){return this._rootObject}ToArray(){return this._rootObject}};class t{constructor(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}WriteObject(e){this.WriteObjectStart(),e(this),this.WriteObjectEnd()}WriteObjectStart(){this.StartNewObject(!0);let t={};if(this.state===e.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let e=this._propertyNameStack.pop();this.currentCollection[e]=t,this._collectionStack.push(t)}else this.state===e.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(t),this._collectionStack.push(t)):(this.Assert(this.state===e.Writer.State.None),this._jsonObject=t,this._collectionStack.push(t));this._stateStack.push(new e.Writer.StateElement(e.Writer.State.Object))}WriteObjectEnd(){this.Assert(this.state===e.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}WriteProperty(e){if(this.WritePropertyStart(e),arguments[1]instanceof Function)(0,arguments[1])(this);else{let e=arguments[1];this.Write(e)}this.WritePropertyEnd()}WriteIntProperty(e,t){this.WritePropertyStart(e),this.WriteInt(t),this.WritePropertyEnd()}WriteFloatProperty(e,t){this.WritePropertyStart(e),this.WriteFloat(t),this.WritePropertyEnd()}WritePropertyStart(t){this.Assert(this.state===e.Writer.State.Object),this._propertyNameStack.push(t),this.IncrementChildCount(),this._stateStack.push(new e.Writer.StateElement(e.Writer.State.Property))}WritePropertyEnd(){this.Assert(this.state===e.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}WritePropertyNameStart(){this.Assert(this.state===e.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new e.Writer.StateElement(e.Writer.State.Property)),this._stateStack.push(new e.Writer.StateElement(e.Writer.State.PropertyName))}WritePropertyNameEnd(){this.Assert(this.state===e.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}WritePropertyNameInner(t){this.Assert(this.state===e.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=t}WriteArrayStart(){this.StartNewObject(!0);let t=[];if(this.state===e.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);let e=this._propertyNameStack.pop();this.currentCollection[e]=t,this._collectionStack.push(t)}else this.state===e.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(t),this._collectionStack.push(t)):(this.Assert(this.state===e.Writer.State.None),this._jsonObject=t,this._collectionStack.push(t));this._stateStack.push(new e.Writer.StateElement(e.Writer.State.Array))}WriteArrayEnd(){this.Assert(this.state===e.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}Write(e){null!==e?(this.StartNewObject(!1),this._addToCurrentObject(e)):console.error("Warning: trying to write a null value")}WriteBool(e){null!==e&&(this.StartNewObject(!1),this._addToCurrentObject(e))}WriteInt(e){null!==e&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(e)))}WriteFloat(e){null!==e&&(this.StartNewObject(!1),e==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):e==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):e!=e?this._addToCurrentObject(0):this._addToCurrentObject(e))}WriteNull(){this.StartNewObject(!1),this._addToCurrentObject(null)}WriteStringStart(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new e.Writer.StateElement(e.Writer.State.String))}WriteStringEnd(){this.Assert(this.state==e.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}WriteStringInner(t){this.Assert(this.state===e.Writer.State.String),null!==t?this._currentString+=t:console.error("Warning: trying to write a null string")}toString(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}StartNewObject(t){t?this.Assert(this.state===e.Writer.State.None||this.state===e.Writer.State.Property||this.state===e.Writer.State.Array):this.Assert(this.state===e.Writer.State.Property||this.state===e.Writer.State.Array),this.state===e.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==e.Writer.State.Array&&this.state!==e.Writer.State.Property||this.IncrementChildCount()}get state(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:e.Writer.State.None}get childCount(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}get currentCollection(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}get currentPropertyName(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}IncrementChildCount(){this.Assert(this._stateStack.length>0);let e=this._stateStack.pop();e.childCount++,this._stateStack.push(e)}Assert(e){if(!e)throw Error("Assert failed while writing JSON")}_addToCurrentObject(t){this.Assert(null!==this.currentCollection),this.state===e.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(t)):this.state===e.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=t,this._propertyNameStack.pop())}}e.Writer=t,function(t){var n;(n=t.State||(t.State={}))[n.None=0]="None",n[n.Object=1]="Object",n[n.Array=2]="Array",n[n.Property=3]="Property",n[n.PropertyName=4]="PropertyName",n[n.String=5]="String",t.StateElement=class{constructor(t){this.type=e.Writer.State.None,this.childCount=0,this.type=t}}}(t=e.Writer||(e.Writer={}))}(S||(S={}));class P{constructor(){let t=arguments[0],e=arguments[1];if(this.name=t,this.callStack=new C(e),arguments[2]){let t=arguments[2];this.callStack.SetJsonToken(t.callstack,e),this.outputStream=v.JArrayToRuntimeObjList(t.outputStream),this.currentChoices=v.JArrayToRuntimeObjList(t.currentChoices);let n=t.choiceThreads;0[0]!==n&&this.LoadFlowChoiceThreads(n,e)}else this.outputStream=[],this.currentChoices=[]}WriteJson(e){e.WriteObjectStart(),e.WriteProperty("callstack",e=>this.callStack.WriteJson(e)),e.WriteProperty("outputStream",e=>v.WriteListRuntimeObjs(e,this.outputStream));let t=!1;for(let s of this.currentChoices){if(null===s.threadAtGeneration)return n("c.threadAtGeneration");s.originalThreadIndex=s.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(s.originalThreadIndex)&&(t||(t=!0,e.WritePropertyStart("choiceThreads"),e.WriteObjectStart()),e.WritePropertyStart(s.originalThreadIndex),s.threadAtGeneration.WriteJson(e),e.WritePropertyEnd())}t&&(e.WriteObjectEnd(),e.WritePropertyEnd()),e.WriteProperty("currentChoices",e=>{e.WriteArrayStart();for(let t of this.currentChoices)v.WriteChoice(e,t);e.WriteArrayEnd()}),e.WriteObjectEnd()}LoadFlowChoiceThreads(e,t){for(let n of this.currentChoices){let s=this.callStack.ThreadWithIndex(n.originalThreadIndex);if(null!==s)n.threadAtGeneration=s.Copy();else{let s=e["".concat(n.originalThreadIndex)];n.threadAtGeneration=new C.Thread(s,t)}}}}class Y{ToJson(){let e=new S.Writer;return this.WriteJson(e),e.toString()}toJson(){let e=arguments.length>0&&0[0]!==arguments[0]&&arguments[0];return this.ToJson(e)}LoadJson(e){let t=S.TextToDictionary(e);this.LoadJsonObj(t),null!==this.onDidLoadState&&this.onDidLoadState()}VisitCountAtPathString(e){let t;if(null!==this._patch){let n=this.story.ContentAtPath(new r(e)).container;if(null===n)throw new Error("Content at path not found: "+e);if(t=this._patch.TryGetVisitCount(n,0),t.exists)return t.result}return t=w(this._visitCounts,e,null),t.exists?t.result:0}VisitCountForContainer(e){if(null===e)return n("container");if(!e.visitsShouldBeCounted)return this.story.Error("Read count for target ("+e.name+" - on "+e.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){let t=this._patch.TryGetVisitCount(e,0);if(t.exists)return t.result}let s=e.path.toString(),t=w(this._visitCounts,s,null);return t.exists?t.result:0}IncrementVisitCountForContainer(e){if(null!==this._patch){let t=this.VisitCountForContainer(e);return t++,void this._patch.SetVisitCount(e,t)}let t=e.path.toString(),n=w(this._visitCounts,t,null);n.exists?this._visitCounts.set(t,n.result+1):this._visitCounts.set(t,1)}RecordTurnIndexVisitToContainer(e){if(null!==this._patch)return void this._patch.SetTurnIndex(e,this.currentTurnIndex);let t=e.path.toString();this._turnIndices.set(t,this.currentTurnIndex)}TurnsSinceForContainer(e){if(e.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+e.name+" - on "+e.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){let t=this._patch.TryGetTurnIndex(e,0);if(t.exists)return this.currentTurnIndex-t.result}let n=e.path.toString(),t=w(this._turnIndices,n,0);return t.exists?this.currentTurnIndex-t.result:-1}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._currentFlow.outputStream}get currentChoices(){return this.canContinue?[]:this._currentFlow.currentChoices}get generatedChoices(){return this._currentFlow.currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}set variablesState(e){this._variablesState=e}get callStack(){return this._currentFlow.callStack}get evaluationStack(){return this._evaluationStack}get currentTurnIndex(){return this._currentTurnIndex}set currentTurnIndex(e){this._currentTurnIndex=e}get currentPathString(){let e=this.currentPointer;return e.isNull?null:null===e.path?n("pointer.path"):e.path.toString()}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(e){this.callStack.currentElement.currentPointer=e.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(e){this.callStack.currentThread.previousPointer=e.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return null!=this.currentErrors&&this.currentErrors.length>0}get hasWarning(){return null!=this.currentWarnings&&this.currentWarnings.length>0}get currentText(){if(this._outputStreamTextDirty){let n=new y,e=!1;for(let o of this.outputStream){let i=s(o,h);if(e||null===i){let n=s(o,t);null!==n&&(n.commandType==t.CommandType.BeginTag?e=!0:n.commandType==t.CommandType.EndTag&&(e=!1))}else n.Append(i.value)}this._currentText=this.CleanOutputWhitespace(n.toString()),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(e){let n=new y,t=-1,s=0;for(let o=0;o<e.length;o++){let i=e.charAt(o),a=" "==i||"	"==i;a&&-1==t&&(t=o),a||(`
`!=i&&t>0&&t!=s&&n.Append(" "),t=-1),`
`==i&&(s=o+1),a||n.Append(i)}return n.toString()}get currentTags(){if(this._outputStreamTagsDirty){this._currentTags=[];let n=!1,e=new y;for(let o of this.outputStream){let i=s(o,t);if(i!=null){if(i.commandType==t.CommandType.BeginTag){if(n&&e.Length>0){let t=this.CleanOutputWhitespace(e.toString());this._currentTags.push(t),e.Clear()}n=!0}else if(i.commandType==t.CommandType.EndTag){if(e.Length>0){let t=this.CleanOutputWhitespace(e.toString());this._currentTags.push(t),e.Clear()}n=!1}}else if(n){let t=s(o,h);null!==t&&e.Append(t.value)}else{let e=s(o,F);e!=null&&null!=e.text&&e.text.length>0&&this._currentTags.push(e.text)}}if(e.Length>0){let t=this.CleanOutputWhitespace(e.toString());this._currentTags.push(t),e.Clear()}this._outputStreamTagsDirty=!1}return this._currentTags}get currentFlowName(){return this._currentFlow.name}get currentFlowIsDefaultFlow(){return this._currentFlow.name==this.kDefaultFlowName}get aliveFlowNames(){if(this._aliveFlowNamesDirty){if(this._aliveFlowNames=[],null!=this._namedFlows)for(let e of this._namedFlows.keys())e!=this.kDefaultFlowName&&this._aliveFlowNames.push(e);this._aliveFlowNamesDirty=!1}return this._aliveFlowNames}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(e){this.callStack.currentElement.inExpressionEvaluation=e}constructor(e){this.kInkSaveStateVersion=10,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=p.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._aliveFlowNames=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this._aliveFlowNamesDirty=!0,this.story=e,this._currentFlow=new P(this.kDefaultFlowName,e),this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this._evaluationStack=[],this._variablesState=new H(this.callStack,e.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;let t=(new Date).getTime();this.storySeed=new D(t).next()%100,this.previousRandom=0,this.GoToStart()}GoToStart(){this.callStack.currentElement.currentPointer=p.StartOf(this.story.mainContentContainer)}SwitchFlow_Internal(e){if(null===e)throw new Error("Must pass a non-null string to Story.SwitchFlow");if(null===this._namedFlows&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),e===this._currentFlow.name)return;let t,n=w(this._namedFlows,e,null);n.exists?t=n.result:(t=new P(e,this.story),this._namedFlows.set(e,t),this._aliveFlowNamesDirty=!0),this._currentFlow=t,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty()}SwitchToDefaultFlow_Internal(){null!==this._namedFlows&&this.SwitchFlow_Internal(this.kDefaultFlowName)}RemoveFlow_Internal(e){if(null===e)throw new Error("Must pass a non-null string to Story.DestroyFlow");if(e===this.kDefaultFlowName)throw new Error("Cannot destroy default flow");if(this._currentFlow.name===e&&this.SwitchToDefaultFlow_Internal(),null===this._namedFlows)return n("this._namedFlows");this._namedFlows.delete(e),this._aliveFlowNamesDirty=!0}CopyAndStartPatching(){let e=new Y(this.story);if(e._patch=new X(this._patch),e._currentFlow.name=this._currentFlow.name,e._currentFlow.callStack=new C(this._currentFlow.callStack),e._currentFlow.currentChoices.push(...this._currentFlow.currentChoices),e._currentFlow.outputStream.push(...this._currentFlow.outputStream),e.OutputStreamDirty(),null!==this._namedFlows){e._namedFlows=new Map;for(let[t,n]of this._namedFlows)e._namedFlows.set(t,n),e._aliveFlowNamesDirty=!0;e._namedFlows.set(this._currentFlow.name,e._currentFlow)}return this.hasError&&(e._currentErrors=[],e._currentErrors.push(...this.currentErrors||[])),this.hasWarning&&(e._currentWarnings=[],e._currentWarnings.push(...this.currentWarnings||[])),e.variablesState=this.variablesState,e.variablesState.callStack=e.callStack,e.variablesState.patch=e._patch,e.evaluationStack.push(...this.evaluationStack),this.divertedPointer.isNull||(e.divertedPointer=this.divertedPointer.copy()),e.previousPointer=this.previousPointer.copy(),e._visitCounts=this._visitCounts,e._turnIndices=this._turnIndices,e.currentTurnIndex=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.didSafeExit=this.didSafeExit,e}RestoreAfterPatch(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}ApplyAnyPatch(){if(null!==this._patch){this.variablesState.ApplyPatch();for(let[e,t]of this._patch.visitCounts)this.ApplyCountChanges(e,t,!0);for(let[e,t]of this._patch.turnIndices)this.ApplyCountChanges(e,t,!1);this._patch=null}}ApplyCountChanges(e,t,n){(n?this._visitCounts:this._turnIndices).set(e.path.toString(),t)}WriteJson(e){if(e.WriteObjectStart(),e.WritePropertyStart("flows"),e.WriteObjectStart(),null!==this._namedFlows)for(let[t,n]of this._namedFlows)e.WriteProperty(t,e=>n.WriteJson(e));else e.WriteProperty(this._currentFlow.name,e=>this._currentFlow.WriteJson(e));if(e.WriteObjectEnd(),e.WritePropertyEnd(),e.WriteProperty("currentFlowName",this._currentFlow.name),e.WriteProperty("variablesState",e=>this.variablesState.WriteJson(e)),e.WriteProperty("evalStack",e=>v.WriteListRuntimeObjs(e,this.evaluationStack)),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return n("divertedPointer");e.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}e.WriteProperty("visitCounts",e=>v.WriteIntDictionary(e,this._visitCounts)),e.WriteProperty("turnIndices",e=>v.WriteIntDictionary(e,this._turnIndices)),e.WriteIntProperty("turnIdx",this.currentTurnIndex),e.WriteIntProperty("storySeed",this.storySeed),e.WriteIntProperty("previousRandom",this.previousRandom),e.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),e.WriteIntProperty("inkFormatVersion",j.inkVersionCurrent),e.WriteObjectEnd()}LoadJsonObj(e){let t=e,s=t.inkSaveVersion;if(s==null)throw new Error("ink save format incorrect, can't load.");if(parseInt(s)<this.kMinCompatibleLoadVersion)throw new Error("Ink save format isn't compatible with the current version (saw '"+s+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");let o=t.flows;if(o!=null){{let e=o;1===Object.keys(e).length?this._namedFlows=null:null===this._namedFlows?this._namedFlows=new Map:this._namedFlows.clear();let s=Object.entries(e);for(let[i,a]of s){let t=i,o=a,r=new P(t,this.story,o);if(1===Object.keys(e).length)this._currentFlow=new P(t,this.story,o);else{if(null===this._namedFlows)return n("this._namedFlows");this._namedFlows.set(t,r)}}if(null!=this._namedFlows&&this._namedFlows.size>1){let e=t.currentFlowName;this._currentFlow=this._namedFlows.get(e)}}}else{this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(t.callstackThreads,this.story),this._currentFlow.outputStream=v.JArrayToRuntimeObjList(t.outputStream),this._currentFlow.currentChoices=v.JArrayToRuntimeObjList(t.currentChoices);let e=t.choiceThreads;this._currentFlow.LoadFlowChoiceThreads(e,this.story)}this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this.variablesState.SetJsonToken(t.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=v.JArrayToRuntimeObjList(t.evalStack);let i=t.currentDivertTarget;if(i!=null){let e=new r(i.toString());this.divertedPointer=this.story.PointerAtPath(e)}this._visitCounts=v.JObjectToIntDictionary(t.visitCounts),this._turnIndices=v.JObjectToIntDictionary(t.turnIndices),this.currentTurnIndex=parseInt(t.turnIdx),this.storySeed=parseInt(t.storySeed),this.previousRandom=parseInt(t.previousRandom)}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:null;this.outputStream.length=0,null!==e&&this.outputStream.push(...e),this.OutputStreamDirty()}PushToOutputStream(e){let t=s(e,h);if(null!==t){let e=this.TrySplittingHeadTailWhitespace(t);if(null!==e){for(let t of e)this.PushToOutputStreamIndividual(t);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(e),this.OutputStreamDirty()}PopFromOutputStream(e){this.outputStream.splice(this.outputStream.length-e,e),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(e){let t=e.value;if(null===t)return n("single.value");let o=-1,a=-1;for(let e=0;e<t.length;e++){let n=t[e];if(`
`!=n){if(" "==n||"	"==n)continue;break}-1==o&&(o=e),a=e}let s=-1,r=-1;for(let e=t.length-1;e>=0;e--){let n=t[e];if(`
`!=n){if(" "==n||"	"==n)continue;break}-1==s&&(s=e),r=e}if(-1==o&&-1==s)return null;let i=[],c=0,l=t.length;if(-1!=o){if(o>0){let e=new h(t.substring(0,o));i.push(e)}i.push(new h(`
`)),c=a+1}if(-1!=s&&(l=r),l>c){let e=t.substring(c,l);i.push(new h(e))}if(-1!=s&&r>a&&(i.push(new h(`
`)),s<t.length-1)){let e=t.length-s-1,n=new h(t.substring(s+1,s+1+e));i.push(n)}return i}PushToOutputStreamIndividual(e){let a=s(e,z),o=s(e,h),i=!0;if(a)this.TrimNewlinesFromOutputStream(),i=!0;else if(o){let e=-1,s=this.callStack.currentElement;s.type==l.Function&&(e=s.functionStartInOutputStream);let n=-1;for(let s=this.outputStream.length-1;s>=0;s--){let o=this.outputStream[s],i=o instanceof t?o:null;if(null!=(o instanceof z?o:null)){n=s;break}if(i!=null&&i.commandType==t.CommandType.BeginString){s>=e&&(e=-1);break}}let a=-1;if(a=-1!=n&&-1!=e?Math.min(e,n):-1!=n?n:e,-1!=a){if(o.isNewline)i=!1;else if(o.isNonWhitespace&&(n>-1&&this.RemoveExistingGlue(),e>-1)){let e=this.callStack.elements;for(let t=e.length-1;t>=0;t--){let n=e[t];if(n.type!=l.Function)break;n.functionStartInOutputStream=-1}}}else o.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(null===e)return n("obj");this.outputStream.push(e),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let n=-1,e=this.outputStream.length-1;for(;e>=0;){let i=this.outputStream[e],a=s(i,t),o=s(i,h);if(a!=null||o!=null&&o.isNonWhitespace)break;o!=null&&o.isNewline&&(n=e),e--}if(n>=0)for(e=n;e<this.outputStream.length;)s(this.outputStream[e],h)?this.outputStream.splice(e,1):e++;this.OutputStreamDirty()}RemoveExistingGlue(){for(let e=this.outputStream.length-1;e>=0;e--){let n=this.outputStream[e];if(n instanceof z)this.outputStream.splice(e,1);else if(n instanceof t)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(this.outputStream.length>0)for(let e=this.outputStream.length-1;e>=0;e--){if(this.outputStream[e]instanceof t)break;let n=this.outputStream[e];if(n instanceof h){if(n.isNewline)return!0;if(n.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(let e of this.outputStream)if(e instanceof h)return!0;return!1}get inStringEvaluation(){for(let e=this.outputStream.length-1;e>=0;e--){let n=s(this.outputStream[e],t);if(n instanceof t&&n.commandType==t.CommandType.BeginString)return!0}return!1}PushEvaluationStack(e){let t=s(e,g);if(t){let e=t.value;if(null===e)return n("rawList");if(null!=e.originNames){e.origins||(e.origins=[]),e.origins.length=0;for(let s of e.originNames){if(null===this.story.listDefinitions)return n("StoryState.story.listDefinitions");let t=this.story.listDefinitions.TryListGetDefinition(s,null);if(null===t.result)return n("StoryState def.result");e.origins.indexOf(t.result)<0&&e.origins.push(t.result)}}}if(null===e)return n("obj");this.evaluationStack.push(e)}PopEvaluationStack(e){if(0[0]===e)return B(this.evaluationStack.pop());if(e>this.evaluationStack.length)throw new Error("trying to pop too many objects");return B(this.evaluationStack.splice(this.evaluationStack.length-e,e))}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=p.Null,this.previousPointer=p.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){E.Assert(this.callStack.currentElement.type==l.Function);let e=this.callStack.currentElement.functionStartInOutputStream;-1==e&&(e=0);for(let n=this.outputStream.length-1;n>=e;n--){let i=this.outputStream[n],o=s(i,h),a=s(i,t);if(o!=null){if(a)break;if(!o.isNewline&&!o.isInlineWhitespace)break;this.outputStream.splice(n,1),this.OutputStreamDirty()}}}PopCallStack(){let e=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:null;this.callStack.currentElement.type==l.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(e)}SetChosenPath(e,t){this._currentFlow.currentChoices.length=0;let n=this.story.PointerAtPath(e);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,t&&this.currentTurnIndex++}StartFunctionEvaluationFromGame(e,t){this.callStack.Push(l.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=p.StartOf(e),this.PassArgumentsToEvaluationStack(t)}PassArgumentsToEvaluationStack(e){if(null!==e)for(let t=0;t<e.length;t++){if(!("number"==typeof e[t]||"string"==typeof e[t]||"boolean"==typeof e[t]||e[t]instanceof f))throw new Error((B(arguments[t]),"null"));this.PushEvaluationStack(m.Create(e[t]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==l.FunctionEvaluationFromGame&&(this.currentPointer=p.Null,this.didSafeExit=!0,!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=l.FunctionEvaluationFromGame)throw new Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;this.evaluationStack.length>t;){let n=this.PopEvaluationStack();null===e&&(e=n)}if(this.PopCallStack(l.FunctionEvaluationFromGame),e){if(e instanceof A)return null;let t=u(e,m);return t.valueType==o.DivertTarget?t.valueObject.toString():t.valueObject}return null}AddError(e,t){t?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(e)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(e))}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}class J{constructor(){this.startTime=0[0]}get ElapsedMilliseconds(){return 0[0]===this.startTime?0:(new Date).getTime()-this.startTime}Start(){this.startTime=(new Date).getTime()}Stop(){this.startTime=0[0]}}!function(e){e[e.Author=0]="Author",e[e.Warning=1]="Warning",e[e.Error=2]="Error"}(L||(L={})),Number.isInteger||(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&e>-9007199254740992&&e<9007199254740992&&Math.floor(e)===e});class j extends b{get currentChoices(){let e=[];if(null===this._state)return n("this._state");for(let t of this._state.currentChoices)t.isInvisibleDefault||(t.index=e.length,e.push(t));return e}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get currentFlowName(){return this.state.currentFlowName}get currentFlowIsDefaultFlow(){return this.state.currentFlowIsDefaultFlow}get aliveFlowNames(){return this.state.aliveFlowNames}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}constructor(){let n;super(),this.inkVersionMinimumCompatible=18,this.onError=null,this.onDidContinue=null,this.onMakeChoice=null,this.onEvaluateFunction=null,this.onCompleteEvaluateFunction=null,this.onChoosePathString=null,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateSnapshotAtLastNewline=null,this._sawLookaheadUnsafeFunctionAfterNewline=!1,this._recursiveContinueCount=0,this._asyncSaving=!1,this._profiler=null;let t=null,e=null;if(arguments[0]instanceof a)n=arguments[0],0[0]!==arguments[1]&&(t=arguments[1]),this._mainContentContainer=n;else if("string"==typeof arguments[0]){let t=arguments[0];e=S.TextToDictionary(t)}else e=arguments[0];if(t!=null&&(this._listDefinitions=new q(t)),this._externals=new Map,null!==e){let t=e,s=t.inkVersion;if(s==null)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");let n=parseInt(s);if(n>j.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(n<this.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");n!=j.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");let o,i=t.root;if(i==null)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(o=t.listDefs)&&(this._listDefinitions=v.JTokenToListDefinitions(o)),this._mainContentContainer=u(v.JTokenToRuntimeObject(i),a),this.ResetState()}}ToJson(e){let t=!1;if(e||(t=!0,e=new S.Writer),e.WriteObjectStart(),e.WriteIntProperty("inkVersion",j.inkVersionCurrent),e.WriteProperty("root",e=>v.WriteRuntimeContainer(e,this._mainContentContainer)),null!=this._listDefinitions){e.WritePropertyStart("listDefs"),e.WriteObjectStart();for(let t of this._listDefinitions.lists){e.WritePropertyStart(t.name),e.WriteObjectStart();for(let[n,s]of t.items){let o=d.fromSerializedKey(n),i=s;e.WriteIntProperty(o.itemName,i)}e.WriteObjectEnd(),e.WritePropertyEnd()}e.WriteObjectEnd(),e.WritePropertyEnd()}if(e.WriteObjectEnd(),t)return e.toString()}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new Y(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(null===this._state)return n("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return n("this._state");this._state.ForceEnd()}ResetGlobals(){if(this._mainContentContainer.namedContent.get("global decl")){let e=this.state.currentPointer.copy();this.ChoosePath(new r("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=e}this.state.variablesState.SnapshotDefaultGlobals()}SwitchFlow(e){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't switch flow to "+e);this.state.SwitchFlow_Internal(e)}RemoveFlow(e){this.state.RemoveFlow_Internal(e)}SwitchToDefaultFlow(){this.state.SwitchToDefaultFlow_Internal()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(e){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(e)}ContinueInternal(){let n=arguments.length>0&&0[0]!==arguments[0]?arguments[0]:0;null!=this._profiler&&this._profiler.PreContinue();let s=n>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=s,!this.canContinue)throw new Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}let e=new J;e.Start();let t=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{t=this.ContinueSingleStep()}catch(e){if(!(e instanceof _))throw e;this.AddError(e.message,0[0],e.useEndLineNumber);break}if(t)break;if(this._asyncContinueActive&&e.ElapsedMilliseconds>n)break}while(this.canContinue)if(e.Stop(),!t&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(l.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(l.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1,null!==this.onDidContinue&&this.onDidContinue()),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(null===this.onError){let e=new y;throw e.Append("Ink had "),this.state.hasError&&(e.Append("".concat(this.state.currentErrors.length)),e.Append(1==this.state.currentErrors.length?" error":"errors"),this.state.hasWarning&&e.Append(" and ")),this.state.hasWarning&&(e.Append("".concat(this.state.currentWarnings.length)),e.Append(1==this.state.currentWarnings.length?" warning":"warnings"),this.state.hasWarning&&e.Append(" and ")),e.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),e.Append(this.state.hasError?this.state.currentErrors[0]:this.state.currentWarnings[0]),new _(e.toString())}if(this.state.hasError)for(let e of this.state.currentErrors)this.onError(e,L.Error);if(this.state.hasWarning)for(let e of this.state.currentWarnings)this.onError(e,L.Warning);this.ResetErrors()}}ContinueSingleStep(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return n("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return n("this.state.currentTags");let e=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(e==j.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;e==j.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(e,t,s,o){if(null===e)return n("prevText");if(null===t)return n("currText");let i=t.length>=e.length&&e.length>0&&`
`==t.charAt(e.length-1);if(s==o&&e.length==t.length&&i)return j.OutputStateChange.NoChange;if(!i)return j.OutputStateChange.NewlineRemoved;if(o>s)return j.OutputStateChange.ExtendedBeyondNewline;for(let n=e.length;n<t.length;n++){let s=t.charAt(n);if(" "!=s&&"	"!=s)return j.OutputStateChange.ExtendedBeyondNewline}return j.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");let e=new y;for(;this.canContinue;)e.Append(this.Continue());return e.toString()}ContentAtPath(e){return this.mainContentContainer.ContentAtPath(e)}KnotContainerWithName(e){let t=this.mainContentContainer.namedContent.get(e);return t instanceof a?t:null}PointerAtPath(e){if(0==e.length)return p.Null;let s=new p,o=e.length,t=null;return null===e.lastComponent?n("path.lastComponent"):(e.lastComponent.isIndex?(o=e.length-1,t=this.mainContentContainer.ContentAtPath(e,0[0],o),s.container=t.container,s.index=e.lastComponent.index):(t=this.mainContentContainer.ContentAtPath(e),s.container=t.container,s.index=-1),null==t.obj||t.obj==this.mainContentContainer&&o>0?this.Error("Failed to find content at path '"+e+"', and no approximation of it was possible."):t.approximate&&this.Warning("Failed to find content at path '"+e+"', so it was approximated to: '"+t.obj.path+"'."),s)}StateSnapshot(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}RestoreStateSnapshot(){null===this._stateSnapshotAtLastNewline&&n("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}DiscardSnapshot(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}CopyStateForBackgroundThreadSave(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");let e=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,e}BackgroundSaveComplete(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}Step(){let i=!0,n=this.state.currentPointer.copy();if(n.isNull)return;let o=s(n.Resolve(),a);for(;o&&(this.VisitContainer(o,!0),0!=o.content.length);)n=p.StartOf(o),o=s(n.Resolve(),a);this.state.currentPointer=n.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);let e=n.Resolve(),l=this.PerformLogicAndFlowControl(e);if(this.state.currentPointer.isNull)return;l&&(i=!1);let r=s(e,V);if(r){let t=this.ProcessChoice(r);t&&this.state.generatedChoices.push(t),e=null,i=!1}if(e instanceof a&&(i=!1),i){let t=s(e,O);if(t&&-1==t.contextIndex){let n=this.state.callStack.ContextForVariableNamed(t.variableName);e=new O(t.variableName,n)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(e):this.state.PushToOutputStream(e)}this.NextContent();let c=s(e,t);c&&c.commandType==t.CommandType.StartThread&&this.state.callStack.PushThread()}VisitContainer(e,t){e.countingAtStartOnly&&!t||(e.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(e),e.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(e))}VisitChangedContainersDueToDivert(){let n=this.state.previousPointer.copy(),o=this.state.currentPointer.copy();if(o.isNull||-1==o.index)return;if(this._prevContainers.length=0,!n.isNull){let e=s(n.Resolve(),a)||s(n.container,a);for(;e;)this._prevContainers.push(e),e=s(e.parent,a)}let t=o.Resolve();if(t==null)return;let e=s(t.parent,a),i=!0;for(;e&&(this._prevContainers.indexOf(e)<0||e.countingAtStartOnly);){let n=e.content.length>0&&t==e.content[0]&&i;n||(i=!1),this.VisitContainer(e,n),t=e,e=s(e.parent,a)}}PopChoiceStringAndTags(e){let t=u(this.state.PopEvaluationStack(),h);for(;this.state.evaluationStack.length>0&&null!=s(this.state.PeekEvaluationStack(),F);){let t=s(this.state.PopEvaluationStack(),F);t&&e.push(t.text)}return t.value}ProcessChoice(e){let n=!0;if(e.hasCondition){let e=this.state.PopEvaluationStack();this.IsTruthy(e)||(n=!1)}let o="",i="",s=[];if((e.hasChoiceOnlyContent&&(i=this.PopChoiceStringAndTags(s)||""),e.hasStartContent&&(o=this.PopChoiceStringAndTags(s)||""),e.onceOnly)&&this.state.VisitCountForContainer(e.choiceTarget)>0&&(n=!1),!n)return null;let t=new $;return t.targetPath=e.pathOnChoice,t.sourcePath=e.path.toString(),t.isInvisibleDefault=e.isInvisibleDefault,t.threadAtGeneration=this.state.callStack.ForkThread(),t.tags=s.reverse(),t.text=(o+i).replace(/^[ \t]+|[ \t]+$/g,""),t}IsTruthy(e){if(e instanceof m){let t=e;if(t instanceof k){let e=t;return this.Error("Shouldn't use a divert target (to "+e.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return t.isTruthy}return!1}PerformLogicAndFlowControl(e){if(e==null)return!1;if(e instanceof T){let t=e;if(t.isConditional){let e=this.state.PopEvaluationStack();if(!this.IsTruthy(e))return!0}if(t.hasVariableTarget){let n=t.variableDivertName,e=this.state.variablesState.GetVariableWithName(n);if(e==null)this.Error("Tried to divert using a target from a variable that could not be found ("+n+")");else if(!(e instanceof k)){let o=s(e,c),t="Tried to divert to a target from a variable, but the variable ("+n+") didn't contain a divert target, it ";o instanceof c&&0==o.value?t+="was empty/null (the value 0).":t+="contained '"+e+"'.",this.Error(t)}let o=u(e,k);this.state.divertedPointer=this.PointerAtPath(o.targetPath)}else{if(t.isExternal)return this.CallExternalFunction(t.targetPathString,t.externalArgs),!0;this.state.divertedPointer=t.targetPointer.copy()}return t.pushesToStack&&this.state.callStack.Push(t.stackPushType,0[0],this.state.outputStream.length),this.state.divertedPointer.isNull&&!t.isExternal&&(t&&t.debugMetadata&&null!=t.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+t.debugMetadata.sourceName):this.Error("Divert resolution failed: "+t)),!0}if(e instanceof t){let o=e;switch(o.commandType){case t.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case t.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case t.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){let e=this.state.PopEvaluationStack();if(!(e instanceof A)){let t=new h(e.toString());this.state.PushToOutputStream(t)}}break;case t.CommandType.NoOp:break;case t.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case t.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case t.CommandType.PopFunction:case t.CommandType.PopTunnel:let O=o.commandType==t.CommandType.PopFunction?l.Function:l.Tunnel,i=null;if(O==l.Tunnel){let e=this.state.PopEvaluationStack();i=s(e,k),null===i&&this.Assert(e instanceof A,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==O&&this.state.callStack.canPop)this.state.PopCallStack(),i&&(this.state.divertedPointer=this.PointerAtPath(i.targetPath));else{let e=new Map;e.set(l.Function,"function return statement (~ return)"),e.set(l.Tunnel,"tunnel onwards statement (->->)");let t=e.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(t="end of flow (-> END or choice)");let n="Found "+e.get(O)+", when expected "+t;this.Error(n)}break;case t.CommandType.BeginString:this.state.PushToOutputStream(o),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case t.CommandType.BeginTag:this.state.PushToOutputStream(o);break;case t.CommandType.EndTag:if(this.state.inStringEvaluation){let e=[],n=0;for(let o=this.state.outputStream.length-1;o>=0;--o){let i=this.state.outputStream[o];n++;let a=s(i,t);if(a!=null){if(a.commandType==t.CommandType.BeginTag)break;this.Error("Unexpected ControlCommand while extracting tag from choice");break}i instanceof h&&e.push(i)}this.state.PopFromOutputStream(n);let o=new y;for(let t of e.reverse())o.Append(t.toString());let i=new F(this.state.CleanOutputWhitespace(o.toString()));this.state.PushEvaluationStack(i)}else this.state.PushToOutputStream(o);break;case t.CommandType.EndString:{let e=[],n=[],o=0;for(let a=this.state.outputStream.length-1;a>=0;--a){let i=this.state.outputStream[a];o++;let r=s(i,t);if(r&&r.commandType==t.CommandType.BeginString)break;i instanceof F&&n.push(i),i instanceof h&&e.push(i)}this.state.PopFromOutputStream(o);for(let e of n)this.state.PushToOutputStream(e);e=e.reverse();let i=new y;for(let t of e)i.Append(t.toString());this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new h(i.toString()));break}case t.CommandType.ChoiceCount:let L=this.state.generatedChoices.length;this.state.PushEvaluationStack(new c(L));break;case t.CommandType.Turns:this.state.PushEvaluationStack(new c(this.state.currentTurnIndex+1));break;case t.CommandType.TurnsSince:case t.CommandType.ReadCount:let v=this.state.PopEvaluationStack();if(!(v instanceof k)){let e="";v instanceof c&&(e=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+v+e);break}let j,C=u(v,k),w=s(this.ContentAtPath(C.targetPath).correctObj,a);w!=null?j=o.commandType==t.CommandType.TurnsSince?this.state.TurnsSinceForContainer(w):this.state.VisitCountForContainer(w):(j=o.commandType==t.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+o.toString()+" lookup at "+C.targetPath.toString())),this.state.PushEvaluationStack(new c(j));break;case t.CommandType.Random:{let t=s(this.state.PopEvaluationStack(),c),e=s(this.state.PopEvaluationStack(),c);if(e==null||e instanceof c==!1)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(t==null||t instanceof c==!1)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===t.value)return n("maxInt.value");if(null===e.value)return n("minInt.value");let o=t.value-e.value+1;(!isFinite(o)||o>Number.MAX_SAFE_INTEGER)&&(o=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),o<=0&&this.Error("RANDOM was called with minimum as "+e.value+" and maximum as "+t.value+". The maximum must be larger");let a=this.state.storySeed+this.state.previousRandom,i=new D(a).next(),r=i%o+e.value;this.state.PushEvaluationStack(new c(r)),this.state.previousRandom=i;break}case t.CommandType.SeedRandom:let e=s(this.state.PopEvaluationStack(),c);if(e==null||e instanceof c==!1)return this.Error("Invalid value passed to SEED_RANDOM");if(null===e.value)return n("minInt.value");this.state.storySeed=e.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new A);break;case t.CommandType.VisitIndex:let z=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new c(z));break;case t.CommandType.SequenceShuffleIndex:let N=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new c(N));break;case t.CommandType.StartThread:break;case t.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=p.Null);break;case t.CommandType.End:this.state.ForceEnd();break;case t.CommandType.ListFromInt:let b=s(this.state.PopEvaluationStack(),c),E=u(this.state.PopEvaluationStack(),h);if(null===b)throw new _("Passed non-integer when creating a list element from a numerical value.");let r=null;if(null===this.listDefinitions)return n("this.listDefinitions");let S=this.listDefinitions.TryListGetDefinition(E.value,null);if(!S.exists)throw new _("Failed to find LIST called "+E.value);{if(null===b.value)return n("minInt.value");let e=S.result.TryGetItemWithValue(b.value,d.Null);e.exists&&(r=new g(e.result,b.value))}r==null&&(r=new g),this.state.PushEvaluationStack(r);break;case t.CommandType.ListRange:let M=s(this.state.PopEvaluationStack(),m),T=s(this.state.PopEvaluationStack(),m),x=s(this.state.PopEvaluationStack(),g);if(null===x||null===T||null===M)throw new _("Expected list, minimum and maximum for LIST_RANGE");if(null===x.value)return n("targetList.value");let R=x.value.ListWithSubRange(T.valueObject,M.valueObject);this.state.PushEvaluationStack(new g(R));break;case t.CommandType.ListRandom:{let s=this.state.PopEvaluationStack();if(null===s)throw new _("Expected list for LIST_RANDOM");let e=s.value,t=null;if(null===e)throw n("list");if(0==e.Count)t=new f;else{let r=this.state.storySeed+this.state.previousRandom,o=new D(r).next(),c=o%e.Count,i=e.entries();for(let e=0;e<=c-1;e++)i.next();let a=i.next().value,s={Key:d.fromSerializedKey(a[0]),Value:a[1]};if(null===s.Key.originName)return n("randomItem.Key.originName");t=new f(s.Key.originName,this),t.Add(s.Key,s.Value),this.state.previousRandom=o}this.state.PushEvaluationStack(new g(t));break}default:this.Error("unhandled ControlCommand: "+o)}return!0}if(e instanceof I){let t=e,n=this.state.PopEvaluationStack();return this.state.variablesState.Assign(t,n),!0}if(e instanceof N){let n=e,t=null;if(null!=n.pathForCount){let e=n.containerForCount,s=this.state.VisitCountForContainer(e);t=new c(s)}else t=this.state.variablesState.GetVariableWithName(n.name),t==null&&(this.Warning("Variable not found: '"+n.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),t=new c(0));return this.state.PushEvaluationStack(t),!0}if(e instanceof i){let t=e,n=this.state.PopEvaluationStack(t.numberOfParameters),s=t.Call(n);return this.state.PushEvaluationStack(s),!0}return!1}ChoosePathString(e){let n=!(arguments.length>1&&0[0]!==arguments[1])||arguments[1],t=arguments.length>2&&0[0]!==arguments[2]?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),null!==this.onChoosePathString&&this.onChoosePathString(e,t),n)this.ResetCallstack();else if(this.state.callStack.currentElement.type==l.Function){let t="",n=this.state.callStack.currentElement.currentPointer.container;throw n!=null&&(t="("+n.path.toString()+") "),new Error("Story was running a function "+t+"when you called ChoosePathString("+e+`) - this is almost certainly not not what you want! Full stack trace: 
`+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(t),this.ChoosePath(new r(e))}IfAsyncWeCant(e){if(this._asyncContinueActive)throw new Error("Can't "+e+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(e){let t=!(arguments.length>1&&0[0]!==arguments[1])||arguments[1];this.state.SetChosenPath(e,t),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(e){let s=this.currentChoices;this.Assert(e>=0&&e<s.length,"choice out of range");let t=s[e];return null!==this.onMakeChoice&&this.onMakeChoice(t),null===t.threadAtGeneration?n("choiceToChoose.threadAtGeneration"):null===t.targetPath?n("choiceToChoose.targetPath"):(this.state.callStack.currentThread=t.threadAtGeneration,void this.ChoosePath(t.targetPath))}HasFunction(e){try{return null!=this.KnotContainerWithName(e)}catch{return!1}}EvaluateFunction(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:[],r=arguments.length>2&&0[0]!==arguments[2]&&arguments[2];if(null!==this.onEvaluateFunction&&this.onEvaluateFunction(e,t),this.IfAsyncWeCant("evaluate a function"),e==null)throw new Error("Function is null");if(""==e||""==e.trim())throw new Error("Function is empty or white space.");let s=this.KnotContainerWithName(e);if(s==null)throw new Error("Function doesn't exist: '"+e+"'");let o=[];o.push(...this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(s,t);let i=new y;for(;this.canContinue;)i.Append(this.Continue());let a=i.toString();this._state.ResetOutput(o);let n=this.state.CompleteFunctionEvaluationFromGame();return null!=this.onCompleteEvaluateFunction&&this.onCompleteEvaluateFunction(e,t,a,n),r?{returned:n,output:a}:n}EvaluateExpression(e){let t=this.state.callStack.elements.length;this.state.callStack.Push(l.Tunnel),this._temporaryEvaluationContainer=e,this.state.GoToStart();let n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>t&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}CallExternalFunction(e,t){if(null===e)return n("funcName");let o=this._externals.get(e),i=null,c=0[0]!==o;if(c&&!o.lookAheadSafe&&null!==this._stateSnapshotAtLastNewline)return void(this._sawLookaheadUnsafeFunctionAfterNewline=!0);if(!c){if(this.allowExternalFunctionFallbacks)return i=this.KnotContainerWithName(e),this.Assert(null!==i,"Trying to call EXTERNAL function '"+e+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(l.Function,0[0],this.state.outputStream.length),void(this.state.divertedPointer=p.StartOf(i));this.Assert(!1,"Trying to call EXTERNAL function '"+e+"' which has not been bound (and ink fallbacks disabled).")}let a=[];for(let e=0;e<t;++e){let n=u(this.state.PopEvaluationStack(),m).valueObject;a.push(n)}a.reverse();let r=o.function(a),s=null;r!=null?(s=m.Create(r),this.Assert(null!==s,"Could not create ink value from returned object of type "+typeof r)):s=new A,this.state.PushEvaluationStack(s)}BindExternalFunctionGeneral(e,t){let n=!(arguments.length>2&&0[0]!==arguments[2])||arguments[2];this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(e),"Function '"+e+"' has already been bound."),this._externals.set(e,{function:t,lookAheadSafe:n})}TryCoerce(e){return e}BindExternalFunction(e,t){let n=arguments.length>2&&0[0]!==arguments[2]&&arguments[2];this.Assert(t!=null,"Can't bind a null function"),this.BindExternalFunctionGeneral(e,e=>{this.Assert(e.length>=t.length,"External function expected "+t.length+" arguments");let n=[];for(let t=0,s=e.length;t<s;t++)n[t]=this.TryCoerce(e[t]);return t.apply(null,n)},n)}UnbindExternalFunction(e){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(e),"Function '"+e+"' has not been bound."),this._externals.delete(e)}ValidateExternalBindings(){let t=null,o=null,e=arguments[1]||new Set;if(arguments[0]instanceof a&&(t=arguments[0]),arguments[0]instanceof b&&(o=arguments[0]),null===t&&null===o)if(this.ValidateExternalBindings(this._mainContentContainer,e),this._hasValidatedExternals=!0,0==e.size)this._hasValidatedExternals=!0;else{let t="Error: Missing function binding for external";t+=e.size>1?"s":"",t+=": '",t+=Array.from(e).join("', '"),t+="' ",t+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(t)}else if(t!=null){for(let n of t.content)n!=null&&n.hasValidName||this.ValidateExternalBindings(n,e);for(let[,n]of t.namedContent)this.ValidateExternalBindings(s(n,b),e)}else if(o!=null){let t=s(o,T);if(t&&t.isExternal){let s=t.targetPathString;if(null===s)return n("name");this._externals.has(s)||(this.allowExternalFunctionFallbacks?this.mainContentContainer.namedContent.has(s)||e.add(s):e.add(s))}}}ObserveVariable(e,t){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(e))throw new Error("Cannot observe variable '"+e+"' because it wasn't declared in the ink story.");this._variableObservers.has(e)?this._variableObservers.get(e).push(t):this._variableObservers.set(e,[t])}ObserveVariables(e,t){for(let n=0,s=e.length;n<s;n++)this.ObserveVariable(e[n],t[n])}RemoveVariableObserver(e,t){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(t!=null){if(this._variableObservers.has(t))if(e!=null){let n=this._variableObservers.get(t);n!=null&&(n.splice(n.indexOf(e),1),0===n.length&&this._variableObservers.delete(t))}else this._variableObservers.delete(t)}else if(e!=null){let t=this._variableObservers.keys();for(let s of t){let n=this._variableObservers.get(s);n!=null&&(n.splice(n.indexOf(e),1),0===n.length&&this._variableObservers.delete(s))}}}VariableStateDidChangeEvent(e,t){if(null===this._variableObservers)return;let n=this._variableObservers.get(e);if(0[0]!==n){if(!(t instanceof m))throw new Error("Tried to get the value of a variable that isn't a standard type");let s=u(t,m);for(let t of n)t(e,s.valueObject)}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(e){return this.TagsAtStartOfFlowContainerWithPathString(e)}TagsAtStartOfFlowContainerWithPathString(e){let l=new r(e),o=this.ContentAtPath(l).container;if(null===o)return n("flowContainer");for(;;){let e=o.content[0];if(!(e instanceof a))break;o=e}let c=!1,i=null;for(let n of o.content){let e=s(n,t);if(e!=null)e.commandType==t.CommandType.BeginTag?c=!0:e.commandType==t.CommandType.EndTag&&(c=!1);else{if(!c)break;{let e=s(n,h);null!==e?(null===i&&(i=[]),null!==e.value&&i.push(e.value)):this.Error("Tag contained non-text content. Only plain text is allowed when using globalTags or TagsAtContentPath. If you want to evaluate dynamic content, you need to use story.Continue().")}}}return i}BuildStringOfHierarchy(){let e=new y;return this.mainContentContainer.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}BuildStringOfContainer(e){let t=new y;return e.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),!this.state.divertedPointer.isNull&&(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=p.Null,this.VisitChangedContainersDueToDivert(),!this.state.currentPointer.isNull))return;if(!this.IncrementContentPointer()){let e=!1;this.state.callStack.CanPop(l.Function)?(this.state.PopCallStack(l.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new A),e=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),e=!0):this.state.TryExitFunctionEvaluationFromGame(),e&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return n("pointer.container");for(;e.index>=e.container.content.length;){t=!1;let o=s(e.container.parent,a);if(o instanceof a==!1)break;let i=o.content.indexOf(e.container);if(-1==i)break;if(e=new p(o,i),e.index++,t=!0,null===e.container)return n("pointer.container")}return t||(e=p.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){let s=this._state.currentChoices,t=s.filter(e=>e.isInvisibleDefault);if(0==t.length||s.length>t.length)return!1;let e=t[0];return null===e.targetPath?n("choice.targetPath"):null===e.threadAtGeneration?n("choice.threadAtGeneration"):(this.state.callStack.currentThread=e.threadAtGeneration,null!==this._stateSnapshotAtLastNewline&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(e.targetPath,!1),!0)}NextSequenceShuffleIndex(){let t=s(this.state.PopEvaluationStack(),c);if(!(t instanceof c))return this.Error("expected number of elements in sequence for shuffle index"),0;let a=this.state.currentPointer.container;if(null===a)return n("seqContainer");if(null===t.value)return n("numElementsIntVal.value");let o=t.value,i=u(this.state.PopEvaluationStack(),c).value;if(null===i)return n("seqCount");let h=i/o,r=i%o,l=a.path.toString(),d=0;for(let e=0,t=l.length;e<t;e++)d+=l.charCodeAt(e)||0;let m=d+h+this.state.storySeed,f=new D(Math.floor(m)),e=[];for(let t=0;t<o;++t)e.push(t);for(let t=0;t<=r;++t){let n=f.next()%e.length,s=e[n];if(e.splice(n,1),t==r)return s}throw new Error("Should never reach here")}Error(e){let n=arguments.length>1&&0[0]!==arguments[1]&&arguments[1],t=new _(e);throw t.useEndLineNumber=n,t}Warning(e){this.AddError(e,!0)}AddError(e){let n=arguments.length>1&&0[0]!==arguments[1]&&arguments[1],o=arguments.length>2&&0[0]!==arguments[2]&&arguments[2],t=this.currentDebugMetadata,s=n?"WARNING":"ERROR";if(t!=null){let n=o?t.endLineNumber:t.startLineNumber;e="RUNTIME "+s+": '"+t.fileName+"' line "+n+": "+e}else e=this.state.currentPointer.isNull?"RUNTIME "+s+": "+e:"RUNTIME "+s+": ("+this.state.currentPointer+"): "+e;this.state.AddError(e,n),n||this.state.ForceEnd()}Assert(e){let t=arguments.length>1&&0[0]!==arguments[1]?arguments[1]:null;if(0==e)throw t==null&&(t="Story assert"),new Error(t+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let e,t=this.state.currentPointer;if(!t.isNull&&null!==t.Resolve()&&(e=t.Resolve().debugMetadata,null!==e))return e;for(let n=this.state.callStack.elements.length-1;n>=0;--n)if(t=this.state.callStack.elements[n].currentPointer,!t.isNull&&null!==t.Resolve()&&(e=t.Resolve().debugMetadata,null!==e))return e;for(let t=this.state.outputStream.length-1;t>=0;--t)if(e=this.state.outputStream[t].debugMetadata,null!==e)return e;return null}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}j.inkVersionCurrent=21,function(e){var t;(t=e.OutputStateChange||(e.OutputStateChange={}))[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"}(j||(j={})),e.InkList=f,e.Story=j,Object.defineProperty(e,"__esModule",{value:!0})});class NotificationManager{constructor(e={}){this.config={position:"bottom-right",maxNotifications:5,defaultDuration:4e3,spacing:10,zIndex:2e3,...e},this.notifications=[],this.container=null,this.init()}init(){this.createContainer(),this.addStyles()}createContainer(){this.container=document.createElement("div"),this.container.className="notification-container",this.container.setAttribute("data-position",this.config.position),this.container.setAttribute("aria-live","polite"),this.container.setAttribute("role","status"),this.setContainerPosition(),document.body.appendChild(this.container)}setContainerPosition(){const e={"top-left":{top:"20px",left:"20px"},"top-right":{top:"20px",right:"20px"},"top-center":{top:"20px",left:"50%",transform:"translateX(-50%)"},"bottom-left":{bottom:"20px",left:"20px"},"bottom-right":{bottom:"20px",right:"20px"},"bottom-center":{bottom:"20px",left:"50%",transform:"translateX(-50%)"}},t=e[this.config.position]||e["bottom-right"];Object.assign(this.container.style,{position:"fixed",zIndex:this.config.zIndex,pointerEvents:"none",...t})}addStyles(){const e=document.documentElement;e.style.setProperty("--notification-spacing",`${this.config.spacing}px`)}show(e,t={}){const n={type:"info",duration:this.config.defaultDuration,closable:!0,icon:null,showProgress:!1,onClick:null,onClose:null,...t};if(!n.icon){const e={success:"âœ“",error:"âœ•",warning:"âš ",info:"â“˜",critical:"ðŸš¨"};n.icon=e[n.type]||"â“˜"}const s=this.createNotificationElement(e,n);this.enforceMaxNotifications(),this.container.appendChild(s);const o={element:s,config:n};return this.notifications.push(o),requestAnimationFrame(()=>{s.classList.add("notification-visible")}),n.duration>0&&n.type!=="critical"&&setTimeout(()=>{this.remove(o)},n.duration),{remove:()=>this.remove(o),element:s}}createNotificationElement(e,t){const n=document.createElement("div");n.className=`notification-item notification-${t.type}`,(t.type==="error"||t.type==="critical")&&n.setAttribute("role","alert");const s=document.createElement("div");s.className="notification-content";const o=document.createElement("span");o.className="notification-icon",o.textContent=t.icon,o.setAttribute("aria-hidden","true"),s.appendChild(o);const i=document.createElement("span");if(i.textContent=e,s.appendChild(i),n.appendChild(s),t.closable){const e=document.createElement("button");e.type="button",e.className="notification-close",e.innerHTML="Ã—",e.setAttribute("aria-label","Dismiss notification"),e.addEventListener("click",e=>{e.stopPropagation(),this.remove({element:n,config:t})}),n.appendChild(e)}if(t.showProgress&&t.duration>0){const e=document.createElement("div");e.className="notification-progress",e.style.width="100%",n.appendChild(e),requestAnimationFrame(()=>{e.style.width="0%",e.style.transitionDuration=`${t.duration}ms`})}return t.onClick&&(n.style.cursor="pointer",n.addEventListener("click",t.onClick)),n}remove(e){if(!e||!e.element)return;const{element:t,config:n}=e;if(n.onClose)try{n.onClose()}catch(e){console.warn("Notification onClose callback failed:",e)}const s=this.notifications.indexOf(e);s>-1&&this.notifications.splice(s,1),t.style.transform=this.getExitTransform(),t.style.opacity="0",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)}getExitTransform(){const e=this.config.position.includes("right"),t=this.config.position.includes("left");return e?"translateX(100%)":t?"translateX(-100%)":"translateY(-100%)"}enforceMaxNotifications(){for(;this.notifications.length>=this.config.maxNotifications;){const e=this.notifications[0];this.remove(e)}}success(e,t={}){return this.show(e,{...t,type:"success"})}error(e,t={}){return this.show(e,{...t,type:"error"})}warning(e,t={}){return this.show(e,{...t,type:"warning"})}info(e,t={}){return this.show(e,{...t,type:"info"})}critical(e,t={}){return this.show(e,{...t,type:"critical",duration:0,closable:!0})}clearAll(){const e=[...this.notifications];e.forEach(e=>{this.remove(e)})}updateConfig(e){this.config={...this.config,...e},e.position&&(this.setContainerPosition(),this.container.setAttribute("data-position",this.config.position))}getStats(){return{activeNotifications:this.notifications.length,maxNotifications:this.config.maxNotifications,position:this.config.position,hasContainer:!!this.container}}destroy(){this.clearAll(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container);const e=document.getElementById("notification-styles");e&&e.remove(),this.container=null,this.notifications=[]}}window.notificationManager=new NotificationManager,typeof module!="undefined"&&module.exports&&(module.exports=NotificationManager);class ErrorManager{static SOURCES={CHOICE_MANAGER:"Choice Manager",CONTENT_PROCESSOR:"Content Processor",DISPLAY_MANAGER:"Display Manager",DOM_HELPERS:"DOM Helpers",KEYBOARD_HELP:"Keyboard Help",KEYBOARD_SHORTCUTS:"Keyboard Shortcuts",MODAL:"Modal",NAVIGATION_MANAGER:"Navigation Manager",PAGE_MANAGER:"Page Manager",SAVES_MODAL:"Saves Modal",SAVE_SYSTEM:"Save System",SETTINGS_MANAGER:"Settings Manager",STORY_MANAGER:"Story Manager",SYSTEM:"System",TAG_PROCESSOR:"Tag Processor"};constructor(){this.setupGlobalHandlers()}setupGlobalHandlers(){window.addEventListener("error",e=>{this.handleError("Uncaught Error",e.error,ErrorManager.SOURCES.SYSTEM)}),window.addEventListener("unhandledrejection",e=>{this.handleError("Unhandled Promise",e.reason,ErrorManager.SOURCES.SYSTEM),e.preventDefault()})}handleError(e,t,n="unknown",s="error"){const o=`[${s.toUpperCase()}] [${n}]`;if(console.group(`${o} ${e}`),console[s==="warning"?"warn":"error"]("Message:",e),console[s==="warning"?"warn":"error"]("Source:",n),t){const e=t instanceof Error?t.message:t;console[s==="warning"?"warn":"error"]("Details:",e),t.stack&&console[s==="warning"?"warn":"error"]("Stack:",t.stack)}console[s==="warning"?"warn":"error"]("Time:",(new Date).toISOString()),console.groupEnd(),(s==="error"||s==="critical")&&this.showNotification(e,s),s==="critical"&&this.attemptRecovery(n)}showNotification(e,t){const n=t==="critical"?"critical":"error";window.notificationManager.show(e,{type:n})}attemptRecovery(e){switch(console.log(`[RECOVERY] Attempting recovery for ${e} error`),e){case ErrorManager.SOURCES.STORY_MANAGER:if(window.storyManager)try{window.storyManager.restart(),console.log("[RECOVERY] Story restarted successfully")}catch(e){console.error("[RECOVERY] Failed to restart story:",e)}break;case ErrorManager.SOURCES.DISPLAY_MANAGER:if(window.storyManager?.display)try{window.storyManager.display.clear(),console.log("[RECOVERY] Display cleared")}catch(e){console.error("[RECOVERY] Failed to clear display:",e)}break;case ErrorManager.SOURCES.SAVE_SYSTEM:if(window.storyManager?.settings)try{window.storyManager.settings.setSetting("autoSave",!1),console.log("[RECOVERY] Autosave disabled due to save system error")}catch(e){console.error("[RECOVERY] Failed to disable autosave:",e)}break;default:console.error("[RECOVERY] Critical error: Failed to recover")}}critical(e,t,n){this.handleError(e,t,n,"critical")}error(e,t,n){this.handleError(e,t,n,"error")}warning(e,t,n){this.handleError(e,t,n,"warning")}safely(e,t=null){try{return e()}catch(e){return this.handleError("Safe execution failed",e,ErrorManager.SOURCES.SYSTEM),t}}async safelyAsync(e,t=null){try{return await e()}catch(e){return this.handleError("Safe async execution failed",e,ErrorManager.SOURCES.SYSTEM),t}}}window.errorManager=new ErrorManager;class MarkdownProcessor{static errorSource=ErrorManager.SOURCES.KEYBOARD_HELP;static patterns={escape:[[/%\*/g,"&#42;"],[/%_/g,"&#95;"],[/%`/g,"&#96;"],[/%:/g,"&#58;"],[/%\[/g,"&#91;"],[/%\]/g,"&#93;"],[/%\(/g,"&#40;"],[/%\)/g,"&#41;"],[/%%/g,"&#37;"]],block:[[/^::: (.*$)/gm,"<h4>$1</h4>"],[/^:: (.*$)/gm,"<h3>$1</h3>"],[/^: (.*$)/gm,"<h2>$1</h2>"],[/^\[---+\]$/gm,"<hr>"],[/^>> (.+)$/gm,"<blockquote>$1</blockquote>"],[/^> (.+)$/gm,"<li>$1</li>"]],inline:[[/___([^_\n]+?)___/g,"<strong><em>$1</em></strong>"],[/__([^_\n]+?)__/g,"<strong>$1</strong>"],[/(?<!_)_([^_\n]+?)_(?!_)/g,"<em>$1</em>"],[/\[(.*?)\]\(([^)]+)\)/g,(e,t,n)=>MarkdownProcessor.processLinkOrClass(t,n)],[/  $/gm,"<br>"]]};static _error(e,t=null){window.errorManager.error(e,t,MarkdownProcessor.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,MarkdownProcessor.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,MarkdownProcessor.errorSource)}static processLinkOrClass(e,t){if(this.isURL(t)){let n=t;(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\/.*)?$/.test(t)||/^www\./i.test(t))&&(n="https://"+t);const s=this.isExternalURL(n),o=s?' target="_blank" rel="noopener noreferrer"':"",i=s?'<span class="sr-only"> (opens in new tab)</span>':"";return`<a href="${n}"${o}>${e}${i}</a>`}return`<span class="inline-${t}">${e}</span>`}static isURL(e){const t=[/^https?:\/\//i,/^\/\//i,/^mailto:/i,/^tel:/i,/^#/,/^\//,/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\/.*)?$/,/^www\./i];return t.some(t=>t.test(e))}static isExternalURL(e){try{if(e.startsWith("/")||e.startsWith("#"))return!1;e.startsWith("//")&&(e="https:"+e),(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\/.*)?$/.test(e)||/^www\./i.test(e))&&(e="https://"+e);const t=new URL(e,window.location.origin);return t.hostname!==window.location.hostname}catch{return!0}}static process(e){if(!e||typeof e!="string")return"";if(e.trim().startsWith("%"))return e.trim().substring(1);try{for(const[t,n]of this.patterns.escape)e=e.replace(t,n);for(const[t,n]of this.patterns.block)e=e.replace(t,n);return e=e.replace(/(<li>.*?<\/li>(?:\s*<li>.*?<\/li>)*)/gs,"<ul>$1</ul>"),e=this.processInlineWithCodeBlocks(e),e}catch(t){return MarkdownProcessor._warning("Markdown processing failed",t),e}}static processInlineWithCodeBlocks(e){const n=this.tokenize(e);let t="";for(const e of n)e.type==="code"?t+=`<code>${e.content}</code>`:e.type==="text"&&(t+=this.processInlineMarkdown(e.content));return t}static tokenize(e){const s=[];let n="",t=0;for(;t<e.length;)if(e[t]==="`"){n&&(s.push({type:"text",content:n}),n=""),t++;let o="";for(;t<e.length&&e[t]!=="`";)o+=e[t],t++;s.push({type:"code",content:o}),t++}else n+=e[t],t++;return n&&s.push({type:"text",content:n}),s}static processInlineMarkdown(e){try{for(const[t,n]of this.patterns.inline)e=e.replace(t,n);return e}catch(t){return MarkdownProcessor._warning("Inline markdown processing failed",t),e}}static selfTest(){try{const e=[{input:"__bold__ and _italic_ text",shouldContain:["<strong>","<em>"]},{input:"[Visit Google](google.com)",shouldContain:['<a href="https://google.com"','target="_blank"']},{input:"[Visit Site](example.com/page.html)",shouldContain:['<a href="https://example.com/page.html"']},{input:"[Highlighted](highlight)",shouldContain:['<span class="inline-highlight"']},{input:"[Internal link](/page)",shouldContain:['<a href="/page"']},{input:"[Anchor](#section)",shouldContain:['<a href="#section"']},{input:"[WWW Site](www.example.com)",shouldContain:['<a href="https://www.example.com"']}];return e.every(e=>{const t=this.process(e.input);return e.shouldContain.every(e=>t.includes(e))})}catch{return!1}}static getStats(){return{selfTest:this.selfTest(),patternCount:{escape:this.patterns.escape.length,block:this.patterns.block.length,inline:this.patterns.inline.length},supportsLinks:!0,supportsInlineClasses:!0,timestamp:(new Date).toISOString()}}}class DOMHelpers{static errorSource=ErrorManager.SOURCES.DOM_HELPERS;constructor(e){if(!e||!(e instanceof Element)){DOMHelpers._critical("Invalid story container provided to DOM helpers",new Error("Invalid story container"));return}this.storyContainer=e}static _error(e,t=null){window.errorManager.error(e,t,DOMHelpers.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,DOMHelpers.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,DOMHelpers.errorSource)}removeAll(e){if(!e||typeof e!="string"){DOMHelpers._warning("Invalid selector passed to removeAll");return}const t=this.storyContainer.querySelectorAll(e);for(let e=0;e<t.length;e++){const n=t[e];try{n?.parentNode&&n.parentNode.removeChild(n)}catch(t){DOMHelpers._warning(`Failed to remove element at index ${e}`,t)}}}setVisible(e,t){if(!e||typeof e!="string"){DOMHelpers._warning("Invalid selector passed to setVisible");return}const n=this.storyContainer.querySelectorAll(e);for(let e=0;e<n.length;e++){const s=n[e];try{if(!s?.classList)continue;t?s.classList.remove("invisible"):s.classList.add("invisible")}catch(t){DOMHelpers._warning(`Failed to set visibility for element at index ${e}`,t)}}}createParagraph(e,t=[]){if(!e||typeof e!="string")return DOMHelpers._warning("Invalid text passed to createParagraph"),null;Array.isArray(t)||(DOMHelpers._warning("Invalid customClasses passed to createParagraph - using empty array"),t=[]);try{const n=document.createElement("p");n.innerHTML=e;for(const e of t)e&&typeof e=="string"&&n.classList.add(e);return this.storyContainer.appendChild(n),n}catch(e){return DOMHelpers._error("Failed to create paragraph",e),null}}createChoice(e,t=[],n=!0,s=null,o=!0,i=[]){(!e||typeof e!="string")&&(DOMHelpers._warning("Invalid choiceText passed to createChoice"),e="[Invalid Choice]"),Array.isArray(t)||(DOMHelpers._warning("Invalid customClasses passed to createChoice - using empty array"),t=[]);try{const a=document.createElement("p");a.classList.add("choice");for(const e of t)e&&typeof e=="string"&&a.classList.add(e);let c="",r="",l="";if(i.length>0){const t=i.map(e=>e.label).join(", ");l=`<span class="sr-only"> (${t})</span>`;const e=e=>{const{icon:t}=e,n=/^[a-z_]+$/.test(t);return n?`<span class="material-icons tone-icon" aria-hidden="true">${t}</span>`:`<span class="tone-icon" aria-hidden="true">${t}</span>`},n=window.storyManager?.settings?.toneIndicatorsTrailing;if(n){const t=i.map(e).join("");r=`<span class="tone-indicator-trailing" aria-hidden="true">${t}</span>`}else if(c=`<span class="tone-indicator-leading" aria-hidden="true">${e(i[0])}</span>`,i.length>1){const t=i.slice(1).map(e).join("");r=`<span class="tone-indicator-trailing" aria-hidden="true">${t}</span>`}}const d=s&&o?`<span class="choice-key-hint">${s}.</span> `:"";return n?a.innerHTML=`<a href="#" role="button" aria-roledescription="choice">${c}${d}${e}${r}${l}</a>`:a.innerHTML=`<span class="unclickable" aria-roledescription="unavailable choice">${c}${d}${e}${r}${l}</span>`,this.storyContainer.appendChild(a),a}catch(e){return DOMHelpers._error("Failed to create choice",e),null}}addChoiceClickHandler(e,t){if(!e||!(e instanceof Element)){DOMHelpers._warning("Invalid choiceElement passed to addChoiceClickHandler");return}if(!t||typeof t!="function"){DOMHelpers._warning("Invalid callback passed to addChoiceClickHandler");return}const n=e.querySelector("a");n?n.addEventListener("click",function(e){try{e.preventDefault(),t()}catch(e){DOMHelpers._error("Choice click handler failed",e)}}):DOMHelpers._warning("No anchor element found in choice for click handler")}clearStoryContent(){this.removeAll("p"),this.removeAll("img"),this.removeAll("figure"),this.removeAll(".stat-bar-container"),this.removeAll(".user-input-inline-container")}scrollToTop(e){if(!e||!(e instanceof Element)){DOMHelpers._warning("Invalid container passed to scrollToTop");return}try{typeof e.scrollTo=="function"?e.scrollTo(0,0):typeof e.scrollTop!="undefined"?(e.scrollTop=0,e.scrollLeft=0):DOMHelpers._warning("Container does not support scrolling operations")}catch(e){DOMHelpers._warning("Failed to scroll to top",e)}}isReady(){return!!this.storyContainer?.parentNode}getStats(){return this.storyContainer?{hasContainer:!0,containerTagName:this.storyContainer.tagName,containerChildren:this.storyContainer.children.length,containerText:this.storyContainer.textContent.length,paragraphCount:this.storyContainer.querySelectorAll("p").length,choiceCount:this.storyContainer.querySelectorAll(".choice").length,imageCount:this.storyContainer.querySelectorAll("img").length}:{hasContainer:!1}}recover(){if(!this.storyContainer?.parentNode){const e=document.querySelector("#story");e?(this.storyContainer=e,DOMHelpers._warning("DOM helpers recovered by finding new story container")):DOMHelpers._error("DOM helpers recovery failed - no story container found")}}}class TagProcessor{static errorSource=ErrorManager.SOURCES.TAG_PROCESSOR;constructor(e,t){this.storyContainer=e||document.querySelector("#story"),this.outerScrollContainer=t||document.querySelector(".outerContainer"),this.audio=null,this.audioLoop=null,this.lastAudioLoopSrc=null;const{TAGS:n}=window.TagRegistry||{};this.tagHandlers=new Map([[n.AUDIO,(e,t)=>{t.specialActions?.push(()=>this.playAudio(e))}],[n.AUDIOLOOP,(e,t)=>{t.specialActions?.push(()=>this.playAudioLoop(e))}],[n.BACKGROUND,(e,t)=>{t.specialActions?.push(()=>this.setBackground(e))}],[n.NOTIFICATION,(e,t)=>{t.specialActions?.push(()=>this.showNotification(e,"info"))}],[n.ACHIEVEMENT,(e,t)=>{t.specialActions?.push(()=>this.showNotification(e,"success",6e3))}],[n.WARNING,(e,t)=>{t.specialActions?.push(()=>this.showNotification(e,"warning"))}],[n.ERROR,(e,t)=>{t.specialActions?.push(()=>this.showNotification(e,"error"))}],[n.CLASS,(e,t)=>{e&&t.customClasses.push(e)}]]),this.simpleTagHandlers=new Map([[n.CLEAR,e=>{e.specialActions?.push(()=>"CLEAR")}],[n.RESTART,e=>{e.specialActions?.push(()=>"RESTART")}],[n.UNCLICKABLE,e=>{e.isClickable=!1}]])}static _error(e,t=null){window.errorManager.error(e,t,TagProcessor.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,TagProcessor.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,TagProcessor.errorSource)}processLineTags(e){try{if(!Array.isArray(e))return TagProcessor._warning("Invalid tags array passed to processLineTags"),{customClasses:[],specialActions:[]};const t={customClasses:[],specialActions:[]};return this._processTags(e,t,"line",!1),t}catch(e){return TagProcessor._error("Failed to process line tags",e),{customClasses:[],specialActions:[]}}}processChoiceTags(e){try{if(!Array.isArray(e))return TagProcessor._warning("Invalid choiceTags array passed to processChoiceTags"),{customClasses:[],isClickable:!0};const t={customClasses:[],isClickable:!0};return this._processTags(e,t,"choice",!0),t}catch(e){return TagProcessor._error("Failed to process choice tags",e),{customClasses:[],isClickable:!0}}}_processTags(e,t,n,s){for(const o of e){const{tagDef:a,tagValue:u,invalid:h,error:r}=TagRegistry.parseTag(o);if(h){r&&TagProcessor._warning(r);continue}const c=this.tagHandlers.get(a);if(c){c(u,t);continue}const l=this.simpleTagHandlers.get(a);if(l){l(t);continue}if(a!==null)continue;if(!o||typeof o!="string")continue;const d=o.includes(":"),i=d?o.split(":")[0].trim():o.trim();if(!i)continue;if(s&&!d&&TagRegistry.isRegisteredToneTag(i)){t.customClasses.push(i.toLowerCase());continue}this.warnUnknownTag(i,n,o)}}playAudio(e){try{if(window.storyManager?.settings&&!window.storyManager.settings.getSetting("audioEnabled"))return;if(!e||typeof e!="string"){TagProcessor._warning("Invalid audio source provided");return}this.audio&&(this.audio.pause(),this.audio.removeAttribute("src"),this.audio.load()),this.audio=new Audio(e),this.audio.play().catch(t=>{TagProcessor._warning(`Failed to play audio: ${e}`,t)})}catch(e){TagProcessor._error("Failed to play audio",e)}}playAudioLoop(e){try{if(!e||typeof e!="string"){TagProcessor._warning("Invalid audio loop source provided");return}if(e.toLowerCase()==="none"||e==="stop"){this.lastAudioLoopSrc=null,this.audioLoop&&(this.audioLoop.pause(),this.audioLoop.removeAttribute("src"),this.audioLoop.load(),this.audioLoop=null);return}if(this.lastAudioLoopSrc=e,window.storyManager?.settings&&!window.storyManager.settings.getSetting("audioEnabled"))return;this.audioLoop&&(this.audioLoop.pause(),this.audioLoop.removeAttribute("src"),this.audioLoop.load(),this.audioLoop=null),this.audioLoop=new Audio(e),this.audioLoop.loop=!0,this.audioLoop.play().catch(t=>{TagProcessor._warning(`Failed to play audio loop: ${e}`,t)})}catch(e){TagProcessor._error("Failed to play audio loop",e)}}stopAllAudio(){try{this.audio&&(this.audio.pause(),this.audio.removeAttribute("src"),this.audio.load(),this.audio=null),this.audioLoop&&(this.audioLoop.pause(),this.audioLoop.removeAttribute("src"),this.audioLoop.load(),this.audioLoop=null)}catch(e){TagProcessor._warning("Failed to stop audio",e)}}resumeAudioLoop(){try{this.lastAudioLoopSrc&&window.storyManager?.settings?.getSetting("audioEnabled")&&this.playAudioLoop(this.lastAudioLoopSrc)}catch(e){TagProcessor._warning("Failed to resume audio loop",e)}}showNotification(e,t="info",n=4e3){window.notificationManager&&window.notificationManager.show(e,{type:t,duration:n})}setBackground(e){try{if(!this.outerScrollContainer){TagProcessor._warning("Outer scroll container not available for background");return}if(!e||typeof e!="string"){TagProcessor._warning("Invalid background source provided");return}e.toLowerCase()==="none"||e===""?this.outerScrollContainer.style.backgroundImage="none":this.outerScrollContainer.style.backgroundImage="url("+e+")"}catch(e){TagProcessor._error("Failed to set background",e)}}warnUnknownTag(e,t,n=""){if(this.warnedTags=this.warnedTags||new Set,this.warnedTags.has(e.toUpperCase()))return;this.warnedTags.add(e.toUpperCase());const o=this.getSimilarTags(e);let s="";o.length>0?s=` Did you mean: ${o.join(", ")}?`:t==="line"?s=" Use # CLASS: for custom CSS classes.":t==="choice"&&(s=" For tone indicators, define with # TONE: tagname icon first."),TagProcessor._warning(`Unknown tag "${e}" on ${t}: "# ${n}".${s}`)}getSimilarTags(e){const{TAGS:n}=window.TagRegistry||{};if(!n)return[];const t=e.toUpperCase(),s=Object.keys(n);return s.filter(e=>!!(t.length>=3&&e.startsWith(t.slice(0,3)))||!!(e.length>=3&&t.startsWith(e.slice(0,3)))||window.Utils.levenshteinDistance(t,e)<=2).slice(0,3)}isReady(){try{return!!(this.storyContainer||this.outerScrollContainer)}catch(e){return TagProcessor._warning("Failed to check readiness",e),!1}}getStats(){try{return{hasStoryContainer:!!this.storyContainer,hasOuterScrollContainer:!!this.outerScrollContainer,hasActiveAudio:!!this.audio,hasActiveAudioLoop:!!this.audioLoop}}catch(e){return TagProcessor._warning("Failed to get stats",e),{}}}cleanup(){try{this.audio&&(this.audio.pause(),this.audio=null),this.audioLoop&&(this.audioLoop.pause(),this.audioLoop=null)}catch(e){TagProcessor._warning("Failed to cleanup",e)}}}window.tagProcessor=new TagProcessor;class BaseModal{static errorSource=ErrorManager.SOURCES.MODAL;static instances=new Set;constructor(e={}){this.config={maxWidth:"500px",width:"90%",maxHeight:"80vh",className:"base-modal",title:"Modal",closeOnBackdrop:!0,closeOnEscape:!0,showCloseButton:!0,showFooter:!0,size:"normal",...e},this.modalElement=null,this.isVisible=!1,this.onShow=e.onShow||null,this.onHide=e.onHide||null,this.previouslyFocusedElement=null,this.init()}init(){this.createModal(),this.setupEventListeners(),BaseModal.instances.add(this)}static _error(e,t=null){window.errorManager.error(e,t,BaseModal.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,BaseModal.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,BaseModal.errorSource)}createModal(){const t=document.createElement("div");t.className=`${this.config.className}-backdrop`,t.setAttribute("role","presentation"),t.style.cssText=`
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); z-index: 1000; display: none;
      opacity: 0; transition: opacity 0.3s ease;
    `;const e=document.createElement("div");if(e.className=`${this.config.className}-content`,e.style.cssText=`
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: var(--color-background);
      border: 1px solid var(--color-border-medium);
      border-radius: var(--border-radius-lg);
      padding: 2rem; max-width: ${this.config.maxWidth}; width: ${this.config.width}; 
      max-height: ${this.config.maxHeight};
      overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease; z-index: 1001;
    `,e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby",`${this.config.className}-title`),e.setAttribute("tabindex","-1"),e.innerHTML=this.getModalHTML(),t.appendChild(e),!document.body){BaseModal._error("Cannot create modal - document.body not available");return}document.body.appendChild(t),this.modalElement=t}getModalHTML(){return`
      <div class="modal-header">
        <h2 id="${this.config.className}-title" style="margin: 0 0 1.5rem 0; color: var(--color-text-strong); font-size: 1.5rem;">${this.config.title}</h2>
        ${this.config.showCloseButton?`
          <button class="modal-close" aria-label="Close" style="
            position: absolute; top: 1rem; right: 1rem; background: none; border: none;
            font-size: 1.5rem; color: var(--color-text-secondary); cursor: pointer;
            padding: 0.5rem; border-radius: var(--border-radius);
          ">&times;</button>
        `:""}
      </div>

      <div class="modal-body">
        <!-- Content will be injected here -->
      </div>

      ${this.config.showFooter?`
        <div class="modal-footer" style="margin-top: 2rem; text-align: right; border-top: 1px solid var(--color-border-light); padding-top: 1rem;">
          <!-- Footer content will be injected here -->
        </div>
      `:""}
    `}setupEventListeners(){if(!this.modalElement)return;this.focusTrapHandler=e=>{if(e.key!=="Tab"||!this.isVisible)return;const o=this.modalElement.querySelector(`.${this.config.className}-content`),t=o?.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(!t?.length)return;const n=t[0],s=t[t.length-1];e.shiftKey&&document.activeElement===n?(e.preventDefault(),s.focus()):!e.shiftKey&&document.activeElement===s&&(e.preventDefault(),n.focus())},document.addEventListener("keydown",this.focusTrapHandler);const e=this.modalElement.querySelector(".modal-close");e&&e.addEventListener("click",()=>this.hide()),this.config.closeOnBackdrop&&this.modalElement.addEventListener("click",e=>{e.target===this.modalElement&&this.hide()}),this.config.closeOnEscape&&(this.escapeHandler=e=>{e.key==="Escape"&&this.isVisible&&this.hide()},document.addEventListener("keydown",this.escapeHandler))}show(e=null){if(BaseModal.closeAll(this),!this.modalElement){BaseModal._error("Cannot show modal - modal element not available");return}if(this.previouslyFocusedElement=document.activeElement,e&&typeof e=="function")try{e(this)}catch(e){BaseModal._error("Failed to populate modal content",e)}if(this.modalElement.style.display="block",this.isVisible=!0,requestAnimationFrame(()=>{if(this.modalElement){this.modalElement.style.opacity="1";const e=this.modalElement.querySelector(`.${this.config.className}-content`);e&&(e.style.transform="translate(-50%, -50%) scale(1)");const t=e?.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');t?.length?t[0].focus():e?.focus()}}),this.onShow&&typeof this.onShow=="function")try{this.onShow()}catch(e){BaseModal._warning("Modal onShow callback failed",e)}}hide(){if(!this.modalElement)return;this.modalElement.style.opacity="0";const e=this.modalElement.querySelector(`.${this.config.className}-content`);if(e&&(e.style.transform="translate(-50%, -50%) scale(0.9)"),setTimeout(()=>{this.modalElement&&(this.modalElement.style.display="none",this.isVisible=!1,this.previouslyFocusedElement?.focus())},300),this.onHide&&typeof this.onHide=="function")try{this.onHide()}catch(e){BaseModal._warning("Modal onHide callback failed",e)}}toggle(){this.isVisible?this.hide():this.show()}setContent(e){const t=this.modalElement?.querySelector(".modal-body");t&&(t.innerHTML=e)}setFooter(e){const t=this.modalElement?.querySelector(".modal-footer");t&&(t.innerHTML=e)}getBody(){return this.modalElement?.querySelector(".modal-body")}getFooter(){return this.modalElement?.querySelector(".modal-footer")}addBodyEventListener(e,t,n){if(!this.modalElement)return;const s=this.modalElement.querySelectorAll(e);s.forEach(e=>{e.addEventListener(t,n)})}showNotification(e,t=!1,n=4e3){const s=t?"error":"success";window.notificationManager.show(e,{type:s,duration:n})}createButton(e,t={}){const n=document.createElement("button");return n.textContent=e,n.className=`modal-button modal-button-${t.variant||"primary"}`,t.onClick&&typeof t.onClick=="function"&&n.addEventListener("click",t.onClick),t.styles&&Object.entries(t.styles).forEach(([e,t])=>{n.style[e]=t}),n}isReady(){return!!(this.modalElement&&document.body)}getStats(){return{hasModalElement:!!this.modalElement,isVisible:this.isVisible,className:this.config.className,hasEscapeHandler:!!this.escapeHandler,size:this.config.size}}destroy(){try{BaseModal.instances.delete(this),this.escapeHandler&&(document.removeEventListener("keydown",this.escapeHandler),this.escapeHandler=null),this.focusTrapHandler&&(document.removeEventListener("keydown",this.focusTrapHandler),this.focusTrapHandler=null),this.modalElement&&this.modalElement.parentNode&&this.modalElement.parentNode.removeChild(this.modalElement),this.modalElement=null,this.isVisible=!1}catch(e){BaseModal._warning("Failed to destroy modal",e)}}showConfirmation(e,t,n,s={}){const a={title:"Confirm",confirmText:"Yes",cancelText:"Cancel",confirmVariant:"danger"},o={...a,...s},i={...this.config};this.config.title=o.title,this.config.closeOnBackdrop=!1,this.config.closeOnEscape=!0,this.show(s=>{s.setContent(`<p style="margin: 0; color: var(--color-text-primary);">${e}</p>`);const a=s.getFooter();if(a){a.innerHTML="",a.style.display="flex",a.style.justifyContent="flex-end",a.style.gap="0.5rem";const e=s.createButton(o.cancelText,{variant:"secondary",onClick:()=>{s.hide(),n&&n(),Object.assign(this.config,i)}}),r=s.createButton(o.confirmText,{variant:o.confirmVariant,onClick:()=>{s.hide(),t&&t(),Object.assign(this.config,i)}});a.appendChild(e),a.appendChild(r)}}),this.escapeHandler&&document.removeEventListener("keydown",this.escapeHandler),this.escapeHandler=e=>{e.key==="Escape"&&this.isVisible&&(this.hide(),n&&n(),Object.assign(this.config,i))},document.addEventListener("keydown",this.escapeHandler)}static closeAll(e=null){for(const t of BaseModal.instances)t!==e&&t.isVisible&&t.hide()}static hasVisibleModal(){for(const e of BaseModal.instances)if(e.isVisible)return!0;return!1}static confirm({title:e,message:t,confirmText:n="Yes",cancelText:s="Cancel",confirmVariant:o="danger",onConfirm:i,onCancel:a}){const r=new BaseModal({title:e||"Confirm",className:"confirm-modal",maxWidth:"400px",showFooter:!0});r.showConfirmation(t,()=>{i?.(),r.destroy()},()=>{a?.(),r.destroy()},{title:e,confirmText:n,cancelText:s,confirmVariant:o})}}class SettingsManager{static errorSource=ErrorManager.SOURCES.SETTINGS_MANAGER;constructor(){this.settings=this.getDefaults(),this.toneIndicatorsAvailable=!1,this.authorToneIndicators=!0,this.toneIndicatorsTrailing=!1,this.toneMap={},this.authorChoiceNumbering="auto",this.init()}init(){this.loadSettings(),this.createSettingsModal(),this.setupEventListeners(),this.setupThemeDetection(),this.applySettings()}static _error(e,t=null){window.errorManager.error(e,t,SettingsManager.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,SettingsManager.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,SettingsManager.errorSource)}getDefaults(){return{theme:"auto",textSize:"medium",lineHeight:"normal",fontFamily:"serif",audioEnabled:!0,autoSave:!0,animations:!0,toneIndicators:this.authorToneIndicators||!1,choiceNumbering:this.authorChoiceNumbering||"auto",keyboardShortcuts:!0}}createSettingsModal(){this.modal=new BaseModal({title:"Settings",className:"settings-modal",maxWidth:"500px",onShow:()=>this.populateSettings(),onHide:()=>this.saveSettings()})}setupThemeDetection(){const e=window.matchMedia("(prefers-color-scheme: dark)");e.addEventListener("change",()=>{this.settings.theme==="auto"&&this.applyTheme()})}processGlobalTags(e){if(!Array.isArray(e))return;const{TAGS:t,getTagDef:n}=window.TagRegistry||{};if(!t||!n)return;for(const s of e){if(typeof s!="string")continue;const{tagDef:o,tagValue:n,invalid:i}=TagRegistry.parseTag(s);if(i)continue;switch(o){case t.THEME:const i=this.getStoredSettings();i?.theme||(this.settings.theme=n==="dark"?"dark":"light");break;case t.TITLE:const a=document.querySelectorAll(".title");a.forEach(e=>e.textContent=n);break;case t.AUTHOR:const s=document.querySelector(".byline");s&&(s.textContent=`by ${n}`);break;case t.CHOICE_NUMBERS:{const e=n.toLowerCase();e==="off"?this.authorChoiceNumbering="off":e==="on"?this.authorChoiceNumbering="on":this.authorChoiceNumbering="auto";const t=this.getStoredSettings();t?.choiceNumbering||(this.settings.choiceNumbering=this.authorChoiceNumbering),this.applyChoiceNumbering();break}case t.TONE_INDICATORS:const o=n.toLowerCase();this.toneIndicatorsAvailable=!0,this.authorToneIndicators=o!=="off"||!1,this.settings.toneIndicators=o!=="off";break;case t.TONE_TRAILING:this.toneIndicatorsTrailing=!0;break;case t.TONE:const e=n.indexOf(" ");if(e!==-1){const t=n.substring(0,e).trim().toLowerCase(),s=n.substring(e+1).trim();this.toneMap[t]=s}break}}}applyTheme(){const e=document.body,t=document.documentElement;if(!e)return;if(e.classList.remove("dark"),t.classList.remove("dark"),this.settings.theme==="dark")e.classList.add("dark"),t.classList.add("dark");else if(this.settings.theme==="auto"){const n=window.matchMedia("(prefers-color-scheme: dark)").matches;n&&(e.classList.add("dark"),t.classList.add("dark"))}e.classList.add("switched")}toggleTheme(){const e=document.body?.classList.contains("dark");this.settings.theme==="auto"?this.settings.theme=e?"light":"dark":this.settings.theme==="light"?this.settings.theme="dark":this.settings.theme="light",this.storeSettings(),this.applyTheme()}isAnimationEnabled(){return this.settings.animations}getStoredSettings(){try{const e=localStorage.getItem("ink-template-settings");return e?JSON.parse(e):null}catch{return null}}getSettingsHTML(){const e=window.StoryFeatures?.hasAudio;return`
      ${this.renderSettingsTabs()}
      <div class="settings-panels">
        ${this.renderReadingPanel()}
        ${this.renderAccessibilityPanel()}
        ${this.renderAudioPanel()}
      </div>
  `}renderSettingsTabs(){const e=window.StoryFeatures?.hasAudio;return`
    <div class="settings-tabs" role="tablist" aria-label="Settings categories">
      ${this.renderSettingsTab("reading","auto_stories","Reading",!0)}
      ${this.renderSettingsTab("accessibility","accessibility_new","Accessibility")}
      ${e?this.renderSettingsTab("audio","volume_up","Audio"):""}
    </div>
    `}renderSettingsTab(e,t,n,s=!1){return`
      <button role="tab" class="settings-tab ${s?"active":""}" 
              id="tab-${e}"
              data-tab="${e}" 
              aria-selected="${s}" 
              aria-controls="panel-${e}"
              tabindex="${s?"0":"-1"}">
        <span class="material-icons" aria-hidden="true">${t}</span>
        <span class="sr-only">${n}</span>
      </button>
    `}renderReadingPanel(){return`
    <div role="tabpanel" class="settings-panel active" id="panel-reading" aria-labelledby="tab-reading">
    ${this.renderDropdownSetting("theme","setting-theme","Theme",[{value:"auto",label:"Auto (System)"},{value:"light",label:"Light"},{value:"dark",label:"Dark"}])}
    ${this.renderDropdownSetting("fontFamily","setting-font","Font Family",[{value:"serif",label:"Serif"},{value:"sans",label:"Sans-serif"},{value:"dyslexic",label:"OpenDyslexic"}])}
    ${this.renderDropdownSetting("textSize","setting-size","Text Size",[{value:"small",label:"Small"},{value:"medium",label:"Medium"},{value:"large",label:"Large"},{value:"xl",label:"Extra Large"}])}
    ${this.renderDropdownSetting("lineHeight","setting-lineheight","Line Height",[{value:"tight",label:"Tight"},{value:"normal",label:"Normal"},{value:"loose",label:"Loose"}])}
      ${this.renderCheckboxSetting("autoSave","Auto Save Progress")}
    </div>
    `}renderAccessibilityPanel(){return`
    <div role="tabpanel" class="settings-panel" id="panel-accessibility" aria-labelledby="tab-accessibility">

      ${this.renderCheckboxSetting("animations","Enable Animations")}
      ${this.toneIndicatorsAvailable?this.renderCheckboxSetting("toneIndicators","Show tone indicators on choices"):""}
      ${this.renderDropdownSetting("choiceNumbering","setting-choicenumbering","Choice Number Hints",[{value:"auto",label:"Auto (hide on mobile)"},{value:"on",label:"Always Show"},{value:"off",label:"Always Hide"}])}
      ${window.keyboardHelpModal?.isAvailable()?this.renderCheckboxSetting("keyboardShortcuts","Enable Keyboard Shortcuts"):""}
      ${window.keyboardHelpModal?.isAvailable()?this.renderButtonSetting("keyboard-help-btn","Keyboard Shortcuts"):""}
    </div>
  `}renderAudioPanel(){return window.StoryFeatures?.hasAudio?`
    <div role="tabpanel" class="settings-panel" id="panel-audio" aria-labelledby="tab-audio">
      ${this.renderCheckboxSetting("audioEnabled","Enable Audio")}
    </div>`:""}renderCheckboxSetting(e,t){return`
      <div class="setting-item">
        <label class="setting-checkbox-label">
          <input type="checkbox" name="${e}" class="setting-checkbox">
          <span>${t}</span>
        </label>
      </div>`}renderDropdownSetting(e,t,n,s){const o=s.map(e=>`<option value="${e.value}">${e.label}</option>`).join(`
          `);return`
      <div class="setting-item">
        <label class="setting-label" for="${t}">${n}</label>
        <select name="${e}" id="${t}" class="setting-select">
          ${o}
        </select>
      </div>`}renderButtonSetting(e,t){return`
      <div class="setting-item">
        <button type="button" class="${e}">${t}</button>
      </div>`}setupEventListeners(){const e=document.getElementById("settings-btn");e&&e.addEventListener("click",e=>{e.preventDefault(),this.showSettings()})}showSettings(){if(!this.modal?.isReady()){SettingsManager._error("Cannot show settings - modal not available");return}this.modal.show(e=>{e.setContent(this.getSettingsHTML());const t=e.getFooter();if(t){t.innerHTML="",t.style.display="flex",t.style.justifyContent="space-between";const n=e.createButton("Reset to Defaults",{variant:"secondary",onClick:()=>this.resetSettings()}),s=e.createButton("Done",{variant:"primary",onClick:()=>this.hideSettings()});t.appendChild(n),t.appendChild(s)}this.setupTabSwitching(),this.setupRealtimePreview(),this.updateKeyboardHelpButtonVisibility();const n=this.modal.modalElement.querySelector(".keyboard-help-btn");n&&n.addEventListener("click",()=>{this.hideSettings(),window.keyboardHelpModal?.show?.()})})}hideSettings(){this.modal?.hide()}setupRealtimePreview(){if(!this.modal?.modalElement)return;const e={theme:this.modal.modalElement.querySelector('select[name="theme"]'),fontFamily:this.modal.modalElement.querySelector('select[name="fontFamily"]'),textSize:this.modal.modalElement.querySelector('select[name="textSize"]'),lineHeight:this.modal.modalElement.querySelector('select[name="lineHeight"]'),toneIndicators:this.modal.modalElement.querySelector('input[name="toneIndicators"]'),choiceNumbering:this.modal.modalElement.querySelector('select[name="choiceNumbering"]'),keyboardShortcuts:this.modal.modalElement.querySelector('input[name="keyboardShortcuts"]')};Object.entries(e).forEach(([e,t])=>{t&&t.addEventListener("change",()=>{t.type==="checkbox"?this.settings[e]=t.checked:this.settings[e]=t.value,this.applyIndividualSetting(e)})})}setupTabSwitching(){if(!this.modal?.modalElement)return;const e=this.modal.modalElement.querySelectorAll(".settings-tab");e.forEach(t=>{t.addEventListener("click",()=>this.switchTab(t.dataset.tab)),t.addEventListener("keydown",t=>this.handleTabKeydown(t,e))})}switchTab(e){if(!this.modal?.modalElement)return;const t=this.modal.modalElement.querySelectorAll(".settings-tab");t.forEach(t=>{const n=t.dataset.tab===e;t.classList.toggle("active",n),t.setAttribute("aria-selected",n),t.setAttribute("tabindex",n?"0":"-1")});const n=this.modal.modalElement.querySelectorAll(".settings-panel");n.forEach(t=>{t.classList.toggle("active",t.id===`panel-${e}`)})}handleTabKeydown(e,t){const n=Array.from(t),o=n.findIndex(t=>t===e.target);let s;switch(e.key){case"ArrowRight":case"ArrowDown":e.preventDefault(),s=(o+1)%n.length;break;case"ArrowLeft":case"ArrowUp":e.preventDefault(),s=(o-1+n.length)%n.length;break;case"Home":e.preventDefault(),s=0;break;case"End":e.preventDefault(),s=n.length-1;break;default:return}n[s].focus(),this.switchTab(n[s].dataset.tab)}applyIndividualSetting(e){switch(e){case"theme":this.applyTheme();break;case"fontFamily":this.applyFontFamily();break;case"textSize":this.applyTextSize();break;case"lineHeight":this.applyLineHeight();break;case"toneIndicators":this.refreshChoices();break;case"choiceNumbering":this.applyChoiceNumbering();break;case"keyboardShortcuts":this.applyKeyboardShortcuts();break}}applyChoiceNumbering(){document.body?.classList.remove("choice-numbers-on","choice-numbers-off","choice-numbers-auto"),document.body?.classList.add(`choice-numbers-${this.settings.choiceNumbering||"auto"}`)}populateSettings(){if(!this.modal?.modalElement)return;const e=[{name:"theme",value:this.settings.theme},{name:"fontFamily",value:this.settings.fontFamily},{name:"textSize",value:this.settings.textSize},{name:"lineHeight",value:this.settings.lineHeight},{name:"audioEnabled",checked:this.settings.audioEnabled},{name:"autoSave",checked:this.settings.autoSave},{name:"animations",checked:this.settings.animations},{name:"choiceNumbering",value:this.settings.choiceNumbering},{name:"toneIndicators",checked:this.settings.toneIndicators},{name:"keyboardShortcuts",checked:this.settings.keyboardShortcuts}];e.forEach(({name:e,value:t,checked:n})=>{const s=this.modal.modalElement.querySelector(`[name="${e}"]`);s&&(typeof n!="undefined"?s.checked=n:s.value=t)})}saveSettings(){if(!this.modal?.modalElement)return;const e=(e,t=!1)=>{const n=this.modal.modalElement.querySelector(`[name="${e}"]`);return n?t?n.checked:n.value:null},t=this.settings.audioEnabled;this.settings.theme=e("theme")||this.settings.theme,this.settings.fontFamily=e("fontFamily")||this.settings.fontFamily,this.settings.textSize=e("textSize")||this.settings.textSize,this.settings.lineHeight=e("lineHeight")||this.settings.lineHeight,this.settings.audioEnabled=e("audioEnabled",!0)??this.settings.audioEnabled,this.settings.autoSave=e("autoSave",!0)??this.settings.autoSave,this.settings.animations=e("animations",!0)??this.settings.animations,this.settings.choiceNumbering=e("choiceNumbering")||this.settings.choiceNumbering,this.settings.toneIndicators=e("toneIndicators",!0)??this.settings.toneIndicators,this.settings.keyboardShortcuts=e("keyboardShortcuts",!0)??this.settings.keyboardShortcuts,this.handleAudioSettingChange(t,this.settings.audioEnabled),this.storeSettings(),this.applySettings(),this.modal.showNotification("Settings saved successfully!")}handleAudioSettingChange(e,t){try{const n=window.storyManager?.contentProcessor?.tagProcessor;if(!n)return;e&&!t?n.stopAllAudio():!e&&t&&n.resumeAudioLoop()}catch(e){SettingsManager._warning("Failed to handle audio setting change",e)}}resetSettings(){this.settings=this.getDefaults(),this.populateSettings(),this.applySettings(),this.modal.showNotification("Settings reset to defaults")}applySettings(){this.applyTheme(),this.applyFontFamily(),this.applyTextSize(),this.applyLineHeight(),this.applyAnimations(),this.applyChoiceNumbering(),this.applyKeyboardShortcuts()}applyFontFamily(){const e=document.documentElement;if(!e)return;const t={serif:"var(--font-serif)",sans:"var(--font-sans)",dyslexic:"var(--font-dyslexic)"};e.style.setProperty("--font-main",t[this.settings.fontFamily]||t.serif)}applyTextSize(){const e=document.documentElement;if(!e)return;const t={small:"11pt",medium:"13pt",large:"15pt",xl:"17pt"};e.style.setProperty("--text-size-base",t[this.settings.textSize]||t.medium)}applyLineHeight(){const e=document.documentElement;if(!e)return;const t={tight:"1.4em",normal:"1.7em",loose:"2.0em"},n=t[this.settings.lineHeight]||t.normal;e.style.setProperty("--line-height-text",n),e.style.setProperty("--line-height-choice",n)}applyAnimations(){const e=document.documentElement;if(!e)return;this.settings.animations?(e.style.setProperty("--transition-fast","0.1s"),e.style.setProperty("--transition-medium","0.2s"),e.style.setProperty("--transition-slow","0.6s"),e.style.setProperty("--transition-very-slow","1s")):(e.style.setProperty("--transition-fast","0s"),e.style.setProperty("--transition-medium","0s"),e.style.setProperty("--transition-slow","0s"),e.style.setProperty("--transition-very-slow","0s"))}applyKeyboardShortcuts(){this.settings.keyboardShortcuts?window.keyboardShortcuts?.enable?.():window.keyboardShortcuts?.disable?.(),this.updateKeyboardHelpButtonVisibility()}updateKeyboardHelpButtonVisibility(){const e=this.modal?.modalElement?.querySelector(".keyboard-help-btn");e&&(e.closest(".setting-item").style.display=this.settings.keyboardShortcuts?"":"none")}refreshChoices(){window.storyManager?.display?.domHelpers&&window.storyManager?.story?.currentChoices?.length>0&&(window.storyManager.display.domHelpers.removeAll(".choice"),window.storyManager.createChoices())}loadSettings(){try{const e=this.getStoredSettings();e&&(this.settings={...this.settings,...e})}catch(e){SettingsManager._warning("Failed to load settings",e)}}storeSettings(){try{localStorage.setItem("ink-template-settings",JSON.stringify(this.settings))}catch(e){SettingsManager._error("Failed to store settings",e)}}getSetting(e){return this.settings[e]}setSetting(e,t){e in this.settings&&(this.settings[e]=t,this.storeSettings(),this.applySettings())}isReady(){return!!(this.modal?.isReady()&&document.documentElement)}getStats(){return{hasModal:!!this.modal,currentTheme:this.settings.theme,settingsCount:Object.keys(this.settings).length}}getToneIndicators(e){if(!this.toneIndicatorsAvailable||!this.settings.toneIndicators)return[];const t=[];for(const s of e){if(typeof s!="string")continue;const n=s.trim().toLowerCase();this.toneMap[n]&&t.push({label:n,icon:this.toneMap[n]})}return t}}const REFRESH_DELAY_MS=100;class SavesModalManager{static errorSource=ErrorManager.SOURCES.SAVES_MODAL;constructor(e){if(this.gameSaveSystem=e,this.maxSaveSlots=e.maxSaveSlots,this.autosaveSlot=e.autosaveSlot,this.confirmModal=null,!this.gameSaveSystem){SavesModalManager._critical("SavesModalManager requires a save system",new Error("Invalid save system"));return}this.init()}init(){this.createModal(),this.createConfirmModal()}static _error(e,t=null){window.errorManager.error(e,t,SavesModalManager.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,SavesModalManager.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,SavesModalManager.errorSource)}createModal(){this.modal=new BaseModal({title:"Save & Load Game",className:"saves-modal",maxWidth:"600px",onShow:()=>this.populateSaveSlots()})}createConfirmModal(){this.confirmModal=new BaseModal({title:"Confirm",className:"confirm-modal",maxWidth:"400px",showFooter:!0})}show(){this.modal?.show()}hide(){this.modal?.hide()}populateSaveSlots(){if(!this.modal?.modalElement)return;const t=`
      <div class="saves-section">
        <h3>Save Slots</h3>
        <div class="save-slots-container">
          ${this.generateSaveSlotsHTML()}
        </div>
        <div class="import-export-info">
          <strong>Tip:</strong> Use "Export" to save a slot to a file. Use "Import Here" on empty slots to load save files. Press Ctrl+S to quickly open this dialog.
        </div>
      </div>
    `;this.modal.setContent(t);const e=this.modal.getFooter();if(e){e.innerHTML="",e.style.textAlign="right";const t=this.modal.createButton("Close",{variant:"primary",onClick:()=>this.hide()});e.appendChild(t)}this.setupSlotEventListeners()}generateSaveSlotsHTML(){let e="";e+=this.createSaveSlotHTML(this.autosaveSlot,!0);for(let t=1;t<=this.maxSaveSlots;t++)e+=this.createSaveSlotHTML(t,!1);return e}createSaveSlotHTML(e,t=!1){try{const n=this.gameSaveSystem.getSaveData(e),s=!n;return s?`<div class="save-slot ${t?"autosave-slot":""}" data-slot="${e}">
          ${this.createEmptySlotHTML(e,t)}
        </div>`:`<div class="save-slot ${t?"autosave-slot":""}" data-slot="${e}">
          ${this.createFilledSlotHTML(e,n,t)}
        </div>`}catch(e){return SavesModalManager._error("Failed to create save slot HTML",e),""}}createEmptySlotHTML(e,t){const s=t?"Autosave":`Slot ${e}`,o=t?"No autosave available":"Empty",n=t?"Game will autosave after choices when enabled in settings":"";return`
      <div class="save-slot-content">
        <div class="save-slot-info">
          <strong class="save-slot-name">${s}</strong>
          <div class="save-slot-description">${o}</div>
          ${n?`<div class="save-slot-detail">${n}</div>`:""}
        </div>
        <div class="save-slot-actions">
          ${t?"":this.createActionButton("Save Here","save-to-slot","primary")}
          ${t?"":this.createActionButton("Import Here","import-to-slot","secondary")}
        </div>
      </div>
    `}createFilledSlotHTML(e,t,n){const s=n?"Autosave":`Slot ${e}`,o=new Date(t.timestamp).toLocaleString();return`
      <div class="save-slot-content">
        <div class="save-slot-info">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <strong class="save-slot-name">${s}</strong>
            <span class="save-slot-timestamp">${o}</span>
          </div>
          <div class="save-slot-description">
            ${t.saveName||"Saved Game"}
          </div>
          ${t.description?`<div class="save-slot-detail">${t.description}</div>`:""}
        </div>
        <div class="save-slot-actions">
          ${this.createActionButton("Load","load-from-slot","secondary")}
          ${this.createActionButton("Export","export-from-slot","primary")}
          ${n?"":this.createActionButton("Overwrite","overwrite-slot","warning")}
          ${this.createActionButton(n?"Clear":"Delete","delete-slot","danger")}
        </div>
      </div>
    `}createActionButton(e,t,n){return`<button class="${t} save-action-button save-action-${n}">${e}</button>`}setupSlotEventListeners(){if(!this.modal?.modalElement)return;this.setupSlotHoverEffects(),this.setupSlotActionHandlers()}setupSlotHoverEffects(){const e=this.modal.modalElement.querySelectorAll(".save-slot");e.forEach(e=>{const t=e.classList.contains("autosave-slot");e.addEventListener("mouseenter",()=>{e.style.background=t?"var(--color-background)":"var(--color-hover-bg)",t&&(e.style.color="white")}),e.addEventListener("mouseleave",()=>{e.style.background=t?"var(--color-hover-bg)":"transparent",e.style.color=""})})}setupSlotActionHandlers(){const e={"save-to-slot":e=>this.gameSaveSystem.saveToSlot(e),"load-from-slot":e=>this.gameSaveSystem.loadFromSlot(e),"export-from-slot":e=>this.gameSaveSystem.exportFromSlot(e),"import-to-slot":e=>this.gameSaveSystem.importToSlot(e),"overwrite-slot":e=>this.gameSaveSystem.saveToSlot(e),"delete-slot":e=>this.handleDeleteSlot(e)};Object.entries(e).forEach(([e,t])=>{this.bindSlotAction(e,t)})}handleDeleteSlot(e){const t=this.modal.modalElement.querySelector(`[data-slot="${e}"]`),n=t?.classList.contains("autosave-slot");this.gameSaveSystem.deleteSlot(e,n)}bindSlotAction(e,t){this.modal.addBodyEventListener(`.${e}`,"click",e=>{try{const s=e.target.closest("[data-slot]"),n=parseInt(s?.dataset.slot);n!=n||(t(n),setTimeout(()=>this.populateSaveSlots(),REFRESH_DELAY_MS))}catch(e){SavesModalManager._error("Save slot action failed",e)}})}showNotification(e,t=!1,n=4e3){this.modal?.showNotification(e,t,n)}isReady(){return!!(this.modal?.isReady()&&this.gameSaveSystem)}getStats(){return{hasModal:!!this.modal,hasGameSaveSystem:!!this.gameSaveSystem,maxSaveSlots:this.maxSaveSlots,autosaveSlot:this.autosaveSlot,modalVisible:this.modal?.isVisible||!1}}}const MAX_IMPORT_SIZE_BYTES=10*1024*1024,IMPORT_TIMEOUT_MS=3e4;class SaveSystem{static errorSource=ErrorManager.SOURCES.SAVE_SYSTEM;constructor(e){this.storyManager=e,this.savePrefix="ink-save-slot-",this.autosaveSlot=0,this.maxSaveSlots=5,this.modal=new SavesModalManager(this),this.setupEventListeners()}static _error(e,t=null){window.errorManager.error(e,t,SaveSystem.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,SaveSystem.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,SaveSystem.errorSource)}setupEventListeners(){const e=document.getElementById("saves-btn");e&&e.addEventListener("click",e=>{e.preventDefault(),this.showSaveDialog()})}saveToSlot(e){try{this.validateSlotNumber(e),this.requireStorage();const t=this.buildSaveData(e);return this.writeSaveData(e,t),this.notifySaveSuccess(e),this.modal?.populateSaveSlots?.(),!0}catch(e){return SaveSystem._error("Failed to save game",e),!1}}validateSlotNumber(e){if(typeof e!="number"||e<0)throw new Error(`Invalid slot number: ${e}`)}requireStorage(){if(!this.isStorageAvailable())throw new Error("localStorage not available")}buildSaveData(e){const t=this.storyManager.pages?.isViewingSpecialPage?.();return{gameState:this.getGameState(t),displayState:this.getDisplayState(t),saveName:this.generateSaveName(e),description:this.generateDescription(),timestamp:Date.now(),version:"1.0",isAutosave:e===this.autosaveSlot,currentPage:null,stateBeforeUserInput:this.storyManager.stateBeforeUserInput||null}}getGameState(e){return e?this.storyManager.pages.savedStoryState:this.storyManager.story.state.ToJson()}getDisplayState(e){return e?this.storyManager.pages.savedDisplayState:this.storyManager.display.getState()}notifySaveSuccess(e){e!==this.autosaveSlot&&this.showNotification(`Game saved to Slot ${e}!`)}loadFromSlot(e){try{const t=this.getSaveData(e);if(!t){const t=e===this.autosaveSlot?"autosave":"this slot";throw new Error(`No save data found in ${t}`)}if(!t.gameState)throw new Error("Save data is corrupted - missing game state");this.storyManager.loadState(t);const n=e===this.autosaveSlot?"Autosave":`Slot ${e}`;return this.showNotification(`Game loaded from ${n}!`),this.hideSaveDialog(),!0}catch(e){return SaveSystem._error("Failed to load game",e),!1}}autosave(){if(!this.shouldAutosave()||this.storyManager.pages?.isViewingSpecialPage?.())return;try{this.saveToSlot(this.autosaveSlot),console.log("[AUTOSAVE] Game autosaved successfully")}catch(e){SaveSystem._error("Autosave failed",e)}}deleteSlot(e,t=!1){console.log("Modal check:",this.modal,this.modal?.confirmModal);try{const s=t?"autosave":`Slot ${e}`,n=t?"Are you sure you want to clear the autosave?":`Are you sure you want to delete the save in Slot ${e}?`;if(this.modal&&this.modal.confirmModal)return this.modal.confirmModal.showConfirmation(n,()=>{try{if(!this.isStorageAvailable())throw new Error("localStorage not available");const n=this.savePrefix+e;localStorage.removeItem(n);const s=t?"Autosave cleared.":`Slot ${e} deleted.`;this.showNotification(s),this.modal?.populateSaveSlots?.()}catch(e){SaveSystem._error("Failed to delete save slot",e)}},null,{title:"Delete Save",confirmText:"Delete",cancelText:"Cancel"}),!0;if(confirm(n)){if(!this.isStorageAvailable())throw new Error("localStorage not available");const n=this.savePrefix+e;localStorage.removeItem(n);const s=t?"Autosave cleared.":`Slot ${e} deleted.`;return this.showNotification(s),this.modal?.populateSaveSlots?.(),!0}return!1}catch(e){return SaveSystem._error("Failed to delete save slot",e),!1}}exportFromSlot(e){try{const n=this.getSaveData(e);if(!n)throw new Error("No save data found in this slot to export");const s=JSON.stringify(n,null,2),o=new Blob([s],{type:"application/json"}),t=document.createElement("a");t.href=URL.createObjectURL(o);const i=new Date(n.timestamp).toISOString().slice(0,19).replace(/:/g,"-"),a=e===this.autosaveSlot?"autosave":`slot${e}`;t.download=`ink-story-${a}-${i}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t);const r=e===this.autosaveSlot?"Autosave":`Slot ${e}`;return this.showNotification(`Save exported from ${r}!`),!0}catch(e){return SaveSystem._error("Failed to export save",e),!1}}importToSlot(e){const t=document.createElement("input");t.type="file",t.accept=".json",t.style.display="none",t.addEventListener("change",n=>{const o=n.target.files[0];if(!o)return;if(o.size>MAX_IMPORT_SIZE_BYTES){const e=MAX_IMPORT_SIZE_BYTES/(1024*1024);SaveSystem._error(`Import file too large (>${e}MB)`,new Error("File size exceeds limit"));return}const s=new FileReader,i=setTimeout(()=>{s.abort(),SaveSystem._error("File import timed out",new Error("FileReader timeout"))},IMPORT_TIMEOUT_MS);s.onload=t=>{clearTimeout(i);try{const n=JSON.parse(t.target.result);if(!n?.gameState||!n?.version)throw new Error("Invalid save file format");const s=this.storyManager.createTempStory();s.state.LoadJson(n.gameState),this.writeSaveData(e,n);const o=e===this.autosaveSlot?"Autosave":`Slot ${e}`;this.showNotification(`Save imported to ${o}!`),this.modal?.populateSaveSlots?.()}catch(e){SaveSystem._error("Failed to import save file",e)}},s.onerror=()=>{clearTimeout(i),SaveSystem._error("Failed to read import file",s.error)},s.readAsText(o),n.target.value="",document.body.removeChild(t)}),document.body.appendChild(t),t.click()}isStorageAvailable(){try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}showSaveDialog(){this.modal?.show?.()}hideSaveDialog(){this.modal?.hide?.()}hasSaves(){if(this.getSaveData(this.autosaveSlot))return!0;for(let e=1;e<=this.maxSaveSlots;e++)if(this.getSaveData(e))return!0;return!1}getSaveData(e){try{if(!this.isStorageAvailable())return null;const n=this.savePrefix+e,t=localStorage.getItem(n);return t?JSON.parse(t):null}catch(e){return SaveSystem._error("Failed to get save data",e),null}}writeSaveData(e,t){if(!this.isStorageAvailable())throw new Error("localStorage not available");const n=this.savePrefix+e,s=JSON.stringify(t);try{localStorage.setItem(n,s)}catch(e){if(e.name==="QuotaExceededError"){this.attemptStorageCleanup();try{localStorage.setItem(n,s)}catch{throw new Error("Storage quota exceeded - please delete some saves manually")}}else throw e}}generateSaveName(e){let t;const n=this.storyManager.story.state.currentPathString;if(n){const e=n.split(".");t=e[e.length-1],t=t.replace(/_/g," "),t=t.replace(/([a-z])([A-Z])/g,"$1 $2"),t=t.toLowerCase().split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}else{const e=this.storyManager.story.state.currentTurnIndex;t=`Turn ${e+1}`}return e===this.autosaveSlot&&(t+=" (Auto)"),t}generateDescription(){const e=this.storyManager.story.state.currentText;if(e?.length>0){let t=e.split(".")[0];return t.length>100&&(t=t.substring(0,97)+"..."),t+"."}return""}shouldAutosave(){try{return this.storyManager.settings?.getSetting?.("autoSave")||!1}catch{return!1}}showNotification(e,t=4e3){this.modal?.showNotification?.(e,!1,t)}attemptStorageCleanup(){try{const e=[];for(let t=1;t<=this.maxSaveSlots;t++){const n=this.getSaveData(t);n?.timestamp&&e.push({slot:t,timestamp:n.timestamp})}if(e.sort((e,t)=>e.timestamp-t.timestamp),e.length>0){const t=e[0].slot,n=this.savePrefix+t;localStorage.removeItem(n),console.log(`[STORAGE] Automatically removed oldest save from slot ${t}`)}}catch(e){SaveSystem._error("Storage cleanup failed",e)}}getSaveStats(){let n=0,e=null,t=null;for(let o=0;o<=this.maxSaveSlots;o++){const s=this.getSaveData(o);s&&(n++,(!e||s.timestamp<e.timestamp)&&(e=s),(!t||s.timestamp>t.timestamp)&&(t=s))}return{totalSaves:n,hasAutosave:!!this.getSaveData(this.autosaveSlot),oldestSave:e,newestSave:t}}cleanup(){this.modal?.modalElement?.remove?.()}}class DisplayManager{static errorSource=ErrorManager.SOURCES.DISPLAY_MANAGER;constructor(){if(this.container=document.querySelector("#story"),this.scrollContainer=document.querySelector(".outerContainer"),this.history=[],!this.container){DisplayManager._critical("Story container element not found",new Error("Missing #story element"));return}this.domHelpers=new DOMHelpers(this.container)}static _error(e,t=null){window.errorManager.error(e,t,DisplayManager.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,DisplayManager.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,DisplayManager.errorSource)}render(e){if(!Array.isArray(e)){DisplayManager._warning("Invalid content passed to render - expected array");return}e.forEach((e,t)=>{try{let t;switch(e.type){case"statbar":t=this.createStatBar(e);break;case"image":t=this.createImage(e);break;case"user-input":t=this.createUserInput(e);break;case"paragraph":default:t=this.createElement(e);break}t&&(this.trackInHistory(e),this.shouldAnimateContent()&&this.fadeInElement(t))}catch(e){DisplayManager._error(`Failed to render content item at index ${t}`,e)}})}renderChoices(e,t=!0){if(!Array.isArray(e)){DisplayManager._warning("Invalid choices passed to renderChoices - expected array");return}e.forEach((e,n)=>{try{const s=this.domHelpers.createChoice(e.text||"",e.classes||[],e.isClickable!==!1,e.keyHint,t,e.toneIndicators||[]);e.isClickable!==!1&&e.onClick&&(typeof e.onClick=="function"?this.domHelpers.addChoiceClickHandler(s,e.onClick):DisplayManager._warning(`Choice at index ${n} has invalid onClick handler`)),s&&this.shouldAnimateContent()&&this.fadeInElement(s)}catch(e){DisplayManager._error(`Failed to render choice at index ${n}`,e)}})}createElement(e){if(!e?.text||typeof e.text!="string")return DisplayManager._warning("createElement called with invalid content"),null;if(!this.domHelpers)return DisplayManager._error("Cannot create element - DOM helpers not available"),null;try{const n=MarkdownProcessor.process(e.text),t=this.domHelpers.createParagraph(n,e.classes||[]);return t&&this.shouldAnimateContent()&&this.fadeInElement(t),t}catch(e){return DisplayManager._error("Failed to create element",e),null}}createStatBar(e){const s=this.getStatValue(e.variableName),t=this.calculateStatBarMetrics(e,s),n=e.isOpposed?this.renderOpposedStatBar(e,t):this.renderSimpleStatBar(e,t);return this.container.appendChild(n),n}getStatValue(e){try{return window.storyManager?.story?.variablesState?.[e]??0}catch{return 0}}calculateStatBarMetrics(e,t){const s=e.max-e.min,o=s>0?Math.max(0,Math.min(100,(t-e.min)/s*100)):0,n=e.clamp?Math.max(e.min,Math.min(e.max,t)):t;return{fillPercent:o,displayValue:Math.round(n),displayLeft:Math.round(Math.max(0,n-e.min)),displayRight:Math.round(Math.max(0,e.max-n))}}renderSimpleStatBar(e,t){const n=document.createElement("div");n.className="stat-bar-container";const s=e.leftLabel||e.variableName.charAt(0).toUpperCase()+e.variableName.slice(1);return n.innerHTML=`
    <div class="stat-bar-header" aria-hidden="true">
      <span class="stat-bar-label">${s}</span>
      <span class="stat-bar-value">
        <span class="stat-bar-current">${t.displayValue}</span>/${e.max}
      </span>
    </div>
    <div class="stat-bar-track" role="progressbar"
         aria-valuenow="${t.displayValue}"
         aria-valuemin="${e.min}"
         aria-valuemax="${e.max}"
         aria-label="${s}: ${t.displayValue} out of ${e.max}">
      <div class="stat-bar-fill" style="width: ${t.fillPercent}%"></div>
    </div>
  `,n}renderOpposedStatBar(e,t){const n=document.createElement("div");return n.className="stat-bar-container stat-bar-opposed",n.innerHTML=`
    <div class="stat-bar-labels" aria-hidden="true">
      <span class="stat-bar-label stat-bar-label-left">${e.leftLabel||e.variableName}</span>
      <span class="stat-bar-value">
        <span class="stat-bar-current">${t.displayLeft}</span>/
        <span class="stat-bar-current">${t.displayRight}</span>
      </span>
      <span class="stat-bar-label stat-bar-label-right">${e.rightLabel||""}</span>
    </div>
    <div class="stat-bar-track" role="progressbar"
         aria-valuenow="${t.displayValue}"
         aria-valuemin="${e.min}"
         aria-valuemax="${e.max}"
         aria-label="${e.leftLabel||e.variableName} versus ${e.rightLabel||""}">
      <div class="stat-bar-fill" style="width: ${t.fillPercent}%"></div>
    </div>
  `,n}createImage(e){const t=document.createElement("img");t.src=e.src,t.className="story-image",e.altText?t.alt=e.altText:t.alt="",e.alignment&&t.classList.add(`image-${e.alignment}`),e.width&&(t.style.width=e.width),t.onerror=()=>{DisplayManager._warning(`Failed to load image: ${e.src}`)};let n;if(e.showCaption&&e.altText){const s=document.createElement("figure");s.className="story-figure",e.alignment&&(s.classList.add(`figure-${e.alignment}`),t.classList.remove(`image-${e.alignment}`)),e.width&&(s.style.width=e.width,t.style.width="100%");const o=document.createElement("figcaption");o.className="story-caption",o.textContent=e.altText,s.appendChild(t),s.appendChild(o),n=s}else n=t;return this.container.appendChild(n),n}createUserInput(e){const n=document.createElement("div");n.className="user-input-inline-container";const o=e.placeholder||"Type your answer here...";n.innerHTML=`
    <div class="user-input-prompt">
      <input type="text" class="user-input-inline-field" 
             placeholder="${o}" 
             maxlength="100" autocomplete="off">
      <button class="user-input-submit-btn">Submit</button>
    </div>
    <div class="user-input-help">Press Enter or click Submit to continue</div>
  `,this.container.appendChild(n);const t=n.querySelector(".user-input-inline-field"),i=n.querySelector(".user-input-submit-btn");setTimeout(()=>t.focus(),100);const s=()=>{const n=t.value.trim();if(!n){t.style.borderColor="var(--color-important)",t.placeholder="Please enter a value...",t.focus();return}try{window.storyManager.story.variablesState.$(e.variableName,n),window.storyManager.stateBeforeUserInput&&(window.storyManager.story.state.LoadJson(window.storyManager.stateBeforeUserInput),window.storyManager.story.variablesState.$(e.variableName,n),window.storyManager.stateBeforeUserInput=null),window.storyManager.reprocessingAfterUserInput=!0,window.storyManager.continue(),window.storyManager.reprocessingAfterUserInput=!1}catch(e){DisplayManager._error("Failed to set user input variable",e),t.style.borderColor="var(--color-important)",t.placeholder="Error - please try again..."}};return i.addEventListener("click",s),t.addEventListener("keypress",e=>{e.key==="Enter"&&s()}),t.addEventListener("input",()=>{t.style.borderColor=""}),n}shouldAnimateContent(){try{const e=window.storyManager?.settings;if(!e?.getSetting)return!0;const t=e.getSetting("animations")===!0;return t}catch{return console.log("Error checking animations, defaulting to true"),!0}}fadeInElement(e){if(!e)return;try{e.style.opacity="0",e.offsetHeight,e.style.opacity="1"}catch{e.style.opacity="1"}}clear(){if(!this.domHelpers){DisplayManager._error("Cannot clear - DOM helpers not available");return}this.domHelpers.clearStoryContent(),this.history=[]}clearContent(){if(!this.domHelpers){DisplayManager._error("Cannot clear content - DOM helpers not available");return}this.domHelpers.clearStoryContent()}scrollToTop(){if(!this.scrollContainer){DisplayManager._warning("Cannot scroll - scroll container not available");return}if(!this.domHelpers){DisplayManager._error("Cannot scroll - DOM helpers not available");return}this.domHelpers.scrollToTop(this.scrollContainer)}hideHeader(){this.domHelpers?.setVisible?.(".header",!1)}showHeader(){this.domHelpers?.setVisible?.(".header",!0)}getState(){return{history:[...this.history]}}restoreState(e){if(!e||typeof e!="object"){DisplayManager._warning("Invalid state passed to restoreState");return}this.clearContent();const t=Array.isArray(e.history)?e.history:[];this.history=[],t.length>0&&this.render(t)}trackInHistory(e){if(!e||typeof e!="object"){DisplayManager._warning("Invalid item passed to trackInHistory");return}this.history.push({...e,timestamp:Date.now()})}reset(){this.clear(),this.showHeader()}getHistoryLength(){return this.history.length}hasContent(){return this.history.length>0}getStats(){return{historyLength:this.history.length,hasContainer:!!this.container,hasScrollContainer:!!this.scrollContainer,hasDomHelpers:!!this.domHelpers,containerElementCount:this.container?this.container.children.length:0}}isReady(){return!!(this.container&&this.domHelpers)}recover(){this.container||(this.container=document.querySelector("#story")),this.scrollContainer||(this.scrollContainer=document.querySelector(".outerContainer")),!this.domHelpers&&this.container&&(this.domHelpers=new DOMHelpers(this.container)),Array.isArray(this.history)||(this.history=[])}}class ChoiceManager{static errorSource=ErrorManager.SOURCES.CHOICE_MANAGER;constructor(e){this.storyManager=e,this.tagProcessor=window.tagProcessor}static _error(e,t=null){window.errorManager.error(e,t,ChoiceManager.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,ChoiceManager.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,ChoiceManager.errorSource)}generate(e){return Array.isArray(e)?e.map((e,t)=>{try{const{customClasses:n,isClickable:s}=this.tagProcessor?.processChoiceTags?.(e.tags||[])||{customClasses:[],isClickable:!0},o=this.storyManager?.settings?.getToneIndicators?.(e.tags||[])||[];return{text:e.text||"",classes:n,isClickable:s,onClick:()=>this.selectChoice(t),originalIndex:t,tags:e.tags||[],keyHint:this.getKeyHint(t),toneIndicators:o}}catch(n){return ChoiceManager._error(`Failed to process choice at index ${t}`,n),{text:e.text||"Invalid choice",classes:["error-choice"],isClickable:!1,onClick:()=>{},originalIndex:t,tags:[],toneIndicators:[]}}}):(ChoiceManager._error("Invalid storyChoices - expected array"),[])}selectChoice(e){if(typeof e!="number"||e<0){ChoiceManager._error(`Invalid choice index: ${e}`);return}if(!this.storyManager){ChoiceManager._error("Story manager not available");return}try{this.storyManager.selectChoice(e)}catch(e){ChoiceManager._error("Failed to select choice",e)}}createSpecialChoice(e,t,n=[]){if(typeof e!="string"||typeof t!="function")return ChoiceManager._error("Invalid parameters for special choice"),{text:e||"Error",classes:["error-choice"],isClickable:!1,onClick:()=>{},isSpecial:!0};const s=()=>{try{t()}catch(e){ChoiceManager._error("Special choice click failed",e)}};return{text:e,classes:Array.isArray(n)?n:[],isClickable:!0,onClick:s,isSpecial:!0}}createReturnChoice(e){return typeof e!="function"?(ChoiceManager._error("onReturn must be a function"),this.createSpecialChoice("â† Return to Story",()=>{},["return-button","error-choice"])):this.createSpecialChoice("â† Return to Story",e,["return-button"])}processChoiceTags(e){if(!this.tagProcessor?.processChoiceTags)return ChoiceManager._warning("TagProcessor not available, using default choice behavior"),{customClasses:[],isClickable:!0};try{return this.tagProcessor.processChoiceTags(e||[])}catch(e){return ChoiceManager._warning("Failed to process choice tags",e),{customClasses:[],isClickable:!0}}}getKeyHint(e){return e<9?String(e+1):String.fromCharCode(97+(e-9))}hasClickableChoices(e){return!!Array.isArray(e)&&e.some(e=>e?.isClickable!==!1)}filterChoices(e,t=!1){return Array.isArray(e)?t?e.filter(e=>e?.isClickable!==!1):e:[]}validateChoice(e){return!!e&&typeof e=="object"&&["text","onClick"].every(t=>t in e)}getChoiceStats(e){return Array.isArray(e)?{total:e.length,clickable:e.filter(e=>e?.isClickable!==!1).length,special:e.filter(e=>e?.isSpecial).length,withClasses:e.filter(e=>e?.classes?.length>0).length}:{total:0,clickable:0,special:0,withClasses:0}}}class PageManager{static errorSource=ErrorManager.SOURCES.PAGE_MANAGER;constructor(e){this.storyManager=e,this.tagProcessor=window.tagProcessor,this.savedDisplayState=null,this.savedStoryState=null,this.storyManager||PageManager._critical("PageManager requires a story manager",new Error("Invalid story manager"))}static _error(e,t=null){window.errorManager.error(e,t,PageManager.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,PageManager.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,PageManager.errorSource)}show(e){if(!e||typeof e!="string"){PageManager._warning("Invalid knotName passed to show");return}if(!this.isSpecialPage(e)){PageManager._warning(`Page "${e}" is not marked as a special page`);return}if(this.isViewingSpecialPage()||this.saveCurrentState(),this.storyManager.currentPage=e,this.storyManager.display){this.storyManager.display.clear();const t=this.generatePageContent(e);t.length>0&&this.storyManager.display.render(t),this.addReturnButton(),this.storyManager.display.scrollToTop()}}isSpecialPage(e){const t=this.storyManager?.availablePages?.[e];return t&&t.isSpecialPage}getPageDisplayName(e){const t=this.storyManager?.availablePages?.[e];return t&&t.displayName?t.displayName:this.formatKnotName(e)}formatKnotName(e){return e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/_/g," ").toLowerCase().split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}saveCurrentState(){this.storyManager.display&&(this.savedDisplayState=this.storyManager.display.getState()),this.savedStoryState=this.storyManager.savePoint||this.storyManager.story.state.ToJson()}generatePageContent(e){try{const t=this.createPageStory(e);return this.extractPageContent(t)}catch{return PageManager._error("Failed to generate page content"),[]}}createPageStory(e){const t=this.storyManager.createTempStory(),n=this.storyManager.story.state.ToJson();return t.state.LoadJson(n),t.ChoosePathString(e),t}extractPageContent(e){const t=[];let n=!0;for(;e.canContinue;){const o=e.Continue(),i=e.currentTags||[],s=this.processPageLine(o,i,n);n=!1,s&&t.push(...s)}return t}processPageLine(e,t,n){if(n&&this.containsOnlySpecialPageTag(e,t))return null;const o=t.some(e=>typeof e=="string"&&e.trim());if(!e?.trim()&&!o)return null;const s=this.storyManager.contentProcessor.process(e,t),i=Array.isArray(s)?s:[s];return i.map(e=>(e&&(e.type==="paragraph"||!e.type)&&(e.classes=["special-page",...e.classes||[]]),e)).filter(Boolean)}containsOnlySpecialPageTag(e,t){return!(e&&e.trim().length>0)&&TagRegistry.hasSpecialPageTag(t)}addReturnButton(){if(!this.storyManager.choices||!this.storyManager.display){PageManager._error("Required managers not available for return button");return}try{const e=this.storyManager.choices.createReturnChoice(()=>{this.returnToStory()});this.storyManager.display.renderChoices([e],!1)}catch(e){PageManager._error("Failed to add return button",e)}}returnToStory(){if(!this.storyManager.currentPage)return;try{if(this.storyManager.currentPage=null,!this.storyManager.display){PageManager._error("Display manager not available for return");return}if(this.storyManager.display.clear(),this.savedStoryState)try{this.storyManager.story.state.LoadJson(this.savedStoryState)}catch(e){PageManager._error("Failed to restore story state",e),this.storyManager.savePoint&&this.storyManager.story.state.LoadJson(this.storyManager.savePoint)}if(this.savedDisplayState)try{this.storyManager.display.restoreState(this.savedDisplayState)}catch(e){PageManager._error("Failed to restore display state",e),this.regenerateDisplayFromStoryState()}else this.regenerateDisplayFromStoryState();this.storyManager.display.showHeader(),this.storyManager.createChoices?.(),this.storyManager.display.scrollToTop(),this.savedDisplayState=null,this.savedStoryState=null}catch(e){PageManager._error("Failed to return to story",e)}}regenerateDisplayFromStoryState(){const e=this.storyManager.story?.state?.currentText;if(e?.trim()){const t=MarkdownProcessor.process(e);this.storyManager.display.render([{text:t,classes:[]}])}}isViewingSpecialPage(){return this.storyManager?.currentPage!==null}getCurrentPageKnotName(){return this.storyManager?.currentPage||null}getCurrentPageDisplayName(){const e=this.getCurrentPageKnotName();return e?this.getPageDisplayName(e):null}pageExists(e){return this.isSpecialPage(e)}getAvailablePages(){return{...this.storyManager?.availablePages}||{}}getAvailablePageDisplayNames(){const e=this.getAvailablePages();return Object.keys(e).map(t=>({knotName:t,displayName:e[t].displayName||this.formatKnotName(t)}))}findKnotByDisplayName(e){const t=this.getAvailablePages();for(const[n,s]of Object.entries(t))if(s.displayName===e)return n;return null}evaluatePageContent(e){if(!this.pageExists(e))return"";try{const t=this.storyManager.createTempStory();t.ChoosePathString(e);let s="",n=!0;for(;t.canContinue;){const e=t.Continue(),o=t.currentTags||[];if(n&&this.containsOnlySpecialPageTag(e,o)){n=!1;continue}n=!1,s+=e}return s.trim()}catch(e){return PageManager._error("Failed to evaluate page content",e),""}}getPageInfo(e){const t=this.storyManager?.availablePages?.[e];return t?{knotName:e,displayName:t.displayName||this.formatKnotName(e),isSpecialPage:t.isSpecialPage,content:this.evaluatePageContent(e)}:null}reset(){this.savedDisplayState=null,this.savedStoryState=null,this.storyManager&&(this.storyManager.currentPage=null)}getStats(){const e=this.getAvailablePages(),t=this.getCurrentPageKnotName(),n=this.getCurrentPageDisplayName();return{hasStoryManager:!!this.storyManager,hasTagProcessor:!!this.tagProcessor,currentPageKnotName:t,currentPageDisplayName:n,isViewingSpecialPage:this.isViewingSpecialPage(),availablePageCount:Object.keys(e).length,hasSavedState:!!(this.savedDisplayState||this.savedStoryState),pageDisplayNames:this.getAvailablePageDisplayNames()}}isReady(){return!!(this.storyManager?.story&&this.storyManager?.display)}validatePages(){const e={valid:[],invalid:[],errors:[]},t=this.getAvailablePages();for(const[n,s]of Object.entries(t))try{const t=this.evaluatePageContent(n);t.length>0?e.valid.push({knotName:n,displayName:s.displayName,contentLength:t.length}):e.invalid.push({knotName:n,displayName:s.displayName,reason:"No content generated"})}catch(t){e.errors.push({knotName:n,displayName:s.displayName,error:t.message})}return e}}class NavigationManager{static errorSource=ErrorManager.SOURCES.NAVIGATION_MANAGER;constructor(e){if(this.storyManager=e,this.dynamicButtons=new Map,this.dropdown=null,this.dropdownButton=null,!this.storyManager){NavigationManager._critical("NavigationManager requires a story manager",new Error("Invalid story manager"),"navigation");return}this.setupButtons()}static _error(e,t=null){window.errorManager.error(e,t,NavigationManager.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,NavigationManager.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,NavigationManager.errorSource)}updateVisibility(e,t=null){if(!e||typeof e!="object"){NavigationManager._warning("Invalid availablePages object passed to updateVisibility",null,"navigation");return}this.clearDynamicButtons();const n=Object.keys(e).length;this.createSlidePanel(e,t)}createSlidePanel(e,t){const o=document.querySelector(".nav-controls");if(!o)return;this.menuButton=document.createElement("button"),this.menuButton.type="button",this.menuButton.id="pages-menu-btn",this.menuButton.setAttribute("aria-label","Menu"),this.menuButton.innerHTML='<span class="material-icons-outlined nav-icon" aria-hidden="true">menu</span>',this.slidePanel=document.createElement("nav"),this.slidePanel.className="slide-panel",this.slidePanel.setAttribute("aria-label","Pages"),this.slidePanel.setAttribute("aria-hidden","true");const s=document.createElement("div");s.className="panel-content",t&&t.length>0?this.addOrderedPagesToPanel(s,e,t):this.addDefaultPagesToPanel(s,e),this.slidePanel.appendChild(s);const n=document.createElement("button");n.type="button",n.className="panel-close-bottom",n.setAttribute("aria-label","Close menu"),n.innerHTML='<span class="material-icons-outlined" aria-hidden="true">expand_less</span>',this.menuButton.setAttribute("aria-expanded","false"),this.slidePanel.appendChild(n),document.body.appendChild(this.slidePanel);const i=document.getElementById("settings-btn");o.insertBefore(this.menuButton,i),this.menuButton.addEventListener("click",e=>{e.stopPropagation(),this.togglePanel()}),n.addEventListener("click",()=>{this.hidePanel()}),document.addEventListener("click",e=>{this.slidePanel&&this.slidePanel.classList.contains("show")&&!this.slidePanel.contains(e.target)&&e.target!==this.menuButton&&this.hidePanel()}),this.dynamicButtons.set("pages-menu",this.menuButton)}addOrderedPagesToPanel(e,t,n){let s=-1;const o=new Set;n.forEach(n=>{const i=t[n.knotName];if(!i||!i.isSpecialPage)return;if(n.section!==s&&s!==-1){const t=document.createElement("hr");t.className="panel-separator",e.appendChild(t)}s=n.section;const a=this.createPageLink(n.knotName,i);e.appendChild(a),o.add(n.knotName)});const i=Object.keys(t).filter(e=>!o.has(e)&&t[e].isSpecialPage);if(i.length>0&&o.size>0){const t=document.createElement("hr");t.className="panel-separator",e.appendChild(t)}i.forEach(n=>{const s=t[n],o=this.createPageLink(n,s);e.appendChild(o)})}addDefaultPagesToPanel(e,t){const n=Object.keys(t).filter(e=>t[e]?.isSpecialPage).sort((e,n)=>{const s=t[e].displayName.toLowerCase(),o=t[n].displayName.toLowerCase();return s.localeCompare(o)});n.forEach(n=>{const s=t[n],o=this.createPageLink(n,s);e.appendChild(o)})}createPageLink(e,t){const n=document.createElement("a");return n.href="#",n.className="panel-link",n.textContent=t.displayName,n.addEventListener("click",t=>{t.preventDefault(),this.hidePanel(),this.storyManager.pages.show(e)}),n}togglePanel(){this.slidePanel&&(this.slidePanel.classList.contains("show")?this.hidePanel():this.showPanel())}showPanel(){if(this.slidePanel){this.slidePanel.classList.add("show"),this.slidePanel.setAttribute("aria-hidden","false"),this.menuButton?.classList.add("active"),this.menuButton?.setAttribute("aria-expanded","true");const e=this.slidePanel.querySelector(".panel-link");e&&e.focus()}}hidePanel(){this.slidePanel&&(this.slidePanel.classList.remove("show"),this.slidePanel.setAttribute("aria-hidden","true"),this.menuButton?.classList.remove("active"),this.menuButton?.setAttribute("aria-expanded","false"),this.menuButton?.focus())}clearDynamicButtons(){this.slidePanel&&this.slidePanel.parentNode&&this.slidePanel.parentNode.removeChild(this.slidePanel),this.menuButton&&this.menuButton.parentNode&&this.menuButton.parentNode.removeChild(this.menuButton),this.slidePanel=null,this.menuButton=null;for(let[t,e]of this.dynamicButtons)e&&e.parentNode&&e.parentNode.removeChild(e);this.dynamicButtons.clear()}setupClickableTitle(){this.setupButton("title-restart",()=>{this.storyManager.confirmRestart()})}setupButtons(){this.setupCoreButtons(),this.setupClickableTitle()}setupCoreButtons(){this.setupButton("rewind",()=>{this.storyManager.confirmRestart()})}setupButton(e,t){if(!e||typeof t!="function"){NavigationManager._warning(`Invalid parameters for button ${e}`,null,"navigation");return}const n=document.getElementById(e);if(!n){NavigationManager._warning(`Button not found: ${e}`,null,"navigation");return}try{const s=n.cloneNode(!0);n.parentNode.replaceChild(s,n),s.addEventListener("click",n=>{try{t(n)}catch(t){NavigationManager._error(`Button click failed: ${e}`,t,"navigation")}})}catch(t){NavigationManager._warning(`Failed to setup button ${e}`,t,"navigation")}}setButtonEnabled(e,t){const n=document.getElementById(e);if(!n)return;t?(n.removeAttribute("disabled"),n.style.cursor="pointer",n.style.opacity=""):(n.setAttribute("disabled","disabled"),n.style.cursor="not-allowed",n.style.opacity="0.5")}setButtonVisible(e,t){const n=document.getElementById(e);n&&(n.style.display=t?"inline-block":"none")}setSpecialPageButtonEnabled(e,t){const n=this.findPageButton(e);n&&(t?(n.removeAttribute("disabled"),n.style.cursor="pointer",n.style.opacity=""):(n.setAttribute("disabled","disabled"),n.style.cursor="not-allowed",n.style.opacity="0.5"))}setSpecialPageButtonVisible(e,t){const n=this.findPageButton(e);n&&(n.style.display=t?"inline-block":"none")}updateSaveLoadButtons(){if(!this.storyManager.pages)return;const t=this.storyManager.pages.isViewingSpecialPage();this.setButtonEnabled("saves-btn",!t)}highlightActivePage(e){for(let[t,e]of this.dynamicButtons)e.classList.remove("active","current-page");if(e){const t=this.findPageButton(e);t&&t.classList.add("active","current-page")}}getSpecialPageButtons(){const e=[];for(let[s,t]of this.dynamicButtons){const n=s.replace("special-page-",""),o=this.storyManager?.availablePages?.[n];e.push({buttonId:s,knotName:n,displayName:o?.displayName||this.formatKnotName(n),element:t,visible:t.style.display!=="none",enabled:!t.hasAttribute("disabled")})}return e}getButtonStates(){const e={},t=["rewind","saves-btn","settings-btn"];t.forEach(t=>{const n=document.getElementById(t);n?e[t]={visible:n.style.display!=="none",enabled:!n.hasAttribute("disabled"),exists:!0,isDynamic:!1}:e[t]={visible:!1,enabled:!1,exists:!1,isDynamic:!1}});for(let[t,n]of this.dynamicButtons){const s=t.replace("special-page-","");e[t]={visible:n.style.display!=="none",enabled:!n.hasAttribute("disabled"),exists:!0,isDynamic:!0,knotName:s,displayName:this.getPageDisplayName(s)}}return e}reset(){this.setButtonEnabled("rewind",!0),this.setButtonEnabled("saves-btn",!0),this.setButtonEnabled("settings-btn",!0),this.clearDynamicButtons(),this.highlightActivePage(null)}refresh(){const e=this.storyManager?.availablePages||{};this.updateVisibility(e)}getStats(){const e=this.getButtonStates(),t=this.getSpecialPageButtons(),n=Object.keys(e).length,s=Object.values(e).filter(e=>e.isDynamic).length,o=Object.values(e).filter(e=>e.exists).length,i=Object.values(e).filter(e=>e.visible).length;return{hasStoryManager:!!this.storyManager,totalButtons:n,dynamicButtons:s,existingButtons:o,visibleButtons:i,trackedDynamicButtons:this.dynamicButtons.size,specialPageButtons:t.length,specialPageButtonDetails:t}}isReady(){return!!(this.storyManager&&document.getElementById("rewind"))}getNavigationInfo(){const e=this.storyManager?.pages?.getCurrentPageKnotName(),t=this.storyManager?.availablePages||{};return{currentPage:{knotName:e,displayName:e?this.getPageDisplayName(e):null,isSpecialPage:!!e},availablePages:Object.keys(t).map(e=>({knotName:e,displayName:this.getPageDisplayName(e),hasButton:this.findPageButton(e)!==null})),coreButtons:{restart:{exists:!!document.getElementById("rewind"),enabled:!document.getElementById("rewind")?.hasAttribute("disabled")},saves:{exists:!!document.getElementById("saves-btn"),enabled:!document.getElementById("saves-btn")?.hasAttribute("disabled")},settings:{exists:!!document.getElementById("settings-btn"),enabled:!document.getElementById("settings-btn")?.hasAttribute("disabled")}}}}cleanup(){this.clearDynamicButtons()}}class ContentProcessor{static errorSource=ErrorManager.SOURCES.CONTENT_PROCESSOR;constructor(){this.tagProcessor=window.tagProcessor}static _error(e,t=null){window.errorManager.error(e,t,ContentProcessor.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,ContentProcessor.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,ContentProcessor.errorSource)}process(e,t){const{TAGS:n}=window.TagRegistry||{};if(n&&Array.isArray(t)){const n=this.checkContentTypeTags(t,e);if(n)return n}return this.createParagraph(e,t)}checkContentTypeTags(e,t){const{TAGS:n}=window.TagRegistry;for(const s of e){if(typeof s!="string")continue;const{tagDef:i,tagValue:o,invalid:a}=TagRegistry.parseTag(s);if(a)continue;switch(i){case n.STATBAR:return this.handleStatBarContent(e,t);case n.USER_INPUT:return this.handleUserInputContent(o);case n.IMAGE:return this.handleImageContent(o,t,e)}}return null}handleImageContent(e,t,n){const s=this.parseImageTag(e);return t?.trim()?[{type:"image",...s},this.createParagraph(t,n)]:{type:"image",...s}}handleStatBarContent(e,t){const{TAGS:s}=window.TagRegistry,o=e.map(e=>TagRegistry.parseTag(e)),i=o.filter(({tagDef:e,invalid:t})=>e===s.STATBAR&&!t),n=i.map(({tagValue:e})=>({type:"statbar",...this.parseStatBarTag(e)}));return t?.trim()?[...n,this.createParagraph(t,e)]:n.length===1?n[0]:n}handleUserInputContent(e){const t=this.parseUserInputTag(e),n=window.storyManager?.story?.variablesState?.[t.variableName];return n&&n!==""&&window.storyManager?.reprocessingAfterUserInput?null:{type:"user-input",...t}}createParagraph(e,t){if(Array.isArray(t)||(ContentProcessor._warning("Invalid tags array provided to createParagraph"),t=[]),!this.tagProcessor?.processLineTags)return ContentProcessor._error("TagProcessor not available in ContentProcessor"),{type:"paragraph",text:e,classes:[],tags:t,hasSpecialAction:!1,action:null};const{customClasses:s,specialActions:o}=this.tagProcessor.processLineTags(t),n=this.findSpecialAction(o);return{type:"paragraph",text:e,classes:s||[],tags:t,hasSpecialAction:!!n,action:n?.()}}findSpecialAction(e){return!Array.isArray(e)||e.length===0?null:e.find(e=>{if(typeof e!="function")return ContentProcessor._warning("Non-function found in specialActions array"),!1;try{const t=e();return t==="RESTART"||t==="CLEAR"||typeof t=="object"}catch(e){return ContentProcessor._error("Error executing special action function",e),!1}})}getStats(){return{hasTagProcessor:!!this.tagProcessor,processorType:this.tagProcessor?.constructor?.name||"unknown",timestamp:(new Date).toISOString()}}isReady(){return!!this.tagProcessor?.processLineTags}parseStatBarTag(e){const r=e.trim(),t=[],m=/"([^"]*)"/g;let i;for(;(i=m.exec(r))!==null;)t.push(i[1]);const d=r.replace(/"[^"]*"/g,"").trim(),n=d.split(/\s+/).filter(e=>e),u=n.some(e=>e.toLowerCase()==="clamp"),h=n[0];let a=0,o=100;if(n.length>=3){const e=parseFloat(n[1]),t=parseFloat(n[2]);!(e!=e)&&!(t!=t)&&(a=e,o=t)}let s=null,c=null,l=!1;return t.length===1?s=t[0]:t.length>=2&&(s=t[0],c=t[1],l=!0),{variableName:h,min:a,max:o,leftLabel:s,rightLabel:c,isOpposed:l,clamp:u}}parseImageTag(e){const t=e.trim();let s=null,o=t;const i=t.match(/"([^"]*)"/);i&&(s=i[1],o=t.replace(/"([^"]*)"/,"").trim());const n=o.split(/\s+/).filter(e=>e),l=n[0];let a=null,r=null,c=!1;for(let t=1;t<n.length;t++){const e=n[t].toLowerCase();["left","right","center"].includes(e)?a=e:e==="caption"?c=!0:e.match(/^\d+(%|px|em|rem|vw)$/)&&(r=e)}return{src:l,alignment:a,width:r,altText:s,showCaption:c}}parseUserInputTag(e){const t=e.trim();let n="",s=t;const o=t.match(/"([^"]*)"/);o&&(n=o[1],s=t.replace(/"([^"]*)"/,"").trim());const i=s.split(/\s+/).filter(e=>e),a=i[0];return{variableName:a,placeholder:n}}}class InkFunctions{static bindAll(e){this.bindStringFunctions(e),this.bindMathFunctions(e),this.bindFairMathFunctions(e),this.bindTimeFunctions(e)}static bindStringFunctions(e){e.BindExternalFunction("UPPERCASE",e=>String(e).toUpperCase()),e.BindExternalFunction("LOWERCASE",e=>String(e).toLowerCase()),e.BindExternalFunction("CAPITALIZE",e=>String(e).charAt(0).toUpperCase()+String(e).slice(1)),e.BindExternalFunction("TRIM",e=>String(e).trim()),e.BindExternalFunction("LENGTH",e=>String(e).length),e.BindExternalFunction("CONTAINS",(e,t)=>String(e).includes(String(t))),e.BindExternalFunction("STARTS_WITH",(e,t)=>String(e).startsWith(String(t))),e.BindExternalFunction("ENDS_WITH",(e,t)=>String(e).endsWith(String(t))),e.BindExternalFunction("REPLACE",(e,t,n)=>String(e).replace(String(t),String(n))),e.BindExternalFunction("REPLACE_ALL",(e,t,n)=>String(e).replaceAll(String(t),String(n)))}static bindMathFunctions(e){e.BindExternalFunction("ROUND",e=>Math.round(e)),e.BindExternalFunction("CLAMP",(e,t,n)=>Math.min(Math.max(e,t),n)),e.BindExternalFunction("ABS",e=>e<0?-e:e),e.BindExternalFunction("PERCENT",(e,t)=>t===0?0:Math.round(e/t*100))}static bindFairMathFunctions(e){e.BindExternalFunction("FAIRADD",(e,t)=>{const n=e+(100-e)*(t/100);return Math.round(Math.min(100,Math.max(0,n)))}),e.BindExternalFunction("FAIRSUB",(e,t)=>{const n=e-e*(t/100);return Math.round(Math.min(100,Math.max(0,n)))})}static bindTimeFunctions(e){e.BindExternalFunction("NOW",()=>Math.floor(Date.now()/1e3)),e.BindExternalFunction("SECONDS_SINCE",e=>Math.floor(Date.now()/1e3)-e),e.BindExternalFunction("MINUTES_SINCE",e=>Math.floor((Date.now()/1e3-e)/60)),e.BindExternalFunction("TIME_SINCE",e=>{const t=Math.floor(Date.now()/1e3)-e;if(t<60)return t===1?"1 second":`${t} seconds`;const n=Math.floor(t/60);if(n<60)return n===1?"1 minute":`${n} minutes`;const s=Math.floor(n/60);if(s<24)return s===1?"1 hour":`${s} hours`;const o=Math.floor(s/24);return o===1?"1 day":`${o} days`}),e.BindExternalFunction("FORMAT_DATE",(e,t)=>{const n=new Date(e*1e3),s={year:"numeric",month:"long",day:"numeric"};try{return n.toLocaleDateString(t||"en-US",s)}catch{return console.warn(`Invalid locale "${t}", falling back to en-US`),n.toLocaleDateString("en-US",s)}}),e.BindExternalFunction("FORMAT_TIME",(e,t)=>{const n=new Date(e*1e3),s={hour:"numeric",minute:"2-digit"};try{return n.toLocaleTimeString(t||"en-US",s)}catch{return console.warn(`Invalid locale "${t}", falling back to en-US`),n.toLocaleTimeString("en-US",s)}}),e.BindExternalFunction("FORMAT_DATETIME",(e,t)=>{const n=new Date(e*1e3),s={year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit"};try{return n.toLocaleString(t||"en-US",s)}catch{return console.warn(`Invalid locale "${t}", falling back to en-US`),n.toLocaleString("en-US",s)}}),e.BindExternalFunction("OFFSET_DATE",(e,t,n,s,o,i)=>{const a=new Date(e*1e3);return a.setFullYear(a.getFullYear()+t),a.setMonth(a.getMonth()+n),a.setDate(a.getDate()+s),a.setHours(a.getHours()+o),a.setMinutes(a.getMinutes()+i),Math.floor(a.getTime()/1e3)})}}class StoryManager{static errorSource=ErrorManager.SOURCES.STORY_MANAGER;constructor(e){try{this.story=new inkjs.Story(e),InkFunctions.bindAll(this.story),this.savePoint="",this.currentPage=null,this.availablePages={},this.pageMenuOrder=null;const{TAGS:t}=window.TagRegistry||{};this.initializeSubsystems(),this.detectSpecialPages(),this.setupInitialState()}catch(e){throw StoryManager._critical("Failed to initialize story",e),e}}static _error(e,t=null){window.errorManager.error(e,t,StoryManager.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,StoryManager.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,StoryManager.errorSource)}initializeSubsystems(){if(this.display=this.safeInit(()=>new DisplayManager,"display"),this.contentProcessor=this.safeInit(()=>new ContentProcessor,"content"),this.settings=this.safeInit(()=>new SettingsManager,"settings"),this.pages=this.safeInit(()=>new PageManager(this),"pages"),this.choices=this.safeInit(()=>new ChoiceManager(this),"choices"),this.navigation=this.safeInit(()=>new NavigationManager(this),"navigation"),this.saves=this.safeInit(()=>new SaveSystem(this),"saves"),!this.display||!this.story)throw new Error("Critical systems failed to initialize")}safeInit(e,t){try{return e()}catch(e){return StoryManager._error(`Failed to initialize ${t}`,e),null}}createTempStory(){const e=new inkjs.Story(this.story.ToJson());return InkFunctions.bindAll(e),e}detectSpecialPages(){this.availablePages={};try{const e=this.story.mainContentContainer.namedContent;for(let[t,n]of e)try{const e=this.getSpecialPageInfo(t);e&&(this.availablePages[t]={displayName:e.displayName,knotName:t,isSpecialPage:!0})}catch(e){StoryManager._warning(`Failed to check if ${t} is special page`,e)}}catch(e){StoryManager._error("Failed to detect special pages",e)}}getSpecialPageInfo(e){const{TAGS:t,getTagDef:n}=window.TagRegistry||{};if(!t||!n)return null;try{const n=this.createTempStory();if(n.ChoosePathString(e),n.canContinue){n.Continue();const s=n.currentTags||[];for(const n of s){if(typeof n!="string")continue;const{tagDef:o,tagValue:i}=TagRegistry.parseTag(n);if(o===t.SPECIAL_PAGE)return{displayName:i?.trim()||this.formatKnotName(e),isSpecialPage:!0}}}return null}catch{return null}}isSpecialPage(e){return this.getSpecialPageInfo(e)!==null}formatKnotName(e){return e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/_/g," ").toLowerCase().split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}setupInitialState(){try{this.settings?.processGlobalTags?.(this.story.globalTags),this.processMenuOrderTag(this.story.globalTags),this.navigation?.updateVisibility?.(this.availablePages,this.pageMenuOrder),this.savePoint=this.story.state.ToJson(),this.continue(!0)}catch(e){StoryManager._error("Failed to setup initial state",e)}}processMenuOrderTag(e){if(!Array.isArray(e))return;for(const t of e){if(typeof t!="string")continue;const n=t.indexOf(":");if(n===-1)continue;const s=t.substring(0,n).trim().toUpperCase(),o=t.substring(n+1).trim();if(getTagDef(s)===TAGS.PAGE_MENU){this.pageMenuOrder=this.parseMenuOrder(o);break}}}parseMenuOrder(e){const n=e.split(",,").map(e=>e.trim()),t=[];return n.forEach((e,n)=>{const s=e.split(",").map(e=>e.trim()).filter(e=>e);s.forEach(e=>{this.availablePages[e]?t.push({knotName:e,section:n}):console.warn(`Page '${e}' in PAGE_MENU not found in special pages`)})}),t.length>0?t:null}continue(e=!1){try{if(this.currentPage)return;e||(this.display?.clear?.(),this.display?.scrollToTop?.());const{content:t,stoppedForUserInput:n,stateBeforeUserInput:s}=this.generateContent();t.length>0&&(this.display?.render?.(t),document.dispatchEvent(new CustomEvent("story:content",{detail:{content:t}}))),e&&setTimeout(()=>document.dispatchEvent(new CustomEvent("story:start")),0),n&&s&&(this.stateBeforeUserInput=s),n||this.createChoices(),!n&&this.hasEnded()&&document.dispatchEvent(new CustomEvent("story:end")),this.savePoint=this.story.state.ToJson()}catch(e){StoryManager._error("Failed to continue story",e)}}continueWithoutClearing(){try{if(this.currentPage)return;const{content:e}=this.generateContent();e.length>0&&this.display?.render?.(e),this.createChoices(),this.savePoint=this.story.state.ToJson()}catch(e){StoryManager._error("Failed to continue story without clearing",e)}}generateContent(){const t=[];let e=!1;const n=this.story.state.ToJson();try{for(;this.story.canContinue;){const s=this.story.Continue(),o=this.story.currentTags||[];if(s.trim().length===0&&o.length===0)continue;const n=this.contentProcessor?.process?.(s,o);if(n)if(Array.isArray(n)){if(t.push(...n),n.some(e=>e.type==="user-input")){e=!0;break}}else if(t.push(n),n.type==="user-input"){e=!0;break}if(n?.hasSpecialAction){const e=this.handleSpecialAction(n.action);if(!e)break}}}catch(e){StoryManager._error("Error generating story content",e)}return{content:t,stoppedForUserInput:e,stateBeforeUserInput:e?n:null}}handleSpecialAction(e){try{if(typeof e=="string")switch(e){case"CLEAR":return this.display?.clear?.(),this.display?.hideHeader?.(),!0;case"RESTART":return this.confirmRestart(),!1;default:return!0}return!0}catch(e){return StoryManager._error("Failed to handle special action",e),!0}}createChoices(){try{if(this.story.currentChoices?.length>0){const e=this.choices?.generate?.(this.story.currentChoices);e&&this.display?.renderChoices?.(e,!0)}}catch(e){StoryManager._error("Failed to create choices",e,"choices")}}selectChoice(e){try{if(typeof e!="number"||e<0||e>=this.story.currentChoices.length)throw new Error(`Invalid choice index: ${e}`);this.display?.container?.querySelectorAll?.(".choice").forEach(e=>{e.remove()}),this.story.ChooseChoiceIndex(e),document.dispatchEvent(new CustomEvent("story:choice",{detail:{index:e}})),this.savePoint=this.story.state.ToJson(),this.continue(),this.saves?.autosave?.()}catch(e){StoryManager._error("Failed to select choice",e,"navigation")}}restart(){try{document.dispatchEvent(new CustomEvent("story:restart")),this.story.ResetState(),this.currentPage=null,this.display?.reset?.(),this.pages?.reset?.(),this.savePoint=this.story.state.ToJson(),this.continue(!0),this.display?.scrollToTop?.(),window.notificationManager?.success?.("Story restarted from the beginning")}catch(e){StoryManager._error("Failed to restart story",e)}}getCurrentState(){try{return{gameState:this.story.state.ToJson(),displayState:this.display?.getState?.()||null,currentPage:this.currentPage,savePoint:this.savePoint,timestamp:Date.now()}}catch(e){return StoryManager._error("Failed to get current state",e),{}}}loadState(e){try{if(!e?.gameState)throw new Error("Invalid save state");const n=this.createTempStory();n.state.LoadJson(e.gameState),this.story.state.LoadJson(e.gameState),this.currentPage=e.currentPage||null,this.savePoint=e.savePoint||this.story.state.ToJson(),this.pages?.reset?.(),this.stateBeforeUserInput=e.stateBeforeUserInput||null;let t=!1;e.displayState?(this.display?.restoreState?.(e.displayState),t=e.displayState.history?.some(e=>e.type==="user-input")):(this.display?.clear?.(),this.regenerateCurrentDisplay()),t||this.createChoices(),this.display?.scrollToTop?.()}catch(e){StoryManager._error("Failed to load state",e,"save-system")}}regenerateCurrentDisplay(){try{const e=this.story.state.currentText;if(e?.trim?.().length>0){const t=[{text:e,classes:[]}];this.display?.render?.(t)}}catch(e){StoryManager._error("Failed to regenerate display",e,"display")}}canContinue(){try{return this.story.canContinue}catch(e){return StoryManager._warning("Failed to check canContinue",e),!1}}hasChoices(){try{return this.story.currentChoices?.length>0}catch(e){return StoryManager._warning("Failed to check hasChoices",e),!1}}hasEnded(){return!this.canContinue()&&!this.hasChoices()}confirmRestart(){BaseModal.confirm({title:"Restart Story",message:"Are you sure you want to restart the story from the beginning? Any unsaved progress will be lost.",confirmText:"Restart",cancelText:"Cancel",confirmVariant:"primary",onConfirm:()=>this.restart()})}getStats(){try{return{currentTurnIndex:this.story.state.currentTurnIndex,hasEnded:this.hasEnded(),canContinue:this.canContinue(),hasChoices:this.hasChoices(),currentPage:this.currentPage,displayLength:this.display?.getHistoryLength?.()||0,specialPagesFound:Object.keys(this.availablePages).length}}catch(e){return StoryManager._warning("Failed to get stats",e),{}}}getFeatureInfo(){return{availablePages:{...this.availablePages},hasGlobalTags:this.story.globalTags?.length>0,hasCurrentTags:this.story.currentTags?.length>0,specialPageCount:Object.keys(this.availablePages).length}}cleanup(){try{this.saves?.cleanup?.(),this.settings?.cleanup?.(),this.pages?.reset?.()}catch(e){StoryManager._warning("Failed to cleanup",e,"system")}}}class KeyboardHelpModal{static errorSource=ErrorManager.SOURCES.KEYBOARD_HELP;constructor(){this.modal=null,this.isMac=window.Utils.isMac(),this.isMobile=window.Utils.isMobile(),this.init()}static _error(e,t=null){window.errorManager.error(e,t,KeyboardHelpModal.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,KeyboardHelpModal.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,KeyboardHelpModal.errorSource)}init(){if(this.isMobile)return;this.createModal()}isAvailable(){return!this.isMobile}createModal(){this.modal=new BaseModal({title:"Keyboard Shortcuts",className:"keyboard-help-modal",maxWidth:"500px",showFooter:!0})}show(){if(this.isMobile)return;if(!this.modal?.isReady()){KeyboadHelpModal._error("Cannot show keyboard help - modal not available");return}this.modal.show(e=>{e.setContent(this.getHelpHTML());const t=e.getFooter();if(t){t.innerHTML="",t.style.textAlign="right";const n=e.createButton("Close",{variant:"primary",onClick:()=>this.hide()});t.appendChild(n)}})}hide(){this.modal?.hide()}getModifierKey(){return this.isMac?"Cmd":"Ctrl"}getHelpHTML(){const e=this.getModifierKey();return`
      <div class="keyboard-help-section">
        <h3>Choice Selection</h3>
        <table class="keyboard-help-table">
          <tr>
            <td class="shortcut-key"><kbd>1</kbd> - <kbd>9</kbd></td>
            <td>Select choice 1-9</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>A</kbd> - <kbd>Z</kbd></td>
            <td>Select choice 10+ (A=10, B=11, etc.)</td>
          </tr>
        </table>
      </div>

      <div class="keyboard-help-section">
        <h3>Scrolling</h3>
        <table class="keyboard-help-table">
          <tr>
            <td class="shortcut-key"><kbd>â†‘</kbd> / <kbd>â†“</kbd></td>
            <td>Scroll up/down (small)</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>PgUp</kbd> / <kbd>PgDn</kbd></td>
            <td>Scroll up/down (large)</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>Home</kbd> / <kbd>End</kbd></td>
            <td>Jump to top/bottom</td>
          </tr>
        </table>
      </div>

      <div class="keyboard-help-section">
        <h3>Menus</h3>
        <table class="keyboard-help-table">
          <tr>
            <td class="shortcut-key"><kbd>${e}</kbd>+<kbd>S</kbd></td>
            <td>Open save menu</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>${e}</kbd>+<kbd>,</kbd></td>
            <td>Open settings</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>${e}</kbd>+<kbd>H</kbd></td>
            <td>Show this help</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>${e}</kbd>+<kbd>R</kbd></td>
            <td>Restart story</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>Esc</kbd></td>
            <td>Close menu / Return to story</td>
          </tr>
        </table>
      </div>
    `}isReady(){return!this.isMobile()&&this.modal?.isReady()}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.keyboardHelpModal=new KeyboardHelpModal}):window.keyboardHelpModal=new KeyboardHelpModal;const SMALL_SCROLL_PERCENT=.15,LARGE_SCROLL_PERCENT=.8;class KeyboardShortcuts{static errorSource=ErrorManager.SOURCES.KEYBOARD_SHORTCUTS;constructor(){this.enabled=!window.Utils.isMobile(),this.init()}static _error(e,t=null){window.errorManager.error(e,t,KeyboardShortcuts.errorSource)}static _warning(e,t=null){window.errorManager.warning(e,t,KeyboardShortcuts.errorSource)}static _critical(e,t=null){window.errorManager.critical(e,t,KeyboardShortcuts.errorSource)}init(){document.addEventListener("keydown",e=>this.handleKeyDown(e))}handleKeyDown(e){if(!window.storyManager||!this.enabled)return;if(e.altKey)return;if(this.isTypingInInput(e))return;if(e.ctrlKey||e.metaKey){this.handleModifierShortcuts(e);return}if(e.key==="Escape"){this.handleEscape(e);return}if(this.handleScrolling(e))return;this.handleChoiceSelection(e)}isTypingInInput(e){return e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"}isInStoryArea(){const e=document.activeElement,t=document.querySelector(".outerContainer");return e===document.body||t?.contains(e)}handleModifierShortcuts(e){try{switch(e.key){case"s":e.preventDefault(),window.storyManager.saves?.showSaveDialog?.();break;case"r":e.preventDefault(),window.storyManager.confirmRestart();break;case",":e.preventDefault(),window.storyManager.settings?.showSettings?.();break;case"h":e.preventDefault(),window.keyboardHelpModal?.show?.();break}}catch(e){KeyboardShortcuts._error("Keyboard shortcut failed",e)}}handleEscape(){if(window.storyManager.pages?.isViewingSpecialPage?.())try{window.storyManager.pages.returnToStory()}catch(e){KeyboardShortcuts._error("Failed to return from special page",e)}}handleScrolling(e){if(!this.isInStoryArea())return!1;const t=document.querySelector(".outerContainer");if(!t)return!1;const n=window.innerHeight*SMALL_SCROLL_PERCENT,s=window.innerHeight*LARGE_SCROLL_PERCENT;switch(e.key){case"ArrowUp":return e.preventDefault(),t.scrollBy({top:-n,behavior:"smooth"}),!0;case"ArrowDown":return e.preventDefault(),t.scrollBy({top:n,behavior:"smooth"}),!0;case"PageUp":return e.preventDefault(),t.scrollBy({top:-s,behavior:"smooth"}),!0;case"PageDown":return e.preventDefault(),t.scrollBy({top:s,behavior:"smooth"}),!0;case"Home":return e.preventDefault(),t.scrollTo({top:0,behavior:"smooth"}),!0;case"End":return e.preventDefault(),t.scrollTo({top:t.scrollHeight,behavior:"smooth"}),!0}return!1}handleChoiceSelection(e){if(!this.isInStoryArea())return;const s=window.storyManager.story?.currentChoices;if(!s||s.length===0)return;const t=e.key.toLowerCase();let n=null;t>="1"&&t<="9"?n=parseInt(t)-1:t>="a"&&t<="z"&&(n=9+(t.charCodeAt(0)-97)),n!==null&&n<s.length&&(e.preventDefault(),window.storyManager.selectChoice(n))}enable(){this.enabled=!0}disable(){this.enabled=!1}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.keyboardShortcuts=new KeyboardShortcuts}):window.keyboardShortcuts=new KeyboardShortcuts,fetch("story.json").then(e=>{if(!e.ok)throw new Error(`story.json not found (${e.status}). `+`Make sure story.json is in the root folder alongside index.html. `);return e.json()}).then(e=>{try{window.StoryFeatures.scan(e),window.storyManager=new StoryManager(e);const t=document.getElementById("loading-screen");t&&(t.classList.add("hidden"),setTimeout(()=>t.remove(),300));const n=document.getElementById("main-content");n&&n.removeAttribute("aria-busy"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&(window.debug={story:window.storyManager.story,display:window.storyManager.display,saves:window.storyManager.saves,settings:window.storyManager.settings,errors:window.errorManager,getStats:()=>window.storyManager.getStats(),getFeatureInfo:()=>window.storyManager.getFeatureInfo()},console.log("Debug tools available in window.debug"))}catch(e){window.errorManager.critical("Failed to initialize story manager",e,ErrorManager.SOURCES.SYSTEM),showFallbackUI(e)}}).catch(e=>{window.errorManager.critical("Failed to load story file",e,ErrorManager.SOURCES.SYSTEM),showFallbackUI(e)});function showFallbackUI(e){const n=document.getElementById("story");if(!n)return;const t=document.getElementById("loading-screen");t&&(t.classList.add("hidden"),setTimeout(()=>t.remove(),300)),n.innerHTML=`
    <div style="text-align: center; padding: 2rem; color: var(--color-important);">
      <h2>âš ï¸ Story Loading Error</h2>
      <p>Unable to load the story. Please check the browser console (F12) for details.</p>
      <div style="margin: 2rem 0;">
        <button onclick="window.location.reload()" style="
          background: var(--color-accent-primary);
          color: white;
          border: none;
          padding: 0.75rem 1.5rem;
          border-radius: 4px;
          cursor: pointer;
          margin-right: 1rem;
          font-size: 1rem;
        ">Reload Page</button>
        <button onclick="showConsoleHelp()" style="
          background: var(--color-border-medium);
          color: var(--color-text-primary);
          border: 1px solid var(--color-border-medium);
          padding: 0.75rem 1.5rem;
          border-radius: 4px;
          cursor: pointer;
          font-size: 1rem;
        ">How to Check Console</button>
      </div>
      <details style="margin-top: 1rem; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
        <summary style="cursor: pointer; font-weight: 600;">Technical Details</summary>
        <div style="background: var(--color-code-bg); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
          Error: ${e.message}<br>
          Time: ${(new Date).toLocaleString()}<br>
          ${e.stack?`Stack: ${e.stack}`:""}
        </div>
      </details>
    </div>
  `}function showConsoleHelp(){alert(`To check the console for error details:

â€¢ Chrome/Edge: Press F12 or Ctrl+Shift+I, then click "Console"
â€¢ Firefox: Press F12 or Ctrl+Shift+K
â€¢ Safari: Press Cmd+Option+I (Mac), then click "Console"
â€¢ Mobile: Console not easily accessible, try on desktop

Look for red error messages that show what went wrong.`)}window.showConsoleHelp=showConsoleHelp