(()=>{var I=class s{constructor(){if(this._components=[],this._componentsString=null,this._isRelative=!1,typeof arguments[0]=="string"){let t=arguments[0];this.componentsString=t}else if(arguments[0]instanceof s.Component&&arguments[1]instanceof s){let t=arguments[0],e=arguments[1];this._components.push(t),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){let t=arguments[0],e=!!arguments[1];this._components=this._components.concat(t),this._isRelative=e}}get isRelative(){return this._isRelative}get componentCount(){return this._components.length}get head(){return this._components.length>0?this._components[0]:null}get tail(){if(this._components.length>=2){let t=this._components.slice(1,this._components.length);return new s(t)}return s.self}get length(){return this._components.length}get lastComponent(){let t=this._components.length-1;return t>=0?this._components[t]:null}get containsNamedComponent(){for(let t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}static get self(){let t=new s;return t._isRelative=!0,t}GetComponent(t){return this._components[t]}PathByAppendingPath(t){let e=new s,n=0;for(let i=0;i<t._components.length&&t._components[i].isParent;++i)n++;for(let i=0;i<this._components.length-n;++i)e._components.push(this._components[i]);for(let i=n;i<t._components.length;++i)e._components.push(t._components[i]);return e}get componentsString(){return this._componentsString==null&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString}set componentsString(t){if(this._components.length=0,this._componentsString=t,this._componentsString==null||this._componentsString=="")return;this._componentsString[0]=="."&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));let e=this._componentsString.split(".");for(let n of e)/^(\-|\+)?([0-9]+|Infinity)$/.test(n)?this._components.push(new s.Component(parseInt(n))):this._components.push(new s.Component(n))}toString(){return this.componentsString}Equals(t){if(t==null||t._components.length!=this._components.length||t.isRelative!=this.isRelative)return!1;for(let e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}PathByAppendingComponent(t){let e=new s;return e._components.push(...this._components),e._components.push(t),e}},ft,f,k,Vt;function p(s,t){return s instanceof t?ve(s):null}function N(s,t){if(s instanceof t)return ve(s);throw new Error(`${s} is not of type ${t}`)}function Bt(s){return s.hasValidName&&s.name?s:null}function re(s){return s===void 0?null:s}function Se(s){return typeof s=="object"&&typeof s.Equals=="function"}function ve(s,t){return s}I.parentId="^",(function(s){class t{constructor(n){this.index=-1,this.name=null,typeof n=="string"?this.name=n:this.index=n}get isIndex(){return this.index>=0}get isParent(){return this.name==s.parentId}static ToParent(){return new t(s.parentId)}toString(){return this.isIndex?this.index.toString():this.name}Equals(n){return n!=null&&n.isIndex==this.isIndex&&(this.isIndex?this.index==n.index:this.name==n.name)}}s.Component=t})(I||(I={})),(function(s){function t(e,n){if(!e)throw n!==void 0&&console.warn(n),console.trace&&console.trace(),new Error("")}s.AssertType=function(e,n,i){t(e instanceof n,i)},s.Assert=t})(ft||(ft={}));var se=class extends Error{};function h(s){throw new se(`${s} is null or undefined`)}var W=class{constructor(){this.parent=null,this._debugMetadata=null,this._path=null}get debugMetadata(){return this._debugMetadata===null&&this.parent?this.parent.debugMetadata:this._debugMetadata}set debugMetadata(t){this._debugMetadata=t}get ownDebugMetadata(){return this._debugMetadata}DebugLineNumberOfPath(t){if(t===null)return null;let e=this.rootContentContainer;if(e){let n=e.ContentAtPath(t).obj;if(n){let i=n.debugMetadata;if(i!==null)return i.startLineNumber}}return null}get path(){if(this._path==null)if(this.parent==null)this._path=new I;else{let t=[],e=this,n=p(e.parent,P);for(;n!==null;){let i=Bt(e);if(i!=null&&i.hasValidName){if(i.name===null)return h("namedChild.name");t.unshift(new I.Component(i.name))}else t.unshift(new I.Component(n.content.indexOf(e)));e=n,n=p(n.parent,P)}this._path=new I(t)}return this._path}ResolvePath(t){if(t===null)return h("path");if(t.isRelative){let e=p(this,P);return e===null&&(ft.Assert(this.parent!==null,"Can't resolve relative path because we don't have a parent"),e=p(this.parent,P),ft.Assert(e!==null,"Expected parent to be a container"),ft.Assert(t.GetComponent(0).isParent),t=t.tail),e===null?h("nearestContainer"):e.ContentAtPath(t)}{let e=this.rootContentContainer;return e===null?h("contentContainer"):e.ContentAtPath(t)}}ConvertPathToRelative(t){let e=this.path,n=Math.min(t.length,e.length),i=-1;for(let o=0;o<n;++o){let l=e.GetComponent(o),c=t.GetComponent(o);if(!l.Equals(c))break;i=o}if(i==-1)return t;let r=e.componentCount-1-i,a=[];for(let o=0;o<r;++o)a.push(I.Component.ToParent());for(let o=i+1;o<t.componentCount;++o)a.push(t.GetComponent(o));return new I(a,!0)}CompactPathString(t){let e=null,n=null;return t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),n.length<e.length?n:e}get rootContentContainer(){let t=this;for(;t.parent;)t=t.parent;return p(t,P)}Copy(){throw Error("Not Implemented: Doesn't support copying")}SetChild(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}Equals(t){return t===this}},z=class{constructor(t){t=t!==void 0?t.toString():"",this.string=t}get Length(){return this.string.length}Append(t){t!==null&&(this.string+=t)}AppendLine(t){t!==void 0&&this.Append(t),this.string+=`
`}AppendFormat(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,((r,a)=>n[a]!==void 0?n[a]:r))}toString(){return this.string}Clear(){this.string=""}},_=class s{constructor(){if(this.originName=null,this.itemName=null,arguments[1]!==void 0){let t=arguments[0],e=arguments[1];this.originName=t,this.itemName=e}else if(arguments[0]){let t=arguments[0].toString().split(".");this.originName=t[0],this.itemName=t[1]}}static get Null(){return new s(null,null)}get isNull(){return this.originName==null&&this.itemName==null}get fullName(){return(this.originName!==null?this.originName:"?")+"."+this.itemName}toString(){return this.fullName}Equals(t){if(t instanceof s){let e=t;return e.itemName==this.itemName&&e.originName==this.originName}return!1}copy(){return new s(this.originName,this.itemName)}serialized(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}static fromSerializedKey(t){let e=JSON.parse(t);if(!s.isLikeInkListItem(e))return s.Null;let n=e;return new s(n.originName,n.itemName)}static isLikeInkListItem(t){return typeof t=="object"&&!(!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName"))&&(typeof t.originName=="string"||typeof t.originName===null)&&(typeof t.itemName=="string"||typeof t.itemName===null)}},et=class s extends Map{constructor(){if(super(arguments[0]instanceof s?arguments[0]:[]),this.origins=null,this._originNames=[],arguments[0]instanceof s){let t=arguments[0],e=t.originNames;e!==null&&(this._originNames=e.slice()),t.origins!==null&&(this.origins=t.origins.slice())}else if(typeof arguments[0]=="string"){let t=arguments[0],e=arguments[1];if(this.SetInitialOriginName(t),e.listDefinitions===null)return h("originStory.listDefinitions");let n=e.listDefinitions.TryListGetDefinition(t,null);if(!n.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+t);if(n.result===null)return h("def.result");this.origins=[n.result]}else if(typeof arguments[0]=="object"&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){let t=arguments[0];this.Add(t.Key,t.Value)}}static FromString(t,e){var n;if(t==null||t=="")return new s;let i=(n=e.listDefinitions)===null||n===void 0?void 0:n.FindSingleItemListWithName(t);if(i)return i.value===null?h("listValue.value"):new s(i.value);throw new Error("Could not find the InkListItem from the string '"+t+"' to create an InkList because it doesn't exist in the original list definition in ink.")}AddItem(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(t instanceof _){let n=t;if(n.originName==null)return void this.AddItem(n.itemName);if(this.origins===null)return h("this.origins");for(let i of this.origins)if(i.name==n.originName){let r=i.TryGetValueForItem(n,0);if(r.exists)return void this.Add(n,r.result);throw new Error("Could not add the item "+n+" to this list because it doesn't exist in the original list definition in ink.")}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}if(t!==null){let n=t,i=null;if(this.origins===null)return h("this.origins");for(let r of this.origins){if(n===null)return h("itemName");if(r.ContainsItemWithName(n)){if(i!=null)throw new Error("Could not add the item "+n+" to this list because it could come from either "+r.name+" or "+i.name);i=r}}if(i==null){if(e==null)throw new Error("Could not add the item "+n+" to this list because it isn't known to any list definitions previously associated with this list.");{let r=s.FromString(n,e).orderedItems[0];this.Add(r.Key,r.Value)}}else{let r=new _(i.name,n),a=i.ValueForItem(r);this.Add(r,a)}}}ContainsItemNamed(t){for(let[e]of this)if(_.fromSerializedKey(e).itemName==t)return!0;return!1}ContainsKey(t){return this.has(t.serialized())}Add(t,e){let n=t.serialized();if(this.has(n))throw new Error(`The Map already contains an entry for ${t}`);this.set(n,e)}Remove(t){return this.delete(t.serialized())}get Count(){return this.size}get originOfMaxItem(){if(this.origins==null)return null;let t=this.maxItem.Key.originName,e=null;return this.origins.every((n=>n.name!=t||(e=n,!1))),e}get originNames(){if(this.Count>0){this._originNames==null&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);for(let[t]of this){let e=_.fromSerializedKey(t);if(e.originName===null)return h("item.originName");this._originNames.push(e.originName)}}return this._originNames}SetInitialOriginName(t){this._originNames=[t]}SetInitialOriginNames(t){this._originNames=t==null?null:t.slice()}get maxItem(){let t={Key:_.Null,Value:0};for(let[e,n]of this){let i=_.fromSerializedKey(e);(t.Key.isNull||n>t.Value)&&(t={Key:i,Value:n})}return t}get minItem(){let t={Key:_.Null,Value:0};for(let[e,n]of this){let i=_.fromSerializedKey(e);(t.Key.isNull||n<t.Value)&&(t={Key:i,Value:n})}return t}get inverse(){let t=new s;if(this.origins!=null)for(let e of this.origins)for(let[n,i]of e.items){let r=_.fromSerializedKey(n);this.ContainsKey(r)||t.Add(r,i)}return t}get all(){let t=new s;if(this.origins!=null)for(let e of this.origins)for(let[n,i]of e.items){let r=_.fromSerializedKey(n);t.set(r.serialized(),i)}return t}Union(t){let e=new s(this);for(let[n,i]of t)e.set(n,i);return e}Intersect(t){let e=new s;for(let[n,i]of this)t.has(n)&&e.set(n,i);return e}HasIntersection(t){for(let[e]of this)if(t.has(e))return!0;return!1}Without(t){let e=new s(this);for(let[n]of t)e.delete(n);return e}Contains(t){if(typeof t=="string")return this.ContainsItemNamed(t);let e=t;if(e.size==0||this.size==0)return!1;for(let[n]of e)if(!this.has(n))return!1;return!0}GreaterThan(t){return this.Count!=0&&(t.Count==0||this.minItem.Value>t.maxItem.Value)}GreaterThanOrEquals(t){return this.Count!=0&&(t.Count==0||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}LessThan(t){return t.Count!=0&&(this.Count==0||this.maxItem.Value<t.minItem.Value)}LessThanOrEquals(t){return t.Count!=0&&(this.Count==0||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}MaxAsList(){return this.Count>0?new s(this.maxItem):new s}MinAsList(){return this.Count>0?new s(this.minItem):new s}ListWithSubRange(t,e){if(this.Count==0)return new s;let n=this.orderedItems,i=0,r=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?i=t:t instanceof s&&t.Count>0&&(i=t.minItem.Value),Number.isInteger(e)?r=e:e instanceof s&&e.Count>0&&(r=e.maxItem.Value);let a=new s;a.SetInitialOriginNames(this.originNames);for(let o of n)o.Value>=i&&o.Value<=r&&a.Add(o.Key,o.Value);return a}Equals(t){if(!(t instanceof s)||t.Count!=this.Count)return!1;for(let[e]of this)if(!t.has(e))return!1;return!0}get orderedItems(){let t=new Array;for(let[e,n]of this){let i=_.fromSerializedKey(e);t.push({Key:i,Value:n})}return t.sort(((e,n)=>e.Key.originName===null?h("x.Key.originName"):n.Key.originName===null?h("y.Key.originName"):e.Value==n.Value?e.Key.originName.localeCompare(n.Key.originName):e.Value<n.Value?-1:e.Value>n.Value?1:0)),t}get singleItem(){for(let t of this.orderedItems)return t.Key;return null}toString(){let t=this.orderedItems,e=new z;for(let n=0;n<t.length;n++){n>0&&e.Append(", ");let i=t[n].Key;if(i.itemName===null)return h("item.itemName");e.Append(i.itemName)}return e.toString()}valueOf(){return NaN}},Y=class extends Error{constructor(t){super(t),this.useEndLineNumber=!1,this.message=t,this.name="StoryException"}};function tt(s,t,e){if(s===null)return{result:e,exists:!1};let n=s.get(t);return n===void 0?{result:e,exists:!1}:{result:n,exists:!0}}var ae=class s extends W{static Create(t,e){if(e){if(e===f.Int&&Number.isInteger(Number(t)))return new E(Number(t));if(e===f.Float&&!isNaN(t))return new nt(Number(t))}return typeof t=="boolean"?new yt(!!t):typeof t=="string"?new T(String(t)):Number.isInteger(Number(t))?new E(Number(t)):isNaN(t)?t instanceof I?new ot(N(t,I)):t instanceof et?new D(N(t,et)):null:new nt(Number(t))}Copy(){return N(s.Create(this.valueObject),W)}BadCastException(t){return new Y("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}},A=class extends ae{constructor(t){super(),this.value=t}get valueObject(){return this.value}toString(){return this.value===null?h("Value.value"):this.value.toString()}},yt=class extends A{constructor(t){super(t||!1)}get isTruthy(){return!!this.value}get valueType(){return f.Bool}Cast(t){if(this.value===null)return h("Value.value");if(t==this.valueType)return this;if(t==f.Int)return new E(this.value?1:0);if(t==f.Float)return new nt(this.value?1:0);if(t==f.String)return new T(this.value?"true":"false");throw this.BadCastException(t)}toString(){return this.value?"true":"false"}},E=class extends A{constructor(t){super(t||0)}get isTruthy(){return this.value!=0}get valueType(){return f.Int}Cast(t){if(this.value===null)return h("Value.value");if(t==this.valueType)return this;if(t==f.Bool)return new yt(this.value!==0);if(t==f.Float)return new nt(this.value);if(t==f.String)return new T(""+this.value);throw this.BadCastException(t)}},nt=class extends A{constructor(t){super(t||0)}get isTruthy(){return this.value!=0}get valueType(){return f.Float}Cast(t){if(this.value===null)return h("Value.value");if(t==this.valueType)return this;if(t==f.Bool)return new yt(this.value!==0);if(t==f.Int)return new E(this.value);if(t==f.String)return new T(""+this.value);throw this.BadCastException(t)}},T=class extends A{constructor(t){if(super(t||""),this._isNewline=this.value==`
`,this._isInlineWhitespace=!0,this.value===null)return h("Value.value");this.value.length>0&&this.value.split("").every((e=>e==" "||e=="	"||(this._isInlineWhitespace=!1,!1)))}get valueType(){return f.String}get isTruthy(){return this.value===null?h("Value.value"):this.value.length>0}get isNewline(){return this._isNewline}get isInlineWhitespace(){return this._isInlineWhitespace}get isNonWhitespace(){return!this.isNewline&&!this.isInlineWhitespace}Cast(t){if(t==this.valueType)return this;if(t==f.Int){let e=(function(n){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=parseInt(n);return Number.isNaN(r)?{result:i,exists:!1}:{result:r,exists:!0}})(this.value);if(e.exists)return new E(e.result);throw this.BadCastException(t)}if(t==f.Float){let e=(function(n){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=parseFloat(n);return Number.isNaN(r)?{result:i,exists:!1}:{result:r,exists:!0}})(this.value);if(e.exists)return new nt(e.result);throw this.BadCastException(t)}throw this.BadCastException(t)}},ot=class extends A{constructor(){super(arguments.length>0&&arguments[0]!==void 0?arguments[0]:null)}get valueType(){return f.DivertTarget}get targetPath(){return this.value===null?h("Value.value"):this.value}set targetPath(t){this.value=t}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a divert target")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"DivertTargetValue("+this.targetPath+")"}},lt=class s extends A{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:-1;super(t),this._contextIndex=e}get contextIndex(){return this._contextIndex}set contextIndex(t){this._contextIndex=t}get variableName(){return this.value===null?h("Value.value"):this.value}set variableName(t){this.value=t}get valueType(){return f.VariablePointer}get isTruthy(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}Cast(t){if(t==this.valueType)return this;throw this.BadCastException(t)}toString(){return"VariablePointerValue("+this.variableName+")"}Copy(){return new s(this.variableName,this.contextIndex)}},D=class s extends A{get isTruthy(){return this.value===null?h("this.value"):this.value.Count>0}get valueType(){return f.List}Cast(t){if(this.value===null)return h("Value.value");if(t==f.Int){let e=this.value.maxItem;return e.Key.isNull?new E(0):new E(e.Value)}if(t==f.Float){let e=this.value.maxItem;return e.Key.isNull?new nt(0):new nt(e.Value)}if(t==f.String){let e=this.value.maxItem;return e.Key.isNull?new T(""):new T(e.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}constructor(t,e){super(null),t||e?t instanceof et?this.value=new et(t):t instanceof _&&typeof e=="number"&&(this.value=new et({Key:t,Value:e})):this.value=new et}static RetainListOriginsForAssignment(t,e){let n=p(t,s),i=p(e,s);return i&&i.value===null?h("newList.value"):n&&n.value===null?h("oldList.value"):void(n&&i&&i.value.Count==0&&i.value.SetInitialOriginNames(n.value.originNames))}};(function(s){s[s.Bool=-1]="Bool",s[s.Int=0]="Int",s[s.Float=1]="Float",s[s.List=2]="List",s[s.String=3]="String",s[s.DivertTarget=4]="DivertTarget",s[s.VariablePointer=5]="VariablePointer"})(f||(f={}));var oe=class s{constructor(){this.obj=null,this.approximate=!1}get correctObj(){return this.approximate?null:this.obj}get container(){return this.obj instanceof P?this.obj:null}copy(){let t=new s;return t.obj=this.obj,t.approximate=this.approximate,t}},P=class s extends W{constructor(){super(...arguments),this.name=null,this._content=[],this.namedContent=new Map,this.visitsShouldBeCounted=!1,this.turnIndexShouldBeCounted=!1,this.countingAtStartOnly=!1,this._pathToFirstLeafContent=null}get hasValidName(){return this.name!=null&&this.name.length>0}get content(){return this._content}set content(t){this.AddContent(t)}get namedOnlyContent(){let t=new Map;for(let[e,n]of this.namedContent){let i=N(n,W);t.set(e,i)}for(let e of this.content){let n=Bt(e);n!=null&&n.hasValidName&&t.delete(n.name)}return t.size==0&&(t=null),t}set namedOnlyContent(t){let e=this.namedOnlyContent;if(e!=null)for(let[n]of e)this.namedContent.delete(n);if(t!=null)for(let[,n]of t){let i=Bt(n);i!=null&&this.AddToNamedContentOnly(i)}}get countFlags(){let t=0;return this.visitsShouldBeCounted&&(t|=s.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=s.CountFlags.Turns),this.countingAtStartOnly&&(t|=s.CountFlags.CountStartOnly),t==s.CountFlags.CountStartOnly&&(t=0),t}set countFlags(t){let e=t;(e&s.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&s.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&s.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}get pathToFirstLeafContent(){return this._pathToFirstLeafContent==null&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}get internalPathToFirstLeafContent(){let t=[],e=this;for(;e instanceof s;)e.content.length>0&&(t.push(new I.Component(0)),e=e.content[0]);return new I(t)}AddContent(t){if(t instanceof Array){let e=t;for(let n of e)this.AddContent(n)}else{let e=t;if(this._content.push(e),e.parent)throw new Error("content is already in "+e.parent);e.parent=this,this.TryAddNamedContent(e)}}TryAddNamedContent(t){let e=Bt(t);e!=null&&e.hasValidName&&this.AddToNamedContentOnly(e)}AddToNamedContentOnly(t){if(ft.AssertType(t,W,"Can only add Runtime.Objects to a Runtime.Container"),N(t,W).parent=this,t.name===null)return h("namedContentObj.name");this.namedContent.set(t.name,t)}ContentAtPath(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:-1;n==-1&&(n=t.length);let i=new oe;i.approximate=!1;let r=this,a=this;for(let o=e;o<n;++o){let l=t.GetComponent(o);if(r==null){i.approximate=!0;break}let c=r.ContentWithPathComponent(l);if(c==null){i.approximate=!0;break}let u=p(c,s);if(o<n-1&&u==null){i.approximate=!0;break}a=c,r=u}return i.obj=a,i}InsertContent(t,e){if(this.content.splice(e,0,t),t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}AddContentsOfContainer(t){this.content.push(...t.content);for(let e of t.content)e.parent=this,this.TryAddNamedContent(e)}ContentWithPathComponent(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;{if(t.name===null)return h("component.name");let e=tt(this.namedContent,t.name,null);return e.exists?N(e.result,W):null}}BuildStringOfHierarchy(){let t;if(arguments.length==0)return t=new z,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];let e=arguments[1],n=arguments[2];function i(){for(let a=0;a<4*e;++a)t.Append(" ")}i(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==n&&t.Append("  <---"),t.AppendLine(),e++;for(let a=0;a<this.content.length;++a){let o=this.content[a];o instanceof s?o.BuildStringOfHierarchy(t,e,n):(i(),o instanceof T?(t.Append('"'),t.Append(o.toString().replace(`
`,"\\n")),t.Append('"')):t.Append(o.toString())),a!=this.content.length-1&&t.Append(","),o instanceof s||o!=n||t.Append("  <---"),t.AppendLine()}let r=new Map;for(let[a,o]of this.namedContent)this.content.indexOf(N(o,W))>=0||r.set(a,o);if(r.size>0){i(),t.AppendLine("-- named: --");for(let[,a]of r)ft.AssertType(a,s,"Can only print out named Containers"),a.BuildStringOfHierarchy(t,e,n),t.AppendLine()}e--,i(),t.Append("]")}};(function(s){var t;(t=s.CountFlags||(s.CountFlags={}))[t.Start=0]="Start",t[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"})(P||(P={}));var Et=class extends W{toString(){return"Glue"}},d=class s extends W{get commandType(){return this._commandType}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:s.CommandType.NotSet;super(),this._commandType=t}Copy(){return new s(this.commandType)}static EvalStart(){return new s(s.CommandType.EvalStart)}static EvalOutput(){return new s(s.CommandType.EvalOutput)}static EvalEnd(){return new s(s.CommandType.EvalEnd)}static Duplicate(){return new s(s.CommandType.Duplicate)}static PopEvaluatedValue(){return new s(s.CommandType.PopEvaluatedValue)}static PopFunction(){return new s(s.CommandType.PopFunction)}static PopTunnel(){return new s(s.CommandType.PopTunnel)}static BeginString(){return new s(s.CommandType.BeginString)}static EndString(){return new s(s.CommandType.EndString)}static NoOp(){return new s(s.CommandType.NoOp)}static ChoiceCount(){return new s(s.CommandType.ChoiceCount)}static Turns(){return new s(s.CommandType.Turns)}static TurnsSince(){return new s(s.CommandType.TurnsSince)}static ReadCount(){return new s(s.CommandType.ReadCount)}static Random(){return new s(s.CommandType.Random)}static SeedRandom(){return new s(s.CommandType.SeedRandom)}static VisitIndex(){return new s(s.CommandType.VisitIndex)}static SequenceShuffleIndex(){return new s(s.CommandType.SequenceShuffleIndex)}static StartThread(){return new s(s.CommandType.StartThread)}static Done(){return new s(s.CommandType.Done)}static End(){return new s(s.CommandType.End)}static ListFromInt(){return new s(s.CommandType.ListFromInt)}static ListRange(){return new s(s.CommandType.ListRange)}static ListRandom(){return new s(s.CommandType.ListRandom)}static BeginTag(){return new s(s.CommandType.BeginTag)}static EndTag(){return new s(s.CommandType.EndTag)}toString(){return"ControlCommand "+this.commandType.toString()}};(function(s){var t;(t=s.CommandType||(s.CommandType={}))[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.ReadCount=13]="ReadCount",t[t.Random=14]="Random",t[t.SeedRandom=15]="SeedRandom",t[t.VisitIndex=16]="VisitIndex",t[t.SequenceShuffleIndex=17]="SequenceShuffleIndex",t[t.StartThread=18]="StartThread",t[t.Done=19]="Done",t[t.End=20]="End",t[t.ListFromInt=21]="ListFromInt",t[t.ListRange=22]="ListRange",t[t.ListRandom=23]="ListRandom",t[t.BeginTag=24]="BeginTag",t[t.EndTag=25]="EndTag",t[t.TOTAL_VALUES=26]="TOTAL_VALUES"})(d||(d={})),(function(s){s[s.Tunnel=0]="Tunnel",s[s.Function=1]="Function",s[s.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"})(k||(k={}));var L=class s{constructor(){this.container=null,this.index=-1,arguments.length===2&&(this.container=arguments[0],this.index=arguments[1])}Resolve(){return this.index<0?this.container:this.container==null?null:this.container.content.length==0?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}get isNull(){return this.container==null}get path(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new I.Component(this.index)):this.container.path}toString(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}copy(){return new s(this.container,this.index)}static StartOf(t){return new s(t,0)}static get Null(){return new s(null,-1)}},kt=class s extends W{get targetPath(){if(this._targetPath!=null&&this._targetPath.isRelative){let t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath}set targetPath(t){this._targetPath=t,this._targetPointer=L.Null}get targetPointer(){if(this._targetPointer.isNull){let t=this.ResolvePath(this._targetPath).obj;if(this._targetPath===null)return h("this._targetPath");if(this._targetPath.lastComponent===null)return h("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(t===null)return h("targetObj");this._targetPointer.container=t.parent instanceof P?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=L.StartOf(t instanceof P?t:null)}return this._targetPointer.copy()}get targetPathString(){return this.targetPath==null?null:this.CompactPathString(this.targetPath)}set targetPathString(t){this.targetPath=t==null?null:new I(t)}get hasVariableTarget(){return this.variableDivertName!=null}constructor(t){super(),this._targetPath=null,this._targetPointer=L.Null,this.variableDivertName=null,this.pushesToStack=!1,this.stackPushType=0,this.isExternal=!1,this.externalArgs=0,this.isConditional=!1,this.pushesToStack=!1,t!==void 0&&(this.pushesToStack=!0,this.stackPushType=t)}Equals(t){let e=t;return e instanceof s&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:this.targetPath===null?h("this.targetPath"):this.targetPath.Equals(e.targetPath))}toString(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(this.targetPath==null)return"Divert(null)";{let t=new z,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==k.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}},_t=class extends W{constructor(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];super(),this._pathOnChoice=null,this.hasCondition=!1,this.hasStartContent=!1,this.hasChoiceOnlyContent=!1,this.isInvisibleDefault=!1,this.onceOnly=!0,this.onceOnly=t}get pathOnChoice(){if(this._pathOnChoice!=null&&this._pathOnChoice.isRelative){let t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice}set pathOnChoice(t){this._pathOnChoice=t}get choiceTarget(){return this._pathOnChoice===null?h("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}get pathStringOnChoice(){return this.pathOnChoice===null?h("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)}set pathStringOnChoice(t){this.pathOnChoice=new I(t)}get flags(){let t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t}set flags(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}toString(){return this.pathOnChoice===null?h("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}},At=class extends W{get containerForCount(){return this.pathForCount===null?null:this.ResolvePath(this.pathForCount).container}get pathStringForCount(){return this.pathForCount===null?null:this.CompactPathString(this.pathForCount)}set pathStringForCount(t){this.pathForCount=t===null?null:new I(t)}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;super(),this.pathForCount=null,this.name=t}toString(){return this.name!=null?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}},Ft=class extends W{constructor(t,e){super(),this.variableName=t||null,this.isNewDeclaration=!!e,this.isGlobal=!1}toString(){return"VarAssign to "+this.variableName}},ut=class extends W{toString(){return"Void"}},b=class s extends W{static CallWithName(t){return new s(t)}static CallExistsWithName(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}get name(){return this._name===null?h("NativeFunctionCall._name"):this._name}set name(t){this._name=t,this._isPrototype||(s._nativeFunctions===null?h("NativeFunctionCall._nativeFunctions"):this._prototype=s._nativeFunctions.get(this._name)||null)}get numberOfParameters(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters}set numberOfParameters(t){this._numberOfParameters=t}Call(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");let e=!1;for(let r of t){if(r instanceof ut)throw new Y("Attempting to perform "+this.name+' on a void value. Did you forget to "return" a value from a function you called here?');r instanceof D&&(e=!0)}if(t.length==2&&e)return this.CallBinaryListOperation(t);let n=this.CoerceValuesToSingleType(t),i=n[0].valueType;return i==f.Int||i==f.Float||i==f.String||i==f.DivertTarget||i==f.List?this.CallType(n):null}CallType(t){let e=N(t[0],A),n=e.valueType,i=e,r=t.length;if(r==2||r==1){if(this._operationFuncs===null)return h("NativeFunctionCall._operationFuncs");let a=this._operationFuncs.get(n);if(!a){let o=f[n];throw new Y("Cannot perform operation "+this.name+" on "+o)}if(r==2){let o=N(t[1],A),l=a;if(i.value===null||o.value===null)return h("NativeFunctionCall.Call BinaryOp values");let c=l(i.value,o.value);return A.Create(c)}{let o=a;if(i.value===null)return h("NativeFunctionCall.Call UnaryOp value");let l=o(i.value);return this.name===s.Int?A.Create(l,f.Int):this.name===s.Float?A.Create(l,f.Float):A.Create(l,e.valueType)}}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}CallBinaryListOperation(t){if((this.name=="+"||this.name=="-")&&t[0]instanceof D&&t[1]instanceof E)return this.CallListIncrementOperation(t);let e=N(t[0],A),n=N(t[1],A);if(!(this.name!="&&"&&this.name!="||"||e.valueType==f.List&&n.valueType==f.List)){if(this._operationFuncs===null)return h("NativeFunctionCall._operationFuncs");let i=this._operationFuncs.get(f.Int);if(i===null)return h("NativeFunctionCall.CallBinaryListOperation op");let r=(function(a){if(typeof a=="boolean")return a;throw new Error(`${a} is not a boolean`)})(i(e.isTruthy?1:0,n.isTruthy?1:0));return new yt(r)}if(e.valueType==f.List&&n.valueType==f.List)return this.CallType([e,n]);throw new Y("Can not call use "+this.name+" operation on "+f[e.valueType]+" and "+f[n.valueType])}CallListIncrementOperation(t){let e=N(t[0],D),n=N(t[1],E),i=new et;if(e.value===null)return h("NativeFunctionCall.CallListIncrementOperation listVal.value");for(let[r,a]of e.value){let o=_.fromSerializedKey(r);if(this._operationFuncs===null)return h("NativeFunctionCall._operationFuncs");let l=this._operationFuncs.get(f.Int);if(n.value===null)return h("NativeFunctionCall.CallListIncrementOperation intVal.value");let c=l(a,n.value),u=null;if(e.value.origins===null)return h("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");for(let m of e.value.origins)if(m.name==o.originName){u=m;break}if(u!=null){let m=u.TryGetItemWithValue(c,_.Null);m.exists&&i.Add(m.result,c)}}return new D(i)}CoerceValuesToSingleType(t){let e=f.Int,n=null;for(let r of t){let a=N(r,A);a.valueType>e&&(e=a.valueType),a.valueType==f.List&&(n=p(a,D))}let i=[];if(f[e]==f[f.List])for(let r of t){let a=N(r,A);if(a.valueType==f.List)i.push(a);else{if(a.valueType!=f.Int){let o=f[a.valueType];throw new Y("Cannot mix Lists and "+o+" values in this operation")}{let o=parseInt(a.valueObject);if(n=N(n,D),n.value===null)return h("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");let l=n.value.originOfMaxItem;if(l===null)return h("NativeFunctionCall.CoerceValuesToSingleType list");let c=l.TryGetItemWithValue(o,_.Null);if(!c.exists)throw new Y("Could not find List item with the value "+o+" in "+l.name);{let u=new D(c.result,o);i.push(u)}}}}else for(let r of t){let a=N(r,A).Cast(e);i.push(a)}return i}constructor(){if(super(),this._name=null,this._numberOfParameters=0,this._prototype=null,this._isPrototype=!1,this._operationFuncs=null,arguments.length===0)s.GenerateNativeFunctionsIfNecessary();else if(arguments.length===1){let t=arguments[0];s.GenerateNativeFunctionsIfNecessary(),this.name=t}else if(arguments.length===2){let t=arguments[0],e=arguments[1];this._isPrototype=!0,this.name=t,this.numberOfParameters=e}}static Identity(t){return t}static GenerateNativeFunctionsIfNecessary(){if(this._nativeFunctions==null){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,((n,i)=>n+i)),this.AddIntBinaryOp(this.Subtract,((n,i)=>n-i)),this.AddIntBinaryOp(this.Multiply,((n,i)=>n*i)),this.AddIntBinaryOp(this.Divide,((n,i)=>Math.floor(n/i))),this.AddIntBinaryOp(this.Mod,((n,i)=>n%i)),this.AddIntUnaryOp(this.Negate,(n=>-n)),this.AddIntBinaryOp(this.Equal,((n,i)=>n==i)),this.AddIntBinaryOp(this.Greater,((n,i)=>n>i)),this.AddIntBinaryOp(this.Less,((n,i)=>n<i)),this.AddIntBinaryOp(this.GreaterThanOrEquals,((n,i)=>n>=i)),this.AddIntBinaryOp(this.LessThanOrEquals,((n,i)=>n<=i)),this.AddIntBinaryOp(this.NotEquals,((n,i)=>n!=i)),this.AddIntUnaryOp(this.Not,(n=>n==0)),this.AddIntBinaryOp(this.And,((n,i)=>n!=0&&i!=0)),this.AddIntBinaryOp(this.Or,((n,i)=>n!=0||i!=0)),this.AddIntBinaryOp(this.Max,((n,i)=>Math.max(n,i))),this.AddIntBinaryOp(this.Min,((n,i)=>Math.min(n,i))),this.AddIntBinaryOp(this.Pow,((n,i)=>Math.pow(n,i))),this.AddIntUnaryOp(this.Floor,s.Identity),this.AddIntUnaryOp(this.Ceiling,s.Identity),this.AddIntUnaryOp(this.Int,s.Identity),this.AddIntUnaryOp(this.Float,(n=>n)),this.AddFloatBinaryOp(this.Add,((n,i)=>n+i)),this.AddFloatBinaryOp(this.Subtract,((n,i)=>n-i)),this.AddFloatBinaryOp(this.Multiply,((n,i)=>n*i)),this.AddFloatBinaryOp(this.Divide,((n,i)=>n/i)),this.AddFloatBinaryOp(this.Mod,((n,i)=>n%i)),this.AddFloatUnaryOp(this.Negate,(n=>-n)),this.AddFloatBinaryOp(this.Equal,((n,i)=>n==i)),this.AddFloatBinaryOp(this.Greater,((n,i)=>n>i)),this.AddFloatBinaryOp(this.Less,((n,i)=>n<i)),this.AddFloatBinaryOp(this.GreaterThanOrEquals,((n,i)=>n>=i)),this.AddFloatBinaryOp(this.LessThanOrEquals,((n,i)=>n<=i)),this.AddFloatBinaryOp(this.NotEquals,((n,i)=>n!=i)),this.AddFloatUnaryOp(this.Not,(n=>n==0)),this.AddFloatBinaryOp(this.And,((n,i)=>n!=0&&i!=0)),this.AddFloatBinaryOp(this.Or,((n,i)=>n!=0||i!=0)),this.AddFloatBinaryOp(this.Max,((n,i)=>Math.max(n,i))),this.AddFloatBinaryOp(this.Min,((n,i)=>Math.min(n,i))),this.AddFloatBinaryOp(this.Pow,((n,i)=>Math.pow(n,i))),this.AddFloatUnaryOp(this.Floor,(n=>Math.floor(n))),this.AddFloatUnaryOp(this.Ceiling,(n=>Math.ceil(n))),this.AddFloatUnaryOp(this.Int,(n=>Math.floor(n))),this.AddFloatUnaryOp(this.Float,s.Identity),this.AddStringBinaryOp(this.Add,((n,i)=>n+i)),this.AddStringBinaryOp(this.Equal,((n,i)=>n===i)),this.AddStringBinaryOp(this.NotEquals,((n,i)=>n!==i)),this.AddStringBinaryOp(this.Has,((n,i)=>n.includes(i))),this.AddStringBinaryOp(this.Hasnt,((n,i)=>!n.includes(i))),this.AddListBinaryOp(this.Add,((n,i)=>n.Union(i))),this.AddListBinaryOp(this.Subtract,((n,i)=>n.Without(i))),this.AddListBinaryOp(this.Has,((n,i)=>n.Contains(i))),this.AddListBinaryOp(this.Hasnt,((n,i)=>!n.Contains(i))),this.AddListBinaryOp(this.Intersect,((n,i)=>n.Intersect(i))),this.AddListBinaryOp(this.Equal,((n,i)=>n.Equals(i))),this.AddListBinaryOp(this.Greater,((n,i)=>n.GreaterThan(i))),this.AddListBinaryOp(this.Less,((n,i)=>n.LessThan(i))),this.AddListBinaryOp(this.GreaterThanOrEquals,((n,i)=>n.GreaterThanOrEquals(i))),this.AddListBinaryOp(this.LessThanOrEquals,((n,i)=>n.LessThanOrEquals(i))),this.AddListBinaryOp(this.NotEquals,((n,i)=>!n.Equals(i))),this.AddListBinaryOp(this.And,((n,i)=>n.Count>0&&i.Count>0)),this.AddListBinaryOp(this.Or,((n,i)=>n.Count>0||i.Count>0)),this.AddListUnaryOp(this.Not,(n=>n.Count==0?1:0)),this.AddListUnaryOp(this.Invert,(n=>n.inverse)),this.AddListUnaryOp(this.All,(n=>n.all)),this.AddListUnaryOp(this.ListMin,(n=>n.MinAsList())),this.AddListUnaryOp(this.ListMax,(n=>n.MaxAsList())),this.AddListUnaryOp(this.Count,(n=>n.Count)),this.AddListUnaryOp(this.ValueOfList,(n=>n.maxItem.Value));let t=(n,i)=>n.Equals(i),e=(n,i)=>!n.Equals(i);this.AddOpToNativeFunc(this.Equal,2,f.DivertTarget,t),this.AddOpToNativeFunc(this.NotEquals,2,f.DivertTarget,e)}}AddOpFuncForType(t,e){this._operationFuncs==null&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}static AddOpToNativeFunc(t,e,n,i){if(this._nativeFunctions===null)return h("NativeFunctionCall._nativeFunctions");let r=this._nativeFunctions.get(t);r||(r=new s(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(n,i)}static AddIntBinaryOp(t,e){this.AddOpToNativeFunc(t,2,f.Int,e)}static AddIntUnaryOp(t,e){this.AddOpToNativeFunc(t,1,f.Int,e)}static AddFloatBinaryOp(t,e){this.AddOpToNativeFunc(t,2,f.Float,e)}static AddFloatUnaryOp(t,e){this.AddOpToNativeFunc(t,1,f.Float,e)}static AddStringBinaryOp(t,e){this.AddOpToNativeFunc(t,2,f.String,e)}static AddListBinaryOp(t,e){this.AddOpToNativeFunc(t,2,f.List,e)}static AddListUnaryOp(t,e){this.AddOpToNativeFunc(t,1,f.List,e)}toString(){return'Native "'+this.name+'"'}};b.Add="+",b.Subtract="-",b.Divide="/",b.Multiply="*",b.Mod="%",b.Negate="_",b.Equal="==",b.Greater=">",b.Less="<",b.GreaterThanOrEquals=">=",b.LessThanOrEquals="<=",b.NotEquals="!=",b.Not="!",b.And="&&",b.Or="||",b.Min="MIN",b.Max="MAX",b.Pow="POW",b.Floor="FLOOR",b.Ceiling="CEILING",b.Int="INT",b.Float="FLOAT",b.Has="?",b.Hasnt="!?",b.Intersect="^",b.ListMin="LIST_MIN",b.ListMax="LIST_MAX",b.All="LIST_ALL",b.Count="LIST_COUNT",b.ValueOfList="LIST_VALUE",b.Invert="LIST_INVERT",b._nativeFunctions=null;var gt=class extends W{constructor(t){super(),this.text=t.toString()||""}toString(){return"# "+this.text}},Mt=class s extends W{constructor(){super(...arguments),this.text="",this.index=0,this.threadAtGeneration=null,this.sourcePath="",this.targetPath=null,this.isInvisibleDefault=!1,this.tags=null,this.originalThreadIndex=0}get pathStringOnChoice(){return this.targetPath===null?h("Choice.targetPath"):this.targetPath.toString()}set pathStringOnChoice(t){this.targetPath=new I(t)}Clone(){let t=new s;return t.text=this.text,t.sourcePath=this.sourcePath,t.index=this.index,t.targetPath=this.targetPath,t.originalThreadIndex=this.originalThreadIndex,t.isInvisibleDefault=this.isInvisibleDefault,this.threadAtGeneration!==null&&(t.threadAtGeneration=this.threadAtGeneration.Copy()),t}},le=class{constructor(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}get name(){return this._name}get items(){if(this._items==null){this._items=new Map;for(let[t,e]of this._itemNameToValues){let n=new _(this.name,t);this._items.set(n.serialized(),e)}}return this._items}ValueForItem(t){if(!t.itemName)return 0;let e=this._itemNameToValues.get(t.itemName);return e!==void 0?e:0}ContainsItem(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}ContainsItemWithName(t){return this._itemNameToValues.has(t)}TryGetItemWithValue(t,e){for(let[n,i]of this._itemNameToValues)if(i==t)return{result:new _(this.name,n),exists:!0};return{result:_.Null,exists:!1}}TryGetValueForItem(t,e){if(!t.itemName)return{result:0,exists:!1};let n=this._itemNameToValues.get(t.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}},$t=class{constructor(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;for(let e of t){this._lists.set(e.name,e);for(let[n,i]of e.items){let r=_.fromSerializedKey(n),a=new D(r,i);if(!r.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(r.itemName,a),this._allUnambiguousListValueCache.set(r.fullName,a)}}}get lists(){let t=[];for(let[,e]of this._lists)t.push(e);return t}TryListGetDefinition(t,e){if(t===null)return{result:e,exists:!1};let n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}FindSingleItemListWithName(t){if(t===null)return h("name");let e=this._allUnambiguousListValueCache.get(t);return e!==void 0?e:null}},V=class s{static JArrayToRuntimeObjList(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=t.length;e&&n--;let i=[];for(let r=0;r<n;r++){let a=t[r],o=this.JTokenToRuntimeObject(a);if(o===null)return h("runtimeObj");i.push(o)}return i}static WriteDictionaryRuntimeObjs(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WritePropertyStart(n),this.WriteRuntimeObject(t,i),t.WritePropertyEnd();t.WriteObjectEnd()}static WriteListRuntimeObjs(t,e){t.WriteArrayStart();for(let n of e)this.WriteRuntimeObject(t,n);t.WriteArrayEnd()}static WriteIntDictionary(t,e){t.WriteObjectStart();for(let[n,i]of e)t.WriteIntProperty(n,i);t.WriteObjectEnd()}static WriteRuntimeObject(t,e){let n=p(e,P);if(n)return void this.WriteRuntimeContainer(t,n);let i=p(e,kt);if(i){let $,mt="->";return i.isExternal?mt="x()":i.pushesToStack&&(i.stackPushType==k.Function?mt="f()":i.stackPushType==k.Tunnel&&(mt="->t->")),$=i.hasVariableTarget?i.variableDivertName:i.targetPathString,t.WriteObjectStart(),t.WriteProperty(mt,$),i.hasVariableTarget&&t.WriteProperty("var",!0),i.isConditional&&t.WriteProperty("c",!0),i.externalArgs>0&&t.WriteIntProperty("exArgs",i.externalArgs),void t.WriteObjectEnd()}let r=p(e,_t);if(r)return t.WriteObjectStart(),t.WriteProperty("*",r.pathStringOnChoice),t.WriteIntProperty("flg",r.flags),void t.WriteObjectEnd();let a=p(e,yt);if(a)return void t.WriteBool(a.value);let o=p(e,E);if(o)return void t.WriteInt(o.value);let l=p(e,nt);if(l)return void t.WriteFloat(l.value);let c=p(e,T);if(c)return void(c.isNewline?t.Write(`
`,!1):(t.WriteStringStart(),t.WriteStringInner("^"),t.WriteStringInner(c.value),t.WriteStringEnd()));let u=p(e,D);if(u)return void this.WriteInkList(t,u);let m=p(e,ot);if(m)return t.WriteObjectStart(),m.value===null?h("divTargetVal.value"):(t.WriteProperty("^->",m.value.componentsString),void t.WriteObjectEnd());let g=p(e,lt);if(g)return t.WriteObjectStart(),t.WriteProperty("^var",g.value),t.WriteIntProperty("ci",g.contextIndex),void t.WriteObjectEnd();if(p(e,Et))return void t.Write("<>");let S=p(e,d);if(S)return void t.Write(s._controlCommandNames[S.commandType]);let B=p(e,b);if(B){let $=B.name;return $=="^"&&($="L^"),void t.Write($)}let R=p(e,At);if(R){t.WriteObjectStart();let $=R.pathStringForCount;return $!=null?t.WriteProperty("CNT?",$):t.WriteProperty("VAR?",R.name),void t.WriteObjectEnd()}let J=p(e,Ft);if(J){t.WriteObjectStart();let $=J.isGlobal?"VAR=":"temp=";return t.WriteProperty($,J.variableName),J.isNewDeclaration||t.WriteProperty("re",!0),void t.WriteObjectEnd()}if(p(e,ut))return void t.Write("void");let O=p(e,gt);if(O)return t.WriteObjectStart(),t.WriteProperty("#",O.text),void t.WriteObjectEnd();let st=p(e,Mt);if(!st)throw new Error("Failed to convert runtime object to Json token: "+e);this.WriteChoice(t,st)}static JObjectToDictionaryRuntimeObjs(t){let e=new Map;for(let n in t)if(t.hasOwnProperty(n)){let i=this.JTokenToRuntimeObject(t[n]);if(i===null)return h("inkObject");e.set(n,i)}return e}static JObjectToIntDictionary(t){let e=new Map;for(let n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}static JTokenToRuntimeObject(t){if(typeof t=="number"&&!isNaN(t)||typeof t=="boolean")return A.Create(t);if(typeof t=="string"){let e=t.toString(),n=/^([0-9]+.[0-9]+f)$/.exec(e);if(n)return new nt(parseFloat(n[0]));let i=e[0];if(i=="^")return new T(e.substring(1));if(i==`
`&&e.length==1)return new T(`
`);if(e=="<>")return new Et;for(let r=0;r<s._controlCommandNames.length;++r)if(e==s._controlCommandNames[r])return new d(r);if(e=="L^"&&(e="^"),b.CallExistsWithName(e))return b.CallWithName(e);if(e=="->->")return d.PopTunnel();if(e=="~ret")return d.PopFunction();if(e=="void")return new ut}if(typeof t=="object"&&!Array.isArray(t)){let e,n=t;if(n["^->"])return e=n["^->"],new ot(new I(e.toString()));if(n["^var"]){e=n["^var"];let u=new lt(e.toString());return"ci"in n&&(e=n.ci,u.contextIndex=parseInt(e)),u}let i=!1,r=!1,a=k.Function,o=!1;if((e=n["->"])?i=!0:(e=n["f()"])?(i=!0,r=!0,a=k.Function):(e=n["->t->"])?(i=!0,r=!0,a=k.Tunnel):(e=n["x()"])&&(i=!0,o=!0,r=!1,a=k.Function),i){let u=new kt;u.pushesToStack=r,u.stackPushType=a,u.isExternal=o;let m=e.toString();return(e=n.var)?u.variableDivertName=m:u.targetPathString=m,u.isConditional=!!n.c,o&&(e=n.exArgs)&&(u.externalArgs=parseInt(e)),u}if(e=n["*"]){let u=new _t;return u.pathStringOnChoice=e.toString(),(e=n.flg)&&(u.flags=parseInt(e)),u}if(e=n["VAR?"])return new At(e.toString());if(e=n["CNT?"]){let u=new At;return u.pathStringForCount=e.toString(),u}let l=!1,c=!1;if((e=n["VAR="])?(l=!0,c=!0):(e=n["temp="])&&(l=!0,c=!1),l){let u=e.toString(),m=!n.re,g=new Ft(u,m);return g.isGlobal=c,g}if(n["#"]!==void 0)return e=n["#"],new gt(e.toString());if(e=n.list){let u=e,m=new et;if(e=n.origins){let g=e;m.SetInitialOriginNames(g)}for(let g in u)if(u.hasOwnProperty(g)){let S=u[g],B=new _(g),R=parseInt(S);m.Add(B,R)}return new D(m)}if(n.originalChoicePath!=null)return this.JObjectToChoice(n)}if(Array.isArray(t))return this.JArrayToContainer(t);if(t==null)return null;throw new Error("Failed to convert token to runtime object: "+this.toJson(t,["parent"]))}static toJson(t,e,n){return JSON.stringify(t,((i,r)=>e?.some((a=>a===i))?void 0:r),n)}static WriteRuntimeContainer(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(t.WriteArrayStart(),e===null)return h("container");for(let l of e.content)this.WriteRuntimeObject(t,l);let i=e.namedOnlyContent,r=e.countFlags,a=e.name!=null&&!n,o=i!=null||r>0||a;if(o&&t.WriteObjectStart(),i!=null)for(let[l,c]of i){let u=l,m=p(c,P);t.WritePropertyStart(u),this.WriteRuntimeContainer(t,m,!0),t.WritePropertyEnd()}r>0&&t.WriteIntProperty("#f",r),a&&t.WriteProperty("#n",e.name),o?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}static JArrayToContainer(t){let e=new P;e.content=this.JArrayToRuntimeObjList(t,!0);let n=t[t.length-1];if(n!=null){let i=new Map;for(let r in n)if(r=="#f")e.countFlags=parseInt(n[r]);else if(r=="#n")e.name=n[r].toString();else{let a=this.JTokenToRuntimeObject(n[r]),o=p(a,P);o&&(o.name=r),i.set(r,a)}e.namedOnlyContent=i}return e}static JObjectToChoice(t){let e=new Mt;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e.tags=this.JArrayToTags(t),e}static JArrayToTags(t){return t.tags?t.tags:null}static WriteChoice(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),this.WriteChoiceTags(t,e),t.WriteObjectEnd()}static WriteChoiceTags(t,e){if(e.tags&&e.tags.length>0){t.WritePropertyStart("tags"),t.WriteArrayStart();for(let n of e.tags)t.Write(n);t.WriteArrayEnd(),t.WritePropertyEnd()}}static WriteInkList(t,e){let n=e.value;if(n===null)return h("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();for(let[i,r]of n){let a=_.fromSerializedKey(i),o=r;if(a.itemName===null)return h("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(a.originName?a.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(a.itemName),t.WritePropertyNameEnd(),t.Write(o),t.WritePropertyEnd()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),n.Count==0&&n.originNames!=null&&n.originNames.length>0){t.WritePropertyStart("origins"),t.WriteArrayStart();for(let i of n.originNames)t.Write(i);t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}static ListDefinitionsToJToken(t){let e={};for(let n of t.lists){let i={};for(let[r,a]of n.items){let o=_.fromSerializedKey(r);if(o.itemName===null)return h("item.itemName");i[o.itemName]=a}e[n.name]=i}return e}static JTokenToListDefinitions(t){let e=t,n=[];for(let i in e)if(e.hasOwnProperty(i)){let r=i.toString(),a=e[i],o=new Map;for(let c in a)if(e.hasOwnProperty(i)){let u=a[c];o.set(c,parseInt(u))}let l=new le(r,o);n.push(l)}return new $t(n)}};V._controlCommandNames=(()=>{let s=[];s[d.CommandType.EvalStart]="ev",s[d.CommandType.EvalOutput]="out",s[d.CommandType.EvalEnd]="/ev",s[d.CommandType.Duplicate]="du",s[d.CommandType.PopEvaluatedValue]="pop",s[d.CommandType.PopFunction]="~ret",s[d.CommandType.PopTunnel]="->->",s[d.CommandType.BeginString]="str",s[d.CommandType.EndString]="/str",s[d.CommandType.NoOp]="nop",s[d.CommandType.ChoiceCount]="choiceCnt",s[d.CommandType.Turns]="turn",s[d.CommandType.TurnsSince]="turns",s[d.CommandType.ReadCount]="readc",s[d.CommandType.Random]="rnd",s[d.CommandType.SeedRandom]="srnd",s[d.CommandType.VisitIndex]="visit",s[d.CommandType.SequenceShuffleIndex]="seq",s[d.CommandType.StartThread]="thread",s[d.CommandType.Done]="done",s[d.CommandType.End]="end",s[d.CommandType.ListFromInt]="listInt",s[d.CommandType.ListRange]="range",s[d.CommandType.ListRandom]="lrnd",s[d.CommandType.BeginTag]="#",s[d.CommandType.EndTag]="/#";for(let t=0;t<d.CommandType.TOTAL_VALUES;++t)if(s[t]==null)throw new Error("Control command not accounted for in serialisation");return s})();var wt=class s{get elements(){return this.callStack}get depth(){return this.elements.length}get currentElement(){let t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}get currentElementIndex(){return this.callStack.length-1}get currentThread(){return this._threads[this._threads.length-1]}set currentThread(t){ft.Assert(this._threads.length==1,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}get canPop(){return this.callStack.length>1}constructor(){if(this._threadCounter=0,this._startOfRoot=L.Null,arguments[0]instanceof ct){let t=arguments[0];this._startOfRoot=L.StartOf(t.rootContentContainer),this.Reset()}else{let t=arguments[0];this._threads=[];for(let e of t._threads)this._threads.push(e.Copy());this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot.copy()}}Reset(){this._threads=[],this._threads.push(new s.Thread),this._threads[0].callstack.push(new s.Element(k.Tunnel,this._startOfRoot))}SetJsonToken(t,e){this._threads.length=0;let n=t.threads;for(let i of n){let r=i,a=new s.Thread(r,e);this._threads.push(a)}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=L.StartOf(e.rootContentContainer)}WriteJson(t){t.WriteObject((e=>{e.WritePropertyStart("threads"),e.WriteArrayStart();for(let n of this._threads)n.WriteJson(e);e.WriteArrayEnd(),e.WritePropertyEnd(),e.WritePropertyStart("threadCounter"),e.WriteInt(this._threadCounter),e.WritePropertyEnd()}))}PushThread(){let t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}ForkThread(){let t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}PopThread(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}get canPopThread(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}get elementIsEvaluateFromGame(){return this.currentElement.type==k.FunctionEvaluationFromGame}Push(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=new s.Element(t,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=e,i.functionStartInOutputStream=n,this.callStack.push(i)}CanPop(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return!!this.canPop&&(t==null||this.currentElement.type==t)}Pop(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}GetTemporaryVariableWithName(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:-1;e==-1&&(e=this.currentElementIndex+1);let n=tt(this.callStack[e-1].temporaryVariables,t,null);return n.exists?n.result:null}SetTemporaryVariable(t,e,n){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:-1;i==-1&&(i=this.currentElementIndex+1);let r=this.callStack[i-1];if(!n&&!r.temporaryVariables.get(t))throw new Error("Could not find temporary variable to set: "+t);let a=tt(r.temporaryVariables,t,null);a.exists&&D.RetainListOriginsForAssignment(a.result,e),r.temporaryVariables.set(t,e)}ContextForVariableNamed(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}ThreadWithIndex(t){let e=this._threads.filter((n=>{if(n.threadIndex==t)return n}));return e.length>0?e[0]:null}get callStack(){return this.currentThread.callstack}get callStackTrace(){let t=new z;for(let e=0;e<this._threads.length;e++){let n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat(`=== THREAD {0}/{1} {2}===
`,e+1,this._threads.length,i?"(current) ":"");for(let r=0;r<n.callstack.length;r++){n.callstack[r].type==k.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");let a=n.callstack[r].currentPointer;if(!a.isNull){if(t.Append("<SOMEWHERE IN "),a.container===null)return h("pointer.container");t.Append(a.container.path.toString()),t.AppendLine(">")}}}return t.toString()}};(function(s){class t{constructor(i,r){let a=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=r.copy(),this.inExpressionEvaluation=a,this.temporaryVariables=new Map,this.type=i}Copy(){let i=new t(this.type,this.currentPointer,this.inExpressionEvaluation);return i.temporaryVariables=new Map(this.temporaryVariables),i.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,i.functionStartInOutputStream=this.functionStartInOutputStream,i}}s.Element=t;class e{constructor(){if(this.threadIndex=0,this.previousPointer=L.Null,this.callstack=[],arguments[0]&&arguments[1]){let i=arguments[0],r=arguments[1];this.threadIndex=parseInt(i.threadIndex);let a=i.callstack;for(let l of a){let c,u=l,m=parseInt(u.type),g=L.Null,S=u.cPath;if(S!==void 0){c=S.toString();let O=r.ContentAtPath(new I(c));if(g.container=O.container,g.index=parseInt(u.idx),O.obj==null)throw new Error("When loading state, internal story location couldn't be found: "+c+". Has the story changed since this save data was created?");O.approximate&&(g.container!==null?r.Warning("When loading state, exact internal story location couldn't be found: '"+c+"', so it was approximated to '"+g.container.path.toString()+"' to recover. Has the story changed since this save data was created?"):r.Warning("When loading state, exact internal story location couldn't be found: '"+c+"' and it may not be recoverable. Has the story changed since this save data was created?"))}let B=!!u.exp,R=new t(m,g,B),J=u.temp;J!==void 0?R.temporaryVariables=V.JObjectToDictionaryRuntimeObjs(J):R.temporaryVariables.clear(),this.callstack.push(R)}let o=i.previousContentObject;if(o!==void 0){let l=new I(o.toString());this.previousPointer=r.PointerAtPath(l)}}}Copy(){let i=new e;i.threadIndex=this.threadIndex;for(let r of this.callstack)i.callstack.push(r.Copy());return i.previousPointer=this.previousPointer.copy(),i}WriteJson(i){i.WriteObjectStart(),i.WritePropertyStart("callstack"),i.WriteArrayStart();for(let r of this.callstack){if(i.WriteObjectStart(),!r.currentPointer.isNull){if(r.currentPointer.container===null)return h("el.currentPointer.container");i.WriteProperty("cPath",r.currentPointer.container.path.componentsString),i.WriteIntProperty("idx",r.currentPointer.index)}i.WriteProperty("exp",r.inExpressionEvaluation),i.WriteIntProperty("type",r.type),r.temporaryVariables.size>0&&(i.WritePropertyStart("temp"),V.WriteDictionaryRuntimeObjs(i,r.temporaryVariables),i.WritePropertyEnd()),i.WriteObjectEnd()}if(i.WriteArrayEnd(),i.WritePropertyEnd(),i.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){let r=this.previousPointer.Resolve();if(r===null)return h("this.previousPointer.Resolve()");i.WriteProperty("previousContentObject",r.path.toString())}i.WriteObjectEnd()}}s.Thread=e})(wt||(wt={}));var Ut=class s extends class{}{variableChangedEvent(t,e){for(let n of this.variableChangedEventCallbacks)n(t,e)}StartVariableObservation(){this._batchObservingVariableChanges=!0,this._changedVariablesForBatchObs=new Set}CompleteVariableObservation(){this._batchObservingVariableChanges=!1;let t=new Map;if(this._changedVariablesForBatchObs!=null)for(let e of this._changedVariablesForBatchObs){let n=this._globalVariables.get(e);this.variableChangedEvent(e,n)}if(this.patch!=null)for(let e of this.patch.changedVariables){let n=this.patch.TryGetGlobal(e,null);n.exists&&t.set(e,n)}return this._changedVariablesForBatchObs=null,t}NotifyObservers(t){for(let[e,n]of t)this.variableChangedEvent(e,n)}get callStack(){return this._callStack}set callStack(t){this._callStack=t}$(t,e){if(e===void 0){let n=null;return this.patch!==null&&(n=this.patch.TryGetGlobal(t,null),n.exists)?n.result.valueObject:(n=this._globalVariables.get(t),n===void 0&&(n=this._defaultGlobalVariables.get(t)),n!==void 0?n.valueObject:null)}{if(this._defaultGlobalVariables.get(t)===void 0)throw new Y("Cannot assign to a variable ("+t+") that hasn't been declared in the story");let n=A.Create(e);if(n==null)throw e==null?new Error("Cannot pass null to VariableState"):new Error("Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,n)}}constructor(t,e){super(),this.variableChangedEventCallbacks=[],this.patch=null,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._batchObservingVariableChanges=!1,this._globalVariables=new Map,this._callStack=t,this._listDefsOrigin=e;try{return new Proxy(this,{get:(n,i)=>i in n?n[i]:n.$(i),set:(n,i,r)=>(i in n?n[i]=r:n.$(i,r),!0),ownKeys:n=>[...new Set([...n._defaultGlobalVariables.keys(),...n._globalVariables.keys()])],getOwnPropertyDescriptor:(n,i)=>({enumerable:!0,configurable:!0,value:n.$(i)})})}catch{}}ApplyPatch(){if(this.patch===null)return h("this.patch");for(let[t,e]of this.patch.globals)this._globalVariables.set(t,e);if(this._changedVariablesForBatchObs!==null)for(let t of this.patch.changedVariables)this._changedVariablesForBatchObs.add(t);this.patch=null}SetJsonToken(t){this._globalVariables.clear();for(let[e,n]of this._defaultGlobalVariables){let i=t[e];if(i!==void 0){let r=V.JTokenToRuntimeObject(i);if(r===null)return h("tokenInkObject");this._globalVariables.set(e,r)}else this._globalVariables.set(e,n)}}WriteJson(t){t.WriteObjectStart();for(let[e,n]of this._globalVariables){let i=e,r=n;if(s.dontSaveDefaultValues&&this._defaultGlobalVariables.has(i)){let a=this._defaultGlobalVariables.get(i);if(this.RuntimeObjectsEqual(r,a))continue}t.WritePropertyStart(i),V.WriteRuntimeObject(t,r),t.WritePropertyEnd()}t.WriteObjectEnd()}RuntimeObjectsEqual(t,e){if(t===null)return h("obj1");if(e===null)return h("obj2");if(t.constructor!==e.constructor)return!1;let n=p(t,yt);if(n!==null)return n.value===N(e,yt).value;let i=p(t,E);if(i!==null)return i.value===N(e,E).value;let r=p(t,nt);if(r!==null)return r.value===N(e,nt).value;let a=p(t,A),o=p(e,A);if(a!==null&&o!==null)return Se(a.valueObject)&&Se(o.valueObject)?a.valueObject.Equals(o.valueObject):a.valueObject===o.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}GetVariableWithName(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:-1,n=this.GetRawVariableWithName(t,e),i=p(n,lt);return i!==null&&(n=this.ValueAtVariablePointer(i)),n}TryGetDefaultVariableValue(t){let e=tt(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}GlobalVariableExistsWithName(t){return this._globalVariables.has(t)||this._defaultGlobalVariables!==null&&this._defaultGlobalVariables.has(t)}GetRawVariableWithName(t,e){let n=null;if(e==0||e==-1){let i=null;if(this.patch!==null&&(i=this.patch.TryGetGlobal(t,null),i.exists)||(i=tt(this._globalVariables,t,null),i.exists)||this._defaultGlobalVariables!==null&&(i=tt(this._defaultGlobalVariables,t,null),i.exists))return i.result;if(this._listDefsOrigin===null)return h("VariablesState._listDefsOrigin");let r=this._listDefsOrigin.FindSingleItemListWithName(t);if(r)return r}return n=this._callStack.GetTemporaryVariableWithName(t,e),n}ValueAtVariablePointer(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}Assign(t,e){let n=t.variableName;if(n===null)return h("name");let i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(n),t.isNewDeclaration){let a=p(e,lt);a!==null&&(e=this.ResolveVariablePointer(a))}else{let a=null;do a=p(this.GetRawVariableWithName(n,i),lt),a!=null&&(n=a.variableName,i=a.contextIndex,r=i==0);while(a!=null)}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}SnapshotDefaultGlobals(){this._defaultGlobalVariables=new Map(this._globalVariables)}RetainListOriginsForAssignment(t,e){let n=N(t,D),i=N(e,D);n.value&&i.value&&i.value.Count==0&&i.value.SetInitialOriginNames(n.value.originNames)}SetGlobal(t,e){let n=null;if(this.patch===null&&(n=tt(this._globalVariables,t,null)),this.patch!==null&&(n=this.patch.TryGetGlobal(t,null),n.exists||(n=tt(this._globalVariables,t,null))),D.RetainListOriginsForAssignment(n.result,e),t===null)return h("variableName");if(this.patch!==null?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),this.variableChangedEvent!==null&&n!==null&&e!==n.result)if(this._batchObservingVariableChanges){if(this._changedVariablesForBatchObs===null)return h("this._changedVariablesForBatchObs");this.patch!==null?this.patch.AddChangedVariable(t):this._changedVariablesForBatchObs!==null&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}ResolveVariablePointer(t){let e=t.contextIndex;e==-1&&(e=this.GetContextIndexOfVariableNamed(t.variableName));let n=p(this.GetRawVariableWithName(t.variableName,e),lt);return n??new lt(t.variableName,e)}GetContextIndexOfVariableNamed(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}ObserveVariableChange(t){this.variableChangedEventCallbacks.push(t)}};Ut.dontSaveDefaultValues=!0;var Pt=class{constructor(t){this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}next(){return this.seed=48271*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}},ue=class{get globals(){return this._globals}get changedVariables(){return this._changedVariables}get visitCounts(){return this._visitCounts}get turnIndices(){return this._turnIndices}constructor(){if(this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,arguments.length===1&&arguments[0]!==null){let t=arguments[0];this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}TryGetGlobal(t,e){return t!==null&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}SetGlobal(t,e){this._globals.set(t,e)}AddChangedVariable(t){return this._changedVariables.add(t)}TryGetVisitCount(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}SetVisitCount(t,e){this._visitCounts.set(t,e)}SetTurnIndex(t,e){this._turnIndices.set(t,e)}TryGetTurnIndex(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}},Ct=class s{static TextToDictionary(t){return new s.Reader(t).ToDictionary()}static TextToArray(t){return new s.Reader(t).ToArray()}};(function(s){s.Reader=class{constructor(e){if(JSON.parse("0",((n,i,r)=>r!=null))){let n=(i,r,a)=>Number.isInteger(r)&&a.source.endsWith(".0")?a.source+"f":r;this._rootObject=JSON.parse(e,n)}else{let n=e.replace(/(,\s*)([0-9]+\.[0]+)([,]*)/g,'$1"$2f"$3');this._rootObject=JSON.parse(n)}}ToDictionary(){return this._rootObject}ToArray(){return this._rootObject}};class t{constructor(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}WriteObject(n){this.WriteObjectStart(),n(this),this.WriteObjectEnd()}WriteObjectStart(){this.StartNewObject(!0);let n={};if(this.state===s.Writer.State.Property){this.Assert(this.currentCollection!==null),this.Assert(this.currentPropertyName!==null);let i=this._propertyNameStack.pop();this.currentCollection[i]=n,this._collectionStack.push(n)}else this.state===s.Writer.State.Array?(this.Assert(this.currentCollection!==null),this.currentCollection.push(n),this._collectionStack.push(n)):(this.Assert(this.state===s.Writer.State.None),this._jsonObject=n,this._collectionStack.push(n));this._stateStack.push(new s.Writer.StateElement(s.Writer.State.Object))}WriteObjectEnd(){this.Assert(this.state===s.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}WriteProperty(n,i){if(this.WritePropertyStart(n),arguments[1]instanceof Function)(0,arguments[1])(this);else{let r=arguments[1];this.Write(r)}this.WritePropertyEnd()}WriteIntProperty(n,i){this.WritePropertyStart(n),this.WriteInt(i),this.WritePropertyEnd()}WriteFloatProperty(n,i){this.WritePropertyStart(n),this.WriteFloat(i),this.WritePropertyEnd()}WritePropertyStart(n){this.Assert(this.state===s.Writer.State.Object),this._propertyNameStack.push(n),this.IncrementChildCount(),this._stateStack.push(new s.Writer.StateElement(s.Writer.State.Property))}WritePropertyEnd(){this.Assert(this.state===s.Writer.State.Property),this.Assert(this.childCount===1),this._stateStack.pop()}WritePropertyNameStart(){this.Assert(this.state===s.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new s.Writer.StateElement(s.Writer.State.Property)),this._stateStack.push(new s.Writer.StateElement(s.Writer.State.PropertyName))}WritePropertyNameEnd(){this.Assert(this.state===s.Writer.State.PropertyName),this.Assert(this._currentPropertyName!==null),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}WritePropertyNameInner(n){this.Assert(this.state===s.Writer.State.PropertyName),this.Assert(this._currentPropertyName!==null),this._currentPropertyName+=n}WriteArrayStart(){this.StartNewObject(!0);let n=[];if(this.state===s.Writer.State.Property){this.Assert(this.currentCollection!==null),this.Assert(this.currentPropertyName!==null);let i=this._propertyNameStack.pop();this.currentCollection[i]=n,this._collectionStack.push(n)}else this.state===s.Writer.State.Array?(this.Assert(this.currentCollection!==null),this.currentCollection.push(n),this._collectionStack.push(n)):(this.Assert(this.state===s.Writer.State.None),this._jsonObject=n,this._collectionStack.push(n));this._stateStack.push(new s.Writer.StateElement(s.Writer.State.Array))}WriteArrayEnd(){this.Assert(this.state===s.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}Write(n){n!==null?(this.StartNewObject(!1),this._addToCurrentObject(n)):console.error("Warning: trying to write a null value")}WriteBool(n){n!==null&&(this.StartNewObject(!1),this._addToCurrentObject(n))}WriteInt(n){n!==null&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(n)))}WriteFloat(n){n!==null&&(this.StartNewObject(!1),n==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):n==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(n)?this._addToCurrentObject(0):this._addToCurrentObject(n))}WriteNull(){this.StartNewObject(!1),this._addToCurrentObject(null)}WriteStringStart(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new s.Writer.StateElement(s.Writer.State.String))}WriteStringEnd(){this.Assert(this.state==s.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}WriteStringInner(n){this.Assert(this.state===s.Writer.State.String),n!==null?this._currentString+=n:console.error("Warning: trying to write a null string")}toString(){return this._jsonObject===null?"":JSON.stringify(this._jsonObject)}StartNewObject(n){n?this.Assert(this.state===s.Writer.State.None||this.state===s.Writer.State.Property||this.state===s.Writer.State.Array):this.Assert(this.state===s.Writer.State.Property||this.state===s.Writer.State.Array),this.state===s.Writer.State.Property&&this.Assert(this.childCount===0),this.state!==s.Writer.State.Array&&this.state!==s.Writer.State.Property||this.IncrementChildCount()}get state(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:s.Writer.State.None}get childCount(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}get currentCollection(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}get currentPropertyName(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}IncrementChildCount(){this.Assert(this._stateStack.length>0);let n=this._stateStack.pop();n.childCount++,this._stateStack.push(n)}Assert(n){if(!n)throw Error("Assert failed while writing JSON")}_addToCurrentObject(n){this.Assert(this.currentCollection!==null),this.state===s.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(n)):this.state===s.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(this.currentPropertyName!==null),this.currentCollection[this.currentPropertyName]=n,this._propertyNameStack.pop())}}s.Writer=t,(function(e){var n;(n=e.State||(e.State={}))[n.None=0]="None",n[n.Object=1]="Object",n[n.Array=2]="Array",n[n.Property=3]="Property",n[n.PropertyName=4]="PropertyName",n[n.String=5]="String",e.StateElement=class{constructor(i){this.type=s.Writer.State.None,this.childCount=0,this.type=i}}})(t=s.Writer||(s.Writer={}))})(Ct||(Ct={}));var Tt=class{constructor(){let t=arguments[0],e=arguments[1];if(this.name=t,this.callStack=new wt(e),arguments[2]){let n=arguments[2];this.callStack.SetJsonToken(n.callstack,e),this.outputStream=V.JArrayToRuntimeObjList(n.outputStream),this.currentChoices=V.JArrayToRuntimeObjList(n.currentChoices);let i=n.choiceThreads;i!==void 0&&this.LoadFlowChoiceThreads(i,e)}else this.outputStream=[],this.currentChoices=[]}WriteJson(t){t.WriteObjectStart(),t.WriteProperty("callstack",(n=>this.callStack.WriteJson(n))),t.WriteProperty("outputStream",(n=>V.WriteListRuntimeObjs(n,this.outputStream)));let e=!1;for(let n of this.currentChoices){if(n.threadAtGeneration===null)return h("c.threadAtGeneration");n.originalThreadIndex=n.threadAtGeneration.threadIndex,this.callStack.ThreadWithIndex(n.originalThreadIndex)===null&&(e||(e=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(n.originalThreadIndex),n.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}e&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("currentChoices",(n=>{n.WriteArrayStart();for(let i of this.currentChoices)V.WriteChoice(n,i);n.WriteArrayEnd()})),t.WriteObjectEnd()}LoadFlowChoiceThreads(t,e){for(let n of this.currentChoices){let i=this.callStack.ThreadWithIndex(n.originalThreadIndex);if(i!==null)n.threadAtGeneration=i.Copy();else{let r=t[`${n.originalThreadIndex}`];n.threadAtGeneration=new wt.Thread(r,e)}}}},he=class s{ToJson(){let t=new Ct.Writer;return this.WriteJson(t),t.toString()}toJson(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return this.ToJson(t)}LoadJson(t){let e=Ct.TextToDictionary(t);this.LoadJsonObj(e),this.onDidLoadState!==null&&this.onDidLoadState()}VisitCountAtPathString(t){let e;if(this._patch!==null){let n=this.story.ContentAtPath(new I(t)).container;if(n===null)throw new Error("Content at path not found: "+t);if(e=this._patch.TryGetVisitCount(n,0),e.exists)return e.result}return e=tt(this._visitCounts,t,null),e.exists?e.result:0}VisitCountForContainer(t){if(t===null)return h("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(this._patch!==null){let i=this._patch.TryGetVisitCount(t,0);if(i.exists)return i.result}let e=t.path.toString(),n=tt(this._visitCounts,e,null);return n.exists?n.result:0}IncrementVisitCountForContainer(t){if(this._patch!==null){let i=this.VisitCountForContainer(t);return i++,void this._patch.SetVisitCount(t,i)}let e=t.path.toString(),n=tt(this._visitCounts,e,null);n.exists?this._visitCounts.set(e,n.result+1):this._visitCounts.set(e,1)}RecordTurnIndexVisitToContainer(t){if(this._patch!==null)return void this._patch.SetTurnIndex(t,this.currentTurnIndex);let e=t.path.toString();this._turnIndices.set(e,this.currentTurnIndex)}TurnsSinceForContainer(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),this._patch!==null){let i=this._patch.TryGetTurnIndex(t,0);if(i.exists)return this.currentTurnIndex-i.result}let e=t.path.toString(),n=tt(this._turnIndices,e,0);return n.exists?this.currentTurnIndex-n.result:-1}get callstackDepth(){return this.callStack.depth}get outputStream(){return this._currentFlow.outputStream}get currentChoices(){return this.canContinue?[]:this._currentFlow.currentChoices}get generatedChoices(){return this._currentFlow.currentChoices}get currentErrors(){return this._currentErrors}get currentWarnings(){return this._currentWarnings}get variablesState(){return this._variablesState}set variablesState(t){this._variablesState=t}get callStack(){return this._currentFlow.callStack}get evaluationStack(){return this._evaluationStack}get currentTurnIndex(){return this._currentTurnIndex}set currentTurnIndex(t){this._currentTurnIndex=t}get currentPathString(){let t=this.currentPointer;return t.isNull?null:t.path===null?h("pointer.path"):t.path.toString()}get previousPathString(){let t=this.previousPointer;return t.isNull?null:t.path===null?h("previousPointer.path"):t.path.toString()}get currentPointer(){return this.callStack.currentElement.currentPointer.copy()}set currentPointer(t){this.callStack.currentElement.currentPointer=t.copy()}get previousPointer(){return this.callStack.currentThread.previousPointer.copy()}set previousPointer(t){this.callStack.currentThread.previousPointer=t.copy()}get canContinue(){return!this.currentPointer.isNull&&!this.hasError}get hasError(){return this.currentErrors!=null&&this.currentErrors.length>0}get hasWarning(){return this.currentWarnings!=null&&this.currentWarnings.length>0}get currentText(){if(this._outputStreamTextDirty){let t=new z,e=!1;for(let n of this.outputStream){let i=p(n,T);if(e||i===null){let r=p(n,d);r!==null&&(r.commandType==d.CommandType.BeginTag?e=!0:r.commandType==d.CommandType.EndTag&&(e=!1))}else t.Append(i.value)}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}CleanOutputWhitespace(t){let e=new z,n=-1,i=0;for(let r=0;r<t.length;r++){let a=t.charAt(r),o=a==" "||a=="	";o&&n==-1&&(n=r),o||(a!=`
`&&n>0&&n!=i&&e.Append(" "),n=-1),a==`
`&&(i=r+1),o||e.Append(a)}return e.toString()}get currentTags(){if(this._outputStreamTagsDirty){this._currentTags=[];let t=!1,e=new z;for(let n of this.outputStream){let i=p(n,d);if(i!=null){if(i.commandType==d.CommandType.BeginTag){if(t&&e.Length>0){let r=this.CleanOutputWhitespace(e.toString());this._currentTags.push(r),e.Clear()}t=!0}else if(i.commandType==d.CommandType.EndTag){if(e.Length>0){let r=this.CleanOutputWhitespace(e.toString());this._currentTags.push(r),e.Clear()}t=!1}}else if(t){let r=p(n,T);r!==null&&e.Append(r.value)}else{let r=p(n,gt);r!=null&&r.text!=null&&r.text.length>0&&this._currentTags.push(r.text)}}if(e.Length>0){let n=this.CleanOutputWhitespace(e.toString());this._currentTags.push(n),e.Clear()}this._outputStreamTagsDirty=!1}return this._currentTags}get currentFlowName(){return this._currentFlow.name}get currentFlowIsDefaultFlow(){return this._currentFlow.name==this.kDefaultFlowName}get aliveFlowNames(){if(this._aliveFlowNamesDirty){if(this._aliveFlowNames=[],this._namedFlows!=null)for(let t of this._namedFlows.keys())t!=this.kDefaultFlowName&&this._aliveFlowNames.push(t);this._aliveFlowNamesDirty=!1}return this._aliveFlowNames}get inExpressionEvaluation(){return this.callStack.currentElement.inExpressionEvaluation}set inExpressionEvaluation(t){this.callStack.currentElement.inExpressionEvaluation=t}constructor(t){this.kInkSaveStateVersion=10,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=L.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._aliveFlowNames=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this._aliveFlowNamesDirty=!0,this.story=t,this._currentFlow=new Tt(this.kDefaultFlowName,t),this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this._evaluationStack=[],this._variablesState=new Ut(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;let e=new Date().getTime();this.storySeed=new Pt(e).next()%100,this.previousRandom=0,this.GoToStart()}GoToStart(){this.callStack.currentElement.currentPointer=L.StartOf(this.story.mainContentContainer)}SwitchFlow_Internal(t){if(t===null)throw new Error("Must pass a non-null string to Story.SwitchFlow");if(this._namedFlows===null&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),t===this._currentFlow.name)return;let e,n=tt(this._namedFlows,t,null);n.exists?e=n.result:(e=new Tt(t,this.story),this._namedFlows.set(t,e),this._aliveFlowNamesDirty=!0),this._currentFlow=e,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty()}SwitchToDefaultFlow_Internal(){this._namedFlows!==null&&this.SwitchFlow_Internal(this.kDefaultFlowName)}RemoveFlow_Internal(t){if(t===null)throw new Error("Must pass a non-null string to Story.DestroyFlow");if(t===this.kDefaultFlowName)throw new Error("Cannot destroy default flow");if(this._currentFlow.name===t&&this.SwitchToDefaultFlow_Internal(),this._namedFlows===null)return h("this._namedFlows");this._namedFlows.delete(t),this._aliveFlowNamesDirty=!0}CopyAndStartPatching(t){let e=new s(this.story);if(e._patch=new ue(this._patch),e._currentFlow.name=this._currentFlow.name,e._currentFlow.callStack=new wt(this._currentFlow.callStack),e._currentFlow.outputStream.push(...this._currentFlow.outputStream),e.OutputStreamDirty(),t)for(let n of this._currentFlow.currentChoices)e._currentFlow.currentChoices.push(n.Clone());else e._currentFlow.currentChoices.push(...this._currentFlow.currentChoices);if(this._namedFlows!==null){e._namedFlows=new Map;for(let[n,i]of this._namedFlows)e._namedFlows.set(n,i),e._aliveFlowNamesDirty=!0;e._namedFlows.set(this._currentFlow.name,e._currentFlow)}return this.hasError&&(e._currentErrors=[],e._currentErrors.push(...this.currentErrors||[])),this.hasWarning&&(e._currentWarnings=[],e._currentWarnings.push(...this.currentWarnings||[])),e.variablesState=this.variablesState,e.variablesState.callStack=e.callStack,e.variablesState.patch=e._patch,e.evaluationStack.push(...this.evaluationStack),this.divertedPointer.isNull||(e.divertedPointer=this.divertedPointer.copy()),e.previousPointer=this.previousPointer.copy(),e._visitCounts=this._visitCounts,e._turnIndices=this._turnIndices,e.currentTurnIndex=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.didSafeExit=this.didSafeExit,e}RestoreAfterPatch(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}ApplyAnyPatch(){if(this._patch!==null){this.variablesState.ApplyPatch();for(let[t,e]of this._patch.visitCounts)this.ApplyCountChanges(t,e,!0);for(let[t,e]of this._patch.turnIndices)this.ApplyCountChanges(t,e,!1);this._patch=null}}ApplyCountChanges(t,e,n){(n?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}WriteJson(t){if(t.WriteObjectStart(),t.WritePropertyStart("flows"),t.WriteObjectStart(),this._namedFlows!==null)for(let[e,n]of this._namedFlows)t.WriteProperty(e,(i=>n.WriteJson(i)));else t.WriteProperty(this._currentFlow.name,(e=>this._currentFlow.WriteJson(e)));if(t.WriteObjectEnd(),t.WritePropertyEnd(),t.WriteProperty("currentFlowName",this._currentFlow.name),t.WriteProperty("variablesState",(e=>this.variablesState.WriteJson(e))),t.WriteProperty("evalStack",(e=>V.WriteListRuntimeObjs(e,this.evaluationStack))),!this.divertedPointer.isNull){if(this.divertedPointer.path===null)return h("divertedPointer");t.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}t.WriteProperty("visitCounts",(e=>V.WriteIntDictionary(e,this._visitCounts))),t.WriteProperty("turnIndices",(e=>V.WriteIntDictionary(e,this._turnIndices))),t.WriteIntProperty("turnIdx",this.currentTurnIndex),t.WriteIntProperty("storySeed",this.storySeed),t.WriteIntProperty("previousRandom",this.previousRandom),t.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),t.WriteIntProperty("inkFormatVersion",ct.inkVersionCurrent),t.WriteObjectEnd()}LoadJsonObj(t){let e=t,n=e.inkSaveVersion;if(n==null)throw new Error("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new Error("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");let i=e.flows;if(i!=null){let a=i;Object.keys(a).length===1?this._namedFlows=null:this._namedFlows===null?this._namedFlows=new Map:this._namedFlows.clear();let o=Object.entries(a);for(let[l,c]of o){let u=l,m=c,g=new Tt(u,this.story,m);if(Object.keys(a).length===1)this._currentFlow=new Tt(u,this.story,m);else{if(this._namedFlows===null)return h("this._namedFlows");this._namedFlows.set(u,g)}}if(this._namedFlows!=null&&this._namedFlows.size>1){let l=e.currentFlowName;this._currentFlow=this._namedFlows.get(l)}}else{this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(e.callstackThreads,this.story),this._currentFlow.outputStream=V.JArrayToRuntimeObjList(e.outputStream),this._currentFlow.currentChoices=V.JArrayToRuntimeObjList(e.currentChoices);let a=e.choiceThreads;this._currentFlow.LoadFlowChoiceThreads(a,this.story)}this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this.variablesState.SetJsonToken(e.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=V.JArrayToRuntimeObjList(e.evalStack);let r=e.currentDivertTarget;if(r!=null){let a=new I(r.toString());this.divertedPointer=this.story.PointerAtPath(a)}this._visitCounts=V.JObjectToIntDictionary(e.visitCounts),this._turnIndices=V.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom)}ResetErrors(){this._currentErrors=null,this._currentWarnings=null}ResetOutput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;this.outputStream.length=0,t!==null&&this.outputStream.push(...t),this.OutputStreamDirty()}PushToOutputStream(t){let e=p(t,T);if(e!==null){let n=this.TrySplittingHeadTailWhitespace(e);if(n!==null){for(let i of n)this.PushToOutputStreamIndividual(i);return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}PopFromOutputStream(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}TrySplittingHeadTailWhitespace(t){let e=t.value;if(e===null)return h("single.value");let n=-1,i=-1;for(let u=0;u<e.length;u++){let m=e[u];if(m!=`
`){if(m==" "||m=="	")continue;break}n==-1&&(n=u),i=u}let r=-1,a=-1;for(let u=e.length-1;u>=0;u--){let m=e[u];if(m!=`
`){if(m==" "||m=="	")continue;break}r==-1&&(r=u),a=u}if(n==-1&&r==-1)return null;let o=[],l=0,c=e.length;if(n!=-1){if(n>0){let u=new T(e.substring(0,n));o.push(u)}o.push(new T(`
`)),l=i+1}if(r!=-1&&(c=a),c>l){let u=e.substring(l,c);o.push(new T(u))}if(r!=-1&&a>i&&(o.push(new T(`
`)),r<e.length-1)){let u=e.length-r-1,m=new T(e.substring(r+1,r+1+u));o.push(m)}return o}PushToOutputStreamIndividual(t){let e=p(t,Et),n=p(t,T),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){let r=-1,a=this.callStack.currentElement;a.type==k.Function&&(r=a.functionStartInOutputStream);let o=-1;for(let c=this.outputStream.length-1;c>=0;c--){let u=this.outputStream[c],m=u instanceof d?u:null;if((u instanceof Et?u:null)!=null){o=c;break}if(m!=null&&m.commandType==d.CommandType.BeginString){c>=r&&(r=-1);break}}let l=-1;if(l=o!=-1&&r!=-1?Math.min(r,o):o!=-1?o:r,l!=-1){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(o>-1&&this.RemoveExistingGlue(),r>-1)){let c=this.callStack.elements;for(let u=c.length-1;u>=0;u--){let m=c[u];if(m.type!=k.Function)break;m.functionStartInOutputStream=-1}}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(t===null)return h("obj");this.outputStream.push(t),this.OutputStreamDirty()}}TrimNewlinesFromOutputStream(){let t=-1,e=this.outputStream.length-1;for(;e>=0;){let n=this.outputStream[e],i=p(n,d),r=p(n,T);if(i!=null||r!=null&&r.isNonWhitespace)break;r!=null&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this.outputStream.length;)p(this.outputStream[e],T)?this.outputStream.splice(e,1):e++;this.OutputStreamDirty()}RemoveExistingGlue(){for(let t=this.outputStream.length-1;t>=0;t--){let e=this.outputStream[t];if(e instanceof Et)this.outputStream.splice(t,1);else if(e instanceof d)break}this.OutputStreamDirty()}get outputStreamEndsInNewline(){if(this.outputStream.length>0)for(let t=this.outputStream.length-1;t>=0&&!(this.outputStream[t]instanceof d);t--){let e=this.outputStream[t];if(e instanceof T){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}get outputStreamContainsContent(){for(let t of this.outputStream)if(t instanceof T)return!0;return!1}get inStringEvaluation(){for(let t=this.outputStream.length-1;t>=0;t--){let e=p(this.outputStream[t],d);if(e instanceof d&&e.commandType==d.CommandType.BeginString)return!0}return!1}PushEvaluationStack(t){let e=p(t,D);if(e){let n=e.value;if(n===null)return h("rawList");if(n.originNames!=null){n.origins||(n.origins=[]),n.origins.length=0;for(let i of n.originNames){if(this.story.listDefinitions===null)return h("StoryState.story.listDefinitions");let r=this.story.listDefinitions.TryListGetDefinition(i,null);if(r.result===null)return h("StoryState def.result");n.origins.indexOf(r.result)<0&&n.origins.push(r.result)}}}if(t===null)return h("obj");this.evaluationStack.push(t)}PopEvaluationStack(t){if(t===void 0)return re(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return re(this.evaluationStack.splice(this.evaluationStack.length-t,t))}PeekEvaluationStack(){return this.evaluationStack[this.evaluationStack.length-1]}ForceEnd(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=L.Null,this.previousPointer=L.Null,this.didSafeExit=!0}TrimWhitespaceFromFunctionEnd(){ft.Assert(this.callStack.currentElement.type==k.Function);let t=this.callStack.currentElement.functionStartInOutputStream;t==-1&&(t=0);for(let e=this.outputStream.length-1;e>=t;e--){let n=this.outputStream[e],i=p(n,T),r=p(n,d);if(i!=null){if(r||!i.isNewline&&!i.isInlineWhitespace)break;this.outputStream.splice(e,1),this.OutputStreamDirty()}}}PopCallStack(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;this.callStack.currentElement.type==k.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}SetChosenPath(t,e){this._currentFlow.currentChoices.length=0;let n=this.story.PointerAtPath(t);n.isNull||n.index!=-1||(n.index=0),this.currentPointer=n,e&&this.currentTurnIndex++}StartFunctionEvaluationFromGame(t,e){this.callStack.Push(k.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=L.StartOf(t),this.PassArgumentsToEvaluationStack(e)}PassArgumentsToEvaluationStack(t){if(t!==null)for(let e=0;e<t.length;e++){if(!(typeof t[e]=="number"||typeof t[e]=="string"||typeof t[e]=="boolean"||t[e]instanceof et))throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters must benumber, string, bool or InkList. Argument was "+(re(t[e])===null?"null":t[e].constructor.name));this.PushEvaluationStack(A.Create(t[e]))}}TryExitFunctionEvaluationFromGame(){return this.callStack.currentElement.type==k.FunctionEvaluationFromGame&&(this.currentPointer=L.Null,this.didSafeExit=!0,!0)}CompleteFunctionEvaluationFromGame(){if(this.callStack.currentElement.type!=k.FunctionEvaluationFromGame)throw new Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);let t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;for(;this.evaluationStack.length>t;){let n=this.PopEvaluationStack();e===null&&(e=n)}if(this.PopCallStack(k.FunctionEvaluationFromGame),e){if(e instanceof ut)return null;let n=N(e,A);return n.valueType==f.DivertTarget?"-> "+n.valueObject.toString():n.valueObject}return null}AddError(t,e){e?(this._currentWarnings==null&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(this._currentErrors==null&&(this._currentErrors=[]),this._currentErrors.push(t))}OutputStreamDirty(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}},ce=class{constructor(){this.startTime=void 0}get ElapsedMilliseconds(){return this.startTime===void 0?0:new Date().getTime()-this.startTime}Start(){this.startTime=new Date().getTime()}Stop(){this.startTime=void 0}};(function(s){s[s.Author=0]="Author",s[s.Warning=1]="Warning",s[s.Error=2]="Error"})(Vt||(Vt={})),Number.isInteger||(Number.isInteger=function(s){return typeof s=="number"&&isFinite(s)&&s>-9007199254740992&&s<9007199254740992&&Math.floor(s)===s});var ct=class s extends W{get currentChoices(){let t=[];if(this._state===null)return h("this._state");for(let e of this._state.currentChoices)e.isInvisibleDefault||(e.index=t.length,t.push(e));return t}get currentText(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}get currentTags(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}get currentErrors(){return this.state.currentErrors}get currentWarnings(){return this.state.currentWarnings}get currentFlowName(){return this.state.currentFlowName}get currentFlowIsDefaultFlow(){return this.state.currentFlowIsDefaultFlow}get aliveFlowNames(){return this.state.aliveFlowNames}get hasError(){return this.state.hasError}get hasWarning(){return this.state.hasWarning}get variablesState(){return this.state.variablesState}get listDefinitions(){return this._listDefinitions}get state(){return this._state}StartProfiling(){}EndProfiling(){}constructor(){let t;super(),this.inkVersionMinimumCompatible=18,this.onError=null,this.onDidContinue=null,this.onMakeChoice=null,this.onEvaluateFunction=null,this.onCompleteEvaluateFunction=null,this.onChoosePathString=null,this._prevContainers=[],this.allowExternalFunctionFallbacks=!1,this._listDefinitions=null,this._variableObservers=null,this._hasValidatedExternals=!1,this._temporaryEvaluationContainer=null,this._asyncContinueActive=!1,this._stateSnapshotAtLastNewline=null,this._sawLookaheadUnsafeFunctionAfterNewline=!1,this._recursiveContinueCount=0,this._asyncSaving=!1,this._profiler=null;let e=null,n=null;if(arguments[0]instanceof P)t=arguments[0],arguments[1]!==void 0&&(e=arguments[1]),this._mainContentContainer=t;else if(typeof arguments[0]=="string"){let i=arguments[0];n=Ct.TextToDictionary(i)}else n=arguments[0];if(e!=null&&(this._listDefinitions=new $t(e)),this._externals=new Map,n!==null){let i=n,r=i.inkVersion;if(r==null)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");let a=parseInt(r);if(a>s.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(a<this.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");a!=s.inkVersionCurrent&&console.warn(`WARNING: Version of ink ${s.inkVersionCurrent} used to build story doesn't match current version of engine (${a}). Non-critical, but recommend synchronising.`);let o,l=i.root;if(l==null)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(o=i.listDefs)&&(this._listDefinitions=V.JTokenToListDefinitions(o)),this._mainContentContainer=N(V.JTokenToRuntimeObject(l),P),this.ResetState()}}ToJson(t){let e=!1;if(t||(e=!0,t=new Ct.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",s.inkVersionCurrent),t.WriteProperty("root",(n=>V.WriteRuntimeContainer(n,this._mainContentContainer))),this._listDefinitions!=null){t.WritePropertyStart("listDefs"),t.WriteObjectStart();for(let n of this._listDefinitions.lists){t.WritePropertyStart(n.name),t.WriteObjectStart();for(let[i,r]of n.items){let a=_.fromSerializedKey(i),o=r;t.WriteIntProperty(a.itemName,o)}t.WriteObjectEnd(),t.WritePropertyEnd()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),e)return t.toString()}ResetState(){this.IfAsyncWeCant("ResetState"),this._state=new he(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}ResetErrors(){if(this._state===null)return h("this._state");this._state.ResetErrors()}ResetCallstack(){if(this.IfAsyncWeCant("ResetCallstack"),this._state===null)return h("this._state");this._state.ForceEnd()}ResetGlobals(){if(this._mainContentContainer.namedContent.get("global decl")){let t=this.state.currentPointer.copy();this.ChoosePath(new I("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}SwitchFlow(t){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't switch flow to "+t);this.state.SwitchFlow_Internal(t)}RemoveFlow(t){this.state.RemoveFlow_Internal(t)}SwitchToDefaultFlow(){this.state.SwitchToDefaultFlow_Internal()}Continue(){return this.ContinueAsync(0),this.currentText}get canContinue(){return this.state.canContinue}get asyncContinueComplete(){return!this._asyncContinueActive}ContinueAsync(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}ContinueInternal(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;this._profiler!=null&&this._profiler.PreContinue();let e=t>0;if(this._recursiveContinueCount++,this._asyncContinueActive)this._asyncContinueActive&&!e&&(this._asyncContinueActive=!1);else{if(this._asyncContinueActive=e,!this.canContinue)throw new Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),this._recursiveContinueCount==1&&this._state.variablesState.StartVariableObservation()}let n=new ce;n.Start();let i=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{i=this.ContinueSingleStep()}catch(a){if(!(a instanceof Y))throw a;this.AddError(a.message,void 0,a.useEndLineNumber);break}if(i||this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);n.Stop();let r=null;if(!i&&this.canContinue||(this._stateSnapshotAtLastNewline!==null&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),this.state.generatedChoices.length!=0||this.state.didSafeExit||this._temporaryEvaluationContainer!=null||(this.state.callStack.CanPop(k.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(k.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,this._recursiveContinueCount==1&&(r=this._state.variablesState.CompleteVariableObservation()),this._asyncContinueActive=!1,this.onDidContinue!==null&&this.onDidContinue()),this._recursiveContinueCount--,this._profiler!=null&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(this.onError===null){let a=new z;throw a.Append("Ink had "),this.state.hasError&&(a.Append(`${this.state.currentErrors.length}`),a.Append(this.state.currentErrors.length==1?" error":" errors"),this.state.hasWarning&&a.Append(" and ")),this.state.hasWarning&&(a.Append(`${this.state.currentWarnings.length}`),a.Append(this.state.currentWarnings.length==1?" warning":" warnings"),this.state.hasWarning&&a.Append(" and ")),a.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),a.Append(this.state.hasError?this.state.currentErrors[0]:this.state.currentWarnings[0]),new Y(a.toString())}if(this.state.hasError)for(let a of this.state.currentErrors)this.onError(a,Vt.Error);if(this.state.hasWarning)for(let a of this.state.currentWarnings)this.onError(a,Vt.Warning);this.ResetErrors()}r!=null&&Object.keys(r).length>0&&this._state.variablesState.NotifyObservers(r)}ContinueSingleStep(){if(this._profiler!=null&&this._profiler.PreStep(),this.Step(),this._profiler!=null&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),this._profiler!=null&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(this._stateSnapshotAtLastNewline!==null){if(this._stateSnapshotAtLastNewline.currentTags===null)return h("this._stateAtLastNewline.currentTags");if(this.state.currentTags===null)return h("this.state.currentTags");let t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==s.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;t==s.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?this._stateSnapshotAtLastNewline==null&&this.StateSnapshot():this.DiscardSnapshot())}return this._profiler!=null&&this._profiler.PostSnapshot(),!1}CalculateNewlineOutputStateChange(t,e,n,i){if(t===null)return h("prevText");if(e===null)return h("currText");let r=e.length>=t.length&&t.length>0&&e.charAt(t.length-1)==`
`;if(n==i&&t.length==e.length&&r)return s.OutputStateChange.NoChange;if(!r)return s.OutputStateChange.NewlineRemoved;if(i>n)return s.OutputStateChange.ExtendedBeyondNewline;for(let a=t.length;a<e.length;a++){let o=e.charAt(a);if(o!=" "&&o!="	")return s.OutputStateChange.ExtendedBeyondNewline}return s.OutputStateChange.NoChange}ContinueMaximally(){this.IfAsyncWeCant("ContinueMaximally");let t=new z;for(;this.canContinue;)t.Append(this.Continue());return t.toString()}ContentAtPath(t){return this.mainContentContainer.ContentAtPath(t)}KnotContainerWithName(t){let e=this.mainContentContainer.namedContent.get(t);return e instanceof P?e:null}PointerAtPath(t){if(t.length==0)return L.Null;let e=new L,n=t.length,i=null;return t.lastComponent===null?h("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),i.obj==null||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}StateSnapshot(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching(!1)}RestoreStateSnapshot(){this._stateSnapshotAtLastNewline===null&&h("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}DiscardSnapshot(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}CopyStateForBackgroundThreadSave(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");let t=this._state;return this._state=this._state.CopyAndStartPatching(!0),this._asyncSaving=!0,t}BackgroundSaveComplete(){this._stateSnapshotAtLastNewline===null&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}Step(){let t=!0,e=this.state.currentPointer.copy();if(e.isNull)return;let n=p(e.Resolve(),P);for(;n&&(this.VisitContainer(n,!0),n.content.length!=0);)e=L.StartOf(n),n=p(e.Resolve(),P);this.state.currentPointer=e.copy(),this._profiler!=null&&this._profiler.Step(this.state.callStack);let i=e.Resolve(),r=this.PerformLogicAndFlowControl(i);if(this.state.currentPointer.isNull)return;r&&(t=!1);let a=p(i,_t);if(a){let l=this.ProcessChoice(a);l&&this.state.generatedChoices.push(l),i=null,t=!1}if(i instanceof P&&(t=!1),t){let l=p(i,lt);if(l&&l.contextIndex==-1){let c=this.state.callStack.ContextForVariableNamed(l.variableName);i=new lt(l.variableName,c)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent();let o=p(i,d);o&&o.commandType==d.CommandType.StartThread&&this.state.callStack.PushThread()}VisitContainer(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}VisitChangedContainersDueToDivert(){let t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(e.isNull||e.index==-1)return;if(this._prevContainers.length=0,!t.isNull){let a=p(t.Resolve(),P)||p(t.container,P);for(;a;)this._prevContainers.push(a),a=p(a.parent,P)}let n=e.Resolve();if(n==null)return;let i=p(n.parent,P),r=!0;for(;i&&(this._prevContainers.indexOf(i)<0||i.countingAtStartOnly);){let a=i.content.length>0&&n==i.content[0]&&r;a||(r=!1),this.VisitContainer(i,a),n=i,i=p(i.parent,P)}}PopChoiceStringAndTags(t){let e=N(this.state.PopEvaluationStack(),T);for(;this.state.evaluationStack.length>0&&p(this.state.PeekEvaluationStack(),gt)!=null;){let n=p(this.state.PopEvaluationStack(),gt);n&&t.push(n.text)}return e.value}ProcessChoice(t){let e=!0;if(t.hasCondition){let o=this.state.PopEvaluationStack();this.IsTruthy(o)||(e=!1)}let n="",i="",r=[];if(t.hasChoiceOnlyContent&&(i=this.PopChoiceStringAndTags(r)||""),t.hasStartContent&&(n=this.PopChoiceStringAndTags(r)||""),t.onceOnly&&this.state.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;let a=new Mt;return a.targetPath=t.pathOnChoice,a.sourcePath=t.path.toString(),a.isInvisibleDefault=t.isInvisibleDefault,a.threadAtGeneration=this.state.callStack.ForkThread(),a.tags=r.reverse(),a.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),a}IsTruthy(t){if(t instanceof A){let e=t;if(e instanceof ot){let n=e;return this.Error("Shouldn't use a divert target (to "+n.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}PerformLogicAndFlowControl(t){if(t==null)return!1;if(t instanceof kt){let e=t;if(e.isConditional){let n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){let n=e.variableDivertName,i=this.state.variablesState.GetVariableWithName(n);if(i==null)this.Error("Tried to divert using a target from a variable that could not be found ("+n+")");else if(!(i instanceof ot)){let a=p(i,E),o="Tried to divert to a target from a variable, but the variable ("+n+") didn't contain a divert target, it ";a instanceof E&&a.value==0?o+="was empty/null (the value 0).":o+="contained '"+i+"'.",this.Error(o)}let r=N(i,ot);this.state.divertedPointer=this.PointerAtPath(r.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&e.debugMetadata.sourceName!=null?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof d){let e=t;switch(e.commandType){case d.CommandType.EvalStart:this.Assert(this.state.inExpressionEvaluation===!1,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case d.CommandType.EvalEnd:this.Assert(this.state.inExpressionEvaluation===!0,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case d.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){let v=this.state.PopEvaluationStack();if(!(v instanceof ut)){let F=new T(v.toString());this.state.PushToOutputStream(F)}}break;case d.CommandType.NoOp:break;case d.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case d.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case d.CommandType.PopFunction:case d.CommandType.PopTunnel:let n=e.commandType==d.CommandType.PopFunction?k.Function:k.Tunnel,i=null;if(n==k.Tunnel){let v=this.state.PopEvaluationStack();i=p(v,ot),i===null&&this.Assert(v instanceof ut,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==n&&this.state.callStack.canPop)this.state.PopCallStack(),i&&(this.state.divertedPointer=this.PointerAtPath(i.targetPath));else{let v=new Map;v.set(k.Function,"function return statement (~ return)"),v.set(k.Tunnel,"tunnel onwards statement (->->)");let F=v.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(F="end of flow (-> END or choice)");let j="Found "+v.get(n)+", when expected "+F;this.Error(j)}break;case d.CommandType.BeginString:this.state.PushToOutputStream(e),this.Assert(this.state.inExpressionEvaluation===!0,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case d.CommandType.BeginTag:this.state.PushToOutputStream(e);break;case d.CommandType.EndTag:if(this.state.inStringEvaluation){let v=[],F=0;for(let G=this.state.outputStream.length-1;G>=0;--G){let Z=this.state.outputStream[G];F++;let bt=p(Z,d);if(bt!=null){if(bt.commandType==d.CommandType.BeginTag)break;this.Error("Unexpected ControlCommand while extracting tag from choice");break}Z instanceof T&&v.push(Z)}this.state.PopFromOutputStream(F);let j=new z;for(let G of v.reverse())j.Append(G.toString());let vt=new gt(this.state.CleanOutputWhitespace(j.toString()));this.state.PushEvaluationStack(vt)}else this.state.PushToOutputStream(e);break;case d.CommandType.EndString:{let v=[],F=[],j=0;for(let G=this.state.outputStream.length-1;G>=0;--G){let Z=this.state.outputStream[G];j++;let bt=p(Z,d);if(bt&&bt.commandType==d.CommandType.BeginString)break;Z instanceof gt&&F.push(Z),Z instanceof T&&v.push(Z)}this.state.PopFromOutputStream(j);for(let G of F)this.state.PushToOutputStream(G);v=v.reverse();let vt=new z;for(let G of v)vt.Append(G.toString());this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new T(vt.toString()));break}case d.CommandType.ChoiceCount:let r=this.state.generatedChoices.length;this.state.PushEvaluationStack(new E(r));break;case d.CommandType.Turns:this.state.PushEvaluationStack(new E(this.state.currentTurnIndex+1));break;case d.CommandType.TurnsSince:case d.CommandType.ReadCount:let a=this.state.PopEvaluationStack();if(!(a instanceof ot)){let v="";a instanceof E&&(v=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+a+v);break}let o,l=N(a,ot),c=p(this.ContentAtPath(l.targetPath).correctObj,P);c!=null?o=e.commandType==d.CommandType.TurnsSince?this.state.TurnsSinceForContainer(c):this.state.VisitCountForContainer(c):(o=e.commandType==d.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+e.toString()+" lookup at "+l.targetPath.toString())),this.state.PushEvaluationStack(new E(o));break;case d.CommandType.Random:{let v=p(this.state.PopEvaluationStack(),E),F=p(this.state.PopEvaluationStack(),E);if(F==null||!(F instanceof E))return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(v==null||!(v instanceof E))return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(v.value===null)return h("maxInt.value");if(F.value===null)return h("minInt.value");let j=v.value-F.value+1;(!isFinite(j)||j>Number.MAX_SAFE_INTEGER)&&(j=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),j<=0&&this.Error("RANDOM was called with minimum as "+F.value+" and maximum as "+v.value+". The maximum must be larger");let vt=this.state.storySeed+this.state.previousRandom,G=new Pt(vt).next(),Z=G%j+F.value;this.state.PushEvaluationStack(new E(Z)),this.state.previousRandom=G;break}case d.CommandType.SeedRandom:let u=p(this.state.PopEvaluationStack(),E);if(u==null||!(u instanceof E))return this.Error("Invalid value passed to SEED_RANDOM");if(u.value===null)return h("minInt.value");this.state.storySeed=u.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new ut);break;case d.CommandType.VisitIndex:let m=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new E(m));break;case d.CommandType.SequenceShuffleIndex:let g=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new E(g));break;case d.CommandType.StartThread:break;case d.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=L.Null);break;case d.CommandType.End:this.state.ForceEnd();break;case d.CommandType.ListFromInt:let S=p(this.state.PopEvaluationStack(),E),B=N(this.state.PopEvaluationStack(),T);if(S===null)throw new Y("Passed non-integer when creating a list element from a numerical value.");let R=null;if(this.listDefinitions===null)return h("this.listDefinitions");let J=this.listDefinitions.TryListGetDefinition(B.value,null);if(!J.exists)throw new Y("Failed to find LIST called "+B.value);{if(S.value===null)return h("minInt.value");let v=J.result.TryGetItemWithValue(S.value,_.Null);v.exists&&(R=new D(v.result,S.value))}R==null&&(R=new D),this.state.PushEvaluationStack(R);break;case d.CommandType.ListRange:let O=p(this.state.PopEvaluationStack(),A),st=p(this.state.PopEvaluationStack(),A),$=p(this.state.PopEvaluationStack(),D);if($===null||st===null||O===null)throw new Y("Expected list, minimum and maximum for LIST_RANGE");if($.value===null)return h("targetList.value");let mt=$.value.ListWithSubRange(st.valueObject,O.valueObject);this.state.PushEvaluationStack(new D(mt));break;case d.CommandType.ListRandom:{let v=this.state.PopEvaluationStack();if(v===null)throw new Y("Expected list for LIST_RANDOM");let F=v.value,j=null;if(F===null)throw h("list");if(F.Count==0)j=new et;else{let vt=this.state.storySeed+this.state.previousRandom,G=new Pt(vt).next(),Z=G%F.Count,bt=F.entries();for(let ye=0;ye<=Z-1;ye++)bt.next();let fe=bt.next().value,Wt={Key:_.fromSerializedKey(fe[0]),Value:fe[1]};if(Wt.Key.originName===null)return h("randomItem.Key.originName");j=new et(Wt.Key.originName,this),j.Add(Wt.Key,Wt.Value),this.state.previousRandom=G}this.state.PushEvaluationStack(new D(j));break}default:this.Error("unhandled ControlCommand: "+e)}return!0}if(t instanceof Ft){let e=t,n=this.state.PopEvaluationStack();return this.state.variablesState.Assign(e,n),!0}if(t instanceof At){let e=t,n=null;if(e.pathForCount!=null){let i=e.containerForCount,r=this.state.VisitCountForContainer(i);n=new E(r)}else n=this.state.variablesState.GetVariableWithName(e.name),n==null&&(this.Warning("Variable not found: '"+e.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),n=new E(0));return this.state.PushEvaluationStack(n),!0}if(t instanceof b){let e=t,n=this.state.PopEvaluationStack(e.numberOfParameters),i=e.Call(n);return this.state.PushEvaluationStack(i),!0}return!1}ChoosePathString(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),this.onChoosePathString!==null&&this.onChoosePathString(t,n),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==k.Function){let i="",r=this.state.callStack.currentElement.currentPointer.container;throw r!=null&&(i="("+r.path.toString()+") "),new Error("Story was running a function "+i+"when you called ChoosePathString("+t+`) - this is almost certainly not not what you want! Full stack trace: 
`+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new I(t))}IfAsyncWeCant(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}ChoosePath(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}ChooseChoiceIndex(t){let e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");let n=e[t];return this.onMakeChoice!==null&&this.onMakeChoice(n),n.threadAtGeneration===null?h("choiceToChoose.threadAtGeneration"):n.targetPath===null?h("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}HasFunction(t){try{return this.KnotContainerWithName(t)!=null}catch{return!1}}EvaluateFunction(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(this.onEvaluateFunction!==null&&this.onEvaluateFunction(t,e),this.IfAsyncWeCant("evaluate a function"),t==null)throw new Error("Function is null");if(t==""||t.trim()=="")throw new Error("Function is empty or white space.");let i=this.KnotContainerWithName(t);if(i==null)throw new Error("Function doesn't exist: '"+t+"'");let r=[];r.push(...this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);let a=new z;for(;this.canContinue;)a.Append(this.Continue());let o=a.toString();this._state.ResetOutput(r);let l=this.state.CompleteFunctionEvaluationFromGame();return this.onCompleteEvaluateFunction!=null&&this.onCompleteEvaluateFunction(t,e,o,l),n?{returned:l,output:o}:l}EvaluateExpression(t){let e=this.state.callStack.elements.length;this.state.callStack.Push(k.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();let n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}CallExternalFunction(t,e){if(t===null)return h("funcName");let n=this._externals.get(t),i=null,r=n!==void 0;if(r&&!n.lookAheadSafe&&this._state.inStringEvaluation&&this.Error("External function "+t+` could not be called because 1) it wasn't marked as lookaheadSafe when BindExternalFunction was called and 2) the story is in the middle of string generation, either because choice text is being generated, or because you have ink like "hello {func()}". You can work around this by generating the result of your function into a temporary variable before the string or choice gets generated: ~ temp x = `+t+"()"),r&&!n.lookAheadSafe&&this._stateSnapshotAtLastNewline!==null)return void(this._sawLookaheadUnsafeFunctionAfterNewline=!0);if(!r){if(this.allowExternalFunctionFallbacks)return i=this.KnotContainerWithName(t),this.Assert(i!==null,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(k.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=L.StartOf(i));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}let a=[];for(let c=0;c<e;++c){let u=N(this.state.PopEvaluationStack(),A).valueObject;a.push(u)}a.reverse();let o=n.function(a),l=null;o!=null?(l=A.Create(o),this.Assert(l!==null,"Could not create ink value from returned object of type "+typeof o)):l=new ut,this.state.PushEvaluationStack(l)}BindExternalFunctionGeneral(t,e){let n=!(arguments.length>2&&arguments[2]!==void 0)||arguments[2];this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,{function:e,lookAheadSafe:n})}TryCoerce(t){return t}BindExternalFunction(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this.Assert(e!=null,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,(i=>{this.Assert(i.length>=e.length,"External function expected "+e.length+" arguments");let r=[];for(let a=0,o=i.length;a<o;a++)r[a]=this.TryCoerce(i[a]);return e.apply(null,r)}),n)}UnbindExternalFunction(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}ValidateExternalBindings(){let t=null,e=null,n=arguments[1]||new Set;if(arguments[0]instanceof P&&(t=arguments[0]),arguments[0]instanceof W&&(e=arguments[0]),t===null&&e===null)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,n.size==0)this._hasValidatedExternals=!0;else{let i="Error: Missing function binding for external";i+=n.size>1?"s":"",i+=": '",i+=Array.from(n).join("', '"),i+="' ",i+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(i)}else if(t!=null){for(let i of t.content)i!=null&&i.hasValidName||this.ValidateExternalBindings(i,n);for(let[,i]of t.namedContent)this.ValidateExternalBindings(p(i,W),n)}else if(e!=null){let i=p(e,kt);if(i&&i.isExternal){let r=i.targetPathString;if(r===null)return h("name");this._externals.has(r)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(r)||n.add(r)}}}ObserveVariable(t,e){if(this.IfAsyncWeCant("observe a new variable"),this._variableObservers===null&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new Error("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}ObserveVariables(t,e){for(let n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}RemoveVariableObserver(t,e){if(this.IfAsyncWeCant("remove a variable observer"),this._variableObservers!==null){if(e!=null){if(this._variableObservers.has(e))if(t!=null){let n=this._variableObservers.get(e);n!=null&&(n.splice(n.indexOf(t),1),n.length===0&&this._variableObservers.delete(e))}else this._variableObservers.delete(e)}else if(t!=null){let n=this._variableObservers.keys();for(let i of n){let r=this._variableObservers.get(i);r!=null&&(r.splice(r.indexOf(t),1),r.length===0&&this._variableObservers.delete(i))}}}}VariableStateDidChangeEvent(t,e){if(this._variableObservers===null)return;let n=this._variableObservers.get(t);if(n!==void 0){if(!(e instanceof A))throw new Error("Tried to get the value of a variable that isn't a standard type");let i=N(e,A);for(let r of n)r(t,i.valueObject)}}get globalTags(){return this.TagsAtStartOfFlowContainerWithPathString("")}TagsForContentAtPath(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}TagsAtStartOfFlowContainerWithPathString(t){let e=new I(t),n=this.ContentAtPath(e).container;if(n===null)return h("flowContainer");for(;;){let a=n.content[0];if(!(a instanceof P))break;n=a}let i=!1,r=null;for(let a of n.content){let o=p(a,d);if(o!=null)o.commandType==d.CommandType.BeginTag?i=!0:o.commandType==d.CommandType.EndTag&&(i=!1);else{if(!i)break;{let l=p(a,T);l!==null?(r===null&&(r=[]),l.value!==null&&r.push(l.value)):this.Error("Tag contained non-text content. Only plain text is allowed when using globalTags or TagsAtContentPath. If you want to evaluate dynamic content, you need to use story.Continue().")}}}return r}BuildStringOfHierarchy(){let t=new z;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}BuildStringOfContainer(t){let e=new z;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}NextContent(){if(this.state.previousPointer=this.state.currentPointer.copy(),!(!this.state.divertedPointer.isNull&&(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=L.Null,this.VisitChangedContainersDueToDivert(),!this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){let t=!1;this.state.callStack.CanPop(k.Function)?(this.state.PopCallStack(k.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new ut),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}IncrementContentPointer(){let t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,e.container===null)return h("pointer.container");for(;e.index>=e.container.content.length;){t=!1;let n=p(e.container.parent,P);if(!(n instanceof P))break;let i=n.content.indexOf(e.container);if(i==-1)break;if(e=new L(n,i),e.index++,t=!0,e.container===null)return h("pointer.container")}return t||(e=L.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}TryFollowDefaultInvisibleChoice(){let t=this._state.currentChoices,e=t.filter((i=>i.isInvisibleDefault));if(e.length==0||t.length>e.length)return!1;let n=e[0];return n.targetPath===null?h("choice.targetPath"):n.threadAtGeneration===null?h("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,this._stateSnapshotAtLastNewline!==null&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(n.targetPath,!1),!0)}NextSequenceShuffleIndex(){let t=p(this.state.PopEvaluationStack(),E);if(!(t instanceof E))return this.Error("expected number of elements in sequence for shuffle index"),0;let e=this.state.currentPointer.container;if(e===null)return h("seqContainer");if(t.value===null)return h("numElementsIntVal.value");let n=t.value,i=N(this.state.PopEvaluationStack(),E).value;if(i===null)return h("seqCount");let r=i/n,a=i%n,o=e.path.toString(),l=0;for(let g=0,S=o.length;g<S;g++)l+=o.charCodeAt(g)||0;let c=l+r+this.state.storySeed,u=new Pt(Math.floor(c)),m=[];for(let g=0;g<n;++g)m.push(g);for(let g=0;g<=a;++g){let S=u.next()%m.length,B=m[S];if(m.splice(S,1),g==a)return B}throw new Error("Should never reach here")}Error(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=new Y(t);throw n.useEndLineNumber=e,n}Warning(t){this.AddError(t,!0)}AddError(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],i=this.currentDebugMetadata,r=e?"WARNING":"ERROR";if(i!=null){let a=n?i.endLineNumber:i.startLineNumber;t="RUNTIME "+r+": '"+i.fileName+"' line "+a+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}Assert(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(t==0)throw e==null&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}get currentDebugMetadata(){let t,e=this.state.currentPointer;if(!e.isNull&&e.Resolve()!==null&&(t=e.Resolve().debugMetadata,t!==null))return t;for(let n=this.state.callStack.elements.length-1;n>=0;--n)if(e=this.state.callStack.elements[n].currentPointer,!e.isNull&&e.Resolve()!==null&&(t=e.Resolve().debugMetadata,t!==null))return t;for(let n=this.state.outputStream.length-1;n>=0;--n)if(t=this.state.outputStream[n].debugMetadata,t!==null)return t;return null}get mainContentContainer(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}};ct.inkVersionCurrent=21,(function(s){var t;(t=s.OutputStateChange||(s.OutputStateChange={}))[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"})(ct||(ct={}));var de=class{constructor(t={}){this.config={position:"bottom-right",maxNotifications:5,defaultDuration:4e3,spacing:10,zIndex:2e3,...t},this.notifications=[],this.container=null,this.init()}init(){this.createContainer(),this.addStyles()}createContainer(){this.container=document.createElement("div"),this.container.className="notification-container",this.container.setAttribute("data-position",this.config.position),this.container.setAttribute("aria-live","polite"),this.container.setAttribute("role","status"),this.setContainerPosition(),document.body.appendChild(this.container)}setContainerPosition(){let t={"top-left":{top:"20px",left:"20px"},"top-right":{top:"20px",right:"20px"},"top-center":{top:"20px",left:"50%",transform:"translateX(-50%)"},"bottom-left":{bottom:"20px",left:"20px"},"bottom-right":{bottom:"20px",right:"20px"},"bottom-center":{bottom:"20px",left:"50%",transform:"translateX(-50%)"}},e=t[this.config.position]||t["bottom-right"];Object.assign(this.container.style,{position:"fixed",zIndex:this.config.zIndex,pointerEvents:"none",...e})}addStyles(){document.documentElement.style.setProperty("--notification-spacing",`${this.config.spacing}px`)}show(t,e={}){let n={type:"info",duration:this.config.defaultDuration,closable:!0,icon:null,showProgress:!1,onClick:null,onClose:null,...e};if(!n.icon){let a={success:"\u2713",error:"\u2715",warning:"\u26A0",info:"\u24D8",critical:"\u{1F6A8}"};n.icon=a[n.type]||"\u24D8"}let i=this.createNotificationElement(t,n);this.enforceMaxNotifications(),this.container.appendChild(i);let r={element:i,config:n};return this.notifications.push(r),requestAnimationFrame(()=>{i.classList.add("notification-visible")}),n.duration>0&&n.type!=="critical"&&setTimeout(()=>{this.remove(r)},n.duration),{remove:()=>this.remove(r),element:i}}success(t,e={}){return this.show(t,{...e,type:"success"})}error(t,e={}){return this.show(t,{...e,type:"error"})}warning(t,e={}){return this.show(t,{...e,type:"warning"})}info(t,e={}){return this.show(t,{...e,type:"info"})}critical(t,e={}){return this.show(t,{...e,type:"critical",duration:0,closable:!0})}remove(t){if(!t||!t.element)return;let{element:e,config:n}=t;if(n.onClose)try{n.onClose()}catch(r){console.warn("Notification onClose callback failed:",r)}let i=this.notifications.indexOf(t);i>-1&&this.notifications.splice(i,1),e.style.transform=this.getExitTransform(),e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}clearAll(){[...this.notifications].forEach(e=>{this.remove(e)})}createNotificationElement(t,e){let n=document.createElement("div");n.className=`notification-item notification-${e.type}`,(e.type==="error"||e.type==="critical")&&n.setAttribute("role","alert");let i=document.createElement("div");i.className="notification-content";let r=document.createElement("span");r.className="notification-icon",r.textContent=e.icon,r.setAttribute("aria-hidden","true"),i.appendChild(r);let a=document.createElement("span");if(a.textContent=t,i.appendChild(a),n.appendChild(i),e.closable){let o=document.createElement("button");o.type="button",o.className="notification-close",o.innerHTML='<span aria-hidden="true">\xD7</span>',o.setAttribute("aria-label","Dismiss notification"),o.addEventListener("click",l=>{l.stopPropagation(),this.remove({element:n,config:e})}),n.appendChild(o)}if(e.showProgress&&e.duration>0){let o=document.createElement("div");o.className="notification-progress",o.style.width="100%",n.appendChild(o),requestAnimationFrame(()=>{o.style.width="0%",o.style.transitionDuration=`${e.duration}ms`})}return e.onClick&&(n.style.cursor="pointer",n.addEventListener("click",e.onClick)),n}getExitTransform(){let t=this.config.position.includes("right"),e=this.config.position.includes("left");return t?"translateX(100%)":e?"translateX(-100%)":"translateY(-100%)"}enforceMaxNotifications(){for(;this.notifications.length>=this.config.maxNotifications;){let t=this.notifications[0];this.remove(t)}}updateConfig(t){this.config={...this.config,...t},t.position&&(this.setContainerPosition(),this.container.setAttribute("data-position",this.config.position))}getStats(){return{activeNotifications:this.notifications.length,maxNotifications:this.config.maxNotifications,position:this.config.position,hasContainer:!!this.container}}destroy(){this.clearAll(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container);let t=document.getElementById("notification-styles");t&&t.remove(),this.container=null,this.notifications=[]}},ht=new de;var Rt=class{static bindAll(t,e=null){this.bindStringFunctions(t),this.bindMathFunctions(t),this.bindFairMathFunctions(t),this.bindTimeFunctions(t),this.bindDebugFunctions(t),e&&this.bindTemplateControlFunctions(t,e)}static bindStringFunctions(t){t.BindExternalFunction("UPPERCASE",e=>String(e).toUpperCase()),t.BindExternalFunction("LOWERCASE",e=>String(e).toLowerCase()),t.BindExternalFunction("CAPITALIZE",e=>String(e).charAt(0).toUpperCase()+String(e).slice(1)),t.BindExternalFunction("TRIM",e=>String(e).trim()),t.BindExternalFunction("LENGTH",e=>String(e).length),t.BindExternalFunction("CONTAINS",(e,n)=>String(e).includes(String(n))),t.BindExternalFunction("STARTS_WITH",(e,n)=>String(e).startsWith(String(n))),t.BindExternalFunction("ENDS_WITH",(e,n)=>String(e).endsWith(String(n))),t.BindExternalFunction("REPLACE",(e,n,i)=>String(e).replace(String(n),String(i))),t.BindExternalFunction("REPLACE_ALL",(e,n,i)=>String(e).replaceAll(String(n),String(i)))}static bindMathFunctions(t){t.BindExternalFunction("ROUND",e=>Math.round(e)),t.BindExternalFunction("CLAMP",(e,n,i)=>Math.min(Math.max(e,n),i)),t.BindExternalFunction("ABS",e=>Math.abs(e)),t.BindExternalFunction("PERCENT",(e,n)=>n===0?0:Math.round(e/n*100))}static bindFairMathFunctions(t){t.BindExternalFunction("FAIRADD",(e,n)=>{let i=e+(100-e)*(n/100);return Math.round(Math.min(100,Math.max(0,i)))}),t.BindExternalFunction("FAIRSUB",(e,n)=>{let i=e-e*(n/100);return Math.round(Math.min(100,Math.max(0,i)))})}static bindTimeFunctions(t){t.BindExternalFunction("NOW",()=>Math.floor(Date.now()/1e3)),t.BindExternalFunction("SECONDS_SINCE",e=>Math.floor(Date.now()/1e3)-e),t.BindExternalFunction("MINUTES_SINCE",e=>Math.floor((Date.now()/1e3-e)/60)),t.BindExternalFunction("TIME_SINCE",e=>{let n=Math.floor(Date.now()/1e3)-e;if(n<60)return n===1?"1 second":`${n} seconds`;let i=Math.floor(n/60);if(i<60)return i===1?"1 minute":`${i} minutes`;let r=Math.floor(i/60);if(r<24)return r===1?"1 hour":`${r} hours`;let a=Math.floor(r/24);return a===1?"1 day":`${a} days`}),t.BindExternalFunction("FORMAT_DATE",(e,n)=>{let i=new Date(e*1e3),r={year:"numeric",month:"long",day:"numeric"};try{return i.toLocaleDateString(n||"en-US",r)}catch{return console.warn(`Invalid locale "${n}", falling back to en-US`),i.toLocaleDateString("en-US",r)}}),t.BindExternalFunction("FORMAT_TIME",(e,n)=>{let i=new Date(e*1e3),r={hour:"numeric",minute:"2-digit"};try{return i.toLocaleTimeString(n||"en-US",r)}catch{return console.warn(`Invalid locale "${n}", falling back to en-US`),i.toLocaleTimeString("en-US",r)}}),t.BindExternalFunction("FORMAT_DATETIME",(e,n)=>{let i=new Date(e*1e3),r={year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit"};try{return i.toLocaleString(n||"en-US",r)}catch{return console.warn(`Invalid locale "${n}", falling back to en-US`),i.toLocaleString("en-US",r)}}),t.BindExternalFunction("OFFSET_DATE",(e,n,i,r,a,o)=>{let l=new Date(e*1e3);return l.setFullYear(l.getFullYear()+n),l.setMonth(l.getMonth()+i),l.setDate(l.getDate()+r),l.setHours(l.getHours()+a),l.setMinutes(l.getMinutes()+o),Math.floor(l.getTime()/1e3)})}static bindDebugFunctions(t){t.BindExternalFunction("DEBUG_LOG",e=>(console.log(`[INK DEBUG] ${e}`),0)),t.BindExternalFunction("DEBUG_WARN",e=>(console.warn(`[INK WARNING] ${e}`),0))}static bindTemplateControlFunctions(t,e){t.BindExternalFunction("OPEN_SAVES",()=>(e.saves.modal.show(),0)),t.BindExternalFunction("OPEN_SETTINGS",()=>(e.settings.settingsModal.show(),0)),t.BindExternalFunction("OPEN_PAGE",n=>e.pages.pageExists(n)?(e.queuedPage=n,0):(console.warn(`[INK] OPEN_PAGE: Page "${n}" not found`),0)),t.BindExternalFunction("RESTART",()=>(e.confirmRestart(),0))}};var jt=class s{static SOURCES={CHOICE_MANAGER:"Choice Manager",CONTENT_PROCESSOR:"Content Processor",DISPLAY_MANAGER:"Display Manager",DOM_HELPERS:"DOM Helpers",KEYBOARD_HELP:"Keyboard Help",KEYBOARD_SHORTCUTS:"Keyboard Shortcuts",MODAL:"Modal",MARKDOWN:"Markdown Processor",NAVIGATION_MANAGER:"Navigation Manager",PAGE_MANAGER:"Page Manager",SAVES_MODAL:"Saves Modal",SAVE_SYSTEM:"Save System",SETTINGS_MANAGER:"Settings Manager",STORY_MANAGER:"Story Manager",SYSTEM:"System",TAG_PROCESSOR:"Tag Processor"};constructor(){this.setupGlobalHandlers()}setupGlobalHandlers(){window.addEventListener("error",t=>{this.handleError("Uncaught Error",t.error,s.SOURCES.SYSTEM)}),window.addEventListener("unhandledrejection",t=>{this.handleError("Unhandled Promise",t.reason,s.SOURCES.SYSTEM),t.preventDefault()})}forSource(t){return{error:(e,n=null)=>this.error(e,n,t),warning:(e,n=null)=>this.warning(e,n,t),critical:(e,n=null)=>this.critical(e,n,t)}}critical(t,e,n){this.handleError(t,e,n,"critical")}error(t,e,n){this.handleError(t,e,n,"error")}warning(t,e,n){this.handleError(t,e,n,"warning")}safely(t,e=null){try{return t()}catch(n){return this.handleError("Safe execution failed",n,s.SOURCES.SYSTEM),e}}async safelyAsync(t,e=null){try{return await t()}catch(n){return this.handleError("Safe async execution failed",n,s.SOURCES.SYSTEM),e}}handleError(t,e,n="unknown",i="error"){let r=`[${i.toUpperCase()}] [${n}]`;if(console.group(`${r} ${t}`),console[i==="warning"?"warn":"error"]("Message:",t),console[i==="warning"?"warn":"error"]("Source:",n),e){let a=e instanceof Error?e.message:e;console[i==="warning"?"warn":"error"]("Details:",a),e.stack&&console[i==="warning"?"warn":"error"]("Stack:",e.stack)}console[i==="warning"?"warn":"error"]("Time:",new Date().toISOString()),console.groupEnd(),(i==="error"||i==="critical")&&this.showNotification(t,i),i==="critical"&&this.attemptRecovery(n)}showNotification(t,e){let n=e==="critical"?"critical":"error";ht.show(t,{type:n})}attemptRecovery(t){console.log(`[RECOVERY] Attempting recovery for ${t} error`);let e=window.InkTemplate?.storyManager;switch(t){case s.SOURCES.STORY_MANAGER:if(e)try{e.restart(),console.log("[RECOVERY] Story restarted successfully")}catch(n){console.error("[RECOVERY] Failed to restart story:",n)}break;case s.SOURCES.DISPLAY_MANAGER:if(e?.display)try{e.display.clear(),console.log("[RECOVERY] Display cleared")}catch(n){console.error("[RECOVERY] Failed to clear display:",n)}break;case s.SOURCES.SAVE_SYSTEM:if(e?.settings)try{e.settings.setSetting("autoSave",!1),console.log("[RECOVERY] Autosave disabled due to save system error")}catch(n){console.error("[RECOVERY] Failed to disable autosave:",n)}break;default:console.error("[RECOVERY] Critical error: Failed to recover")}}},C=new jt,w=jt.SOURCES;var Nt=C.forSource(w.MODAL),it=class s{static instances=new Set;constructor(t={}){this.config={maxWidth:"500px",width:"90%",maxHeight:"80vh",className:"base-modal",title:"Modal",closeOnBackdrop:!0,closeOnEscape:!0,showCloseButton:!0,showFooter:!0,size:"normal",...t},this.modalElement=null,this.isVisible=!1,this.onShow=t.onShow||null,this.onHide=t.onHide||null,this.previouslyFocusedElement=null,this.init()}init(){this.createModal(),this.setupEventListeners(),s.instances.add(this)}createModal(){let t=document.createElement("div");t.className=`base-modal-backdrop ${this.config.className}-backdrop`,t.setAttribute("role","presentation");let e=document.createElement("div"),n=this.getSizeClass();if(e.className=`base-modal-content ${this.config.className}-content ${n}`,e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby",`${this.config.className}-title`),e.setAttribute("tabindex","-1"),e.innerHTML=this.getModalHTML(),t.appendChild(e),!document.body){Nt.error("Cannot create modal - document.body not available");return}document.body.appendChild(t),this.modalElement=t}getModalHTML(){return`
      <div class="modal-header">
        <h2 id="${this.config.className}-title" tabindex="-1">${this.config.title}</h2>
        ${this.config.showCloseButton?'<button class="modal-close" aria-label="Close"><span aria-hidden="true">&times;</span></button>':""}
      </div>
      <div class="modal-body">
        <!-- Content will be injected here -->
      </div>
      ${this.config.showFooter?'<div class="modal-footer"></div>':""}
    `}setupEventListeners(){if(!this.modalElement)return;this.focusTrapHandler=e=>{if(e.key!=="Tab"||!this.isVisible)return;let i=this.modalElement.querySelector(`.${this.config.className}-content`)?.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(!i?.length)return;let r=i[0],a=i[i.length-1];e.shiftKey&&document.activeElement===r?(e.preventDefault(),a.focus()):!e.shiftKey&&document.activeElement===a&&(e.preventDefault(),r.focus())},document.addEventListener("keydown",this.focusTrapHandler);let t=this.modalElement.querySelector(".modal-close");t&&t.addEventListener("click",()=>this.hide()),this.config.closeOnBackdrop&&this.modalElement.addEventListener("click",e=>{e.target===this.modalElement&&this.hide()}),this.config.closeOnEscape&&(this.escapeHandler=e=>{e.key==="Escape"&&this.isVisible&&this.hide()},document.addEventListener("keydown",this.escapeHandler))}show(t=null){if(s.closeAll(this),!this.modalElement){Nt.error("Cannot show modal - modal element not available");return}this.previouslyFocusedElement=document.activeElement;let e=document.getElementById("main-content"),n=document.querySelector(".top-nav"),i=document.querySelector(".skip-link");if(e&&e.setAttribute("aria-hidden","true"),n&&n.setAttribute("aria-hidden","true"),i&&i.setAttribute("aria-hidden","true"),t&&typeof t=="function")try{t(this)}catch(r){Nt.error("Failed to populate modal content",r)}if(this.modalElement.style.display="block",this.isVisible=!0,requestAnimationFrame(()=>{if(this.modalElement){this.modalElement.style.opacity="1";let r=this.modalElement.querySelector(`.${this.config.className}-content`);r&&r.classList.add("modal-open");let a=r?.querySelector("h2");a?(a.setAttribute("tabindex","-1"),a.focus()):r?.focus()}}),this.onShow&&typeof this.onShow=="function")try{this.onShow()}catch(r){Nt.warning("Modal onShow callback failed",r)}}hide(){if(!this.modalElement)return;this.modalElement.style.opacity="0";let t=this.modalElement.querySelector(`.${this.config.className}-content`);if(t&&t.classList.remove("modal-open"),setTimeout(()=>{if(this.modalElement){this.modalElement.style.display="none",this.isVisible=!1;let e=document.getElementById("main-content"),n=document.querySelector(".top-nav"),i=document.querySelector(".skip-link");e&&e.removeAttribute("aria-hidden"),n&&n.removeAttribute("aria-hidden"),i&&i.removeAttribute("aria-hidden"),this.previouslyFocusedElement?.focus()}},300),this.onHide&&typeof this.onHide=="function")try{this.onHide()}catch(e){Nt.warning("Modal onHide callback failed",e)}}toggle(){this.isVisible?this.hide():this.show()}showConfirmation(t,e,n,i={}){let a={...{title:"Confirm",confirmText:"Yes",cancelText:"Cancel",confirmVariant:"danger"},...i},o={...this.config};this.config.title=a.title,this.config.closeOnBackdrop=!1,this.config.closeOnEscape=!0,this.show(l=>{l.setContent(`<p style="margin: 0; color: var(--color-text-primary);">${t}</p>`);let c=l.getFooter();if(c){c.innerHTML="",c.className="modal-footer modal-footer-right";let u=l.createButton(a.cancelText,{variant:"secondary",onClick:()=>{l.hide(),n&&n(),Object.assign(this.config,o)}}),m=l.createButton(a.confirmText,{variant:a.confirmVariant,onClick:()=>{l.hide(),e&&e(),Object.assign(this.config,o)}});c.appendChild(u),c.appendChild(m)}}),this.escapeHandler&&document.removeEventListener("keydown",this.escapeHandler),this.escapeHandler=l=>{l.key==="Escape"&&this.isVisible&&(this.hide(),n&&n(),Object.assign(this.config,o))},document.addEventListener("keydown",this.escapeHandler)}setContent(t){let e=this.modalElement?.querySelector(".modal-body");e&&(e.innerHTML=t)}setFooter(t){let e=this.modalElement?.querySelector(".modal-footer");e&&(e.innerHTML=t)}getBody(){return this.modalElement?.querySelector(".modal-body")}getFooter(){return this.modalElement?.querySelector(".modal-footer")}getSizeClass(){return{"400px":"modal-small","500px":"modal-medium","600px":"modal-large","700px":"modal-wide"}[this.config.maxWidth]||"modal-medium"}addBodyEventListener(t,e,n){if(!this.modalElement)return;this.modalElement.querySelectorAll(t).forEach(r=>{r.addEventListener(e,n)})}createButton(t,e={}){let n=document.createElement("button");return n.textContent=t,n.className=`modal-button modal-button-${e.variant||"primary"}`,e.onClick&&typeof e.onClick=="function"&&n.addEventListener("click",e.onClick),e.styles&&Object.entries(e.styles).forEach(([i,r])=>{n.style[i]=r}),n}showNotification(t,e=!1,n=4e3){let i=e?"error":"success";ht.show(t,{type:i,duration:n})}isReady(){return!!(this.modalElement&&document.body)}getStats(){return{hasModalElement:!!this.modalElement,isVisible:this.isVisible,className:this.config.className,hasEscapeHandler:!!this.escapeHandler,size:this.config.size}}destroy(){try{s.instances.delete(this),this.escapeHandler&&(document.removeEventListener("keydown",this.escapeHandler),this.escapeHandler=null),this.focusTrapHandler&&(document.removeEventListener("keydown",this.focusTrapHandler),this.focusTrapHandler=null);let t=document.getElementById("main-content"),e=document.querySelector(".top-nav"),n=document.querySelector(".skip-link");t&&t.removeAttribute("aria-hidden"),e&&e.removeAttribute("aria-hidden"),n&&n.removeAttribute("aria-hidden"),this.previouslyFocusedElement?.focus(),this.modalElement&&this.modalElement.parentNode&&this.modalElement.parentNode.removeChild(this.modalElement),this.modalElement=null,this.isVisible=!1}catch(t){Nt.warning("Failed to destroy modal",t)}}static closeAll(t=null){for(let e of s.instances)e!==t&&e.isVisible&&e.hide()}static hasVisibleModal(){for(let t of s.instances)if(t.isVisible)return!0;return!1}static confirm({title:t,message:e,confirmText:n="Yes",cancelText:i="Cancel",confirmVariant:r="danger",onConfirm:a,onCancel:o}){let l=new s({title:t||"Confirm",className:"confirm-modal",maxWidth:"400px",showFooter:!0});l.showConfirmation(e,()=>{a?.(),l.destroy()},()=>{o?.(),l.destroy()},{title:t,confirmText:n,cancelText:i,confirmVariant:r})}};var X=C.forSource(w.STORY_MANAGER),Gt=class{constructor(t,{display:e,settings:n,contentProcessor:i}){try{this.story=new ct(t),Rt.bindAll(this.story,this),this.savePoint="",this.autoClear=!1,this.queuedPage=null,this.display=e,this.settings=n,this.contentProcessor=i,this.pages=null,this.choices=null,this.navigation=null,this.saves=null}catch(r){throw X.critical("Failed to initialize story",r),r}}start(){let t={display:this.display,settings:this.settings,contentProcessor:this.contentProcessor,pages:this.pages,choices:this.choices,navigation:this.navigation,saves:this.saves},e=Object.entries(t).filter(([n,i])=>!i).map(([n])=>n);if(e.length>0)throw new Error(`StoryManager.start() called before wiring dependencies: ${e.join(", ")}`);this.pages.detectSpecialPages();try{this.settings.processGlobalTags(this.story.globalTags),this.settings.maxHistory&&this.display.setMaxHistory(this.settings.maxHistory),this.pages.processMenuOrderTag(this.story.globalTags),this.navigation.updateVisibility(this.pages.availablePages,this.pages.pageMenuOrder),this.savePoint=this.story.state.ToJson(),this.continue(!0)}catch(n){X.error("Failed to setup initial state",n)}}continue(t=!1){try{if(this.pages?.isViewingSpecialPage())return;let e=this.display?.getContentElementCount?.()||0;t||(this.autoClear?(this.display?.clear?.(),this.display?.scrollToTop?.()):this.display?.removeChoices?.());let{content:n,stoppedForUserInput:i,stateBeforeUserInput:r}=this.generateContent();if(n.length>0)if(this.display?.render?.(n),document.dispatchEvent(new CustomEvent("story:content",{detail:{content:n}})),t)this.display?.positionFocusMarkerAtNewContent?.(0);else{let a;this.userInputMarkerPosition!=null?a=this.userInputMarkerPosition:this.autoClear?a=0:a=e,this.display?.positionFocusMarkerAtNewContent?.(a),this.userInputMarkerPosition!=null?this.display?.focusMarker?.("Input submitted"):this.display?.focusMarker?.()}if(t&&setTimeout(()=>document.dispatchEvent(new CustomEvent("story:start")),0),i&&r&&(this.stateBeforeUserInput=r),i||this.createChoices(),!i&&this.hasEnded()&&document.dispatchEvent(new CustomEvent("story:end")),this.savePoint=this.story.state.ToJson(),this.queuedPage){let a=this.queuedPage;this.queuedPage=null,this.pages.show(a)}}catch(e){X.error("Failed to continue story",e)}}createChoices(){try{if(this.story.currentChoices?.length>0){let t=this.choices?.generate?.(this.story.currentChoices);t&&this.display?.renderChoices?.(t,!0)}}catch(t){X.error("Failed to create choices",t,"choices")}}selectChoice(t){try{if(typeof t!="number"||t<0||t>=this.story.currentChoices.length)throw new Error(`Invalid choice index: ${t}`);this.display?.container?.querySelectorAll?.(".choice").forEach(e=>{e.remove()}),this.story.ChooseChoiceIndex(t),document.dispatchEvent(new CustomEvent("story:choice",{detail:{index:t}})),this.savePoint=this.story.state.ToJson(),this.continue(),this.saves?.autosave?.()}catch(e){X.error("Failed to select choice",e,"navigation")}}restart(){try{document.dispatchEvent(new CustomEvent("story:restart")),this.story.ResetState(),this.display?.reset?.(),this.pages?.reset?.(),this.savePoint=this.story.state.ToJson(),this.autoClear=!1,this.continue(!0),this.display?.scrollToTop?.(),ht.success?.("Story restarted from the beginning")}catch(t){X.error("Failed to restart story",t)}}confirmRestart(){it.confirm({title:"Restart Story",message:"Are you sure you want to restart the story from the beginning? Any unsaved progress will be lost.",confirmText:"Restart",cancelText:"Cancel",confirmVariant:"primary",onConfirm:()=>this.restart()})}generateContent(){let t=[],e=!1,n=this.story.state.ToJson();try{for(;this.story.canContinue;){let i=this.story.Continue(),r=this.story.currentTags||[];if(i.trim().length===0&&r.length===0)continue;let a=this.contentProcessor?.process?.(i,r);if(a){if(Array.isArray(a)){if(t.push(...a),a.some(o=>o.type==="user-input")){e=!0;break}}else if(t.push(a),a.type==="user-input"){e=!0;break}}if(a?.hasSpecialAction&&!this.handleSpecialAction(a.action))break}}catch(i){X.error("Error generating story content",i)}return{content:t,stoppedForUserInput:e,stateBeforeUserInput:e?n:null}}handleSpecialAction(t){try{if(typeof t=="string")switch(t){case"CLEAR":return this.display?.clear?.(),this.display?.hideHeader?.(),!0;case"AUTOCLEAR_ON":return this.autoClear=!0,!0;case"AUTOCLEAR_OFF":return this.autoClear=!1,!0;case"RESTART":return this.confirmRestart(),!1;default:return!0}return!0}catch(e){return X.error("Failed to handle special action",e),!0}}getCurrentState(){try{return{gameState:this.story.state.ToJson(),displayState:this.display?.getState?.()||null,currentPage:this.pages?.currentPage,savePoint:this.savePoint,timestamp:Date.now(),autoClear:this.autoClear}}catch(t){return X.error("Failed to get current state",t),{}}}loadState(t){try{if(!t?.gameState)throw new Error("Invalid save state");this.createTempStory().state.LoadJson(t.gameState),this.story.state.LoadJson(t.gameState),this.pages.currentPage=t.currentPage||null,this.savePoint=t.savePoint||this.story.state.ToJson(),this.autoClear=t.autoClear??!1,this.pages?.reset?.(),this.stateBeforeUserInput=t.stateBeforeUserInput||null;let n=!1;t.displayState?(this.display?.restoreState?.(t.displayState),n=t.stateBeforeUserInput!=null):(this.display?.clear?.(),this.regenerateCurrentDisplay()),n||this.createChoices(),this.display?.focusMarker?.("Continuing story")}catch(e){X.error("Failed to load state",e,"save-system")}}regenerateCurrentDisplay(){try{let t=this.story.state.currentText;if(t?.trim?.().length>0){let e=[{text:t,classes:[]}];this.display?.render?.(e)}}catch(t){X.error("Failed to regenerate display",t,"display")}}canContinue(){try{return this.story.canContinue}catch(t){return X.warning("Failed to check canContinue",t),!1}}hasChoices(){try{return this.story.currentChoices?.length>0}catch(t){return X.warning("Failed to check hasChoices",t),!1}}hasEnded(){return!this.canContinue()&&!this.hasChoices()}createTempStory(){let t=new ct(this.story.ToJson());return Rt.bindAll(t,this),t}getStats(){try{return{currentTurnIndex:this.story.state.currentTurnIndex,hasEnded:this.hasEnded(),canContinue:this.canContinue(),hasChoices:this.hasChoices(),currentPage:this.pages?.currentPage,displayLength:this.display?.getHistoryLength?.()||0,specialPagesFound:Object.keys(this.pages?.availablePages||{}).length}}catch(t){return X.warning("Failed to get stats",t),{}}}getFeatureInfo(){return{availablePages:{...this.pages?.availablePages},hasGlobalTags:this.story.globalTags?.length>0,hasCurrentTags:this.story.currentTags?.length>0,specialPageCount:Object.keys(this.pages?.availablePages||{}).length}}cleanup(){try{this.saves?.cleanup?.(),this.settings?.cleanup?.(),this.pages?.reset?.()}catch(t){X.warning("Failed to cleanup",t,"system")}}};var M={GLOBAL:"global",DISCOVERY:"discovery",CONTENT:"content",EFFECT:"effect"},x={REQUIRED:"required",OPTIONAL:"optional",NONE:"none"},y={THEME:{names:["THEME"],phase:M.GLOBAL,value:x.REQUIRED,description:"Set default theme (light/dark)"},AUTHOR:{names:["AUTHOR"],phase:M.GLOBAL,value:x.REQUIRED,description:"Story author name"},TITLE:{names:["TITLE"],phase:M.GLOBAL,value:x.REQUIRED,description:"Story title"},MAX_HISTORY:{names:["MAX_HISTORY","HISTORY_LIMIT"],phase:M.GLOBAL,value:x.REQUIRED,description:"Maximum display history items to keep in saves"},TONE:{names:["TONE"],phase:M.GLOBAL,value:x.REQUIRED,description:"Define tone indicator (e.g., TONE: flirty \u{1F525})"},TONE_INDICATORS:{names:["TONE_INDICATORS","SHOW_TONES"],phase:M.GLOBAL,value:x.REQUIRED,description:"Enable tone indicators (on/off)"},TONE_TRAILING:{names:["TONE_TRAILING","TRAILING_TONES"],phase:M.GLOBAL,value:x.NONE,description:"Show all tone icons after choice text"},CHOICE_NUMBERS:{names:["CHOICE_NUMBERS","CHOICE_NUMBERING","KEYBOARD_HINTS"],phase:M.GLOBAL,value:x.REQUIRED,description:"Choice numbering mode (auto/on/off)"},PAGE_MENU:{names:["PAGE_MENU","MENU","MENU_ORDER","PAGE_ORDER","SPECIAL_PAGE_ORDER"],phase:M.GLOBAL,value:x.REQUIRED,description:"Define page menu order"},SPECIAL_PAGE:{names:["SPECIAL_PAGE","PAGE"],phase:M.DISCOVERY,value:x.OPTIONAL,description:"Mark knot as special page, optionally with display name"},IMAGE:{names:["IMAGE","IMG","PICTURE","PIC"],phase:M.CONTENT,value:x.REQUIRED,description:"Display image (src, alignment, width, alt)"},STATBAR:{names:["STATBAR","STAT_BAR","PROGRESSBAR","PROGRESS_BAR"],phase:M.CONTENT,value:x.REQUIRED,description:"Display stat bar (variable, min, max, labels)"},USER_INPUT:{names:["USER_INPUT","INPUT","PROMPT","TEXT_INPUT"],phase:M.CONTENT,value:x.REQUIRED,description:"Text input field (variable, placeholder)"},AUDIO:{names:["AUDIO","SOUND","SFX","SOUND_EFFECT"],phase:M.EFFECT,value:x.REQUIRED,description:"Play one-shot audio file"},AUDIOLOOP:{names:["AUDIOLOOP","AUDIO_LOOP","MUSIC","BACKGROUND_MUSIC","BGM"],phase:M.EFFECT,value:x.REQUIRED,description:"Play looping audio (or 'none' to stop)"},BACKGROUND:{names:["BACKGROUND","BG","BACKGROUND_IMAGE"],phase:M.EFFECT,value:x.REQUIRED,description:"Set background image (or 'none' to remove)"},NOTIFICATION:{names:["NOTIFICATION","NOTIFY","MESSAGE","INFO"],phase:M.EFFECT,value:x.REQUIRED,description:"Show info notification"},ACHIEVEMENT:{names:["ACHIEVEMENT","SUCCESS"],phase:M.EFFECT,value:x.REQUIRED,description:"Show success notification (6s duration)"},WARNING:{names:["WARNING","WARN"],phase:M.EFFECT,value:x.REQUIRED,description:"Show warning notification"},ERROR:{names:["ERROR","ERR"],phase:M.EFFECT,value:x.REQUIRED,description:"Show error notification"},CLASS:{names:["CLASS","CSS","CSS_CLASS","STYLE"],phase:M.EFFECT,value:x.REQUIRED,description:"Add CSS class to element"},AUTOCLEAR:{names:["AUTOCLEAR","AUTO_CLEAR"],phase:M.EFFECT,value:x.REQUIRED,description:"Toggle auto-clear on choice selection (on/off)"},CLEAR:{names:["CLEAR"],phase:M.EFFECT,value:x.NONE,description:"Clear story content"},RESTART:{names:["RESTART","RESET","NEW_GAME"],phase:M.EFFECT,value:x.NONE,description:"Restart story from beginning"},UNCLICKABLE:{names:["UNCLICKABLE","DISABLED","DISABLE"],phase:M.EFFECT,value:x.NONE,description:"Make choice visible but not clickable"}};for(let s in y)y[s].names||(y[s].names=[s]);var Ot={};for(let s in y)for(let t of y[s].names){let e=t.toUpperCase();Ot[e]&&console.warn(`Duplicate tag alias "${e}" used by both "${Ot[e]}" and "${s}"`),Ot[e]=s}function we(s){return Object.keys(y).filter(t=>y[t].phase===s)}function Te(s){return!s||typeof s!="string"?!1:Ot[s.toUpperCase()]!==void 0}function Ae(s){if(!s||typeof s!="string")return null;let t=Ot[s.toUpperCase()];return t?y[t]:null}function Pe(s,t){if(!s)return{valid:!0,error:null};let e=t&&t.trim()!=="",n=s.names[0];return s.value===x.REQUIRED&&!e?{valid:!1,error:`Tag "${n}" requires a value (use # ${n}: value)`}:s.value===x.NONE&&e?{valid:!1,error:`Tag "${n}" should not have a value (use # ${n} alone)`}:{valid:!0,error:null}}var Q={TAG_PHASE:M,TAG_VALUE:x,TAGS:y,TAG_LOOKUP:Ot,getTagsByPhase:we,isKnownTag:Te,getTagDef:Ae,validateTagValue:Pe,parseTag(s){if(!s||typeof s!="string")return{tagDef:null,tagValue:"",invalid:!1,error:null};let t=this.splitPropertyTag(s),e=t?t.property:s.trim(),n=t?.val||"",i=this.getTagDef(e);if(i){let r=this.validateTagValue(i,n);if(!r.valid)return{tagDef:i,tagValue:n,invalid:!0,error:r.error}}return{tagDef:i,tagValue:n,invalid:!1,error:null}},splitPropertyTag(s){if(!s||typeof s!="string")return null;let t=s.indexOf(":");return t===-1?null:{property:s.slice(0,t).trim(),val:s.slice(t+1).trim()}},hasSpecialPageTag(s){return Array.isArray(s)?s.some(t=>{if(typeof t!="string")return!1;let{tagDef:e}=this.parseTag(t);return e===y.SPECIAL_PAGE}):!1},toneMap:{},registerTone(s,t){!s||typeof s!="string"||(this.toneMap[s.toLowerCase()]=t)},getToneIcon(s){return!s||typeof s!="string"?null:this.toneMap[s.toLowerCase()]||null},isRegisteredToneTag(s){return!s||typeof s!="string"?!1:s.toLowerCase()in this.toneMap},clearTones(){this.toneMap={}}},Lt={hasAudio:!1,scan(s){let t=JSON.stringify(s),e=(...n)=>{let i=n.flatMap(r=>r?.names||[]);return i.length?new RegExp(`"\\^(${i.join("|")})\\s*:`,"i").test(t):!1};return this.hasAudio=e(y.AUDIO,y.AUDIOLOOP),this}};var q={isMobile(){return window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(pointer: fine)").matches},isMac(){return navigator.userAgentData?.platform==="macOS"||navigator.platform.toUpperCase().includes("MAC")},formatKnotName(s){return s.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2").replace(/_/g," ").toLowerCase().split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")},levenshteinDistance(s,t){if(s.length===0)return t.length;if(t.length===0)return s.length;let e=[];for(let n=0;n<=t.length;n++)e[n]=[n];for(let n=0;n<=s.length;n++)e[0][n]=n;for(let n=1;n<=t.length;n++)for(let i=1;i<=s.length;i++){let r=s[i-1]===t[n-1]?0:1;e[n][i]=Math.min(e[n-1][i]+1,e[n][i-1]+1,e[n-1][i-1]+r)}return e[t.length][s.length]}};var be=C.forSource(w.KEYBOARD_SHORTCUTS),ke=.15,Ne=.8,Ht=class{constructor(){this.enabled=!q.isMobile(),this.storyManager=null,this.keyboardHelpModal=null,this.init()}init(){document.addEventListener("keydown",t=>this.handleKeyDown(t))}enable(){this.enabled=!0}disable(){this.enabled=!1}handleKeyDown(t){if(!(!this.storyManager||!this.enabled)&&!t.altKey&&!this.isTypingInInput(t)){if(t.ctrlKey||t.metaKey){this.handleModifierShortcuts(t);return}if(t.key==="Escape"){this.handleEscape();return}this.handleScrolling(t)||this.handleChoiceSelection(t)}}handleModifierShortcuts(t){try{switch(t.key){case"s":t.preventDefault(),this.storyManager.saves?.showSaveDialog?.();break;case"r":t.preventDefault(),this.storyManager.confirmRestart();break;case",":t.preventDefault(),this.storyManager.settings?.showSettings?.();break;case"h":t.preventDefault(),this.keyboardHelpModal?.show?.();break}}catch(e){be.error("Keyboard shortcut failed",e)}}handleEscape(){if(this.storyManager.pages?.isViewingSpecialPage?.())try{this.storyManager.pages.returnToStory()}catch(t){be.error("Failed to return from special page",t)}}handleScrolling(t){if(!this.isInStoryArea())return!1;let e=document.querySelector(".outerContainer");if(!e)return!1;let n=window.innerHeight*ke,i=window.innerHeight*Ne;switch(t.key){case"ArrowUp":return t.preventDefault(),e.scrollBy({top:-n,behavior:"smooth"}),!0;case"ArrowDown":return t.preventDefault(),e.scrollBy({top:n,behavior:"smooth"}),!0;case"PageUp":return t.preventDefault(),e.scrollBy({top:-i,behavior:"smooth"}),!0;case"PageDown":return t.preventDefault(),e.scrollBy({top:i,behavior:"smooth"}),!0;case"Home":return t.preventDefault(),e.scrollTo({top:0,behavior:"smooth"}),!0;case"End":return t.preventDefault(),e.scrollTo({top:e.scrollHeight,behavior:"smooth"}),!0}return!1}handleChoiceSelection(t){if(!this.isInStoryArea())return;let e=this.storyManager.story?.currentChoices;if(!e||e.length===0)return;let n=t.key.toLowerCase(),i=null;n>="1"&&n<="9"?i=parseInt(n)-1:n>="a"&&n<="z"&&(i=9+(n.charCodeAt(0)-97)),i!==null&&i<e.length&&(t.preventDefault(),this.storyManager.selectChoice(i))}isTypingInInput(t){return t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA"}isInStoryArea(){let t=document.activeElement,e=document.querySelector(".outerContainer");return t===document.body||e?.contains(t)}};var Oe=C.forSource(w.KEYBOARD_HELP),qt=class{constructor(){this.modal=null,this.isMac=q.isMac(),this.isMobile=q.isMobile(),this.init()}init(){this.isMobile||this.createModal()}createModal(){this.modal=new it({title:"Keyboard Shortcuts",className:"keyboard-help-modal",maxWidth:"500px",showFooter:!0})}show(){if(!this.isMobile){if(!this.modal?.isReady()){Oe.error("Cannot show keyboard help - modal not available");return}this.modal.show(t=>{t.setContent(this.getHelpHTML());let e=t.getFooter();if(e){e.innerHTML="",e.className="modal-footer modal-footer-right";let n=t.createButton("Close",{variant:"primary",onClick:()=>this.hide()});e.appendChild(n)}})}}hide(){this.modal?.hide()}isAvailable(){return!this.isMobile}isReady(){return!this.isMobile&&this.modal?.isReady()}getModifierKey(){return this.isMac?"Cmd":"Ctrl"}getHelpHTML(){let t=this.getModifierKey();return`
      <div class="keyboard-help-section">
        <h3>Choice Selection</h3>
        <table class="keyboard-help-table">
          <tr>
            <td class="shortcut-key"><kbd>1</kbd> - <kbd>9</kbd></td>
            <td>Select choice 1-9</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>A</kbd> - <kbd>Z</kbd></td>
            <td>Select choice 10+ (A=10, B=11, etc.)</td>
          </tr>
        </table>
      </div>

      <div class="keyboard-help-section">
        <h3>Scrolling</h3>
        <table class="keyboard-help-table">
          <tr>
            <td class="shortcut-key"><kbd>\u2191</kbd> / <kbd>\u2193</kbd></td>
            <td>Scroll up/down (small)</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>PgUp</kbd> / <kbd>PgDn</kbd></td>
            <td>Scroll up/down (large)</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>Home</kbd> / <kbd>End</kbd></td>
            <td>Jump to top/bottom</td>
          </tr>
        </table>
      </div>

      <div class="keyboard-help-section">
        <h3>Menus</h3>
        <table class="keyboard-help-table">
          <tr>
            <td class="shortcut-key"><kbd>${t}</kbd>+<kbd>S</kbd></td>
            <td>Open save menu</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>${t}</kbd>+<kbd>,</kbd></td>
            <td>Open settings</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>${t}</kbd>+<kbd>H</kbd></td>
            <td>Show this help</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>${t}</kbd>+<kbd>R</kbd></td>
            <td>Restart story</td>
          </tr>
          <tr>
            <td class="shortcut-key"><kbd>Esc</kbd></td>
            <td>Close menu / Return to story</td>
          </tr>
        </table>
      </div>
    `}};var Ce=C.forSource(w.MARKDOWN),It=class s{static patterns={escape:[[/%\*/g,"&#42;"],[/%_/g,"&#95;"],[/%`/g,"&#96;"],[/%:/g,"&#58;"],[/%\[/g,"&#91;"],[/%\]/g,"&#93;"],[/%\(/g,"&#40;"],[/%\)/g,"&#41;"],[/%%/g,"&#37;"]],block:[[/^::: (.*$)/gm,"<h4>$1</h4>"],[/^:: (.*$)/gm,"<h3>$1</h3>"],[/^: (.*$)/gm,"<h2>$1</h2>"],[/^\[---+\]$/gm,"<hr>"],[/^>> (.+)$/gm,"<blockquote>$1</blockquote>"],[/^> (.+)$/gm,"<li>$1</li>"]],inline:[[/___([^_\n]+?)___/g,"<strong><em>$1</em></strong>"],[/__([^_\n]+?)__/g,"<strong>$1</strong>"],[/(?<!_)_([^_\n]+?)_(?!_)/g,"<em>$1</em>"],[/\[(.*?)\]\(([^)]+)\)/g,(t,e,n)=>s.processLinkOrClass(e,n)],[/  $/gm,"<br>"]]};static process(t){if(!t||typeof t!="string")return"";if(t.trim().startsWith("%"))return t.trim().substring(1);try{for(let[e,n]of this.patterns.escape)t=t.replace(e,n);for(let[e,n]of this.patterns.block)t=t.replace(e,n);return t=t.replace(/(<li>.*?<\/li>(?:\s*<li>.*?<\/li>)*)/gs,"<ul>$1</ul>"),t=this.processInlineWithCodeBlocks(t),t}catch(e){return Ce.warning("Markdown processing failed",e),t}}static processInlineWithCodeBlocks(t){let e=this.tokenize(t),n="";for(let i of e)i.type==="code"?n+=`<code>${i.content}</code>`:i.type==="text"&&(n+=this.processInlineMarkdown(i.content));return n}static tokenize(t){let e=[],n="",i=0;for(;i<t.length;)if(t[i]==="`"){n&&(e.push({type:"text",content:n}),n=""),i++;let r="";for(;i<t.length&&t[i]!=="`";)r+=t[i],i++;e.push({type:"code",content:r}),i++}else n+=t[i],i++;return n&&e.push({type:"text",content:n}),e}static processInlineMarkdown(t){try{for(let[e,n]of this.patterns.inline)t=t.replace(e,n);return t}catch(e){return Ce.warning("Inline markdown processing failed",e),t}}static processLinkOrClass(t,e){if(this.isURL(e)){let n=e;(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\/.*)?$/.test(e)||/^www\./i.test(e))&&(n="https://"+e);let i=this.isExternalURL(n);return`<a href="${n}"${i?' target="_blank" rel="noopener noreferrer"':""}>${t}${i?'<span class="sr-only"> (opens in new tab)</span>':""}</a>`}else return`<span class="inline-${e}">${t}</span>`}static isURL(t){return[/^https?:\/\//i,/^\/\//i,/^mailto:/i,/^tel:/i,/^#/,/^\//,/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\/.*)?$/,/^www\./i].some(n=>n.test(t))}static isExternalURL(t){try{return t.startsWith("/")||t.startsWith("#")?!1:(t.startsWith("//")&&(t="https:"+t),(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(\/.*)?$/.test(t)||/^www\./i.test(t))&&(t="https://"+t),new URL(t,window.location.origin).hostname!==window.location.hostname)}catch{return!0}}static getStats(){return{patternCount:{escape:this.patterns.escape.length,block:this.patterns.block.length,inline:this.patterns.inline.length},supportsLinks:!0,supportsInlineClasses:!0,timestamp:new Date().toISOString()}}};var H=C.forSource(w.DOM_HELPERS),Dt=class{constructor(t,e=null){if(!t||!(t instanceof Element)){H.critical("Invalid story container provided to DOM helpers",new Error("Invalid story container"));return}this.settings=e,this.storyContainer=t}createParagraph(t,e=[]){if(!t||typeof t!="string"||!t.trim())return H.warning("Invalid text passed to createParagraph"),null;Array.isArray(e)||(H.warning("Invalid customClasses passed to createParagraph - using empty array"),e=[]);try{let n=document.createElement("p");n.innerHTML=t;for(let i of e)i&&typeof i=="string"&&n.classList.add(i);return this.storyContainer.appendChild(n),n}catch(n){return H.error("Failed to create paragraph",n),null}}createChoice(t,e=[],n=!0,i=null,r=!0,a=[],o=null,l=null,c=null){(!t||typeof t!="string")&&(H.warning("Invalid choiceText passed to createChoice"),t="[Invalid Choice]"),Array.isArray(e)||(H.warning("Invalid customClasses passed to createChoice - using empty array"),e=[]);try{let u=document.createElement("button");u.type="button",u.classList.add("choice");for(let st of e)st&&typeof st=="string"&&u.classList.add(st);n||(u.classList.add("unclickable"),u.setAttribute("aria-disabled","true"));let m="",g="",S="";if(a.length>0){S=`<span class="sr-only"> (${a.map(v=>v.label).join(", ")})</span>`;let $=v=>{let{icon:F}=v;return/^[a-z_]+$/.test(F)?`<span class="material-icons tone-icon" aria-hidden="true">${F}</span>`:`<span class="tone-icon" aria-hidden="true">${F}</span>`};this.settings?.toneIndicatorsTrailing?g=`<span class="tone-indicator-trailing" aria-hidden="true">${a.map($).join("")}</span>`:(m=`<span class="tone-indicator-leading" aria-hidden="true">${$(a[0])}</span>`,a.length>1&&(g=`<span class="tone-indicator-trailing" aria-hidden="true">${a.slice(1).map($).join("")}</span>`))}let B=i&&r?`<span class="choice-key-hint" aria-hidden="true">${i}.</span> `:"",R=o!==null&&l!==null?` ${o} of ${l}: `:": ",J=n?`<span class="sr-only">Choice${R}</span>`:`<span class="sr-only">Unavailable choice${R}</span>`;return u.innerHTML=`${J}${m}${B}${t}${g}${S}`,(c||this.storyContainer).appendChild(u),u}catch(u){return H.error("Failed to create choice",u),null}}addChoiceClickHandler(t,e){if(!t||!(t instanceof Element)){H.warning("Invalid choiceElement passed to addChoiceClickHandler");return}if(!e||typeof e!="function"){H.warning("Invalid callback passed to addChoiceClickHandler");return}t.addEventListener("click",function(n){try{n.preventDefault(),e()}catch(i){H.error("Choice click handler failed",i)}})}mergeConsecutiveElements(){this.mergeElementsByTag("ul"),this.mergeElementsByTag("blockquote")}mergeElementsByTag(t){let e=this.storyContainer.querySelectorAll(t);for(let n=e.length-1;n>=0;n--){let i=e[n],r=i.nextElementSibling;if(r&&r.tagName.toLowerCase()===t.toLowerCase()){for(;r.firstChild;)i.appendChild(r.firstChild);r.remove()}}}removeAll(t){if(!t||typeof t!="string"){H.warning("Invalid selector passed to removeAll");return}let e=this.storyContainer.querySelectorAll(t);for(let n=0;n<e.length;n++){let i=e[n];try{i?.parentNode&&i.parentNode.removeChild(i)}catch(r){H.warning(`Failed to remove element at index ${n}`,r)}}}setVisible(t,e){if(!t||typeof t!="string"){H.warning("Invalid selector passed to setVisible");return}let n=this.storyContainer.querySelectorAll(t);for(let i=0;i<n.length;i++){let r=n[i];try{if(!r?.classList)continue;e?r.classList.remove("invisible"):r.classList.add("invisible")}catch(a){H.warning(`Failed to set visibility for element at index ${i}`,a)}}}clearStoryContent(){this.removeAll("p"),this.removeAll("h2"),this.removeAll("h3"),this.removeAll("h4"),this.removeAll("ul"),this.removeAll("blockquote"),this.removeAll("hr"),this.removeAll("img"),this.removeAll("figure"),this.removeAll(".stat-bar-container"),this.removeAll(".user-input-inline-container"),this.removeAll(".choices-container")}scrollToTop(t){if(!t||!(t instanceof Element)){H.warning("Invalid container passed to scrollToTop");return}try{typeof t.scrollTo=="function"?t.scrollTo(0,0):typeof t.scrollTop<"u"?(t.scrollTop=0,t.scrollLeft=0):H.warning("Container does not support scrolling operations")}catch(e){H.warning("Failed to scroll to top",e)}}recover(){if(!this.storyContainer?.parentNode){let t=document.querySelector("#story");t?(this.storyContainer=t,H.warning("DOM helpers recovered by finding new story container")):H.error("DOM helpers recovery failed - no story container found")}}isReady(){return!!this.storyContainer?.parentNode}getStats(){return this.storyContainer?{hasContainer:!0,containerTagName:this.storyContainer.tagName,containerChildren:this.storyContainer.children.length,containerText:this.storyContainer.textContent.length,paragraphCount:this.storyContainer.querySelectorAll("p").length,choiceCount:this.storyContainer.querySelectorAll(".choice").length,imageCount:this.storyContainer.querySelectorAll("img").length}:{hasContainer:!1}}};var K=C.forSource(w.DISPLAY_MANAGER),Kt=class s{static CONTENT_SELECTOR="p, h2, h3, h4, ul, blockquote, hr, figure, .stat-bar-container, .user-input-inline-container";constructor(t){if(t||K.warning("DisplayManager created without settings: animations will default to on"),this.settings=t,this.storyManager=null,this.container=document.querySelector("#story"),this.scrollContainer=document.querySelector(".outerContainer"),this.history=[],this.maxHistory=null,this.focusMarkerIndex=null,this.focusMarkerElement=null,this.initFocusMarker(),!this.container){K.critical("Story container element not found",new Error("Missing #story element"));return}this.domHelpers=new Dt(this.container,this.settings)}initFocusMarker(){this.focusMarkerElement=document.createElement("span"),this.focusMarkerElement.id="focus-marker",this.focusMarkerElement.className="sr-only",this.focusMarkerElement.setAttribute("tabindex","-1")}render(t){if(!Array.isArray(t)){K.warning("Invalid content passed to render - expected array");return}t.forEach((e,n)=>{try{let i;switch(e.type){case"statbar":i=this.createStatBar(e);break;case"image":i=this.createImage(e);break;case"user-input":i=this.createUserInput(e);break;case"paragraph":default:i=this.createElement(e);break}i&&(this.trackInHistory(e),this.shouldAnimateContent()&&this.fadeInElement(i))}catch(i){K.error(`Failed to render content item at index ${n}`,i)}}),this.domHelpers?.mergeConsecutiveElements?.()}renderChoices(t,e=!0){if(!Array.isArray(t)){K.warning("Invalid choices passed to renderChoices - expected array");return}let n=t.length,i=document.createElement("div");i.className="choices-container",i.setAttribute("role","region"),i.setAttribute("aria-label",`${n} choices available`),this.container.appendChild(i),t.forEach((r,a)=>{try{let o=this.domHelpers.createChoice(r.text||"",r.classes||[],r.isClickable!==!1,r.keyHint,e,r.toneIndicators||[],a+1,n,i);r.isClickable!==!1&&r.onClick&&(typeof r.onClick=="function"?this.domHelpers.addChoiceClickHandler(o,r.onClick):K.warning(`Choice at index ${a} has invalid onClick handler`)),o&&this.shouldAnimateContent()&&this.fadeInElement(o)}catch(o){K.error(`Failed to render choice at index ${a}`,o)}})}createElement(t){if(!t?.text||typeof t.text!="string")return K.warning("createElement called with invalid content"),null;if(!this.domHelpers)return K.error("Cannot create element - DOM helpers not available"),null;try{let e=It.process(t.text),i=/^<(h[2-4]|ul|blockquote|hr)/i.test(e.trim()),r;if(i){let a=document.createElement("div");if(a.innerHTML=e,r=a.firstElementChild,t.classes?.length)for(let o of t.classes)o&&typeof o=="string"&&r.classList.add(o);this.domHelpers.storyContainer.appendChild(r)}else r=this.domHelpers.createParagraph(e,t.classes||[]);return r&&this.shouldAnimateContent()&&this.fadeInElement(r),r}catch(e){return K.error("Failed to create element",e),null}}createImage(t){let e=document.createElement("img");e.src=t.src,e.className="story-image",t.altText?e.alt=t.altText:e.alt="",t.alignment&&e.classList.add(`image-${t.alignment}`),t.width&&(e.style.width=t.width),e.onerror=()=>{K.warning(`Failed to load image: ${t.src}`)};let n;if(t.showCaption&&t.altText){let i=document.createElement("figure");i.className="story-figure",t.alignment&&(i.classList.add(`figure-${t.alignment}`),e.classList.remove(`image-${t.alignment}`)),t.width&&(i.style.width=t.width,e.style.width="100%");let r=document.createElement("figcaption");r.className="story-caption",r.textContent=t.altText,i.appendChild(e),i.appendChild(r),n=i}else n=e;return this.container.appendChild(n),n}createStatBar(t){let e=this.getStatValue(t.variableName),n=this.calculateStatBarMetrics(t,e),i=t.isOpposed?this.renderOpposedStatBar(t,n):this.renderSimpleStatBar(t,n);return this.container.appendChild(i),i}createUserInput(t){let e=document.createElement("div");e.className="user-input-inline-container";let n=t.placeholder||"Type your answer here...";e.innerHTML=`
    <div class="user-input-prompt">
      <input type="text" class="user-input-inline-field" 
             placeholder="${n}" 
             maxlength="100" autocomplete="off">
      <button class="user-input-submit-btn">Submit</button>
    </div>
    <div class="user-input-help">Press Enter or click Submit to continue</div>
  `,this.container.appendChild(e);let i=e.querySelector(".user-input-inline-field"),r=e.querySelector(".user-input-submit-btn"),a=()=>{let o=i.value.trim();if(!o){i.style.borderColor="var(--color-important)",i.placeholder="Please enter a value...",i.focus();return}try{this.storyManager.story.variablesState.$(t.variableName,o),this.storyManager.stateBeforeUserInput&&(this.storyManager.story.state.LoadJson(this.storyManager.stateBeforeUserInput),this.storyManager.story.variablesState.$(t.variableName,o),this.storyManager.stateBeforeUserInput=null);let l=this.truncateFromFocusMarker();this.storyManager.reprocessingAfterUserInput=!0,this.storyManager.userInputMarkerPosition=l,this.storyManager.continue(),this.storyManager.reprocessingAfterUserInput=!1,this.storyManager.userInputMarkerPosition=null}catch(l){K.error("Failed to set user input variable",l),i.style.borderColor="var(--color-important)",i.placeholder="Error - please try again..."}};return r.addEventListener("click",a),i.addEventListener("keypress",o=>{o.key==="Enter"&&a()}),i.addEventListener("input",()=>{i.style.borderColor=""}),e}getStatValue(t){try{return this.storyManager?.story?.variablesState?.[t]??0}catch{return 0}}calculateStatBarMetrics(t,e){let n=t.max-t.min,i=n>0?Math.max(0,Math.min(100,(e-t.min)/n*100)):0,r=t.clamp?Math.max(t.min,Math.min(t.max,e)):e;return{fillPercent:i,displayValue:Math.round(r),displayLeft:Math.round(Math.max(0,r-t.min)),displayRight:Math.round(Math.max(0,t.max-r))}}renderSimpleStatBar(t,e){let n=document.createElement("div");n.className="stat-bar-container";let i=t.leftLabel||t.variableName.charAt(0).toUpperCase()+t.variableName.slice(1);return n.innerHTML=`
    <div class="stat-bar-header" aria-hidden="true">
      <span class="stat-bar-label">${i}</span>
      <span class="stat-bar-value">
        <span class="stat-bar-current">${e.displayValue}</span>/${t.max}
      </span>
    </div>
    <div class="stat-bar-track" role="progressbar"
       aria-valuenow="${e.displayValue}"
       aria-valuemin="${t.min}"
       aria-valuemax="${t.max}"
       aria-valuetext="${i}: ${e.displayValue} out of ${t.max}">
        <div class="stat-bar-fill" style="width: ${e.fillPercent}%"></div>
    </div>
  `,n}renderOpposedStatBar(t,e){let n=document.createElement("div");return n.className="stat-bar-container stat-bar-opposed",n.innerHTML=`
    <div class="stat-bar-labels" aria-hidden="true">
      <span class="stat-bar-label stat-bar-label-left">${t.leftLabel||t.variableName}</span>
      <span class="stat-bar-value">
        <span class="stat-bar-current">${e.displayLeft}</span>/
        <span class="stat-bar-current">${e.displayRight}</span>
      </span>
      <span class="stat-bar-label stat-bar-label-right">${t.rightLabel||""}</span>
    </div>
    <div class="stat-bar-track" role="progressbar"
       aria-valuenow="${e.displayValue}"
       aria-valuemin="${t.min}"
       aria-valuemax="${t.max}"
       aria-valuetext="${t.leftLabel||t.variableName}: ${e.displayLeft} versus ${t.rightLabel||""}: ${e.displayRight}">
        <div class="stat-bar-fill" style="width: ${e.fillPercent}%"></div>
    </div>
  `,n}positionFocusMarker(t,e=null){!this.focusMarkerElement||!t?.parentNode||(t.parentNode.insertBefore(this.focusMarkerElement,t),this.focusMarkerIndex=e)}positionFocusMarkerAtIndex(t){if(!this.container)return;let e=this.container.querySelectorAll(s.CONTENT_SELECTOR),n=e[t];if(n)this.positionFocusMarker(n,t);else if(e.length>0){let i=e[e.length-1];this.positionFocusMarker(i,e.length-1)}}positionFocusMarkerAtNewContent(t){if(!this.container)return;let e=this.container.querySelectorAll(s.CONTENT_SELECTOR);if(t<e.length){let n=e[t];this.positionFocusMarker(n,t)}}setMaxHistory(t){this.maxHistory=typeof t=="number"&&t>0?t:null}focusMarker(t="Next"){if(!this.focusMarkerElement)return;this.focusMarkerElement.textContent=t;let e=window.matchMedia("(prefers-reduced-motion: reduce)").matches;this.focusMarkerElement.focus(),this.focusMarkerElement.scrollIntoView({behavior:e?"auto":"smooth",block:"start"})}resetFocusMarker(){this.focusMarkerElement?.parentNode&&this.focusMarkerElement.parentNode.removeChild(this.focusMarkerElement),this.focusMarkerElement.textContent="",this.focusMarkerIndex=null}truncateFromFocusMarker(){if(!this.focusMarkerElement?.parentNode)return null;let t=null,e=this.container.querySelector(".user-input-inline-container");if(e){let r=this.container.querySelectorAll(s.CONTENT_SELECTOR);t=0;for(let a of r){if(a===e)break;t++}}let n=0,i=this.focusMarkerElement.nextSibling;for(;i;)i.nodeType===Node.ELEMENT_NODE&&n++,i=i.nextSibling;for(;this.focusMarkerElement.nextSibling;)this.focusMarkerElement.nextSibling.remove();return n>0&&this.history.length>=n&&(this.history.length=this.history.length-n),this.resetFocusMarker(),t}getContentElementCount(){return this.container?this.container.querySelectorAll(s.CONTENT_SELECTOR).length:0}shouldAnimateContent(){return this.settings?.getSetting("animations")!==!1}fadeInElement(t){if(t)try{t.style.opacity="0",t.offsetHeight,t.style.opacity="1"}catch{t.style.opacity="1"}}clear(){if(!this.domHelpers){K.error("Cannot clear \u2014 DOM helpers not available");return}this.domHelpers.clearStoryContent(),this.history=[],this.resetFocusMarker()}removeChoices(){this.domHelpers?.removeAll?.(".choices-container")}clearContent(){if(!this.domHelpers){K.error("Cannot clear content - DOM helpers not available");return}this.domHelpers.clearStoryContent()}scrollToTop(){if(!this.scrollContainer){K.warning("Cannot scroll - scroll container not available");return}if(!this.domHelpers){K.error("Cannot scroll - DOM helpers not available");return}this.domHelpers.scrollToTop(this.scrollContainer)}hideHeader(){this.domHelpers?.setVisible?.(".header",!1)}showHeader(){this.domHelpers?.setVisible?.(".header",!0)}reset(){this.clear(),this.showHeader()}getState(){return{history:[...this.history],focusMarkerIndex:this.focusMarkerIndex}}restoreState(t){if(!t||typeof t!="object"){K.warning("Invalid state passed to restoreState");return}this.clearContent(),this.resetFocusMarker();let e=Array.isArray(t.history)?t.history:[];this.history=[],e.length>0&&this.render(e);let n=t.focusMarkerIndex;n!=null?this.positionFocusMarkerAtIndex(n):e.length>0&&this.positionFocusMarkerAtIndex(e.length-1)}trackInHistory(t){if(!t||typeof t!="object"){K.warning("Invalid item passed to trackInHistory");return}if(this.history.push({...t,timestamp:Date.now()}),this.maxHistory&&this.history.length>this.maxHistory){let e=this.history.length-this.maxHistory;this.history.splice(0,e)}}getHistoryLength(){return this.history.length}hasContent(){return this.history.length>0}recover(){this.container||(this.container=document.querySelector("#story")),this.scrollContainer||(this.scrollContainer=document.querySelector(".outerContainer")),!this.domHelpers&&this.container&&(this.domHelpers=new Dt(this.container)),Array.isArray(this.history)||(this.history=[])}isReady(){return!!(this.container&&this.domHelpers)}getStats(){return{historyLength:this.history.length,hasContainer:!!this.container,hasScrollContainer:!!this.scrollContainer,hasDomHelpers:!!this.domHelpers,containerElementCount:this.container?this.container.children.length:0}}};var dt=C.forSource(w.CONTENT_PROCESSOR),Jt=class{constructor(t){t||dt.warning("ContentProcessor created without tagProcessor"),this.tagProcessor=t,this.storyManager=null}process(t,e){if(y&&Array.isArray(e)){let n=this.checkContentTypeTags(e,t);if(n)return n}return this.createParagraph(t,e)}createParagraph(t,e){if(Array.isArray(e)||(dt.warning("Invalid tags array provided to createParagraph"),e=[]),!this.tagProcessor?.processLineTags)return dt.error("TagProcessor not available in ContentProcessor"),{type:"paragraph",text:t,classes:[],tags:e,hasSpecialAction:!1,action:null};let{customClasses:n,specialActions:i}=this.tagProcessor.processLineTags(e),r=this.findSpecialAction(i);return{type:"paragraph",text:t,classes:n||[],tags:e,hasSpecialAction:!!r,action:r?.()}}checkContentTypeTags(t,e){for(let n of t){if(typeof n!="string")continue;let{tagDef:i,tagValue:r,invalid:a}=Q.parseTag(n);if(!a)switch(i){case y.STATBAR:return this.handleStatBarContent(t,e);case y.USER_INPUT:return this.handleUserInputContent(r);case y.IMAGE:return this.handleImageContent(r,e,t)}}return null}handleImageContent(t,e,n){let i=this.parseImageTag(t);return e?.trim()?[{type:"image",...i},this.createParagraph(e,n)]:{type:"image",...i}}handleStatBarContent(t,e){let r=t.map(a=>Q.parseTag(a)).filter(({tagDef:a,invalid:o})=>a===y.STATBAR&&!o).map(({tagValue:a})=>({type:"statbar",...this.parseStatBarTag(a)}));return e?.trim()?[...r,this.createParagraph(e,t)]:r.length===1?r[0]:r}handleUserInputContent(t){let e=this.parseUserInputTag(t),n=this.storyManager?.story?.variablesState?.[e.variableName];return n&&n!==""&&this.storyManager?.reprocessingAfterUserInput?null:{type:"user-input",...e}}parseImageTag(t){let e=t.trim(),n=null,i=e,r=e.match(/"([^"]*)"/);r&&(n=r[1],i=e.replace(/"([^"]*)"/,"").trim());let a=i.split(/\s+/).filter(m=>m),o=a[0]||null,l=null,c=null,u=!1;for(let m=1;m<a.length;m++){let g=a[m].toLowerCase();["left","right","center"].includes(g)?l=g:g==="caption"?u=!0:g.match(/^\d+(%|px|em|rem|vw)$/)&&(c=g)}return{src:o,alignment:l,width:c,altText:n,showCaption:u}}parseStatBarTag(t){let e=t.trim(),n=[],i=/"([^"]*)"/g,r;for(;(r=i.exec(e))!==null;)n.push(r[1]);let o=e.replace(/"[^"]*"/g,"").trim().split(/\s+/).filter(O=>O),l=o.some(O=>O.toLowerCase()==="clamp"),c=o[0]||null,u=0,m=100,g=o.slice(1).map(O=>({value:parseFloat(O),original:O})).filter(O=>!isNaN(O.value));g.length===2?(u=g[0].value,m=g[1].value):g.length===1?dt.warning(`STATBAR "${c}" has only one number - provide both min and max (e.g., "0 100")`):g.length>2&&dt.warning(`STATBAR "${c}" has too many numbers - provide only min and max (e.g., "0 100")`),g.length===2&&u>=m&&dt.warning(`STATBAR "${c}" has min (${u}) >= max (${m}) - bar will not display correctly`);let S=null,B=null,R=!1;n.length===1?S=n[0]:n.length>=2&&(S=n[0],B=n[1],R=!0),n.length>2&&dt.warning(`STATBAR "${c}" has ${n.length} labels - only first two are used`);let J=["clamp"];for(let O=1;O<o.length;O++){let st=o[O].toLowerCase(),$=!isNaN(parseFloat(o[O])),mt=J.includes(st);if(!$&&!mt){dt.warning(`STATBAR "${c}" has unquoted text "${o[O]}" - use quotes for labels (e.g., "Label")`);break}}return{variableName:c,min:u,max:m,leftLabel:S,rightLabel:B,isOpposed:R,clamp:l}}parseUserInputTag(t){let e=t.trim(),n="",i=e,r=e.match(/"([^"]*)"/);return r&&(n=r[1],i=e.replace(/"([^"]*)"/,"").trim()),{variableName:i.split(/\s+/).filter(l=>l)[0],placeholder:n}}findSpecialAction(t){return!Array.isArray(t)||t.length===0?null:t.find(e=>{if(typeof e!="function")return dt.warning("Non-function found in specialActions array"),!1;try{let n=e();return n==="RESTART"||n==="CLEAR"||n==="AUTOCLEAR_ON"||n==="AUTOCLEAR_OFF"||typeof n=="object"&&n!==null}catch(n){return dt.error("Error executing special action function",n),!1}})}isReady(){return!!this.tagProcessor?.processLineTags}getStats(){return{hasTagProcessor:!!this.tagProcessor,processorType:this.tagProcessor?.constructor?.name||"unknown",timestamp:new Date().toISOString()}}};var U=C.forSource(w.TAG_PROCESSOR),zt=class{constructor(t=null){this.settings=t,this.storyContainer=document.querySelector("#story"),this.outerScrollContainer=document.querySelector(".outerContainer"),this.audio=null,this.audioLoop=null,this.lastAudioLoopSrc=null,this.tagHandlers=new Map([[y.AUDIO,(e,n)=>{n.specialActions?.push(()=>this.playAudio(e))}],[y.AUDIOLOOP,(e,n)=>{n.specialActions?.push(()=>this.playAudioLoop(e))}],[y.BACKGROUND,(e,n)=>{n.specialActions?.push(()=>this.setBackground(e))}],[y.NOTIFICATION,(e,n)=>{n.specialActions?.push(()=>this.showNotification(e,"info"))}],[y.ACHIEVEMENT,(e,n)=>{n.specialActions?.push(()=>this.showNotification(e,"success",6e3))}],[y.WARNING,(e,n)=>{n.specialActions?.push(()=>this.showNotification(e,"warning"))}],[y.ERROR,(e,n)=>{n.specialActions?.push(()=>this.showNotification(e,"error"))}],[y.CLASS,(e,n)=>{e&&n.customClasses.push(e)}],[y.AUTOCLEAR,(e,n)=>{let i=e.toLowerCase();i==="on"?n.specialActions?.push(()=>"AUTOCLEAR_ON"):i==="off"?n.specialActions?.push(()=>"AUTOCLEAR_OFF"):U.warning(`Invalid AUTOCLEAR value: "${e}". Use "on" or "off".`)}]]),this.simpleTagHandlers=new Map([[y.CLEAR,e=>{e.specialActions?.push(()=>"CLEAR")}],[y.RESTART,e=>{e.specialActions?.push(()=>"RESTART")}],[y.UNCLICKABLE,e=>{e.isClickable=!1}]])}processLineTags(t){try{if(!Array.isArray(t))return U.warning("Invalid tags array passed to processLineTags"),{customClasses:[],specialActions:[]};let e={customClasses:[],specialActions:[]};return this._processTags(t,e,"line",!1),e}catch(e){return U.error("Failed to process line tags",e),{customClasses:[],specialActions:[]}}}processChoiceTags(t){try{if(!Array.isArray(t))return U.warning("Invalid choiceTags array passed to processChoiceTags"),{customClasses:[],isClickable:!0};let e={customClasses:[],isClickable:!0};return this._processTags(t,e,"choice",!0),e}catch(e){return U.error("Failed to process choice tags",e),{customClasses:[],isClickable:!0}}}_processTags(t,e,n,i){for(let r of t){let{tagDef:a,tagValue:o,invalid:l,error:c}=Q.parseTag(r);if(l){c&&U.warning(c);continue}let u=this.tagHandlers.get(a);if(u){u(o,e);continue}let m=this.simpleTagHandlers.get(a);if(m){m(e);continue}if(a!==null||!r||typeof r!="string")continue;let g=r.includes(":"),S=g?r.split(":")[0].trim():r.trim();if(S){if(i&&!g&&Q.isRegisteredToneTag(S)){e.customClasses.push(S.toLowerCase());continue}this.warnUnknownTag(S,n,r)}}}playAudio(t){try{if(this.settings&&!this.settings.getSetting("audioEnabled"))return;if(!t||typeof t!="string"){U.warning("Invalid audio source provided");return}this.audio&&(this.audio.pause(),this.audio.removeAttribute("src"),this.audio.load()),this.audio=new Audio(t),this.audio.play().catch(e=>{U.warning(`Failed to play audio: ${t}`,e)})}catch(e){U.error("Failed to play audio",e)}}playAudioLoop(t){try{if(!t||typeof t!="string"){U.warning("Invalid audio loop source provided");return}if(t.toLowerCase()==="none"||t==="stop"){this.lastAudioLoopSrc=null,this.audioLoop&&(this.audioLoop.pause(),this.audioLoop.removeAttribute("src"),this.audioLoop.load(),this.audioLoop=null);return}if(this.lastAudioLoopSrc=t,this.settings&&!this.settings.getSetting("audioEnabled"))return;this.audioLoop&&(this.audioLoop.pause(),this.audioLoop.removeAttribute("src"),this.audioLoop.load(),this.audioLoop=null),this.audioLoop=new Audio(t),this.audioLoop.loop=!0,this.audioLoop.play().catch(e=>{U.warning(`Failed to play audio loop: ${t}`,e)})}catch(e){U.error("Failed to play audio loop",e)}}stopAllAudio(){try{this.audio&&(this.audio.pause(),this.audio.removeAttribute("src"),this.audio.load(),this.audio=null),this.audioLoop&&(this.audioLoop.pause(),this.audioLoop.removeAttribute("src"),this.audioLoop.load(),this.audioLoop=null)}catch(t){U.warning("Failed to stop audio",t)}}resumeAudioLoop(){try{this.lastAudioLoopSrc&&this.settings?.getSetting("audioEnabled")&&this.playAudioLoop(this.lastAudioLoopSrc)}catch(t){U.warning("Failed to resume audio loop",t)}}setBackground(t){try{if(!this.outerScrollContainer){U.warning("Outer scroll container not available for background");return}if(!t||typeof t!="string"){U.warning("Invalid background source provided");return}t.toLowerCase()==="none"||t===""?this.outerScrollContainer.style.backgroundImage="none":this.outerScrollContainer.style.backgroundImage="url("+t+")"}catch(e){U.error("Failed to set background",e)}}showNotification(t,e="info",n=4e3){ht&&ht.show(t,{type:e,duration:n})}warnUnknownTag(t,e,n=""){if(this.warnedTags=this.warnedTags||new Set,this.warnedTags.has(t.toUpperCase()))return;this.warnedTags.add(t.toUpperCase());let i=this.getSimilarTags(t),r="";i.length>0?r=` Did you mean: ${i.join(", ")}?`:e==="line"?r=" Use # CLASS: for custom CSS classes.":e==="choice"&&(r=" For tone indicators, define with # TONE: tagname icon first."),U.warning(`Unknown tag "${t}" on ${e}: "# ${n}".${r}`)}getSimilarTags(t){if(!y)return[];let e=t.toUpperCase();return Object.keys(y).filter(i=>e.length>=3&&i.startsWith(e.slice(0,3))||i.length>=3&&e.startsWith(i.slice(0,3))?!0:q.levenshteinDistance(e,i)<=2).slice(0,3)}isReady(){try{return!!(this.storyContainer||this.outerScrollContainer)}catch(t){return U.warning("Failed to check readiness",t),!1}}getStats(){try{return{hasStoryContainer:!!this.storyContainer,hasOuterScrollContainer:!!this.outerScrollContainer,hasActiveAudio:!!this.audio,hasActiveAudioLoop:!!this.audioLoop}}catch(t){return U.warning("Failed to get stats",t),{}}}cleanup(){try{this.audio&&(this.audio.pause(),this.audio=null),this.audioLoop&&(this.audioLoop.pause(),this.audioLoop=null)}catch(t){U.warning("Failed to cleanup",t)}}};var Yt=C.forSource(w.SETTINGS_MANAGER),Qt=class{constructor(){this.settings=this.getDefaults(),this.storyManager=null,this.keyboardShortcuts=null,this.settingsModal=null,this.storyTitle="Untitled",this.storyAuthor=null,this.maxHistory=null,this.toneIndicatorsAvailable=!1,this.authorToneIndicators=!0,this.toneIndicatorsTrailing=!1,this.authorChoiceNumbering="auto",this.init()}init(){this.loadSettings(),this.setupThemeDetection(),this.applySettings()}showSettings(){this.settingsModal?.show?.()}getDefaults(){return{theme:"auto",textSize:"medium",lineHeight:"normal",fontFamily:"serif",audioEnabled:!0,autoSave:!0,animations:!0,toneIndicators:this.authorToneIndicators||!1,choiceNumbering:this.authorChoiceNumbering||"auto",keyboardShortcuts:!0}}setupThemeDetection(){window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{this.settings.theme==="auto"&&this.applyTheme()})}getSetting(t){return this.settings[t]}setSetting(t,e){t in this.settings&&(this.settings[t]=e,this.storeSettings(),this.applySettings())}resetToDefaults(){this.settings=this.getDefaults(),this.applySettings()}toggleTheme(){let t=document.body?.classList.contains("dark");this.settings.theme==="auto"?this.settings.theme=t?"light":"dark":this.settings.theme==="light"?this.settings.theme="dark":this.settings.theme="light",this.storeSettings(),this.applyTheme()}loadSettings(){try{let t=this.getStoredSettings();t&&(this.settings={...this.settings,...t})}catch(t){Yt.warning("Failed to load settings",t)}}storeSettings(){try{localStorage.setItem("ink-template-settings",JSON.stringify(this.settings))}catch(t){Yt.error("Failed to store settings",t)}}getStoredSettings(){try{let t=localStorage.getItem("ink-template-settings");return t?JSON.parse(t):null}catch{return null}}applySettings(){this.applyTheme(),this.applyFontFamily(),this.applyTextSize(),this.applyLineHeight(),this.applyAnimations(),this.applyChoiceNumbering(),this.applyKeyboardShortcuts()}applyIndividualSetting(t){switch(t){case"theme":this.applyTheme();break;case"fontFamily":this.applyFontFamily();break;case"textSize":this.applyTextSize();break;case"lineHeight":this.applyLineHeight();break;case"toneIndicators":this.refreshChoices();break;case"choiceNumbering":this.applyChoiceNumbering();break;case"keyboardShortcuts":this.applyKeyboardShortcuts();break}}applyTheme(){let t=document.body,e=document.documentElement;t&&(t.classList.remove("dark"),e.classList.remove("dark"),(this.settings.theme==="dark"||this.settings.theme==="auto"&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&(t.classList.add("dark"),e.classList.add("dark")),t.classList.add("switched"))}applyFontFamily(){let t=document.documentElement;if(!t)return;let e={serif:"var(--font-serif)",sans:"var(--font-sans)",mono:"var(--font-monospace)",dyslexic:"var(--font-dyslexic)"};t.style.setProperty("--font-main",e[this.settings.fontFamily]||e.serif)}applyTextSize(){let t=document.documentElement;if(!t)return;let e={small:"11pt",medium:"13pt",large:"15pt",xl:"17pt"};t.style.setProperty("--text-size-base",e[this.settings.textSize]||e.medium)}applyLineHeight(){let t=document.documentElement;if(!t)return;let e={tight:"1.4em",normal:"1.7em",loose:"2.0em"},n=e[this.settings.lineHeight]||e.normal;t.style.setProperty("--line-height-text",n),t.style.setProperty("--line-height-choice",n)}applyAnimations(){let t=document.documentElement;t&&(this.settings.animations?(t.style.setProperty("--transition-fast","0.1s"),t.style.setProperty("--transition-medium","0.2s"),t.style.setProperty("--transition-slow","0.6s"),t.style.setProperty("--transition-very-slow","1s")):(t.style.setProperty("--transition-fast","0s"),t.style.setProperty("--transition-medium","0s"),t.style.setProperty("--transition-slow","0s"),t.style.setProperty("--transition-very-slow","0s")))}applyChoiceNumbering(){document.body?.classList.remove("choice-numbers-on","choice-numbers-off","choice-numbers-auto"),document.body?.classList.add(`choice-numbers-${this.settings.choiceNumbering||"auto"}`)}applyKeyboardShortcuts(){this.settings.keyboardShortcuts?this.keyboardShortcuts?.enable?.():this.keyboardShortcuts?.disable?.(),this.settingsModal?.updateKeyboardHelpButtonVisibility?.()}processGlobalTags(t){if(!Array.isArray(t)||!y||!Q.getTagDef)return;for(let n of t){if(typeof n!="string")continue;let{tagDef:i,tagValue:r,invalid:a}=Q.parseTag(n);if(!a)switch(i){case y.THEME:this.getStoredSettings()?.theme||(this.settings.theme=r==="dark"?"dark":"light");break;case y.TITLE:this.storyTitle=r,document.querySelectorAll(".title").forEach(S=>S.textContent=r);break;case y.AUTHOR:this.storyAuthor=r;let c=document.querySelector(".byline");c&&(c.textContent=`by ${r}`);break;case y.MAX_HISTORY:let u=parseInt(r,10);!isNaN(u)&&u>0?this.maxHistory=u:Yt.warning(`Invalid MAX_HISTORY value: ${r}`);break;case y.CHOICE_NUMBERS:{let S=r.toLowerCase();S==="off"?this.authorChoiceNumbering="off":S==="on"?this.authorChoiceNumbering="on":this.authorChoiceNumbering="auto",this.getStoredSettings()?.choiceNumbering||(this.settings.choiceNumbering=this.authorChoiceNumbering),this.applyChoiceNumbering();break}case y.TONE_INDICATORS:let m=r.toLowerCase();this.toneIndicatorsAvailable=!0,this.authorToneIndicators=m!=="off"||!1,this.settings.toneIndicators=m!=="off";break;case y.TONE_TRAILING:this.toneIndicatorsTrailing=!0;break;case y.TONE:let g=r.indexOf(" ");if(g!==-1){let S=r.substring(0,g).trim(),B=r.substring(g+1).trim();Q.registerTone(S,B),this.toneIndicatorsAvailable=!0}break}}let e=this.storyTitle;this.storyAuthor&&(e+=`, by ${this.storyAuthor}`),e+=" - Interactive Fiction",document.title=e}handleAudioSettingChange(t,e){try{let n=this.storyManager?.contentProcessor?.tagProcessor;if(!n)return;t&&!e?n.stopAllAudio():!t&&e&&n.resumeAudioLoop()}catch(n){Yt.warning("Failed to handle audio setting change",n)}}refreshChoices(){this.storyManager?.display?.domHelpers&&this.storyManager?.story?.currentChoices?.length>0&&(this.storyManager.display.domHelpers.removeAll(".choice"),this.storyManager.createChoices())}isAnimationEnabled(){return this.settings.animations}getToneIndicators(t){if(!this.toneIndicatorsAvailable||!this.settings.toneIndicators)return[];let e=[];for(let n of t){if(typeof n!="string")continue;let i=n.trim().toLowerCase(),r=Q.getToneIcon(i);r&&e.push({label:i,icon:r})}return e}isReady(){return!!document.documentElement}getStats(){return{currentTheme:this.settings.theme,settingsCount:Object.keys(this.settings).length}}};var Ie=C.forSource(w.SETTINGS_MANAGER),Xt=class{constructor(t){if(!t)throw new Error("SettingsModal requires a SettingsManager instance");this.settingsManager=t,this.modal=null,this.keyboardHelpModal=null,this.init()}init(){this.createModal(),this.setupEventListeners()}createModal(){this.modal=new it({title:"Settings",className:"settings-modal",maxWidth:"500px",onShow:()=>this.populateSettings(),onHide:()=>this.saveSettings()})}setupEventListeners(){let t=document.getElementById("settings-btn");t&&t.addEventListener("click",e=>{e.preventDefault(),this.show()})}show(){if(!this.modal?.isReady()){Ie.error("Cannot show settings - modal not available");return}this.modal.show(t=>{t.setContent(this.getSettingsHTML());let e=t.getFooter();if(e){e.innerHTML="",e.className="modal-footer modal-footer-split";let i=t.createButton("Reset to Defaults",{variant:"secondary",onClick:()=>this.resetSettings()}),r=t.createButton("Done",{variant:"primary",onClick:()=>this.hide()});e.appendChild(i),e.appendChild(r)}this.setupTabSwitching(),this.setupRealtimePreview(),this.updateKeyboardHelpButtonVisibility();let n=this.modal.modalElement.querySelector(".keyboard-help-btn");n&&n.addEventListener("click",()=>{this.hide(),this.keyboardHelpModal?.show?.()})})}hide(){this.modal?.hide()}isReady(){return!!this.modal?.isReady()}resetSettings(){this.settingsManager.resetToDefaults(),this.populateSettings(),this.modal.showNotification("Settings reset to defaults")}saveSettings(){if(!this.modal?.modalElement)return;let t=(i,r=!1)=>{let a=this.modal.modalElement.querySelector(`[name="${i}"]`);return a?r?a.checked:a.value:null},e=this.settingsManager.settings.audioEnabled,n=this.settingsManager.settings;n.theme=t("theme")||n.theme,n.fontFamily=t("fontFamily")||n.fontFamily,n.textSize=t("textSize")||n.textSize,n.lineHeight=t("lineHeight")||n.lineHeight,n.audioEnabled=t("audioEnabled",!0)??n.audioEnabled,n.autoSave=t("autoSave",!0)??n.autoSave,n.animations=t("animations",!0)??n.animations,n.choiceNumbering=t("choiceNumbering")||n.choiceNumbering,n.toneIndicators=t("toneIndicators",!0)??n.toneIndicators,n.keyboardShortcuts=t("keyboardShortcuts",!0)??n.keyboardShortcuts,this.settingsManager.handleAudioSettingChange(e,n.audioEnabled),this.settingsManager.storeSettings(),this.settingsManager.applySettings(),this.modal.showNotification("Settings saved successfully!")}populateSettings(){if(!this.modal?.modalElement)return;let t=this.settingsManager.settings;[{name:"theme",value:t.theme},{name:"fontFamily",value:t.fontFamily},{name:"textSize",value:t.textSize},{name:"lineHeight",value:t.lineHeight},{name:"audioEnabled",checked:t.audioEnabled},{name:"autoSave",checked:t.autoSave},{name:"animations",checked:t.animations},{name:"choiceNumbering",value:t.choiceNumbering},{name:"toneIndicators",checked:t.toneIndicators},{name:"keyboardShortcuts",checked:t.keyboardShortcuts}].forEach(({name:n,value:i,checked:r})=>{let a=this.modal.modalElement.querySelector(`[name="${n}"]`);a&&(typeof r<"u"?a.checked=r:a.value=i)})}setupRealtimePreview(){if(!this.modal?.modalElement)return;let t={theme:this.modal.modalElement.querySelector('select[name="theme"]'),fontFamily:this.modal.modalElement.querySelector('select[name="fontFamily"]'),textSize:this.modal.modalElement.querySelector('select[name="textSize"]'),lineHeight:this.modal.modalElement.querySelector('select[name="lineHeight"]'),toneIndicators:this.modal.modalElement.querySelector('input[name="toneIndicators"]'),choiceNumbering:this.modal.modalElement.querySelector('select[name="choiceNumbering"]'),keyboardShortcuts:this.modal.modalElement.querySelector('input[name="keyboardShortcuts"]')};Object.entries(t).forEach(([e,n])=>{n&&n.addEventListener("change",()=>{n.type==="checkbox"?this.settingsManager.settings[e]=n.checked:this.settingsManager.settings[e]=n.value,this.settingsManager.applyIndividualSetting(e)})})}setupTabSwitching(){if(!this.modal?.modalElement)return;let t=this.modal.modalElement.querySelectorAll(".settings-tab");t.forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab)),e.addEventListener("keydown",n=>this.handleTabKeydown(n,t))})}switchTab(t){if(!this.modal?.modalElement)return;this.modal.modalElement.querySelectorAll(".settings-tab").forEach(i=>{let r=i.dataset.tab===t;i.classList.toggle("active",r),i.setAttribute("aria-selected",r),i.setAttribute("tabindex",r?"0":"-1")}),this.modal.modalElement.querySelectorAll(".settings-panel").forEach(i=>{i.classList.toggle("active",i.id===`panel-${t}`)})}handleTabKeydown(t,e){let n=Array.from(e),i=n.findIndex(a=>a===t.target),r;switch(t.key){case"ArrowRight":r=(i+1)%n.length;break;case"ArrowLeft":r=(i-1+n.length)%n.length;break;case"Home":r=0;break;case"End":r=n.length-1;break;default:return}t.preventDefault(),n[r].focus(),this.switchTab(n[r].dataset.tab)}updateKeyboardHelpButtonVisibility(){if(!this.modal?.modalElement)return;let t=this.modal.modalElement.querySelector(".keyboard-help-btn");if(t){let e=this.keyboardHelpModal?.isAvailable()&&this.settingsManager.settings.keyboardShortcuts;t.style.display=e?"":"none"}}getSettingsHTML(){return`
      ${this.renderSettingsTabs()}
      <div class="settings-panels">
        ${this.renderReadingPanel()}
        ${this.renderAccessibilityPanel()}
        ${this.renderAudioPanel()}
      </div>
    `}renderSettingsTabs(){return`
    <div role="tablist" class="settings-tabs" aria-label="Settings categories">
      ${this.renderSettingsTab("reading","menu_book","Reading",!0)}
      ${this.renderSettingsTab("accessibility","accessibility","Accessibility")}
      ${Lt.hasAudio?this.renderSettingsTab("audio","volume_up","Audio"):""}
    </div>
    `}renderSettingsTab(t,e,n,i=!1){return`
      <button role="tab" class="settings-tab ${i?"active":""}" 
              id="tab-${t}"
              data-tab="${t}" 
              aria-selected="${i}" 
              aria-controls="panel-${t}"
              tabindex="${i?"0":"-1"}">
        <span class="material-icons-outlined" aria-hidden="true">${e}</span>
        <span class="sr-only">${n}</span>
      </button>
    `}renderReadingPanel(){return`
    <div role="tabpanel" class="settings-panel active" id="panel-reading" aria-labelledby="tab-reading">
    ${this.renderDropdownSetting("theme","setting-theme","Theme",[{value:"auto",label:"Auto (System)"},{value:"light",label:"Light"},{value:"dark",label:"Dark"}])}
    ${this.renderDropdownSetting("fontFamily","setting-font","Font Family",[{value:"serif",label:"Serif"},{value:"sans",label:"Sans-serif"},{value:"mono",label:"Monospace"},{value:"dyslexic",label:"OpenDyslexic"}])}
    ${this.renderDropdownSetting("textSize","setting-size","Text Size",[{value:"small",label:"Small"},{value:"medium",label:"Medium"},{value:"large",label:"Large"},{value:"xl",label:"Extra Large"}])}
    ${this.renderDropdownSetting("lineHeight","setting-lineheight","Line Height",[{value:"tight",label:"Tight"},{value:"normal",label:"Normal"},{value:"loose",label:"Loose"}])}
      ${this.renderCheckboxSetting("autoSave","Auto Save Progress")}
    </div>
    `}renderAccessibilityPanel(){return`
    <div role="tabpanel" class="settings-panel" id="panel-accessibility" aria-labelledby="tab-accessibility">
      ${this.renderCheckboxSetting("animations","Enable Animations")}
      ${this.settingsManager.toneIndicatorsAvailable?this.renderCheckboxSetting("toneIndicators","Show tone indicators on choices"):""}
      ${this.renderDropdownSetting("choiceNumbering","setting-choicenumbering","Choice Number Hints",[{value:"auto",label:"Auto (hide on mobile)"},{value:"on",label:"Always Show"},{value:"off",label:"Always Hide"}])}
      ${this.keyboardHelpModal?.isAvailable()?this.renderCheckboxSetting("keyboardShortcuts","Enable Keyboard Shortcuts"):""}
      ${this.keyboardHelpModal?.isAvailable()?this.renderButtonSetting("keyboard-help-btn","Keyboard Shortcuts"):""}
    </div>
    `}renderAudioPanel(){return Lt.hasAudio?`
    <div role="tabpanel" class="settings-panel" id="panel-audio" aria-labelledby="tab-audio">
      ${this.renderCheckboxSetting("audioEnabled","Enable Audio")}
    </div>`:""}renderCheckboxSetting(t,e){return`
      <div class="setting-item">
        <label class="setting-checkbox-label">
          <input type="checkbox" name="${t}" class="setting-checkbox">
          <span>${e}</span>
        </label>
      </div>`}renderDropdownSetting(t,e,n,i){let r=i.map(a=>`<option value="${a.value}">${a.label}</option>`).join(`
          `);return`
      <div class="setting-item">
        <label class="setting-label" for="${e}">${n}</label>
        <select name="${t}" id="${e}" class="setting-select">
          ${r}
        </select>
      </div>`}renderButtonSetting(t,e){return`
      <div class="setting-item">
        <button type="button" class="${t}">${e}</button>
      </div>`}};var rt=C.forSource(w.PAGE_MANAGER),Zt=class{constructor(t){this.storyManager=t,this.tagProcessor=t.TagProcessor,this.savedDisplayState=null,this.savedStoryState=null,this.currentPage=null,this.availablePages={},this.pageMenuOrder=null,this.storyManager||rt.critical("PageManager requires a story manager",new Error("Invalid story manager"))}show(t){if(!t||typeof t!="string"){rt.warning("Invalid knotName passed to show");return}if(!this.isSpecialPage(t)){rt.warning(`Page "${t}" is not marked as a special page`);return}if(this.isViewingSpecialPage()||this.saveCurrentState(),this.currentPage=t,this.storyManager.display){this.storyManager.display.clear();let e=this.generatePageContent(t);e.length>0&&this.storyManager.display.render(e),this.addReturnButton(),this.storyManager.display.scrollToTop()}}returnToStory(){if(this.currentPage)try{if(this.currentPage=null,!this.storyManager.display){rt.error("Display manager not available for return");return}if(this.storyManager.display.clear(),this.savedStoryState)try{this.storyManager.story.state.LoadJson(this.savedStoryState)}catch(t){rt.error("Failed to restore story state",t),this.storyManager.savePoint&&this.storyManager.story.state.LoadJson(this.storyManager.savePoint)}if(this.savedDisplayState)try{this.storyManager.display.restoreState(this.savedDisplayState)}catch(t){rt.error("Failed to restore display state",t),this.regenerateDisplayFromStoryState()}else this.regenerateDisplayFromStoryState();this.storyManager.display.showHeader(),this.storyManager.createChoices?.(),this.storyManager.display.focusMarker("Returning to story"),this.savedDisplayState=null,this.savedStoryState=null}catch(t){rt.error("Failed to return to story",t)}}reset(){this.savedDisplayState=null,this.savedStoryState=null,this.currentPage=null}isViewingSpecialPage(){return this.currentPage!==null}isSpecialPage(t){let e=this.availablePages?.[t];return e&&e.isSpecialPage}pageExists(t){return this.isSpecialPage(t)}getCurrentPageKnotName(){return this.currentPage||null}getCurrentPageDisplayName(){let t=this.getCurrentPageKnotName();return t?this.getPageDisplayName(t):null}getPageDisplayName(t){let e=this.availablePages?.[t];return e&&e.displayName?e.displayName:q.formatKnotName(t)}getAvailablePages(){return{...this.availablePages}}getAvailablePageDisplayNames(){let t=this.getAvailablePages();return Object.keys(t).map(e=>({knotName:e,displayName:t[e].displayName||this.formatKnotName(e)}))}findKnotByDisplayName(t){let e=this.getAvailablePages();for(let[n,i]of Object.entries(e))if(i.displayName===t)return n;return null}getPageInfo(t){let e=this.availablePages?.[t];return e?{knotName:t,displayName:e.displayName||q.formatKnotName(t),isSpecialPage:e.isSpecialPage,content:this.evaluatePageContent(t)}:null}evaluatePageContent(t){if(!this.pageExists(t))return"";try{let e=this.storyManager.createTempStory();e.ChoosePathString(t);let n="",i=!0;for(;e.canContinue;){let r=e.Continue(),a=e.currentTags||[];if(i&&this.containsOnlySpecialPageTag(r,a)){i=!1;continue}i=!1,n+=r}return n.trim()}catch(e){return rt.error("Failed to evaluate page content",e),""}}saveCurrentState(){this.storyManager.display&&(this.savedDisplayState=this.storyManager.display.getState()),this.savedStoryState=this.storyManager.savePoint||this.storyManager.story.state.ToJson()}regenerateDisplayFromStoryState(){let t=this.storyManager.story?.state?.currentText;if(t?.trim()){let e=It.process(t);this.storyManager.display.render([{text:e,classes:[]}])}}generatePageContent(t){try{let e=this.createPageStory(t);return this.extractPageContent(e)}catch(e){return rt.error("Failed to generate page content",e),[]}}createPageStory(t){let e=this.storyManager.createTempStory(),n=this.storyManager.story.state.ToJson();return e.state.LoadJson(n),e.ChoosePathString(t),e}extractPageContent(t){let e=[],n=!0;for(;t.canContinue;){let i=t.Continue(),r=t.currentTags||[],a=this.processPageLine(i,r,n);n=!1,a&&e.push(...a)}return e}processPageLine(t,e,n){if(n&&this.containsOnlySpecialPageTag(t,e))return null;let i=e.some(o=>typeof o=="string"&&o.trim());if(!t?.trim()&&!i)return null;let r=this.storyManager.contentProcessor.process(t,e);return(Array.isArray(r)?r:[r]).map(o=>(o&&(o.type==="paragraph"||!o.type)&&(o.classes=["special-page",...o.classes||[]]),o)).filter(Boolean)}containsOnlySpecialPageTag(t,e){return t&&t.trim().length>0?!1:Q.hasSpecialPageTag(e)}addReturnButton(){if(!this.storyManager.choices||!this.storyManager.display){rt.error("Required managers not available for return button");return}try{let t=this.storyManager.choices.createReturnChoice(()=>{this.returnToStory()});this.storyManager.display.renderChoices([t],!1)}catch(t){rt.error("Failed to add return button",t)}}detectSpecialPages(){this.availablePages={};try{let t=this.storyManager.story.mainContentContainer.namedContent;for(let e of t.keys())try{let n=this.getSpecialPageInfo(e);n&&(this.availablePages[e]={displayName:n.displayName,knotName:e,isSpecialPage:!0})}catch(n){rt.warning(`Failed to check if ${e} is special page`,n)}}catch(t){rt.error("Failed to detect special pages",t)}}getSpecialPageInfo(t){if(!y||!Q.getTagDef)return null;try{let e=this.storyManager.createTempStory();if(e.ChoosePathString(t),e.canContinue){e.Continue();let n=e.currentTags||[];for(let i of n){if(typeof i!="string")continue;let{tagDef:r,tagValue:a}=Q.parseTag(i);if(r===y.SPECIAL_PAGE)return{displayName:a?.trim()||q.formatKnotName(t),isSpecialPage:!0}}}return null}catch{return null}}processMenuOrderTag(t){if(Array.isArray(t))for(let e of t){if(typeof e!="string")continue;let n=e.indexOf(":");if(n===-1)continue;let i=e.substring(0,n).trim().toUpperCase(),r=e.substring(n+1).trim();if(Q.getTagDef(i)===y.PAGE_MENU){this.pageMenuOrder=this.parseMenuOrder(r);break}}}parseMenuOrder(t){let e=t.split(",,").map(i=>i.trim()),n=[];return e.forEach((i,r)=>{i.split(",").map(o=>o.trim()).filter(o=>o).forEach(o=>{this.availablePages[o]?n.push({knotName:o,section:r}):console.warn(`Page '${o}' in PAGE_MENU not found in special pages`)})}),n.length>0?n:null}isReady(){return!!(this.storyManager?.story&&this.storyManager?.display)}getStats(){let t=this.getAvailablePages(),e=this.getCurrentPageKnotName(),n=this.getCurrentPageDisplayName();return{hasStoryManager:!!this.storyManager,hasTagProcessor:!!this.tagProcessor,currentPageKnotName:e,currentPageDisplayName:n,isViewingSpecialPage:this.isViewingSpecialPage(),availablePageCount:Object.keys(t).length,hasSavedState:!!(this.savedDisplayState||this.savedStoryState),pageDisplayNames:this.getAvailablePageDisplayNames()}}validatePages(){let t={valid:[],invalid:[],errors:[]},e=this.getAvailablePages();for(let[n,i]of Object.entries(e))try{let r=this.evaluatePageContent(n);r.length>0?t.valid.push({knotName:n,displayName:i.displayName,contentLength:r.length}):t.invalid.push({knotName:n,displayName:i.displayName,reason:"No content generated"})}catch(r){t.errors.push({knotName:n,displayName:i.displayName,error:r.message})}return t}};var pt=C.forSource(w.CHOICE_MANAGER),te=class{constructor(t,e){this.storyManager=t,this.tagProcessor=e}generate(t){return Array.isArray(t)?t.map((e,n)=>{try{let{customClasses:i,isClickable:r}=this.tagProcessor?.processChoiceTags?.(e.tags||[])||{customClasses:[],isClickable:!0},a=this.storyManager?.settings?.getToneIndicators?.(e.tags||[])||[];return{text:e.text||"",classes:i,isClickable:r,onClick:()=>this.selectChoice(n),originalIndex:n,tags:e.tags||[],keyHint:this.getKeyHint(n),toneIndicators:a}}catch(i){return pt.error(`Failed to process choice at index ${n}`,i),{text:e.text||"Invalid choice",classes:["error-choice"],isClickable:!1,onClick:()=>{},originalIndex:n,tags:[],toneIndicators:[]}}}):(pt.error("Invalid storyChoices - expected array"),[])}selectChoice(t){if(typeof t!="number"||t<0){pt.error(`Invalid choice index: ${t}`);return}if(!this.storyManager){pt.error("Story manager not available");return}try{this.storyManager.selectChoice(t)}catch(e){pt.error("Failed to select choice",e)}}createSpecialChoice(t,e,n=[]){if(typeof t!="string"||typeof e!="function")return pt.error("Invalid parameters for special choice"),{text:t||"Error",classes:["error-choice"],isClickable:!1,onClick:()=>{},isSpecial:!0};let i=()=>{try{e()}catch(r){pt.error("Special choice click failed",r)}};return{text:t,classes:Array.isArray(n)?n:[],isClickable:!0,onClick:i,isSpecial:!0}}createReturnChoice(t){return typeof t!="function"?(pt.error("onReturn must be a function"),this.createSpecialChoice("\u2190 Return to Story",()=>{},["return-button","error-choice"])):this.createSpecialChoice('<span aria-hidden="true">\u2190</span> Return to Story',t,["return-button"])}processChoiceTags(t){if(!this.tagProcessor?.processChoiceTags)return pt.warning("TagProcessor not available, using default choice behavior"),{customClasses:[],isClickable:!0};try{return this.tagProcessor.processChoiceTags(t||[])}catch(e){return pt.warning("Failed to process choice tags",e),{customClasses:[],isClickable:!0}}}getKeyHint(t){return t<9?String(t+1):String.fromCharCode(97+(t-9))}hasClickableChoices(t){return Array.isArray(t)?t.some(e=>e?.isClickable!==!1):!1}filterChoices(t,e=!1){return Array.isArray(t)?e?t.filter(n=>n?.isClickable!==!1):t:[]}validateChoice(t){return!t||typeof t!="object"?!1:["text","onClick"].every(e=>e in t)}getChoiceStats(t){return Array.isArray(t)?{total:t.length,clickable:t.filter(e=>e?.isClickable!==!1).length,special:t.filter(e=>e?.isSpecial).length,withClasses:t.filter(e=>e?.classes?.length>0).length}:{total:0,clickable:0,special:0,withClasses:0}}};var xt=C.forSource(w.NAVIGATION_MANAGER),ee=class{constructor(t){if(this.storyManager=t,this.dynamicButtons=new Map,this.dropdown=null,this.dropdownButton=null,!this.storyManager){xt.critical("NavigationManager requires a story manager",new Error("Invalid story manager"),"navigation");return}this.setupButtons()}setupButtons(){this.setupCoreButtons(),this.setupClickableTitle()}setupCoreButtons(){this.setupButton("rewind",()=>{this.storyManager.confirmRestart()})}setupClickableTitle(){this.setupButton("title-restart",()=>{this.storyManager.confirmRestart()})}setupButton(t,e){if(!t||typeof e!="function"){xt.warning(`Invalid parameters for button ${t}`,null,"navigation");return}let n=document.getElementById(t);if(!n){xt.warning(`Button not found: ${t}`,null,"navigation");return}try{let i=n.cloneNode(!0);n.parentNode.replaceChild(i,n),i.addEventListener("click",r=>{try{e(r)}catch(a){xt.error(`Button click failed: ${t}`,a,"navigation")}})}catch(i){xt.warning(`Failed to setup button ${t}`,i,"navigation")}}updateVisibility(t,e=null){if(!t||typeof t!="object"){xt.warning("Invalid availablePages object passed to updateVisibility",null,"navigation");return}this.clearDynamicButtons(),this.createSlidePanel(t,e)}refresh(){let t=this.storyManager?.pages?.availablePages||{};this.updateVisibility(t)}reset(){this.setButtonEnabled("rewind",!0),this.setButtonEnabled("saves-btn",!0),this.setButtonEnabled("settings-btn",!0),this.clearDynamicButtons(),this.highlightActivePage(null)}cleanup(){this.clearDynamicButtons()}setButtonEnabled(t,e){let n=document.getElementById(t);n&&(e?(n.removeAttribute("disabled"),n.style.cursor="pointer",n.style.opacity=""):(n.setAttribute("disabled","disabled"),n.style.cursor="not-allowed",n.style.opacity="0.5"))}setButtonVisible(t,e){let n=document.getElementById(t);n&&(n.style.display=e?"inline-block":"none")}setSpecialPageButtonEnabled(t,e){let n=this.findPageButton(t);n&&(e?(n.removeAttribute("disabled"),n.style.cursor="pointer",n.style.opacity=""):(n.setAttribute("disabled","disabled"),n.style.cursor="not-allowed",n.style.opacity="0.5"))}setSpecialPageButtonVisible(t,e){let n=this.findPageButton(t);n&&(n.style.display=e?"inline-block":"none")}highlightActivePage(t){for(let e of this.dynamicButtons.values())e.classList.remove("active","current-page");if(t){let e=this.findPageButton(t);e&&e.classList.add("active","current-page")}}createSlidePanel(t,e){let n=document.querySelector(".nav-controls");if(!n)return;this.menuButton=document.createElement("button"),this.menuButton.type="button",this.menuButton.id="pages-menu-btn",this.menuButton.setAttribute("aria-label","Menu"),this.menuButton.innerHTML='<span class="material-icons-outlined nav-icon" aria-hidden="true">menu</span>',this.slidePanel=document.createElement("nav"),this.slidePanel.className="slide-panel",this.slidePanel.setAttribute("aria-label","Pages"),this.slidePanel.setAttribute("aria-hidden","true");let i=document.createElement("div");i.className="panel-content",e&&e.length>0?this.addOrderedPagesToPanel(i,t,e):this.addDefaultPagesToPanel(i,t),this.slidePanel.appendChild(i);let r=document.createElement("button");r.type="button",r.className="panel-close-bottom",r.setAttribute("aria-label","Close menu"),r.innerHTML='<span class="material-icons-outlined" aria-hidden="true">expand_less</span>',this.menuButton.setAttribute("aria-expanded","false"),this.slidePanel.appendChild(r),document.body.appendChild(this.slidePanel);let a=document.getElementById("settings-btn");n.insertBefore(this.menuButton,a),this.menuButton.addEventListener("click",o=>{o.stopPropagation(),this.togglePanel()}),r.addEventListener("click",()=>{this.hidePanel()}),document.addEventListener("click",o=>{this.slidePanel&&this.slidePanel.classList.contains("show")&&!this.slidePanel.contains(o.target)&&o.target!==this.menuButton&&this.hidePanel()}),this.dynamicButtons.set("pages-menu",this.menuButton)}addOrderedPagesToPanel(t,e,n){let i=-1,r=new Set;n.forEach(o=>{let l=e[o.knotName];if(!l||!l.isSpecialPage)return;if(o.section!==i&&i!==-1){let u=document.createElement("hr");u.className="panel-separator",t.appendChild(u)}i=o.section;let c=this.createPageLink(o.knotName,l);t.appendChild(c),r.add(o.knotName)});let a=Object.keys(e).filter(o=>!r.has(o)&&e[o].isSpecialPage);if(a.length>0&&r.size>0){let o=document.createElement("hr");o.className="panel-separator",t.appendChild(o)}a.forEach(o=>{let l=e[o],c=this.createPageLink(o,l);t.appendChild(c)})}addDefaultPagesToPanel(t,e){Object.keys(e).filter(i=>e[i]?.isSpecialPage).sort((i,r)=>{let a=e[i].displayName.toLowerCase(),o=e[r].displayName.toLowerCase();return a.localeCompare(o)}).forEach(i=>{let r=e[i],a=this.createPageLink(i,r);t.appendChild(a)})}createPageLink(t,e){let n=document.createElement("a");return n.href="#",n.className="panel-link",n.textContent=e.displayName,n.addEventListener("click",i=>{i.preventDefault(),this.hidePanel(!1),this.storyManager.pages.show(t),this.storyManager.display?.container?.focus()}),n}togglePanel(){this.slidePanel&&(this.slidePanel.classList.contains("show")?this.hidePanel():this.showPanel())}showPanel(){if(this.slidePanel){this.slidePanel.classList.add("show"),this.slidePanel.setAttribute("aria-hidden","false"),this.menuButton?.classList.add("active"),this.menuButton?.setAttribute("aria-expanded","true");let t=this.slidePanel.querySelector(".panel-link");t&&t.focus()}}hidePanel(t=!0){this.slidePanel&&(this.slidePanel.classList.remove("show"),this.slidePanel.setAttribute("aria-hidden","true"),this.menuButton?.classList.remove("active"),this.menuButton?.setAttribute("aria-expanded","false"),t&&this.menuButton?.focus())}clearDynamicButtons(){this.slidePanel&&this.slidePanel.parentNode&&this.slidePanel.parentNode.removeChild(this.slidePanel),this.menuButton&&this.menuButton.parentNode&&this.menuButton.parentNode.removeChild(this.menuButton),this.slidePanel=null,this.menuButton=null;for(let t of this.dynamicButtons)t&&t.parentNode&&t.parentNode.removeChild(t);this.dynamicButtons.clear()}getSpecialPageButtons(){let t=[];for(let[e,n]of this.dynamicButtons){let i=e.replace("special-page-",""),r=this.storyManager?.pages?.availablePages?.[i];t.push({buttonId:e,knotName:i,displayName:r?.displayName||q.formatKnotName(i),element:n,visible:n.style.display!=="none",enabled:!n.hasAttribute("disabled")})}return t}getButtonStates(){let t={};["rewind","saves-btn","settings-btn"].forEach(n=>{let i=document.getElementById(n);i?t[n]={visible:i.style.display!=="none",enabled:!i.hasAttribute("disabled"),exists:!0,isDynamic:!1}:t[n]={visible:!1,enabled:!1,exists:!1,isDynamic:!1}});for(let[n,i]of this.dynamicButtons){let r=n.replace("special-page-","");t[n]={visible:i.style.display!=="none",enabled:!i.hasAttribute("disabled"),exists:!0,isDynamic:!0,knotName:r,displayName:this.getPageDisplayName(r)}}return t}findPageButton(t){if(!this.slidePanel)return null;let e=this.slidePanel.querySelectorAll(".panel-link");for(let n of e){let i=this.storyManager?.pages?.availablePages?.[t];if(i&&n.textContent===i.displayName)return n}return null}getPageDisplayName(t){return this.storyManager?.pages?.availablePages?.[t]?.displayName||q.formatKnotName(t)}isReady(){return!!(this.storyManager&&document.getElementById("rewind"))}getStats(){let t=this.getButtonStates(),e=this.getSpecialPageButtons(),n=Object.keys(t).length,i=Object.values(t).filter(o=>o.isDynamic).length,r=Object.values(t).filter(o=>o.exists).length,a=Object.values(t).filter(o=>o.visible).length;return{hasStoryManager:!!this.storyManager,totalButtons:n,dynamicButtons:i,existingButtons:r,visibleButtons:a,trackedDynamicButtons:this.dynamicButtons.size,specialPageButtons:e.length,specialPageButtonDetails:e}}getNavigationInfo(){let t=this.storyManager?.pages?.getCurrentPageKnotName(),e=this.storyManager?.pages?.availablePages||{};return{currentPage:{knotName:t,displayName:t?this.getPageDisplayName(t):null,isSpecialPage:!!t},availablePages:Object.keys(e).map(n=>({knotName:n,displayName:this.getPageDisplayName(n),hasButton:this.findPageButton(n)!==null})),coreButtons:{restart:{exists:!!document.getElementById("rewind"),enabled:!document.getElementById("rewind")?.hasAttribute("disabled")},saves:{exists:!!document.getElementById("saves-btn"),enabled:!document.getElementById("saves-btn")?.hasAttribute("disabled")},settings:{exists:!!document.getElementById("settings-btn"),enabled:!document.getElementById("settings-btn")?.hasAttribute("disabled")}}}}};var pe=C.forSource(w.SAVES_MODAL),xe=100,ne=class{constructor(t){if(this.gameSaveSystem=t,this.maxSaveSlots=t.maxSaveSlots,this.autosaveSlot=t.autosaveSlot,this.confirmModal=null,!this.gameSaveSystem){pe.critical("SavesModal requires a save system",new Error("Invalid save system"));return}this.init()}init(){this.createModal(),this.createConfirmModal()}createModal(){this.modal=new it({title:"Save & Load Game",className:"saves-modal",maxWidth:"600px",onShow:()=>this.populateSaveSlots()})}createConfirmModal(){this.confirmModal=new it({title:"Confirm",className:"confirm-modal",maxWidth:"400px",showFooter:!0})}show(){this.modal?.show()}hide(){this.modal?.hide()}populateSaveSlots(){if(!this.modal?.modalElement)return;let t=`
      <div class="saves-section">
        <h3>Save Slots</h3>
        <div class="save-slots-container">
          ${this.generateSaveSlotsHTML()}
        </div>
        <div class="import-export-info">
          <strong>Tip:</strong> Use "Export" to save a slot to a file. Use "Import Here" on empty slots to load save files. Press Ctrl+S to quickly open this dialog.
        </div>
      </div>
    `;this.modal.setContent(t);let e=this.modal.getFooter();if(e){e.innerHTML="",e.className="modal-footer modal-footer-right";let n=this.modal.createButton("Close",{variant:"primary",onClick:()=>this.hide()});e.appendChild(n)}this.setupSlotEventListeners()}showNotification(t,e=!1,n=4e3){this.modal?.showNotification(t,e,n)}generateSaveSlotsHTML(){let t="";t+=this.createSaveSlotHTML(this.autosaveSlot,!0);for(let e=1;e<=this.maxSaveSlots;e++)t+=this.createSaveSlotHTML(e,!1);return t}createSaveSlotHTML(t,e=!1){try{let n=this.gameSaveSystem.getSaveData(t);return n?`<div class="save-slot ${e?"autosave-slot":""}" data-slot="${t}">
          ${this.createFilledSlotHTML(t,n,e)}
        </div>`:`<div class="save-slot ${e?"autosave-slot":""}" data-slot="${t}">
          ${this.createEmptySlotHTML(t,e)}
        </div>`}catch(n){return pe.error("Failed to create save slot HTML",n),""}}createEmptySlotHTML(t,e){let n=e?"Autosave":`Slot ${t}`,i=e?"No autosave available":"Empty",r=e?"Game will autosave after choices when enabled in settings":"";return`
      <div class="save-slot-content">
        <div class="save-slot-info">
          <strong class="save-slot-name">${n}</strong>
          <span class="save-slot-meta">${i}</span>
          ${r?`<span class="save-slot-meta">${r}</span>`:""}
        </div>
        <div class="save-slot-actions">
          ${e?"":this.createActionButton("Save","save-to-slot","primary",n)}
          ${e?"":this.createActionButton("Import","import-to-slot","secondary",n)}
        </div>
      </div>
    `}createFilledSlotHTML(t,e,n){let i=n?"Autosave":`Slot ${t}`,r=new Date(e.timestamp).toLocaleString(),a=(e.turnIndex??0)+1;return`
      <div class="save-slot-content">
        <div class="save-slot-info">
          <strong class="save-slot-name">${i}</strong>
          <span class="save-slot-date">${r}</span>
          <span class="save-slot-meta">Turn ${a}${e.description?` \xB7 ${e.description}`:""}</span>
        </div>
        <div class="save-slot-actions">
          ${this.createActionButton("Load","load-from-slot","secondary",i)}
          ${this.createActionButton("Export","export-from-slot","primary",i)}
          ${n?"":this.createActionButton("Overwrite","overwrite-slot","warning",i)}
          ${this.createActionButton(n?"Clear":"Delete","delete-slot","danger",i)}
        </div>
      </div>
    `}createActionButton(t,e,n,i){let r=`${t} ${i}`;return`<button class="${e} save-action-button save-action-${n}" aria-label="${r}">${t}</button>`}setupSlotEventListeners(){this.modal?.modalElement&&this.setupSlotActionHandlers()}setupSlotActionHandlers(){Object.entries({"save-to-slot":e=>this.gameSaveSystem.saveToSlot(e),"load-from-slot":e=>this.gameSaveSystem.loadFromSlot(e),"export-from-slot":e=>this.gameSaveSystem.exportFromSlot(e),"import-to-slot":e=>this.gameSaveSystem.importToSlot(e),"overwrite-slot":e=>this.gameSaveSystem.saveToSlot(e),"delete-slot":e=>this.handleDeleteSlot(e)}).forEach(([e,n])=>{this.bindSlotAction(e,n)})}handleDeleteSlot(t){let n=this.modal.modalElement.querySelector(`[data-slot="${t}"]`)?.classList.contains("autosave-slot");this.gameSaveSystem.deleteSlot(t,n)}bindSlotAction(t,e){this.modal.addBodyEventListener(`.${t}`,"click",n=>{try{let i=n.target.closest("[data-slot]"),r=parseInt(i?.dataset.slot);isNaN(r)||(e(r),setTimeout(()=>this.populateSaveSlots(),xe))}catch(i){pe.error("Save slot action failed",i)}})}isReady(){return!!(this.modal?.isReady()&&this.gameSaveSystem)}getStats(){return{hasModal:!!this.modal,hasGameSaveSystem:!!this.gameSaveSystem,maxSaveSlots:this.maxSaveSlots,autosaveSlot:this.autosaveSlot,modalVisible:this.modal?.isVisible||!1}}};var me=class{constructor(){this.modal=null,this.init()}init(){this.modal=new it({title:"Error",className:"error-modal",maxWidth:"500px",showFooter:!0})}show({title:t="Something went wrong",message:e="An unexpected error occurred.",suggestions:n=[],error:i=null}={}){if(!this.modal?.isReady()){console.error("[ErrorModal] Modal not initialized");return}this.modal.show(r=>{let a=r.modalElement?.querySelector(".modal-header h2");a&&(a.innerHTML=`<span class="material-icons error-modal-icon" aria-hidden="true">warning</span><span class="sr-only">Error: </span>${this.escapeHtml(t)}`),r.setContent(this.buildContent(e,n,i)),this.setupFooter(r)})}buildContent(t,e,n){let i=`<p class="error-modal-message">${t}</p>`;if(e.length>0&&(i+=`
        <div class="error-modal-suggestions">
          <p><strong>This might be because:</strong></p>
          <ul>
            ${e.map(r=>`<li>${r}</li>`).join("")}
          </ul>
        </div>
      `),n){let r=n instanceof Error?`${n.message}${n.stack?`

${n.stack}`:""}`:String(n),a=q.isMobile()?"":`<p class="error-modal-console-hint">
        For more details, open browser console: <kbd>F12</kbd> \u2192 Console tab
      </p>`;i+=`
    <details class="error-modal-details">
      <summary>Technical Details</summary>
      <pre>${this.escapeHtml(r)}</pre>
      ${a}
    </details>
  `}return i}setupFooter(t){let e=t.getFooter();if(!e)return;e.innerHTML="",e.className="modal-footer modal-footer-right";let n=t.createButton("Close",{variant:"primary",onClick:()=>t.hide()});e.appendChild(n)}escapeHtml(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}hide(){this.modal?.hide()}},St=new me;var at=C.forSource(w.SAVE_SYSTEM),ge=10*1024*1024,Fe=3e4,ie=class{constructor(t){this.storyManager=t,this.savePrefix="ink-save-slot-",this.autosaveSlot=0,this.maxSaveSlots=5,this.modal=new ne(this),this.setupEventListeners()}setupEventListeners(){let t=document.getElementById("saves-btn");t&&t.addEventListener("click",e=>{e.preventDefault(),this.showSaveDialog()})}showSaveDialog(){this.modal?.show?.()}hideSaveDialog(){this.modal?.hide?.()}saveToSlot(t){try{this.validateSlotNumber(t),this.requireStorage();let e=this.buildSaveData(t);return this.writeSaveData(t,e),this.notifySaveSuccess(t),this.modal?.populateSaveSlots?.(),!0}catch(e){return at.error("Failed to save game",e),t!==this.autosaveSlot&&St.show({title:"Unable to Save",message:"Your progress couldn't be saved.",suggestions:["Your browser's storage may be full","Try deleting old saves to free up space","Private/incognito mode may be blocking storage"],error:e}),!1}}loadFromSlot(t){try{let e=this.getSaveData(t);if(!e){let i=t===this.autosaveSlot?"autosave":"this slot";throw new Error(`No save data found in ${i}`)}if(!e.gameState)throw new Error("Save data is corrupted: missing game state");this.storyManager.loadState(e);let n=t===this.autosaveSlot?"Autosave":`Slot ${t}`;return this.showNotification(`Game loaded from ${n}!`),this.hideSaveDialog(),!0}catch(e){return at.error("Failed to load game",e),St.show({title:"Unable to Load Save",message:"This save couldn't be loaded.",suggestions:["The save data may be corrupted","It may be from an incompatible version of the story","Try loading a different save or restarting"],error:e}),!1}}deleteSlot(t,e=!1){try{let n=e?"Are you sure you want to clear the autosave?":`Are you sure you want to delete the save in Slot ${t}?`;if(this.modal&&this.modal.confirmModal)return this.modal.confirmModal.showConfirmation(n,()=>{try{if(!this.isStorageAvailable())throw new Error("localStorage not available");let i=this.savePrefix+t;localStorage.removeItem(i);let r=e?"Autosave cleared.":`Slot ${t} deleted.`;this.showNotification(r),this.modal?.populateSaveSlots?.()}catch(i){at.error("Failed to delete save slot",i)}},null,{title:"Delete Save",confirmText:"Delete",cancelText:"Cancel"}),!0;if(confirm(n)){if(!this.isStorageAvailable())throw new Error("localStorage not available");let i=this.savePrefix+t;localStorage.removeItem(i);let r=e?"Autosave cleared.":`Slot ${t} deleted.`;return this.showNotification(r),this.modal?.populateSaveSlots?.(),!0}return!1}catch(n){return at.error("Failed to delete save slot",n),St.show({title:"Unable to Delete Save",message:"This save couldn't be deleted.",suggestions:["Your browser's storage may be unavailable","Private/incognito mode may be blocking storage","Try refreshing the page and trying again"],error:n}),!1}}exportFromSlot(t){try{let e=this.getSaveData(t);if(!e)throw new Error("No save data found in this slot to export");let n=JSON.stringify(e),i=new Blob([n],{type:"application/json"}),r=document.createElement("a");r.href=URL.createObjectURL(i);let a=new Date(e.timestamp).toISOString().slice(0,19).replace(/:/g,"-"),o=t===this.autosaveSlot?"autosave":`slot${t}`,l=this.slugifyTitle(this.storyManager.settings?.storyTitle);r.download=`${l}-${o}-${a}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r);let c=t===this.autosaveSlot?"Autosave":`Slot ${t}`;return this.showNotification(`Save exported from ${c}!`),!0}catch(e){return at.error("Failed to export save",e),St.show({title:"Unable to Export Save",message:"This save couldn't be exported.",suggestions:["The save data may be corrupted","Try saving to a new slot first, then export"],error:e}),!1}}importToSlot(t){let e=document.createElement("input");e.type="file",e.accept=".json",e.style.display="none",e.addEventListener("change",n=>{let i=n.target.files[0];if(!i)return;if(i.size>ge){let o=ge/1048576;St.show({title:"Unable to Import Save",message:"This save file couldn't be loaded.",suggestions:[`The file exceeds the ${o}MB size limit`,"Make sure you're importing a save file, not a story file"],error:new Error(`File size ${i.size} exceeds limit of ${ge}`)}),at.error(`Import file too large (>${o}MB)`,new Error("File size exceeds limit"));return}let r=new FileReader,a=setTimeout(()=>{r.abort();let o=new Error("FileReader timeout");St.show({title:"Unable to Import Save",message:"This save file couldn't be loaded.",suggestions:["The file took too long to read","Try again or use a smaller file"],error:o}),at.error("File import timed out",o)},Fe);r.onload=o=>{clearTimeout(a);try{let l=JSON.parse(o.target.result);if(!l?.gameState||!l?.version)throw new Error("Invalid save file format");this.storyManager.createTempStory().state.LoadJson(l.gameState),this.writeSaveData(t,l);let u=t===this.autosaveSlot?"Autosave":`Slot ${t}`;this.showNotification(`Save imported to ${u}!`),this.modal?.populateSaveSlots?.()}catch(l){at.error("Failed to import save file",l),St.show({title:"Unable to Import Save",message:"This save file couldn't be loaded.",suggestions:["The file may be corrupted or invalid","It may be from a different story","It may be from an incompatible version of the story"],error:l})}},r.onerror=()=>{clearTimeout(a);let o=r.error||new Error("Unknown read error");at.error("Failed to read import file",o),St.show({title:"Unable to Import Save",message:"This save file couldn't be loaded.",suggestions:["The file couldn't be read","It may be corrupted","Try exporting the save again from the original source"],error:o})},r.readAsText(i),n.target.value="",document.body.removeChild(e)}),document.body.appendChild(e),e.click()}autosave(){if(!(!this.shouldAutosave()||this.storyManager.pages?.isViewingSpecialPage?.()))try{this.saveToSlot(this.autosaveSlot),console.log("[AUTOSAVE] Game autosaved successfully")}catch(t){at.error("Autosave failed",t)}}hasSaves(){if(this.getSaveData(this.autosaveSlot))return!0;for(let t=1;t<=this.maxSaveSlots;t++)if(this.getSaveData(t))return!0;return!1}getSaveData(t){try{if(!this.isStorageAvailable())return null;let e=this.savePrefix+t,n=localStorage.getItem(e);return n?JSON.parse(n):null}catch(e){return at.error("Failed to get save data",e),null}}getSaveStats(){let t=0,e=null,n=null;for(let i=0;i<=this.maxSaveSlots;i++){let r=this.getSaveData(i);r&&(t++,(!e||r.timestamp<e.timestamp)&&(e=r),(!n||r.timestamp>n.timestamp)&&(n=r))}return{totalSaves:t,hasAutosave:!!this.getSaveData(this.autosaveSlot),oldestSave:e,newestSave:n}}shouldAutosave(){try{return this.storyManager.settings?.getSetting?.("autoSave")||!1}catch{return!1}}isStorageAvailable(){try{let t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch{return!1}}validateSlotNumber(t){if(typeof t!="number"||!Number.isInteger(t)||t<0||t>this.maxSaveSlots)throw new Error(`Invalid slot number: ${t}`)}requireStorage(){if(!this.isStorageAvailable())throw new Error("localStorage not available")}buildSaveData(t){let e=this.storyManager.pages?.isViewingSpecialPage?.();return{version:"dev",gameState:this.getGameState(e),displayState:this.getDisplayState(e),turnIndex:this.storyManager.story.state.currentTurnIndex,description:this.generateDescription(),timestamp:Date.now(),autoClear:this.storyManager.autoClear,isAutosave:t===this.autosaveSlot,currentPage:null,stateBeforeUserInput:this.storyManager.stateBeforeUserInput||null}}getGameState(t){return t?this.storyManager.pages.savedStoryState:this.storyManager.story.state.ToJson()}getDisplayState(t){return t?this.storyManager.pages.savedDisplayState:this.storyManager.display.getState()}writeSaveData(t,e){if(!this.isStorageAvailable())throw new Error("localStorage not available");let n=this.savePrefix+t,i=JSON.stringify(e);try{localStorage.setItem(n,i)}catch(r){if(r.name==="QuotaExceededError"){this.attemptStorageCleanup();try{localStorage.setItem(n,i)}catch{throw new Error("Storage quota exceeded - please delete some saves manually")}}else throw r}}slugifyTitle(t){return!t||typeof t!="string"?"ink-story":t.toLowerCase().trim().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"ink-story"}generateDescription(){let t=this.storyManager.story.state.currentPathString;if(t)return this.pathToDisplayName(t);let e=this.storyManager.display?.getState?.();return this.descriptionFromHistory(e?.history)}pathToDisplayName(t){if(!t)return"";let e=t.split("."),n=e[e.length-1];return n=n.replace(/_/g," "),n=n.replace(/([a-z])([A-Z])/g,"$1 $2"),n=n.toLowerCase().split(" ").map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join(" "),n}descriptionFromHistory(t,e=60){if(!t?.length)return"";for(let n of t)if(n.type==="paragraph"&&n.text?.trim()){let i=n.text.trim();return i=i.replace(/^:{1,3}\s+/,""),i=i.replace(/^>{1,2}\s+/,""),i.length>e&&(i=i.substring(0,e-3)+"..."),i}return""}notifySaveSuccess(t){t!==this.autosaveSlot&&this.showNotification(`Game saved to Slot ${t}!`)}showNotification(t,e=4e3){this.modal?.showNotification?.(t,!1,e)}attemptStorageCleanup(){try{let t=[];for(let e=1;e<=this.maxSaveSlots;e++){let n=this.getSaveData(e);n?.timestamp&&t.push({slot:e,timestamp:n.timestamp})}if(t.sort((e,n)=>e.timestamp-n.timestamp),t.length>0){let e=t[0].slot,n=this.savePrefix+e;localStorage.removeItem(n),console.log(`[STORAGE] Automatically removed oldest save from slot ${e}`)}}catch(t){at.error("Storage cleanup failed",t)}}cleanup(){this.modal?.modalElement?.remove?.()}};window.InkTemplate={storyManager:null,errorManager:C,notificationManager:ht,keyboardShortcuts:null,keyboardHelpModal:null};fetch("story.json").then(s=>{if(!s.ok)throw new Error(`story.json not found (${s.status}). Make sure story.json is in the root folder alongside index.html.`);return s.json()}).then(s=>{try{Lt.scan(s);let t=new Qt,e=new Xt(t),n=new zt(t),i=new Jt(n),r=new Kt(t),a=new Gt(s,{display:r,settings:t,contentProcessor:i}),o=new Zt(a),l=new te(a,n),c=new ee(a),u=new ie(a);a.pages=o,a.choices=l,a.navigation=c,a.saves=u,i.storyManager=a,r.storyManager=a;let m=null,g=null;q.isMobile()||(g=new qt,m=new Ht,m.storyManager=a,m.keyboardHelpModal=g),t.storyManager=a,t.keyboardShortcuts=m,t.settingsModal=e,e.keyboardHelpModal=g,a.start(),window.InkTemplate.storyManager=a,window.InkTemplate.keyboardShortcuts=m,window.InkTemplate.keyboardHelpModal=g;let S=document.getElementById("loading-screen");S&&(S.classList.add("hidden"),setTimeout(()=>S.remove(),300));let B=document.getElementById("main-content");B&&B.removeAttribute("aria-busy");let R=document.querySelector(".skip-link");R&&R.addEventListener("click",J=>{J.preventDefault();let O=document.querySelector(R.getAttribute("href"));O&&O.focus()}),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&(window.debug={story:a.story,display:a.display,saves:a.saves,settings:a.settings,errors:C,getStats:()=>a.getStats(),getFeatureInfo:()=>a.getFeatureInfo()},console.log("Debug tools available in window.debug"))}catch(t){C.critical("Failed to initialize story manager",t,w.SYSTEM),Ee(t)}}).catch(s=>{C.critical("Failed to load story file",s,w.SYSTEM),Ee(s)});function Ee(s){let t=document.getElementById("story");if(!t)return;let e=document.getElementById("loading-screen");e&&(e.classList.add("hidden"),setTimeout(()=>e.remove(),300)),t.innerHTML=`
    <div style="text-align: center; padding: 2rem; color: var(--color-important);">
      <h2>\u26A0\uFE0F Story Loading Error</h2>
      <p>Unable to load the story. Please check the browser console (F12) for details.</p>
      <div style="margin: 2rem 0;">
        <button onclick="window.location.reload()" style="
          background: var(--color-accent-primary);
          color: var(--color-background);
          border: none;
          padding: 0.75rem 1.5rem;
          border-radius: 4px;
          cursor: pointer;
          margin-right: 1rem;
          font-size: 1rem;
        ">Reload Page</button>
        <button onclick="showConsoleHelp()" style="
          color: var(--color-text-primary);
          border: 1px solid var(--color-border-medium);
          padding: 0.75rem 1.5rem;
          border-radius: 4px;
          cursor: pointer;
          font-size: 1rem;
        ">How to Check Console</button>
      </div>
      <details style="margin-top: 1rem; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
        <summary style="cursor: pointer; font-weight: 600;">Technical Details</summary>
        <div style="background: var(--color-background); color: var(--color-text-primary); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto;">
          Error: ${s.message}<br>
          Time: ${new Date().toLocaleString()}<br>
          ${s.stack?`Stack: ${s.stack}`:""}
        </div>
      </details>
    </div>
  `}function Me(){alert(`To check the console for error details:

\u2022 Chrome/Edge: Press F12 or Ctrl+Shift+I, then click "Console"
\u2022 Firefox: Press F12 or Ctrl+Shift+K
\u2022 Safari: Press Cmd+Option+I (Mac), then click "Console"
\u2022 Mobile: Console not easily accessible, try on desktop

Look for red error messages that show what went wrong.`)}window.showConsoleHelp=Me;})();
//# sourceMappingURL=template.min.js.map
